/*! For license information please see hypha-core.mjs.LICENSE.txt */
var __webpack_modules__={42:function(module){var factory;factory=()=>(()=>{var __webpack_modules__={"./src/rpc.js":(e,t,n)=>{n.r(t),n.d(t,{API_VERSION:()=>a,RPC:()=>_});var r=n("./src/utils/index.js"),i=n("./src/utils/schema.js"),s=n("./node_modules/@msgpack/msgpack/dist.es5+esm/decode.mjs"),o=n("./node_modules/@msgpack/msgpack/dist.es5+esm/encode.mjs");const a="0.20.0",c=512e3,l=Object.getPrototypeOf(Object.getPrototypeOf(new Uint8Array)).constructor;function u(e,t){const n=new Uint8Array(e.byteLength+t.byteLength);return n.set(new Uint8Array(e),0),n.set(new Uint8Array(t),e.byteLength),n.buffer}function d(e,t){if(!t)throw new Error("undefined index");return"string"==typeof t?d(e,t.split(".")):0===t.length?e:d(e[t[0]],t.slice(1))}function h(e,t=null,n=!1){if(e instanceof Object){let t={};for(let r in e)t[r]=h(e[r],r,n);return t}if(e instanceof Array)return e.map(((e,t)=>h(e,null,n)));if("function"==typeof e){if(e.__schema__){const r=JSON.parse(JSON.stringify(e.__schema__));return t&&(r.name=t,e.__schema__.name=t),n&&r.parameters&&r.parameters.properties&&delete r.parameters.properties.context,{type:"function",function:r}}return{type:"function"}}return"number"==typeof e?{type:"number"}:"string"==typeof e?{type:"string"}:"boolean"==typeof e?{type:"boolean"}:null===e?{type:"null"}:{}}class p{constructor(e,t,n,r){this._timeout=e,this._callback=t,this._args=n,this._label=r||"timer",this._task=null,this.started=!1}start(){this.started?this.reset():(this._task=setTimeout((()=>{this._callback.apply(this,this._args)}),1e3*this._timeout),this.started=!0)}clear(){this._task?(clearTimeout(this._task),this._task=null,this.started=!1):console.warn(`Clearing a timer (${this._label}) which is not started`)}reset(){this._task&&clearTimeout(this._task),this._task=setTimeout((()=>{this._callback.apply(this,this._args)}),1e3*this._timeout),this.started=!0}}class f extends Object{}class _ extends r.MessageEmitter{constructor(e,{client_id:t=null,default_context:n=null,name:i=null,codecs:s=null,method_timeout:o=null,max_message_buffer_size:a=0,debug:c=!1,workspace:l=null,silent:u=!1,app_id:d=null}){if(super(c),this._codecs=s||{},(0,r.assert)(t&&"string"==typeof t),(0,r.assert)(t,"client_id is required"),this._client_id=t,this._name=i,this._app_id=d||"*",this._local_workspace=l,this._silent=u,this.default_context=n||{},this._method_annotations=new WeakMap,this._max_message_buffer_size=a,this._chunk_store={},this._method_timeout=o||30,this._services={},this._object_store={services:this._services},e){this.add_service({id:"built-in",type:"built-in",name:`Built-in services for ${this._local_workspace}/${this._client_id}`,config:{require_context:!0,visibility:"public"},ping:this._ping.bind(this),get_service:this.get_local_service.bind(this),message_cache:{create:this._create_message.bind(this),append:this._append_message.bind(this),process:this._process_message.bind(this),remove:this._remove_message.bind(this)}}),this.on("method",this._handle_method.bind(this)),this.on("error",console.error),(0,r.assert)(e.emit_message&&e.on_message),(0,r.assert)(void 0!==e.manager_id,"Connection must have manager_id"),this._emit_message=e.emit_message.bind(e),e.on_message(this._on_message.bind(this)),this._connection=e;const t=async e=>{if(!this._silent&&this._connection.manager_id){console.log("Connection established, reporting services...");const e=await this.get_manager_service({timeout:10,case_conversion:"camel"});for(let t of Object.values(this._services)){const n=this._extract_service_info(t);await e.registerService(n)}}else console.log("Connection established",e);this._fire("connected",e)};e.on_connected(t),t()}else this._emit_message=function(){console.log("No connection to emit message")}}register_codec(e){if(!e.name||!e.encoder&&!e.decoder)throw new Error("Invalid codec format, please make sure you provide a name, type, encoder and decoder.");if(e.type)for(let t of Object.keys(this._codecs))this._codecs[t].type!==e.type&&t!==e.name||(delete this._codecs[t],console.warn("Remove duplicated codec: "+t));this._codecs[e.name]=e}async _ping(e,t){return(0,r.assert)("ping"==e),"pong"}async ping(e,t){let n=this._generate_remote_method({_rtarget:e,_rmethod:"services.built-in.ping",_rpromise:!0,_rdoc:"Ping a remote client"});(0,r.assert)("pong"==await n("ping",t))}_create_message(e,t,n,r){if(t){if(!this._object_store[e])throw new Error(`session does not exist anymore: ${e}`);this._object_store[e].timer.reset()}if(this._object_store.message_cache||(this._object_store.message_cache={}),!n&&this._object_store.message_cache[e])throw new Error(`Message with the same key (${e}) already exists in the cache store, please use overwrite=true or remove it first.`);this._object_store.message_cache[e]=[]}_append_message(e,t,n,i){if(n){if(!this._object_store[e])throw new Error(`session does not exist anymore: ${e}`);this._object_store[e].timer.reset()}const s=this._object_store.message_cache;if(!s[e])throw new Error(`Message with key ${e} does not exists.`);(0,r.assert)(t instanceof l),s[e].push(t)}_remove_message(e,t){const n=this._object_store.message_cache;if(!n[e])throw new Error(`Message with key ${e} does not exists.`);delete n[e]}_process_message(e,t,n){if(t){if(!this._object_store[e])throw new Error(`session does not exist anymore: ${e}`);this._object_store[e].timer.reset()}const i=this._object_store.message_cache;if((0,r.assert)(!!n,"Context is required"),!i[e])throw new Error(`Message with key ${e} does not exists.`);var o,a,c,l;i[e]=(c=(a=(o=i[e]).map((function(e){return e.byteLength}))).reduce((function(e,t){return e+t}),0),l=new Uint8Array(c),a.reduce((function(e,t,n){return l.set(new Uint8Array(o[n]),e),e+t}),0),l.buffer),console.debug(`Processing message ${e} (bytes=${i[e].byteLength})`);let u=(0,s.decodeMulti)(i[e]);const{done:d,value:h}=u.next(),p=h;if(Object.assign(p,{from:n.from,to:n.to,user:n.user}),p.ctx=JSON.parse(JSON.stringify(p)),Object.assign(p.ctx,this.default_context),!d){let e=u.next();Object.assign(p,e.value)}this._fire(p.type,p),console.debug(this._client_id,`Processed message ${e} (bytes=${i[e].byteLength})`),delete i[e]}_on_message(e){if("string"==typeof e){const t=JSON.parse(e);this._fire(t.type,t)}else if(e instanceof ArrayBuffer){let t=(0,s.decodeMulti)(e);const{done:n,value:r}=t.next(),i=r;if(i.ctx=JSON.parse(JSON.stringify(i)),Object.assign(i.ctx,this.default_context),!n){let e=t.next();Object.assign(i,e.value)}this._fire(i.type,i)}else{if("object"!=typeof e)throw new Error("Invalid message format");this._fire(e.type,e)}}reset(){this._event_handlers={},this._services={}}async disconnect(){this._fire("disconnected"),await this._connection.disconnect()}async get_manager_service(e){e=e||{};let{timeout:t,case_conversion:n}=e;return(0,r.assert)(this._connection.manager_id,"Manager id is not set"),await this.get_remote_service(`*/${this._connection.manager_id}:default`,{timeout:t,case_conversion:n})}get_all_local_services(){return this._services}get_local_service(e,t){(0,r.assert)(e);const[n,i]=t.to.split("/");(0,r.assert)(i===this._client_id,"Services can only be accessed locally");const s=this._services[e];if(!s)throw new Error("Service not found: "+e);if(s.config.workspace=t.ws,"public"==s.config.visibility)return s;if(t.ws===n)return s;throw new Error(`Permission denied for getting protected service: ${e}, workspace mismatch: ${n} != ${t.ws}`)}async get_remote_service(e,t){let{timeout:n,case_conversion:i}=t||{};n=void 0===n?this._method_timeout:n,!e&&this._connection.manager_id?e="*/"+this._connection.manager_id:e.includes(":")||(e=this._client_id+":"+e);const s=e.split(":")[0];let o=e.split(":")[1];if(o.includes("@")){o=o.split("@")[0];const t=e.split("@")[1];this._app_id&&"*"!==this._app_id&&(0,r.assert)(t===this._app_id,`Invalid app id: ${t} != ${this._app_id}`)}(0,r.assert)(s,`Invalid service uri: ${e}`);try{const t=this._generate_remote_method({_rtarget:s,_rmethod:"services.built-in.get_service",_rpromise:!0,_rdoc:"Get a remote service"}),a=await(0,r.waitFor)(t(o),n,"Timeout Error: Failed to get remote service: "+e);return a.id=`${s}:${o}`,i?Object.assign(new f,(0,r.convertCase)(a,i)):Object.assign(new f,a)}catch(t){throw console.warn("Failed to get remote service: "+e,t),t}}_annotate_service_methods(e,t,n,r,i){if("function"==typeof e){let s=t.split(".")[1];this._method_annotations.set(e,{require_context:Array.isArray(n)?n.includes(s):!!n,run_in_executor:r,method_id:"services."+t,visibility:i})}else if(e instanceof Array||e instanceof Object)for(let s of Object.keys(e)){let o=e[s];if("function"==typeof o&&o.__rpc_object__){let t=o.__rpc_object__._rtarget;if(t.includes("/")&&(t=t.split("/")[1]),this._client_id!==t)throw new Error(`Local method not found: ${o.__rpc_object__._rmethod}, client id mismatch ${this._client_id} != ${t}`);e instanceof Array&&(e=e.slice()),e[s]=d(this._object_store,o.__rpc_object__._rmethod),o=e[s]}this._annotate_service_methods(o,t+"."+s,n,r,i)}}add_service(e,t){if(!e||Array.isArray(e))throw new Error("Invalid service object");if(e.constructor===Object)e=Object.assign({},e);else{const t={},n=Object.getOwnPropertyNames(e).concat(Object.getOwnPropertyNames(Object.getPrototypeOf(e)));for(let r of n)"constructor"!==r&&("function"==typeof e[r]?t[r]=e[r].bind(e):t[r]=e[r]);e.id=e.id||"default",e=t}(0,r.assert)(e.id&&"string"==typeof e.id,`Service id not found: ${e}`),e.name||(e.name=e.id),e.config||(e.config={}),e.type||(e.type="generic");let n=!1,i=!1;e.config.require_context&&(n=e.config.require_context),e.config.run_in_executor&&(i=!0);const s=e.config.visibility||"protected";if((0,r.assert)(["protected","public"].includes(s)),this._annotate_service_methods(e,e.id,n,i,s),this._services[e.id]){if(!t)throw new Error(`Service already exists: ${e.id}, please specify a different id (not ${e.id}) or overwrite=true`);delete this._services[e.id]}return this._services[e.id]=e,e}_extract_service_info(e){const t=e.config||{};t.workspace=t.workspace||this._local_workspace||this._connection.workspace;const n=h(e,null,t.require_context);return{config:t,id:`${t.workspace}/${this._client_id}:${e.id}`,name:e.name||e.id,description:e.description||"",type:e.type||"generic",docs:e.docs||null,app_id:this._app_id,service_schema:n}}async get_service_schema(e){return h(e,null,e.config.require_context)}async register_service(e,t){let n,{check_type:r,notify:s,overwrite:o}=t||{};if(s=void 0===s||s,r&&e.type)try{n=await this.get_manager_service({timeout:10,case_conversion:"camel"}),e=function(e,t){function n(e,t,n="root"){for(let r in t)if(!e.hasOwnProperty(r))throw new Error(`Missing key '${r}' in service at path '${n}'`);for(let r in e)if("type"!==r&&!t.hasOwnProperty(r))throw new Error(`Unexpected key '${r}' in service at path '${n}'`)}return n(e,t.definition),function e(t,r,s="root"){if("object"!=typeof t||Array.isArray(t)){if(Array.isArray(t)){if(t.length!==r.length)throw new Error(`Length mismatch at path '${s}'`);t.forEach(((n,o)=>{let a=`${s}[${o}]`;if("object"!=typeof n||Array.isArray(n)){if("function"==typeof n){if(!r.hasOwnProperty(o))throw new Error(`Missing schema for function at index ${o} in path '${a}'`);t[o]=(0,i.schemaFunction)(n,{name:r[o].name,description:r[o].description||"",parameters:r[o].parameters})}}else e(n,r[o],a)}))}}else{n(t,r,s);for(let n in t){let o=t[n],a=`${s}.${n}`;if("object"!=typeof o||Array.isArray(o)){if("function"==typeof o){if(!r.hasOwnProperty(n))throw new Error(`Missing schema for function '${n}' at path '${a}'`);t[n]=(0,i.schemaFunction)(o,{name:r[n].name,description:r[n].description||"",parameters:r[n].parameters})}}else e(o,r[n],a)}}}(e,t.definition),e}(e,await n.get_service_type(e.type))}catch(t){throw new Error(`Failed to get service type ${e.type}, error: ${t}`)}const a=this.add_service(e,o),c=this._extract_service_info(a);if(s)try{n=n||await this.get_manager_service({timeout:10,case_conversion:"camel"}),await n.registerService(c)}catch(e){throw new Error(`Failed to notify workspace manager: ${e}`)}return c}async unregister_service(e,t){if(e instanceof Object&&(e=e.id),!this._services[e])throw new Error(`Service not found: ${e}`);const n=this._services[e];if(delete this._services[e],t){const e=await this.get_manager_service({timeout:10,case_conversion:"camel"});await e.registerService(n.id)}}_ndarray(e,t,n){const i=(0,r.typedArrayToDtype)(e);if(n&&n!==i)throw"dtype doesn't match the type of the array: "+i+" != "+n;return t=t||[e.length],{_rtype:"ndarray",_rvalue:e.buffer,_rshape:t,_rdtype:i}}_encode_callback(e,t,n,r,i,s){let o=`${n}.${e}`,a={_rtype:"method",_rtarget:s?`${s}/${this._client_id}`:this._client_id,_rmethod:o,_rpromise:!1};const c=this;return[a,function(){try{t.apply(null,Array.prototype.slice.call(arguments))}catch(e){console.error("Error in callback:",o,e)}finally{r&&c._object_store[n]&&delete c._object_store[n],i&&i.started&&i.clear()}}]}async _encode_promise(e,t,n,i,s,o){let a=this._get_session_store(n,!0);(0,r.assert)(a,`Failed to create session store ${n} due to invalid parent`);let c={};return s&&t&&this._method_timeout?(c.heartbeat=await this._encode(s.reset.bind(s),n,o),c.interval=this._method_timeout/2,a.timer=s):s=null,[c.resolve,a.resolve]=this._encode_callback("resolve",e,n,i,s,o),[c.reject,a.reject]=this._encode_callback("reject",t,n,i,s,o),c}async _send_chunks(e,t,n){let i=await this.get_remote_service(`${t}:built-in`);(0,r.assert)(i.message_cache,"Remote client does not support message caching for long message.");let s=i.message_cache,o=n||(0,r.randId)();await s.create(o,!!n);let a=e.length,l=Math.ceil(a/c);for(let t=0;t<l;t++){let r=t*c;await s.append(o,e.slice(r,r+c),!!n),console.log(`Sending chunk ${t+1}/${l} (${a} bytes)`)}await s.process(o,!!n)}emit(e,t){if((0,r.assert)("object"==typeof e&&e.type,"Invalid message, must be an object with a `type` fields."),!e.to)return void this._fire(e.type,e);let n=(0,o.encode)(e);if(t){const e=(0,o.encode)(t);n=new Uint8Array([...n,...e])}if(n.length<=513024)return this._emit_message(n);throw new Error("Message is too large to send in one go.")}_generate_remote_method(e,t,n,i,s){let a=e._rtarget;i&&!a.includes("/")&&(i!==a&&(a=i+"/"+a),e._rtarget=a);let c=e._rmethod,l=e._rpromise;const u=this;function d(){return new Promise((async(e,i)=>{let d=(0,r.randId)();n&&(d=n+"."+d);let h=u._get_session_store(d,!0);if(!h)return void i(new Error(`Runtime Error: Failed to get session store ${d}`));h.target_id=a;const f=await u._encode(Array.prototype.slice.call(arguments),d,s),_=f.length,m=_>0&&"object"==typeof f[_-1]&&null!==f[_-1]&&f[_-1]._rkwargs;let y;m&&delete f[_-1]._rkwargs,y=u._local_workspace?u._local_workspace+"/"+u._client_id:u._client_id;let g={type:"method",from:y,to:a,method:c},b={};f&&(b.args=f),m&&(b.with_kwargs=m),t&&(g.parent=t);let w=null;if(l){g.session=d;let t=`${a}:${c}`;w=new p(u._method_timeout,i,[`Method call time out: ${t}`],t);let n=!0;for(let e of f)if("object"==typeof e&&!0===e._rintf){n=!1;break}b.promise=await u._encode_promise(e,i,d,n,w,s)}let v=(0,o.encode)(g);if(b){const e=(0,o.encode)(b);v=new Uint8Array([...v,...e])}v.length<=513024?u._emit_message(v).then((function(){w&&w.start()})):u._send_chunks(v,a,t).then((function(){w&&w.start()})).catch((function(e){console.error("Failed to send message",e),i(e)}))}))}d.__rpc_object__=e;const h=c.split(".");return d.__name__=h[h.length-1],d.__doc__=e._rdoc||`Remote method: ${c}`,d.__schema__=e._rschema,d}get_client_info(){const e=[];for(let t of Object.values(this._services))e.push(this._extract_service_info(t));return{id:this._client_id,services:e}}async _handle_method(e){let t=null;try{(0,r.assert)(e.method&&e.ctx&&e.from);const n=e.from+":"+e.method,i=e.from.split("/")[0],s=e.from.split("/")[1];let o;e.to=e.to.includes("/")?e.to:i+"/"+e.to,e.ctx.to=e.to,this._local_workspace?(this._local_workspace&&"*"!==this._local_workspace&&(0,r.assert)(e.to.split("/")[0]===this._local_workspace,"Workspace mismatch: "+e.to.split("/")[0]+" != "+this._local_workspace),o=this._local_workspace):o=e.to.split("/")[0];const a=e.parent;let c,l,u,h;if(e.promise){const p=await this._decode(e.promise,e.session,a,i,o);if(c=p.resolve,l=p.reject,p.heartbeat&&p.interval){async function f(){try{console.log("Reset heartbeat timer: "+e.method),await p.heartbeat()}catch(e){console.error(e)}}t=setInterval(f,1e3*p.interval)}}try{u=d(this._object_store,e.method)}catch(_){throw console.debug("Failed to find method",n,this._client_id,_),new Error(`Method not found: ${n} at ${this._client_id}`)}if((0,r.assert)(u&&"function"==typeof u,"Invalid method: "+n),this._method_annotations.has(u)){if("protected"===this._method_annotations.get(u).visibility&&o!==i&&("*"!==i||s!==this._connection.manager_id))throw new Error("Permission denied for invoking protected method "+n+", workspace mismatch: "+o+" != "+i)}else{let m=this._object_store[e.method.split(".")[0]].target_id;if(o===i&&m&&-1===m.indexOf("/")&&(m=o+"/"+m),m!==e.from)throw new Error("Access denied for method call ("+n+") from "+e.from+" to target "+m)}if(a&&(0,r.assert)(null!==this._get_session_store(a,!0),"Parent session was closed: "+a),h=e.args?await this._decode(e.args,e.session,null,i,null):[],this._method_annotations.has(u)&&this._method_annotations.get(u).require_context){if(h.length+1<u.length)for(let y=h.length;y<u.length-1;y++)h.push(void 0);h.push(e.ctx),(0,r.assert)(h.length===u.length,`Runtime Error: Invalid number of arguments for method ${n}, expected ${u.length} but got ${h.length}`)}if(e.promise){const g=u.apply(null,h);g instanceof Promise?g.then((e=>{c(e),clearInterval(t)})).catch((e=>{l(e),clearInterval(t)})):(c(g),clearInterval(t))}else u.apply(null,h),clearInterval(t)}catch(b){console.error("Error during calling method: ",b),clearInterval(t)}}encode(e,t){return this._encode(e,t)}_get_session_store(e,t){let n=this._object_store;const r=e.split(".");if(t){const e=r.length-1;for(let t of r.slice(0,e)){if(!n[t])return null;n=n[t]}return n[r[e]]||(n[r[e]]={}),n[r[e]]}for(let e of r){if(!n[e])return null;n=n[e]}return n}async _encode(e,t,n){const i=typeof e;if("number"===i||"string"===i||"boolean"===i||null==e||e instanceof Uint8Array)return e;if(e instanceof ArrayBuffer)return{_rtype:"memoryview",_rvalue:new Uint8Array(e)};if(e.__rpc_object__)return e.__rpc_object__;let s;if(e.constructor instanceof Object&&e._rtype){const a=e._rtype;return delete e._rtype,s=await this._encode(e,t,n),s._rtype=a,s}if("function"==typeof e){if(this._method_annotations.has(e)){let c=this._method_annotations.get(e);s={_rtype:"method",_rtarget:this._client_id,_rmethod:c.method_id,_rpromise:!0}}else{let u;(0,r.assert)("string"==typeof t),u=e.__name__?`${(0,r.randId)()}-${e.__name__}`:(0,r.randId)(),s={_rtype:"method",_rtarget:this._client_id,_rmethod:`${t}.${u}`,_rpromise:!0};let d=this._get_session_store(t,!0);(0,r.assert)(null!==d,`Failed to create session store ${t} due to invalid parent`),d[u]=e}if(s._rdoc=e.__doc__,!s._rdoc)try{const h=function(e){const t=e.toString(),n=t.match(/function\s*(\w*)/),r=n&&n[1]||"",i=t.match(/\(([^)]*)\)/);let s="";i&&(s=i[1].split(",").map((e=>e.replace(/\/\*.*?\*\//g,"").replace(/\/\/.*$/g,""))).filter((e=>e.trim().length>0)).map((e=>e.trim())).join(", "));let o=t.match(/\)\s*\{\s*\/\*([\s\S]*?)\*\//);const a=o&&o[1].trim()||"";o=t.match(/\)\s*\{\s*(\/\/[\s\S]*?)\n\s*[^\s\/]/);const c=o&&o[1].split("\n").map((e=>e.replace(/^\/\/\s*/,"").trim())).join("\n")||"",l=a||c;return r&&s.length>0&&{name:r,sig:s,doc:l}}(e);h&&!s._rdoc&&(s._rdoc=`${h.doc}`)}catch(p){console.error("Failed to extract function docstring:",e)}return s._rschema=e.__schema__,s}const o=Array.isArray(e);for(let f of Object.keys(this._codecs)){const _=this._codecs[f];if(_.encoder&&e instanceof _.type){let m=await Promise.resolve(_.encoder(e));if(m&&!m._rtype&&(m._rtype=_.name),"object"==typeof m){const y=m._rtype;delete m._rtype,m=await this._encode(m,t,n),m._rtype=y}return s=m,s}}if("undefined"!=typeof tf&&tf.Tensor&&e instanceof tf.Tensor){const g=e.dataSync();s={_rtype:"ndarray",_rvalue:new Uint8Array(g.buffer),_rshape:e.shape,_rdtype:e.dtype}}else if("undefined"!=typeof nj&&nj.NdArray&&e instanceof nj.NdArray){const b=(0,r.typedArrayToDtype)(e.selection.data);s={_rtype:"ndarray",_rvalue:new Uint8Array(e.selection.data.buffer),_rshape:e.shape,_rdtype:b}}else if(e instanceof Error)console.error(e),s={_rtype:"error",_rvalue:e.toString(),_rtrace:e.stack};else if(e!==Object(e)||e instanceof Boolean||e instanceof String||e instanceof Date||e instanceof RegExp||e instanceof ImageData||"undefined"!=typeof FileList&&e instanceof FileList||"undefined"!=typeof FileSystemDirectoryHandle&&e instanceof FileSystemDirectoryHandle||"undefined"!=typeof FileSystemFileHandle&&e instanceof FileSystemFileHandle||"undefined"!=typeof FileSystemHandle&&e instanceof FileSystemHandle||"undefined"!=typeof FileSystemWritableFileStream&&e instanceof FileSystemWritableFileStream)s=e;else if(e instanceof Blob){let w=0;async function v(t){let n;n=t?e.slice(w,w+t):e.slice(w);const r=new Uint8Array(await n.arrayBuffer());return w+=r.byteLength,r}function k(e){w=e}s={_rtype:"iostream",_rnative:"js:blob",type:e.type,name:e.name,size:e.size,path:e._path||e.webkitRelativePath,read:await this._encode(v,t,n),seek:await this._encode(k,t,n)}}else if(e instanceof l){const j=(0,r.typedArrayToDtype)(e);s={_rtype:"typedarray",_rvalue:new Uint8Array(e.buffer),_rdtype:j}}else if(e instanceof DataView)s={_rtype:"memoryview",_rvalue:new Uint8Array(e.buffer)};else if(e instanceof Set)s={_rtype:"set",_rvalue:await this._encode(Array.from(e),t,n)};else if(e instanceof Map)s={_rtype:"orderedmap",_rvalue:await this._encode(Array.from(e),t,n)};else{if(!(e.constructor instanceof Object||Array.isArray(e)))throw`hypha-rpc: Unsupported data type: ${e}, you can register a custom codec to encode/decode the object.`;{s=o?[]:{};const E=Object.keys(e);for(let O of E)s[O]=await this._encode(e[O],t,n)}}if(!s)throw new Error("Failed to encode object");return s}async decode(e){return await this._decode(e)}async _decode(e,t,n,i,s){if(!e)return e;let o;if(e._rtype)if(this._codecs[e._rtype]&&this._codecs[e._rtype].decoder){const r=e._rtype;delete e._rtype,(e=await this._decode(e,t,n,i,s))._rtype=r,o=await Promise.resolve(this._codecs[e._rtype].decoder(e))}else if("method"===e._rtype)o=this._generate_remote_method(e,t,n,i,s);else if("ndarray"===e._rtype)if("undefined"!=typeof nj&&nj.array)Array.isArray(e._rvalue)&&(e._rvalue=e._rvalue.reduce(u)),o=nj.array(new Uint8(e._rvalue),e._rdtype).reshape(e._rshape);else if("undefined"!=typeof tf&&tf.Tensor){Array.isArray(e._rvalue)&&(e._rvalue=e._rvalue.reduce(u));const t=r.dtypeToTypedArray[e._rdtype];o=tf.tensor(new t(e._rvalue),e._rshape,e._rdtype)}else o=e;else if("error"===e._rtype)o=new Error("RemoteError: "+e._rvalue+"\n"+(e._rtrace||""));else if("typedarray"===e._rtype){const t=r.dtypeToTypedArray[e._rdtype];if(!t)throw new Error("unsupported dtype: "+e._rdtype);o=new t(e._rvalue.buffer.slice(e._rvalue.byteOffset,e._rvalue.byteOffset+e._rvalue.byteLength))}else if("memoryview"===e._rtype)o=e._rvalue.buffer.slice(e._rvalue.byteOffset,e._rvalue.byteOffset+e._rvalue.byteLength);else if("iostream"===e._rtype){if("js:blob"===e._rnative){const r=await this._generate_remote_method(e.read,t,n,i,s),a=await r();o=new Blob([a],{type:e.type,name:e.name})}else{o={};for(let r of Object.keys(e))r.startsWith("_")||(o[r]=await this._decode(e[r],t,n,i,s))}o.__rpc_object__=e}else if("orderedmap"===e._rtype)o=new Map(await this._decode(e._rvalue,t,n,i,s));else if("set"===e._rtype)o=new Set(await this._decode(e._rvalue,t,n,i,s));else{const r=e._rtype;delete e._rtype,o=await this._decode(e,t,n,i,s),o._rtype=r}else if(e.constructor===Object||Array.isArray(e)){const r=Array.isArray(e);o=r?[]:{};for(let a of Object.keys(e))if(r||e.hasOwnProperty(a)){const r=e[a];o[a]=await this._decode(r,t,n,i,s)}}else o=e;if(void 0===o)throw new Error("Failed to decode object");return o}}},"./src/utils/index.js":(__unused_webpack_module,__nested_webpack_exports__,__nested_webpack_require_55989__)=>{function randId(){return Math.random().toString(36).substr(2,10)+(new Date).getTime()}function toCamelCase(e){return e.includes("_")?e.replace(/_./g,(e=>e[1].toUpperCase())):e}function toSnakeCase(e){return e.replace(/([A-Z])/g,"_$1").toLowerCase()}function convertCase(e,t){if("object"!=typeof e||null===e||!t)return e;const n=Array.isArray(e)?[]:{};for(const r in e)if(e.hasOwnProperty(r)){const i=e[r],s=toCamelCase(r),o=toSnakeCase(r);"camel"===t?(n[s]=convertCase(i,t),"function"==typeof i&&(n[s].__name__=s,i.__schema__&&(n[s].__schema__={...i.__schema__},n[s].__schema__.name=s))):"snake"===t?(n[o]=convertCase(i,t),"function"==typeof i&&(n[o].__name__=o,i.__schema__&&(n[o].__schema__={...i.__schema__},n[o].__schema__.name=o))):(t.includes("camel")&&(n[s]=convertCase(i,"camel")),t.includes("snake")&&(n[o]=convertCase(i,"snake")))}return n}function parseServiceUrl(e){e=e.replace(/\/$/,"");const t=new RegExp("^(https?:\\/\\/[^/]+)\\/([a-z0-9_-]+)\\/services\\/(?:(?<clientId>[a-zA-Z0-9_-]+):)?(?<serviceId>[a-zA-Z0-9_-]+)(?:@(?<appId>[a-zA-Z0-9_-]+))?"),n=e.match(t);if(!n)throw new Error("URL does not match the expected pattern");const r=n[1],i=n[2],s=n.groups?.clientId||"*",o=n.groups?.serviceId;return{serverUrl:r,workspace:i,clientId:s,serviceId:o,appId:n.groups?.appId||"*"}}__nested_webpack_require_55989__.r(__nested_webpack_exports__),__nested_webpack_require_55989__.d(__nested_webpack_exports__,{MessageEmitter:()=>MessageEmitter,assert:()=>assert,cacheRequirements:()=>cacheRequirements,convertCase:()=>convertCase,dtypeToTypedArray:()=>dtypeToTypedArray,loadRequirements:()=>loadRequirements,loadRequirementsInWebworker:()=>loadRequirementsInWebworker,loadRequirementsInWindow:()=>loadRequirementsInWindow,normalizeConfig:()=>normalizeConfig,parseServiceUrl:()=>parseServiceUrl,randId:()=>randId,toCamelCase:()=>toCamelCase,toSnakeCase:()=>toSnakeCase,typedArrayToDtype:()=>typedArrayToDtype,typedArrayToDtypeMapping:()=>typedArrayToDtypeMapping,urlJoin:()=>urlJoin,waitFor:()=>waitFor});const dtypeToTypedArray={int8:Int8Array,int16:Int16Array,int32:Int32Array,uint8:Uint8Array,uint16:Uint16Array,uint32:Uint32Array,float32:Float32Array,float64:Float64Array,array:Array};async function loadRequirementsInWindow(e){function t(e){return new Promise(((t,n)=>{var r=document.createElement("script");r.src=e,r.type="text/javascript",r.onload=t,r.onreadystatechange=function(){"loaded"!==this.readyState&&"complete"!==this.readyState||t()},r.onerror=n,document.head.appendChild(r)}))}async function n(){for(var e=Array.prototype.slice.call(arguments),n=e.length,r=0;r<n;r++)await t(e[r])}if(e&&(Array.isArray(e)||"string"==typeof e))try{var r;if(e="string"==typeof e?[e]:e,!Array.isArray(e))throw"unsupported requirements definition";for(var i=0;i<e.length;i++)e[i].toLowerCase().endsWith(".css")||e[i].startsWith("css:")?(e[i].startsWith("css:")&&(e[i]=e[i].slice(4)),(r=document.createElement("link")).rel="stylesheet",r.href=e[i],document.head.appendChild(r)):e[i].toLowerCase().endsWith(".mjs")||e[i].startsWith("mjs:")?(e[i].startsWith("mjs:")&&(e[i]=e[i].slice(4)),await import(e[i])):e[i].toLowerCase().endsWith(".js")||e[i].startsWith("js:")?(e[i].startsWith("js:")&&(e[i]=e[i].slice(3)),await n(e[i])):e[i].startsWith("http")?await n(e[i]):e[i].startsWith("cache:")||console.log("Unprocessed requirements url: "+e[i])}catch(t){throw"failed to import required scripts: "+e.toString()}}async function loadRequirementsInWebworker(e){if(e&&(Array.isArray(e)||"string"==typeof e))try{Array.isArray(e)||(e=[e]);for(var t=0;t<e.length;t++){if(e[t].toLowerCase().endsWith(".css")||e[t].startsWith("css:"))throw"unable to import css in a webworker";e[t].toLowerCase().endsWith(".js")||e[t].startsWith("js:")?(e[t].startsWith("js:")&&(e[t]=e[t].slice(3)),importScripts(e[t])):e[t].startsWith("http")?importScripts(e[t]):e[t].startsWith("cache:")||console.log("Unprocessed requirements url: "+e[t])}}catch(t){throw"failed to import required scripts: "+e.toString()}}function loadRequirements(e){return"undefined"!=typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope?loadRequirementsInWebworker(e):loadRequirementsInWindow(e)}function normalizeConfig(e){return e.version=e.version||"0.1.0",e.description=e.description||`[TODO: add description for ${e.name} ]`,e.type=e.type||"rpc-window",e.id=e.id||randId(),e.target_origin=e.target_origin||"*",e.allow_execution=e.allow_execution||!1,e=Object.keys(e).reduce(((t,n)=>("function"!=typeof e[n]&&(t[n]=e[n]),t)),{})}const typedArrayToDtypeMapping={Int8Array:"int8",Int16Array:"int16",Int32Array:"int32",Uint8Array:"uint8",Uint16Array:"uint16",Uint32Array:"uint32",Float32Array:"float32",Float64Array:"float64",Array:"array"},typedArrayToDtypeKeys=[];for(const arrType of Object.keys(typedArrayToDtypeMapping))typedArrayToDtypeKeys.push(eval(arrType));function typedArrayToDtype(e){let t=typedArrayToDtypeMapping[e.constructor.name];if(!t){const n=Object.getPrototypeOf(e);for(const e of typedArrayToDtypeKeys)if(n instanceof e){t=typedArrayToDtypeMapping[e.name];break}}return t}function cacheUrlInServiceWorker(e){return new Promise((function(t,n){const r={command:"add",url:e};if(!navigator.serviceWorker||!navigator.serviceWorker.register)return void n("Service worker is not supported.");const i=new MessageChannel;i.port1.onmessage=function(e){e.data&&e.data.error?n(e.data.error):t(e.data&&e.data.result)},navigator.serviceWorker&&navigator.serviceWorker.controller?navigator.serviceWorker.controller.postMessage(r,[i.port2]):n("Service worker controller is not available")}))}async function cacheRequirements(e){e=e||[],Array.isArray(e)||(e=[e]);for(let t of e)t.startsWith("js:")&&(t=t.slice(3)),t.startsWith("css:")&&(t=t.slice(4)),t.startsWith("cache:")&&(t=t.slice(6)),t.startsWith("http")&&await cacheUrlInServiceWorker(t).catch((e=>{console.error(e)}))}function assert(e,t){if(!e)throw new Error(t||"Assertion failed")}function urlJoin(...e){return e.join("/").replace(/[\/]+/g,"/").replace(/^(.+):\//,"$1://").replace(/^file:/,"file:/").replace(/\/(\?|&|#[^!])/g,"$1").replace(/\?/g,"&").replace("&","?")}function waitFor(e,t,n){let r;return Promise.race([e,new Promise(((e,i)=>r=setTimeout((()=>{i(n||"Timeout Error")}),1e3*t)))]).finally((()=>clearTimeout(r)))}class MessageEmitter{constructor(e){this._event_handlers={},this._once_handlers={},this._debug=e}emit(){throw new Error("emit is not implemented")}on(e,t){this._event_handlers[e]||(this._event_handlers[e]=[]),this._event_handlers[e].push(t)}once(e,t){t.___event_run_once=!0,this.on(e,t)}off(e,t){if(e||t){if(e&&!t)this._event_handlers[e]&&(this._event_handlers[e]=[]);else if(this._event_handlers[e]){const n=this._event_handlers[e].indexOf(t);n>=0&&this._event_handlers[e].splice(n,1)}}else this._event_handlers={}}_fire(e,t){if(this._event_handlers[e])for(var n=this._event_handlers[e].length;n--;){const r=this._event_handlers[e][n];try{r(t)}catch(e){console.error(e)}finally{r.___event_run_once&&this._event_handlers[e].splice(n,1)}}else this._debug&&console.warn("unhandled event",e,t)}waitFor(e,t){return new Promise(((n,r)=>{const i=e=>{clearTimeout(s),n(e)};this.once(e,i);const s=setTimeout((()=>{this.off(e,i),r(new Error("Timeout"))}),t)}))}}},"./src/utils/schema.js":(e,t,n)=>{n.r(t),n.d(t,{schemaFunction:()=>i});var r=n("./src/utils/index.js");function i(e,{schema_type:t="auto",name:n=null,description:i=null,parameters:s=null}){if(!e||"function"!=typeof e)throw Error("func should be a function");return(0,r.assert)("auto"===t,"schema_type should be auto"),(0,r.assert)(n,"name should not be null"),(0,r.assert)(s&&"object"===s.type,"parameters should be an object"),e.__schema__={name:n,description:i,parameters:s||[]},e}},"./src/webrtc-client.js":(e,t,n)=>{n.r(t),n.d(t,{getRTCService:()=>c,registerRTCService:()=>l});var r=n("./src/rpc.js"),i=n("./src/utils/index.js"),s=n("./src/utils/schema.js");class o{constructor(e){this._data_channel=e,this._handle_message=null,this._reconnection_token=null,this._handle_disconnected=null,this._handle_connected=()=>{},this.manager_id=null,this._data_channel.onopen=async()=>{this._handle_connected&&this._handle_connected({channel:this._data_channel})},this._data_channel.onmessage=async e=>{let t=e.data;t instanceof Blob&&(t=await t.arrayBuffer()),this._handle_message(t)};const t=this;this._data_channel.onclose=function(){this._handle_disconnected&&this._handle_disconnected("closed"),console.log("websocket closed"),t._data_channel=null}}on_disconnected(e){this._handle_disconnected=e}on_connected(e){this._handle_connected=e}on_message(e){(0,i.assert)(e,"handler is required"),this._handle_message=e}async emit_message(e){(0,i.assert)(this._handle_message,"No handler for message");try{this._data_channel.send(e)}catch(e){throw console.error(`Failed to send data, error: ${e}`),e}}async disconnect(e){this._data_channel=null,console.info(`data channel connection disconnected (${e})`)}}async function a(e){(0,i.assert)(e.channel,"No channel provided"),(0,i.assert)(e.workspace,"No workspace provided");const t=e.channel,n=e.client_id||(0,i.randId)(),s=new o(t);return e.context=e.context||{},e.context.connection_type="webrtc",new r.RPC(s,{client_id:n,default_context:e.context,name:e.name,method_timeout:e.method_timeout||10,workspace:e.workspace})}async function c(e,t,n){(n=n||{}).peer_id=n.peer_id||(0,i.randId)();const r=new RTCPeerConnection({iceServers:n.ice_servers||[{urls:["stun:stun.l.google.com:19302"]}],sdpSemantics:"unified-plan"});return new Promise((async(o,c)=>{try{r.addEventListener("connectionstatechange",(()=>{"failed"===r.connectionState?(r.close(),c(new Error("WebRTC Connection failed"))):"closed"===r.connectionState?c(new Error("WebRTC Connection closed")):console.log("WebRTC Connection state: ",r.connectionState)}),!1),n.on_init&&(await n.on_init(r),delete n.on_init);let l=r.createDataChannel(n.peer_id,{ordered:!0});l.binaryType="arraybuffer";const u=await r.createOffer();await r.setLocalDescription(u);const d=await e.getService(t),h=await d.offer({sdp:r.localDescription.sdp,type:r.localDescription.type});l.onopen=()=>{n.channel=l,n.workspace=h.workspace,setTimeout((async()=>{const e=await a(n);r.rpc=e,r.getService=(0,s.schemaFunction)((async function(t,...r){return(0,i.assert)(!t.includes(":"),"WebRTC service name should not contain ':'"),(0,i.assert)(!t.includes("/"),"WebRTC service name should not contain '/'"),await e.get_remote_service(n.workspace+"/"+n.peer_id+":"+t,...r)}),{name:"getService",description:"Get a remote service via webrtc",parameters:{type:"object",properties:{service_id:{type:"string",description:"Service ID. This should be a service id in the format: 'workspace/service_id', 'workspace/client_id:service_id' or 'workspace/client_id:service_id@app_id'"},config:{type:"object",description:"Options for the service"}},required:["id"]}}),r.disconnect=(0,s.schemaFunction)((async function(){await e.disconnect(),r.close()}),{name:"disconnect",description:"Disconnect from the webrtc connection via webrtc",parameters:{type:"object",properties:{}}}),r.registerCodec=(0,s.schemaFunction)(e.register_codec,{name:"registerCodec",description:"Register a codec for the webrtc connection",parameters:{type:"object",properties:{codec:{type:"object",description:"Codec to register",properties:{name:{type:"string"},type:{},encoder:{type:"function"},decoder:{type:"function"}}}}}}),o(r)}),500)},l.onclose=()=>c(new Error("Data channel closed")),await r.setRemoteDescription(new RTCSessionDescription({sdp:h.sdp,type:h.type}))}catch(e){c(e)}}))}async function l(e,t,n){const r=(n=n||{visibility:"protected",require_context:!0}).on_init;return delete n.on_init,await e.registerService({id:t,config:n,offer:(t,i)=>async function(e,t,n,r,i){n=n||{};let s=new RTCSessionDescription({sdp:e.sdp,type:e.type}),o=new RTCPeerConnection({iceServers:n.ice_servers||[{urls:["stun:stun.l.google.com:19302"]}],sdpSemantics:"unified-plan"});t&&o.addEventListener("datachannel",(async e=>{const n=e.channel;let r=null;i&&i.user&&(r={user:i.user,ws:i.ws}),(await a({channel:n,client_id:n.label,workspace:t.config.workspace,context:r}))._services=t.rpc._services})),r&&await r(o),await o.setRemoteDescription(s);let c=await o.createAnswer();return await o.setLocalDescription(c),{sdp:o.localDescription.sdp,type:o.localDescription.type,workspace:t.config.workspace}}(t,e,n,r,i)})}},"./node_modules/@msgpack/msgpack/dist.es5+esm/CachedKeyDecoder.mjs":(e,t,n)=>{n.r(t),n.d(t,{CachedKeyDecoder:()=>i});var r=n("./node_modules/@msgpack/msgpack/dist.es5+esm/utils/utf8.mjs"),i=function(){function e(e,t){void 0===e&&(e=16),void 0===t&&(t=16),this.maxKeyLength=e,this.maxLengthPerKey=t,this.hit=0,this.miss=0,this.caches=[];for(var n=0;n<this.maxKeyLength;n++)this.caches.push([])}return e.prototype.canBeCached=function(e){return e>0&&e<=this.maxKeyLength},e.prototype.find=function(e,t,n){e:for(var r=0,i=this.caches[n-1];r<i.length;r++){for(var s=i[r],o=s.bytes,a=0;a<n;a++)if(o[a]!==e[t+a])continue e;return s.str}return null},e.prototype.store=function(e,t){var n=this.caches[e.length-1],r={bytes:e,str:t};n.length>=this.maxLengthPerKey?n[Math.random()*n.length|0]=r:n.push(r)},e.prototype.decode=function(e,t,n){var i=this.find(e,t,n);if(null!=i)return this.hit++,i;this.miss++;var s=(0,r.utf8DecodeJs)(e,t,n),o=Uint8Array.prototype.slice.call(e,t,t+n);return this.store(o,s),s},e}()},"./node_modules/@msgpack/msgpack/dist.es5+esm/DecodeError.mjs":(e,t,n)=>{n.r(t),n.d(t,{DecodeError:()=>s});var r,i=(r=function(e,t){return r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])},r(e,t)},function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function n(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}),s=function(e){function t(n){var r=e.call(this,n)||this,i=Object.create(t.prototype);return Object.setPrototypeOf(r,i),Object.defineProperty(r,"name",{configurable:!0,enumerable:!1,value:t.name}),r}return i(t,e),t}(Error)},"./node_modules/@msgpack/msgpack/dist.es5+esm/Decoder.mjs":(e,t,n)=>{n.r(t),n.d(t,{DataViewIndexOutOfBoundsError:()=>_,Decoder:()=>g});var r=n("./node_modules/@msgpack/msgpack/dist.es5+esm/utils/prettyByte.mjs"),i=n("./node_modules/@msgpack/msgpack/dist.es5+esm/ExtensionCodec.mjs"),s=n("./node_modules/@msgpack/msgpack/dist.es5+esm/utils/int.mjs"),o=n("./node_modules/@msgpack/msgpack/dist.es5+esm/utils/utf8.mjs"),a=n("./node_modules/@msgpack/msgpack/dist.es5+esm/utils/typedArrays.mjs"),c=n("./node_modules/@msgpack/msgpack/dist.es5+esm/CachedKeyDecoder.mjs"),l=n("./node_modules/@msgpack/msgpack/dist.es5+esm/DecodeError.mjs"),u=function(e,t){var n,r,i,s,o={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return s={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function a(s){return function(a){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;o;)try{if(n=1,r&&(i=2&s[0]?r.return:s[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,s[1])).done)return i;switch(r=0,i&&(s=[2&s[0],i.value]),s[0]){case 0:case 1:i=s;break;case 4:return o.label++,{value:s[1],done:!1};case 5:o.label++,r=s[1],s=[0];continue;case 7:s=o.ops.pop(),o.trys.pop();continue;default:if(!((i=(i=o.trys).length>0&&i[i.length-1])||6!==s[0]&&2!==s[0])){o=0;continue}if(3===s[0]&&(!i||s[1]>i[0]&&s[1]<i[3])){o.label=s[1];break}if(6===s[0]&&o.label<i[1]){o.label=i[1],i=s;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(s);break}i[2]&&o.ops.pop(),o.trys.pop();continue}s=t.call(e,o)}catch(e){s=[6,e],r=0}finally{n=i=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,a])}}},d=function(e){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var t,n=e[Symbol.asyncIterator];return n?n.call(e):(e="function"==typeof __values?__values(e):e[Symbol.iterator](),t={},r("next"),r("throw"),r("return"),t[Symbol.asyncIterator]=function(){return this},t);function r(n){t[n]=e[n]&&function(t){return new Promise((function(r,i){!function(e,t,n,r){Promise.resolve(r).then((function(t){e({value:t,done:n})}),t)}(r,i,(t=e[n](t)).done,t.value)}))}}},h=function(e){return this instanceof h?(this.v=e,this):new h(e)},p=new DataView(new ArrayBuffer(0)),f=new Uint8Array(p.buffer),_=function(){try{p.getInt8(0)}catch(e){return e.constructor}throw new Error("never reached")}(),m=new _("Insufficient data"),y=new c.CachedKeyDecoder,g=function(){function e(e,t,n,r,o,a,c,l){void 0===e&&(e=i.ExtensionCodec.defaultCodec),void 0===t&&(t=void 0),void 0===n&&(n=s.UINT32_MAX),void 0===r&&(r=s.UINT32_MAX),void 0===o&&(o=s.UINT32_MAX),void 0===a&&(a=s.UINT32_MAX),void 0===c&&(c=s.UINT32_MAX),void 0===l&&(l=y),this.extensionCodec=e,this.context=t,this.maxStrLength=n,this.maxBinLength=r,this.maxArrayLength=o,this.maxMapLength=a,this.maxExtLength=c,this.keyDecoder=l,this.totalPos=0,this.pos=0,this.view=p,this.bytes=f,this.headByte=-1,this.stack=[]}return e.prototype.reinitializeState=function(){this.totalPos=0,this.headByte=-1,this.stack.length=0},e.prototype.setBuffer=function(e){this.bytes=(0,a.ensureUint8Array)(e),this.view=(0,a.createDataView)(this.bytes),this.pos=0},e.prototype.appendBuffer=function(e){if(-1!==this.headByte||this.hasRemaining(1)){var t=this.bytes.subarray(this.pos),n=(0,a.ensureUint8Array)(e),r=new Uint8Array(t.length+n.length);r.set(t),r.set(n,t.length),this.setBuffer(r)}else this.setBuffer(e)},e.prototype.hasRemaining=function(e){return this.view.byteLength-this.pos>=e},e.prototype.createExtraByteError=function(e){var t=this.view,n=this.pos;return new RangeError("Extra ".concat(t.byteLength-n," of ").concat(t.byteLength," byte(s) found at buffer[").concat(e,"]"))},e.prototype.decode=function(e){this.reinitializeState(),this.setBuffer(e);var t=this.doDecodeSync();if(this.hasRemaining(1))throw this.createExtraByteError(this.pos);return t},e.prototype.decodeMulti=function(e){return u(this,(function(t){switch(t.label){case 0:this.reinitializeState(),this.setBuffer(e),t.label=1;case 1:return this.hasRemaining(1)?[4,this.doDecodeSync()]:[3,3];case 2:return t.sent(),[3,1];case 3:return[2]}}))},e.prototype.decodeAsync=function(e){var t,n,i,s,o,a,c,l;return o=this,a=void 0,l=function(){var o,a,c,l,h,p,f,m;return u(this,(function(u){switch(u.label){case 0:o=!1,u.label=1;case 1:u.trys.push([1,6,7,12]),t=d(e),u.label=2;case 2:return[4,t.next()];case 3:if((n=u.sent()).done)return[3,5];if(c=n.value,o)throw this.createExtraByteError(this.totalPos);this.appendBuffer(c);try{a=this.doDecodeSync(),o=!0}catch(e){if(!(e instanceof _))throw e}this.totalPos+=this.pos,u.label=4;case 4:return[3,2];case 5:return[3,12];case 6:return l=u.sent(),i={error:l},[3,12];case 7:return u.trys.push([7,,10,11]),n&&!n.done&&(s=t.return)?[4,s.call(t)]:[3,9];case 8:u.sent(),u.label=9;case 9:return[3,11];case 10:if(i)throw i.error;return[7];case 11:return[7];case 12:if(o){if(this.hasRemaining(1))throw this.createExtraByteError(this.totalPos);return[2,a]}throw p=(h=this).headByte,f=h.pos,m=h.totalPos,new RangeError("Insufficient data in parsing ".concat((0,r.prettyByte)(p)," at ").concat(m," (").concat(f," in the current buffer)"))}}))},new((c=void 0)||(c=Promise))((function(e,t){function n(e){try{i(l.next(e))}catch(e){t(e)}}function r(e){try{i(l.throw(e))}catch(e){t(e)}}function i(t){var i;t.done?e(t.value):(i=t.value,i instanceof c?i:new c((function(e){e(i)}))).then(n,r)}i((l=l.apply(o,a||[])).next())}))},e.prototype.decodeArrayStream=function(e){return this.decodeMultiAsync(e,!0)},e.prototype.decodeStream=function(e){return this.decodeMultiAsync(e,!1)},e.prototype.decodeMultiAsync=function(e,t){return function(e,t,n){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var r,i=n.apply(e,t||[]),s=[];return r={},o("next"),o("throw"),o("return"),r[Symbol.asyncIterator]=function(){return this},r;function o(e){i[e]&&(r[e]=function(t){return new Promise((function(n,r){s.push([e,t,n,r])>1||a(e,t)}))})}function a(e,t){try{(n=i[e](t)).value instanceof h?Promise.resolve(n.value.v).then(c,l):u(s[0][2],n)}catch(e){u(s[0][3],e)}var n}function c(e){a("next",e)}function l(e){a("throw",e)}function u(e,t){e(t),s.shift(),s.length&&a(s[0][0],s[0][1])}}(this,arguments,(function(){var n,r,i,s,o,a,c,l,p;return u(this,(function(u){switch(u.label){case 0:n=t,r=-1,u.label=1;case 1:u.trys.push([1,13,14,19]),i=d(e),u.label=2;case 2:return[4,h(i.next())];case 3:if((s=u.sent()).done)return[3,12];if(o=s.value,t&&0===r)throw this.createExtraByteError(this.totalPos);this.appendBuffer(o),n&&(r=this.readArraySize(),n=!1,this.complete()),u.label=4;case 4:u.trys.push([4,9,,10]),u.label=5;case 5:return[4,h(this.doDecodeSync())];case 6:return[4,u.sent()];case 7:return u.sent(),0==--r?[3,8]:[3,5];case 8:return[3,10];case 9:if(!((a=u.sent())instanceof _))throw a;return[3,10];case 10:this.totalPos+=this.pos,u.label=11;case 11:return[3,2];case 12:return[3,19];case 13:return c=u.sent(),l={error:c},[3,19];case 14:return u.trys.push([14,,17,18]),s&&!s.done&&(p=i.return)?[4,h(p.call(i))]:[3,16];case 15:u.sent(),u.label=16;case 16:return[3,18];case 17:if(l)throw l.error;return[7];case 18:return[7];case 19:return[2]}}))}))},e.prototype.doDecodeSync=function(){e:for(;;){var e=this.readHeadByte(),t=void 0;if(e>=224)t=e-256;else if(e<192)if(e<128)t=e;else if(e<144){if(0!=(i=e-128)){this.pushMapState(i),this.complete();continue e}t={}}else if(e<160){if(0!=(i=e-144)){this.pushArrayState(i),this.complete();continue e}t=[]}else{var n=e-160;t=this.decodeUtf8String(n,0)}else if(192===e)t=null;else if(194===e)t=!1;else if(195===e)t=!0;else if(202===e)t=this.readF32();else if(203===e)t=this.readF64();else if(204===e)t=this.readU8();else if(205===e)t=this.readU16();else if(206===e)t=this.readU32();else if(207===e)t=this.readU64();else if(208===e)t=this.readI8();else if(209===e)t=this.readI16();else if(210===e)t=this.readI32();else if(211===e)t=this.readI64();else if(217===e)n=this.lookU8(),t=this.decodeUtf8String(n,1);else if(218===e)n=this.lookU16(),t=this.decodeUtf8String(n,2);else if(219===e)n=this.lookU32(),t=this.decodeUtf8String(n,4);else if(220===e){if(0!==(i=this.readU16())){this.pushArrayState(i),this.complete();continue e}t=[]}else if(221===e){if(0!==(i=this.readU32())){this.pushArrayState(i),this.complete();continue e}t=[]}else if(222===e){if(0!==(i=this.readU16())){this.pushMapState(i),this.complete();continue e}t={}}else if(223===e){if(0!==(i=this.readU32())){this.pushMapState(i),this.complete();continue e}t={}}else if(196===e){var i=this.lookU8();t=this.decodeBinary(i,1)}else if(197===e)i=this.lookU16(),t=this.decodeBinary(i,2);else if(198===e)i=this.lookU32(),t=this.decodeBinary(i,4);else if(212===e)t=this.decodeExtension(1,0);else if(213===e)t=this.decodeExtension(2,0);else if(214===e)t=this.decodeExtension(4,0);else if(215===e)t=this.decodeExtension(8,0);else if(216===e)t=this.decodeExtension(16,0);else if(199===e)i=this.lookU8(),t=this.decodeExtension(i,1);else if(200===e)i=this.lookU16(),t=this.decodeExtension(i,2);else{if(201!==e)throw new l.DecodeError("Unrecognized type byte: ".concat((0,r.prettyByte)(e)));i=this.lookU32(),t=this.decodeExtension(i,4)}this.complete();for(var s=this.stack;s.length>0;){var o=s[s.length-1];if(0===o.type){if(o.array[o.position]=t,o.position++,o.position!==o.size)continue e;s.pop(),t=o.array}else{if(1===o.type){if(void 0,"string"!=(a=typeof t)&&"number"!==a)throw new l.DecodeError("The type of key must be string or number but "+typeof t);if("__proto__"===t)throw new l.DecodeError("The key __proto__ is not allowed");o.key=t,o.type=2;continue e}if(o.map[o.key]=t,o.readCount++,o.readCount!==o.size){o.key=null,o.type=1;continue e}s.pop(),t=o.map}}return t}var a},e.prototype.readHeadByte=function(){return-1===this.headByte&&(this.headByte=this.readU8()),this.headByte},e.prototype.complete=function(){this.headByte=-1},e.prototype.readArraySize=function(){var e=this.readHeadByte();switch(e){case 220:return this.readU16();case 221:return this.readU32();default:if(e<160)return e-144;throw new l.DecodeError("Unrecognized array type byte: ".concat((0,r.prettyByte)(e)))}},e.prototype.pushMapState=function(e){if(e>this.maxMapLength)throw new l.DecodeError("Max length exceeded: map length (".concat(e,") > maxMapLengthLength (").concat(this.maxMapLength,")"));this.stack.push({type:1,size:e,key:null,readCount:0,map:{}})},e.prototype.pushArrayState=function(e){if(e>this.maxArrayLength)throw new l.DecodeError("Max length exceeded: array length (".concat(e,") > maxArrayLength (").concat(this.maxArrayLength,")"));this.stack.push({type:0,size:e,array:new Array(e),position:0})},e.prototype.decodeUtf8String=function(e,t){var n;if(e>this.maxStrLength)throw new l.DecodeError("Max length exceeded: UTF-8 byte length (".concat(e,") > maxStrLength (").concat(this.maxStrLength,")"));if(this.bytes.byteLength<this.pos+t+e)throw m;var r,i=this.pos+t;return r=this.stateIsMapKey()&&(null===(n=this.keyDecoder)||void 0===n?void 0:n.canBeCached(e))?this.keyDecoder.decode(this.bytes,i,e):e>o.TEXT_DECODER_THRESHOLD?(0,o.utf8DecodeTD)(this.bytes,i,e):(0,o.utf8DecodeJs)(this.bytes,i,e),this.pos+=t+e,r},e.prototype.stateIsMapKey=function(){return this.stack.length>0&&1===this.stack[this.stack.length-1].type},e.prototype.decodeBinary=function(e,t){if(e>this.maxBinLength)throw new l.DecodeError("Max length exceeded: bin length (".concat(e,") > maxBinLength (").concat(this.maxBinLength,")"));if(!this.hasRemaining(e+t))throw m;var n=this.pos+t,r=this.bytes.subarray(n,n+e);return this.pos+=t+e,r},e.prototype.decodeExtension=function(e,t){if(e>this.maxExtLength)throw new l.DecodeError("Max length exceeded: ext length (".concat(e,") > maxExtLength (").concat(this.maxExtLength,")"));var n=this.view.getInt8(this.pos+t),r=this.decodeBinary(e,t+1);return this.extensionCodec.decode(r,n,this.context)},e.prototype.lookU8=function(){return this.view.getUint8(this.pos)},e.prototype.lookU16=function(){return this.view.getUint16(this.pos)},e.prototype.lookU32=function(){return this.view.getUint32(this.pos)},e.prototype.readU8=function(){var e=this.view.getUint8(this.pos);return this.pos++,e},e.prototype.readI8=function(){var e=this.view.getInt8(this.pos);return this.pos++,e},e.prototype.readU16=function(){var e=this.view.getUint16(this.pos);return this.pos+=2,e},e.prototype.readI16=function(){var e=this.view.getInt16(this.pos);return this.pos+=2,e},e.prototype.readU32=function(){var e=this.view.getUint32(this.pos);return this.pos+=4,e},e.prototype.readI32=function(){var e=this.view.getInt32(this.pos);return this.pos+=4,e},e.prototype.readU64=function(){var e=(0,s.getUint64)(this.view,this.pos);return this.pos+=8,e},e.prototype.readI64=function(){var e=(0,s.getInt64)(this.view,this.pos);return this.pos+=8,e},e.prototype.readF32=function(){var e=this.view.getFloat32(this.pos);return this.pos+=4,e},e.prototype.readF64=function(){var e=this.view.getFloat64(this.pos);return this.pos+=8,e},e}()},"./node_modules/@msgpack/msgpack/dist.es5+esm/Encoder.mjs":(e,t,n)=>{n.r(t),n.d(t,{DEFAULT_INITIAL_BUFFER_SIZE:()=>c,DEFAULT_MAX_DEPTH:()=>a,Encoder:()=>l});var r=n("./node_modules/@msgpack/msgpack/dist.es5+esm/utils/utf8.mjs"),i=n("./node_modules/@msgpack/msgpack/dist.es5+esm/ExtensionCodec.mjs"),s=n("./node_modules/@msgpack/msgpack/dist.es5+esm/utils/int.mjs"),o=n("./node_modules/@msgpack/msgpack/dist.es5+esm/utils/typedArrays.mjs"),a=100,c=2048,l=function(){function e(e,t,n,r,s,o,l,u){void 0===e&&(e=i.ExtensionCodec.defaultCodec),void 0===t&&(t=void 0),void 0===n&&(n=a),void 0===r&&(r=c),void 0===s&&(s=!1),void 0===o&&(o=!1),void 0===l&&(l=!1),void 0===u&&(u=!1),this.extensionCodec=e,this.context=t,this.maxDepth=n,this.initialBufferSize=r,this.sortKeys=s,this.forceFloat32=o,this.ignoreUndefined=l,this.forceIntegerToFloat=u,this.pos=0,this.view=new DataView(new ArrayBuffer(this.initialBufferSize)),this.bytes=new Uint8Array(this.view.buffer)}return e.prototype.reinitializeState=function(){this.pos=0},e.prototype.encodeSharedRef=function(e){return this.reinitializeState(),this.doEncode(e,1),this.bytes.subarray(0,this.pos)},e.prototype.encode=function(e){return this.reinitializeState(),this.doEncode(e,1),this.bytes.slice(0,this.pos)},e.prototype.doEncode=function(e,t){if(t>this.maxDepth)throw new Error("Too deep objects in depth ".concat(t));null==e?this.encodeNil():"boolean"==typeof e?this.encodeBoolean(e):"number"==typeof e?this.encodeNumber(e):"string"==typeof e?this.encodeString(e):this.encodeObject(e,t)},e.prototype.ensureBufferSizeToWrite=function(e){var t=this.pos+e;this.view.byteLength<t&&this.resizeBuffer(2*t)},e.prototype.resizeBuffer=function(e){var t=new ArrayBuffer(e),n=new Uint8Array(t),r=new DataView(t);n.set(this.bytes),this.view=r,this.bytes=n},e.prototype.encodeNil=function(){this.writeU8(192)},e.prototype.encodeBoolean=function(e){!1===e?this.writeU8(194):this.writeU8(195)},e.prototype.encodeNumber=function(e){Number.isSafeInteger(e)&&!this.forceIntegerToFloat?e>=0?e<128?this.writeU8(e):e<256?(this.writeU8(204),this.writeU8(e)):e<65536?(this.writeU8(205),this.writeU16(e)):e<4294967296?(this.writeU8(206),this.writeU32(e)):(this.writeU8(207),this.writeU64(e)):e>=-32?this.writeU8(224|e+32):e>=-128?(this.writeU8(208),this.writeI8(e)):e>=-32768?(this.writeU8(209),this.writeI16(e)):e>=-2147483648?(this.writeU8(210),this.writeI32(e)):(this.writeU8(211),this.writeI64(e)):this.forceFloat32?(this.writeU8(202),this.writeF32(e)):(this.writeU8(203),this.writeF64(e))},e.prototype.writeStringHeader=function(e){if(e<32)this.writeU8(160+e);else if(e<256)this.writeU8(217),this.writeU8(e);else if(e<65536)this.writeU8(218),this.writeU16(e);else{if(!(e<4294967296))throw new Error("Too long string: ".concat(e," bytes in UTF-8"));this.writeU8(219),this.writeU32(e)}},e.prototype.encodeString=function(e){if(e.length>r.TEXT_ENCODER_THRESHOLD){var t=(0,r.utf8Count)(e);this.ensureBufferSizeToWrite(5+t),this.writeStringHeader(t),(0,r.utf8EncodeTE)(e,this.bytes,this.pos),this.pos+=t}else t=(0,r.utf8Count)(e),this.ensureBufferSizeToWrite(5+t),this.writeStringHeader(t),(0,r.utf8EncodeJs)(e,this.bytes,this.pos),this.pos+=t},e.prototype.encodeObject=function(e,t){var n=this.extensionCodec.tryToEncode(e,this.context);if(null!=n)this.encodeExtension(n);else if(Array.isArray(e))this.encodeArray(e,t);else if(ArrayBuffer.isView(e))this.encodeBinary(e);else{if("object"!=typeof e)throw new Error("Unrecognized object: ".concat(Object.prototype.toString.apply(e)));this.encodeMap(e,t)}},e.prototype.encodeBinary=function(e){var t=e.byteLength;if(t<256)this.writeU8(196),this.writeU8(t);else if(t<65536)this.writeU8(197),this.writeU16(t);else{if(!(t<4294967296))throw new Error("Too large binary: ".concat(t));this.writeU8(198),this.writeU32(t)}var n=(0,o.ensureUint8Array)(e);this.writeU8a(n)},e.prototype.encodeArray=function(e,t){var n=e.length;if(n<16)this.writeU8(144+n);else if(n<65536)this.writeU8(220),this.writeU16(n);else{if(!(n<4294967296))throw new Error("Too large array: ".concat(n));this.writeU8(221),this.writeU32(n)}for(var r=0,i=e;r<i.length;r++){var s=i[r];this.doEncode(s,t+1)}},e.prototype.countWithoutUndefined=function(e,t){for(var n=0,r=0,i=t;r<i.length;r++)void 0!==e[i[r]]&&n++;return n},e.prototype.encodeMap=function(e,t){var n=Object.keys(e);this.sortKeys&&n.sort();var r=this.ignoreUndefined?this.countWithoutUndefined(e,n):n.length;if(r<16)this.writeU8(128+r);else if(r<65536)this.writeU8(222),this.writeU16(r);else{if(!(r<4294967296))throw new Error("Too large map object: ".concat(r));this.writeU8(223),this.writeU32(r)}for(var i=0,s=n;i<s.length;i++){var o=s[i],a=e[o];this.ignoreUndefined&&void 0===a||(this.encodeString(o),this.doEncode(a,t+1))}},e.prototype.encodeExtension=function(e){var t=e.data.length;if(1===t)this.writeU8(212);else if(2===t)this.writeU8(213);else if(4===t)this.writeU8(214);else if(8===t)this.writeU8(215);else if(16===t)this.writeU8(216);else if(t<256)this.writeU8(199),this.writeU8(t);else if(t<65536)this.writeU8(200),this.writeU16(t);else{if(!(t<4294967296))throw new Error("Too large extension object: ".concat(t));this.writeU8(201),this.writeU32(t)}this.writeI8(e.type),this.writeU8a(e.data)},e.prototype.writeU8=function(e){this.ensureBufferSizeToWrite(1),this.view.setUint8(this.pos,e),this.pos++},e.prototype.writeU8a=function(e){var t=e.length;this.ensureBufferSizeToWrite(t),this.bytes.set(e,this.pos),this.pos+=t},e.prototype.writeI8=function(e){this.ensureBufferSizeToWrite(1),this.view.setInt8(this.pos,e),this.pos++},e.prototype.writeU16=function(e){this.ensureBufferSizeToWrite(2),this.view.setUint16(this.pos,e),this.pos+=2},e.prototype.writeI16=function(e){this.ensureBufferSizeToWrite(2),this.view.setInt16(this.pos,e),this.pos+=2},e.prototype.writeU32=function(e){this.ensureBufferSizeToWrite(4),this.view.setUint32(this.pos,e),this.pos+=4},e.prototype.writeI32=function(e){this.ensureBufferSizeToWrite(4),this.view.setInt32(this.pos,e),this.pos+=4},e.prototype.writeF32=function(e){this.ensureBufferSizeToWrite(4),this.view.setFloat32(this.pos,e),this.pos+=4},e.prototype.writeF64=function(e){this.ensureBufferSizeToWrite(8),this.view.setFloat64(this.pos,e),this.pos+=8},e.prototype.writeU64=function(e){this.ensureBufferSizeToWrite(8),(0,s.setUint64)(this.view,this.pos,e),this.pos+=8},e.prototype.writeI64=function(e){this.ensureBufferSizeToWrite(8),(0,s.setInt64)(this.view,this.pos,e),this.pos+=8},e}()},"./node_modules/@msgpack/msgpack/dist.es5+esm/ExtData.mjs":(e,t,n)=>{n.r(t),n.d(t,{ExtData:()=>r});var r=function(e,t){this.type=e,this.data=t}},"./node_modules/@msgpack/msgpack/dist.es5+esm/ExtensionCodec.mjs":(e,t,n)=>{n.r(t),n.d(t,{ExtensionCodec:()=>s});var r=n("./node_modules/@msgpack/msgpack/dist.es5+esm/ExtData.mjs"),i=n("./node_modules/@msgpack/msgpack/dist.es5+esm/timestamp.mjs"),s=function(){function e(){this.builtInEncoders=[],this.builtInDecoders=[],this.encoders=[],this.decoders=[],this.register(i.timestampExtension)}return e.prototype.register=function(e){var t=e.type,n=e.encode,r=e.decode;if(t>=0)this.encoders[t]=n,this.decoders[t]=r;else{var i=1+t;this.builtInEncoders[i]=n,this.builtInDecoders[i]=r}},e.prototype.tryToEncode=function(e,t){for(var n=0;n<this.builtInEncoders.length;n++)if(null!=(s=this.builtInEncoders[n])&&null!=(o=s(e,t))){var i=-1-n;return new r.ExtData(i,o)}for(n=0;n<this.encoders.length;n++){var s,o;if(null!=(s=this.encoders[n])&&null!=(o=s(e,t)))return i=n,new r.ExtData(i,o)}return e instanceof r.ExtData?e:null},e.prototype.decode=function(e,t,n){var i=t<0?this.builtInDecoders[-1-t]:this.decoders[t];return i?i(e,t,n):new r.ExtData(t,e)},e.defaultCodec=new e,e}()},"./node_modules/@msgpack/msgpack/dist.es5+esm/decode.mjs":(e,t,n)=>{n.r(t),n.d(t,{decode:()=>s,decodeMulti:()=>o,defaultDecodeOptions:()=>i});var r=n("./node_modules/@msgpack/msgpack/dist.es5+esm/Decoder.mjs"),i={};function s(e,t){return void 0===t&&(t=i),new r.Decoder(t.extensionCodec,t.context,t.maxStrLength,t.maxBinLength,t.maxArrayLength,t.maxMapLength,t.maxExtLength).decode(e)}function o(e,t){return void 0===t&&(t=i),new r.Decoder(t.extensionCodec,t.context,t.maxStrLength,t.maxBinLength,t.maxArrayLength,t.maxMapLength,t.maxExtLength).decodeMulti(e)}},"./node_modules/@msgpack/msgpack/dist.es5+esm/encode.mjs":(e,t,n)=>{n.r(t),n.d(t,{encode:()=>s});var r=n("./node_modules/@msgpack/msgpack/dist.es5+esm/Encoder.mjs"),i={};function s(e,t){return void 0===t&&(t=i),new r.Encoder(t.extensionCodec,t.context,t.maxDepth,t.initialBufferSize,t.sortKeys,t.forceFloat32,t.ignoreUndefined,t.forceIntegerToFloat).encodeSharedRef(e)}},"./node_modules/@msgpack/msgpack/dist.es5+esm/timestamp.mjs":(e,t,n)=>{n.r(t),n.d(t,{EXT_TIMESTAMP:()=>s,decodeTimestampExtension:()=>h,decodeTimestampToTimeSpec:()=>d,encodeDateToTimeSpec:()=>l,encodeTimeSpecToTimestamp:()=>c,encodeTimestampExtension:()=>u,timestampExtension:()=>p});var r=n("./node_modules/@msgpack/msgpack/dist.es5+esm/DecodeError.mjs"),i=n("./node_modules/@msgpack/msgpack/dist.es5+esm/utils/int.mjs"),s=-1,o=4294967295,a=17179869183;function c(e){var t,n=e.sec,r=e.nsec;if(n>=0&&r>=0&&n<=a){if(0===r&&n<=o){var s=new Uint8Array(4);return(t=new DataView(s.buffer)).setUint32(0,n),s}var c=n/4294967296,l=4294967295&n;return s=new Uint8Array(8),(t=new DataView(s.buffer)).setUint32(0,r<<2|3&c),t.setUint32(4,l),s}return s=new Uint8Array(12),(t=new DataView(s.buffer)).setUint32(0,r),(0,i.setInt64)(t,4,n),s}function l(e){var t=e.getTime(),n=Math.floor(t/1e3),r=1e6*(t-1e3*n),i=Math.floor(r/1e9);return{sec:n+i,nsec:r-1e9*i}}function u(e){return e instanceof Date?c(l(e)):null}function d(e){var t=new DataView(e.buffer,e.byteOffset,e.byteLength);switch(e.byteLength){case 4:return{sec:t.getUint32(0),nsec:0};case 8:var n=t.getUint32(0);return{sec:4294967296*(3&n)+t.getUint32(4),nsec:n>>>2};case 12:return{sec:(0,i.getInt64)(t,4),nsec:t.getUint32(0)};default:throw new r.DecodeError("Unrecognized data size for timestamp (expected 4, 8, or 12): ".concat(e.length))}}function h(e){var t=d(e);return new Date(1e3*t.sec+t.nsec/1e6)}var p={type:s,encode:u,decode:h}},"./node_modules/@msgpack/msgpack/dist.es5+esm/utils/int.mjs":(e,t,n)=>{n.r(t),n.d(t,{UINT32_MAX:()=>r,getInt64:()=>o,getUint64:()=>a,setInt64:()=>s,setUint64:()=>i});var r=4294967295;function i(e,t,n){var r=n/4294967296,i=n;e.setUint32(t,r),e.setUint32(t+4,i)}function s(e,t,n){var r=Math.floor(n/4294967296),i=n;e.setUint32(t,r),e.setUint32(t+4,i)}function o(e,t){return 4294967296*e.getInt32(t)+e.getUint32(t+4)}function a(e,t){return 4294967296*e.getUint32(t)+e.getUint32(t+4)}},"./node_modules/@msgpack/msgpack/dist.es5+esm/utils/prettyByte.mjs":(e,t,n)=>{function r(e){return"".concat(e<0?"-":"","0x").concat(Math.abs(e).toString(16).padStart(2,"0"))}n.r(t),n.d(t,{prettyByte:()=>r})},"./node_modules/@msgpack/msgpack/dist.es5+esm/utils/typedArrays.mjs":(e,t,n)=>{function r(e){return e instanceof Uint8Array?e:ArrayBuffer.isView(e)?new Uint8Array(e.buffer,e.byteOffset,e.byteLength):e instanceof ArrayBuffer?new Uint8Array(e):Uint8Array.from(e)}function i(e){if(e instanceof ArrayBuffer)return new DataView(e);var t=r(e);return new DataView(t.buffer,t.byteOffset,t.byteLength)}n.r(t),n.d(t,{createDataView:()=>i,ensureUint8Array:()=>r})},"./node_modules/@msgpack/msgpack/dist.es5+esm/utils/utf8.mjs":(e,t,n)=>{n.r(t),n.d(t,{TEXT_DECODER_THRESHOLD:()=>m,TEXT_ENCODER_THRESHOLD:()=>d,utf8Count:()=>c,utf8DecodeJs:()=>f,utf8DecodeTD:()=>y,utf8EncodeJs:()=>l,utf8EncodeTE:()=>h});var r,i,s,o=n("./node_modules/@msgpack/msgpack/dist.es5+esm/utils/int.mjs"),a=("undefined"==typeof process||"never"!==(null===(r=null===process||void 0===process?void 0:process.env)||void 0===r?void 0:r.TEXT_ENCODING))&&"undefined"!=typeof TextEncoder&&"undefined"!=typeof TextDecoder;function c(e){for(var t=e.length,n=0,r=0;r<t;){var i=e.charCodeAt(r++);if(4294967168&i)if(4294965248&i){if(i>=55296&&i<=56319&&r<t){var s=e.charCodeAt(r);56320==(64512&s)&&(++r,i=((1023&i)<<10)+(1023&s)+65536)}n+=4294901760&i?4:3}else n+=2;else n++}return n}function l(e,t,n){for(var r=e.length,i=n,s=0;s<r;){var o=e.charCodeAt(s++);if(4294967168&o){if(4294965248&o){if(o>=55296&&o<=56319&&s<r){var a=e.charCodeAt(s);56320==(64512&a)&&(++s,o=((1023&o)<<10)+(1023&a)+65536)}4294901760&o?(t[i++]=o>>18&7|240,t[i++]=o>>12&63|128,t[i++]=o>>6&63|128):(t[i++]=o>>12&15|224,t[i++]=o>>6&63|128)}else t[i++]=o>>6&31|192;t[i++]=63&o|128}else t[i++]=o}}var u=a?new TextEncoder:void 0,d=a?"undefined"!=typeof process&&"force"!==(null===(i=null===process||void 0===process?void 0:process.env)||void 0===i?void 0:i.TEXT_ENCODING)?200:0:o.UINT32_MAX,h=(null==u?void 0:u.encodeInto)?function(e,t,n){u.encodeInto(e,t.subarray(n))}:function(e,t,n){t.set(u.encode(e),n)},p=4096;function f(e,t,n){for(var r=t,i=r+n,s=[],o="";r<i;){var a=e[r++];if(128&a)if(192==(224&a)){var c=63&e[r++];s.push((31&a)<<6|c)}else if(224==(240&a)){c=63&e[r++];var l=63&e[r++];s.push((31&a)<<12|c<<6|l)}else if(240==(248&a)){var u=(7&a)<<18|(c=63&e[r++])<<12|(l=63&e[r++])<<6|63&e[r++];u>65535&&(u-=65536,s.push(u>>>10&1023|55296),u=56320|1023&u),s.push(u)}else s.push(a);else s.push(a);s.length>=p&&(o+=String.fromCharCode.apply(String,s),s.length=0)}return s.length>0&&(o+=String.fromCharCode.apply(String,s)),o}var _=a?new TextDecoder:null,m=a?"undefined"!=typeof process&&"force"!==(null===(s=null===process||void 0===process?void 0:process.env)||void 0===s?void 0:s.TEXT_DECODER)?200:0:o.UINT32_MAX;function y(e,t,n){var r=e.subarray(t,t+n);return _.decode(r)}}},__webpack_module_cache__={};function __nested_webpack_require_160612__(e){var t=__webpack_module_cache__[e];if(void 0!==t)return t.exports;var n=__webpack_module_cache__[e]={exports:{}};return __webpack_modules__[e](n,n.exports,__nested_webpack_require_160612__),n.exports}__nested_webpack_require_160612__.d=(e,t)=>{for(var n in t)__nested_webpack_require_160612__.o(t,n)&&!__nested_webpack_require_160612__.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},__nested_webpack_require_160612__.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),__nested_webpack_require_160612__.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var __nested_webpack_exports__={};__nested_webpack_require_160612__.r(__nested_webpack_exports__),__nested_webpack_require_160612__.d(__nested_webpack_exports__,{API_VERSION:()=>_rpc_js__WEBPACK_IMPORTED_MODULE_0__.API_VERSION,LocalWebSocket:()=>LocalWebSocket,RPC:()=>_rpc_js__WEBPACK_IMPORTED_MODULE_0__.RPC,connectToServer:()=>connectToServer,getRTCService:()=>_webrtc_client_js__WEBPACK_IMPORTED_MODULE_3__.getRTCService,getRemoteService:()=>getRemoteService,loadRequirements:()=>_utils__WEBPACK_IMPORTED_MODULE_1__.loadRequirements,login:()=>login,registerRTCService:()=>_webrtc_client_js__WEBPACK_IMPORTED_MODULE_3__.registerRTCService,schemaFunction:()=>_utils_schema_js__WEBPACK_IMPORTED_MODULE_2__.schemaFunction,setupLocalClient:()=>setupLocalClient});var _rpc_js__WEBPACK_IMPORTED_MODULE_0__=__nested_webpack_require_160612__("./src/rpc.js"),_utils__WEBPACK_IMPORTED_MODULE_1__=__nested_webpack_require_160612__("./src/utils/index.js"),_utils_schema_js__WEBPACK_IMPORTED_MODULE_2__=__nested_webpack_require_160612__("./src/utils/schema.js"),_webrtc_client_js__WEBPACK_IMPORTED_MODULE_3__=__nested_webpack_require_160612__("./src/webrtc-client.js");const MAX_RETRY=1e6;class WebsocketRPCConnection{constructor(e,t,n,r,i=null,s=60,o=null){(0,_utils__WEBPACK_IMPORTED_MODULE_1__.assert)(e&&t,"server_url and client_id are required"),this._server_url=e,this._client_id=t,this._workspace=n,this._token=r,this._reconnection_token=i,this._websocket=null,this._handle_message=null,this._handle_connected=null,this._handle_disconnected=null,this._timeout=s,this._WebSocketClass=o||WebSocket,this._closed=!1,this._legacy_auth=null,this.connection_info=null,this._enable_reconnect=!1,this.manager_id=null}on_message(e){(0,_utils__WEBPACK_IMPORTED_MODULE_1__.assert)(e,"handler is required"),this._handle_message=e}on_connected(e){this._handle_connected=e}on_disconnected(e){this._handle_disconnected=e}async _attempt_connection(e,t=!0){return new Promise(((n,r)=>{this._legacy_auth=!1;const i=new this._WebSocketClass(e);i.binaryType="arraybuffer",i.onopen=()=>{console.info("WebSocket connection established"),n(i)},i.onerror=e=>{console.error("WebSocket connection error:",e),r(new Error(`WebSocket connection error: ${e}`))},i.onclose=i=>{1003===i.code&&t?(console.info("Received 1003 error, attempting connection with query parameters."),this._legacy_auth=!0,this._attempt_connection_with_query_params(e).then(n).catch(r)):this._handle_disconnected&&this._handle_disconnected(i.reason)}}))}async _attempt_connection_with_query_params(e){const t=[];this._client_id&&t.push(`client_id=${encodeURIComponent(this._client_id)}`),this._workspace&&t.push(`workspace=${encodeURIComponent(this._workspace)}`),this._token&&t.push(`token=${encodeURIComponent(this._token)}`),this._reconnection_token&&t.push(`reconnection_token=${encodeURIComponent(this._reconnection_token)}`);const n=e+(t.length>0?`?${t.join("&")}`:"");return await this._attempt_connection(n,!1)}_establish_connection(){return new Promise(((e,t)=>{this._websocket.onmessage=n=>{const r=n.data,i=JSON.parse(r);if("connection_info"!=i.type){if("error"==i.type){const e="ConnectionAbortedError: "+i.message;return console.error("Failed to connect, "+e),void t(new Error(e))}return console.error("ConnectionAbortedError: Unexpected message received from the server:",r),void t(new Error("ConnectionAbortedError: Unexpected message received from the server"))}this.connection_info=i,this._workspace&&(0,_utils__WEBPACK_IMPORTED_MODULE_1__.assert)(this.connection_info.workspace===this._workspace,`Connected to the wrong workspace: ${this.connection_info.workspace}, expected: ${this._workspace}`),this.connection_info.reconnection_token&&(this._reconnection_token=this.connection_info.reconnection_token),this.manager_id=this.connection_info.manager_id||null,console.log(`Successfully connected to the server, workspace: ${this.connection_info.workspace}, manager_id: ${this.manager_id}`),this.connection_info.announcement&&console.log(`${this.connection_info.announcement}`),e(this.connection_info)}}))}async open(){console.log("Creating a new websocket connection to",this._server_url.split("?")[0]);try{if(this._websocket=await this._attempt_connection(this._server_url),this._legacy_auth)throw new Error("NotImplementedError: Legacy authentication is not supported");const e=JSON.stringify({client_id:this._client_id,workspace:this._workspace,token:this._token,reconnection_token:this._reconnection_token});return this._websocket.send(e),await(0,_utils__WEBPACK_IMPORTED_MODULE_1__.waitFor)(this._establish_connection(),this._timeout,"Failed to receive the first message from the server"),this._enable_reconnect=!0,this._closed=!1,this._websocket.onmessage=e=>{this._handle_message(e.data)},this._websocket.onerror=e=>{console.error("WebSocket connection error:",e)},this._websocket.onclose=this._handle_close.bind(this),this._handle_connected&&this._handle_connected(this.connection_info),this.connection_info}catch(e){throw console.error("Failed to connect to",this._server_url.split("?")[0],e),e}}_handle_close(e){if(!this._closed&&this._websocket&&this._websocket.readyState===WebSocket.CLOSED){if([1e3,1001].includes(e.code))console.info(`Websocket connection closed (code: ${e.code}): ${e.reason}`),this._handle_disconnected&&this._handle_disconnected(e.reason),this._closed=!0;else if(this._enable_reconnect){console.warn("Websocket connection closed unexpectedly (code: %s): %s",e.code,e.reason);let t=0;const n=async()=>{try{console.warn(`Reconnecting to ${this._server_url.split("?")[0]} (attempt #${t})`),await this.open(),console.warn(`Successfully reconnected to server ${this._server_url}`)}catch(e){if(`${e}`.includes("ConnectionAbortedError:"))return void console.warn("Failed to reconnect, connection aborted:",e);if(`${e}`.includes("NotImplementedError:"))return void console.error(`${e}\nIt appears that you are trying to connect to a hypha server that is older than 0.20.0, please upgrade the hypha server or use the websocket client in imjoy-rpc(https://www.npmjs.com/package/imjoy-rpc) instead`);if(await new Promise((e=>setTimeout(e,1e3))),this._websocket&&this._websocket.readyState===WebSocket.CONNECTED)return;t+=1,t<MAX_RETRY?await n():console.error("Failed to reconnect after",MAX_RETRY,"attempts")}};n()}}else this._handle_disconnected&&this._handle_disconnected(e.reason)}async emit_message(e){if(this._closed)throw new Error("Connection is closed");this._websocket&&this._websocket.readyState===WebSocket.OPEN||await this.open();try{this._websocket.send(e)}catch(e){throw console.error(`Failed to send data, error: ${e}`),e}}disconnect(e){this._closed=!0,this._websocket&&this._websocket.readyState===WebSocket.OPEN&&this._websocket.close(1e3,e),console.info(`WebSocket connection disconnected (${e})`)}}function normalizeServerUrl(e){if(!e)throw new Error("server_url is required");return e.startsWith("http://")?e=e.replace("http://","ws://").replace(/\/$/,"")+"/ws":e.startsWith("https://")&&(e=e.replace("https://","wss://").replace(/\/$/,"")+"/ws"),e}async function login(e){const t=e.login_service_id||"public/hypha-login",n=e.login_timeout||60,r=e.login_callback,i=e.profile,s=await connectToServer({name:"initial login client",server_url:e.server_url});try{const e=await s.getService(t);(0,_utils__WEBPACK_IMPORTED_MODULE_1__.assert)(e,`Failed to get the login service: ${t}`);const o=await e.start();return r?await r(o):console.log(`Please open your browser and login at ${o.login_url}`),await e.check(o.key,n,i)}catch(e){throw e}finally{await s.disconnect()}}async function webrtcGetService(e,t,n,r){const i=(r=r||{}).webrtc,s=r.webrtc_config;void 0!==r.webrtc&&delete r.webrtc,void 0!==r.webrtc_config&&delete r.webrtc_config,(0,_utils__WEBPACK_IMPORTED_MODULE_1__.assert)([void 0,!0,!1,"auto"].includes(i),"webrtc must be true, false or 'auto'");const o=await e.getService(n,r);if(!0===i||"auto"===i){if(o.id.includes(":")&&o.id.includes("/"))try{const n=await(0,_webrtc_client_js__WEBPACK_IMPORTED_MODULE_3__.getRTCService)(e,t,s),i=await n.getService(o.id.split(":")[1],r);return i._webrtc=!0,i._peer=n,i._service=o,i}catch(e){console.warn("Failed to get webrtc service, using websocket connection",e)}if(!0===i)throw new Error("Failed to get the service via webrtc")}return o}async function connectToServer(e){e.server&&(e.server_url=e.server_url||e.server.url,e.WebSocketClass=e.WebSocketClass||e.server.WebSocketClass);let t=e.client_id;t||(t=(0,_utils__WEBPACK_IMPORTED_MODULE_1__.randId)(),e.client_id=t);let n=normalizeServerUrl(e.server_url),r=new WebsocketRPCConnection(n,t,e.workspace,e.token,e.reconnection_token,e.method_timeout||60,e.WebSocketClass);const i=await r.open();if((0,_utils__WEBPACK_IMPORTED_MODULE_1__.assert)(i,"Failed to connect to the server, no connection info obtained. This issue is most likely due to an outdated Hypha server version. Please use `imjoy-rpc` for compatibility, or upgrade the Hypha server to the latest version."),e.workspace&&i.workspace!==e.workspace)throw new Error(`Connected to the wrong workspace: ${i.workspace}, expected: ${e.workspace}`);const s=i.workspace,o=new _rpc_js__WEBPACK_IMPORTED_MODULE_0__.RPC(r,{client_id:t,workspace:s,default_context:{connection_type:"websocket"},name:e.name,method_timeout:e.method_timeout,app_id:e.app_id}),a=await o.get_manager_service({timeout:e.method_timeout,case_conversion:"camel"});if(a.rpc=o,i&&(a.config=Object.assign(a.config,i)),a.export=(0,_utils_schema_js__WEBPACK_IMPORTED_MODULE_2__.schemaFunction)((async function(t){t.id="default",t.name=t.name||e.name||t.id,t.description=t.description||e.description,await o.register_service(t,{overwrite:!0})}),{name:"export",description:"Export the api.",parameters:{properties:{api:{description:"The api to export",type:"object"}},required:["api"],type:"object"}}),a.getApp=(0,_utils_schema_js__WEBPACK_IMPORTED_MODULE_2__.schemaFunction)((async function(e){return e=e||"*",(0,_utils__WEBPACK_IMPORTED_MODULE_1__.assert)(!e.includes(":"),"clientId should not contain ':'"),e.includes("/")||(e=i.workspace+"/"+e),(0,_utils__WEBPACK_IMPORTED_MODULE_1__.assert)(2===e.split("/").length,"clientId should match pattern workspace/clientId"),await a.getService(`${e}:default`)}),{name:"getApp",description:"Get the app.",parameters:{properties:{clientId:{default:"*",description:"The clientId",type:"string"}},type:"object"}}),a.listApps=(0,_utils_schema_js__WEBPACK_IMPORTED_MODULE_2__.schemaFunction)((async function(e){e=e||s,(0,_utils__WEBPACK_IMPORTED_MODULE_1__.assert)(!e.includes(":"),"workspace should not contain ':'"),(0,_utils__WEBPACK_IMPORTED_MODULE_1__.assert)(!e.includes("/"),"workspace should not contain '/'");const t={workspace:e,service_id:"default"};return await a.listServices(t)}),{name:"listApps",description:"List the apps.",parameters:{properties:{workspace:{default:s,description:"The workspace",type:"string"}},type:"object"}}),a.disconnect=(0,_utils_schema_js__WEBPACK_IMPORTED_MODULE_2__.schemaFunction)(o.disconnect.bind(o),{name:"disconnect",description:"Disconnect from the server.",parameters:{type:"object",properties:{},required:[]}}),a.registerCodec=(0,_utils_schema_js__WEBPACK_IMPORTED_MODULE_2__.schemaFunction)(o.register_codec.bind(o),{name:"registerCodec",description:"Register a codec for the webrtc connection",parameters:{type:"object",properties:{codec:{type:"object",description:"Codec to register",properties:{name:{type:"string"},type:{},encoder:{type:"function"},decoder:{type:"function"}}}}}}),a.emit=(0,_utils_schema_js__WEBPACK_IMPORTED_MODULE_2__.schemaFunction)(o.emit.bind(o),{name:"emit",description:"Emit a message.",parameters:{properties:{data:{description:"The data to emit",type:"object"}},required:["data"],type:"object"}}),a.on=(0,_utils_schema_js__WEBPACK_IMPORTED_MODULE_2__.schemaFunction)(o.on.bind(o),{name:"on",description:"Register a message handler.",parameters:{properties:{event:{description:"The event to listen to",type:"string"},handler:{description:"The handler function",type:"function"}},required:["event","handler"],type:"object"}}),a.off=(0,_utils_schema_js__WEBPACK_IMPORTED_MODULE_2__.schemaFunction)(o.off.bind(o),{name:"off",description:"Remove a message handler.",parameters:{properties:{event:{description:"The event to remove",type:"string"},handler:{description:"The handler function",type:"function"}},required:["event","handler"],type:"object"}}),a.once=(0,_utils_schema_js__WEBPACK_IMPORTED_MODULE_2__.schemaFunction)(o.once.bind(o),{name:"once",description:"Register a one-time message handler.",parameters:{properties:{event:{description:"The event to listen to",type:"string"},handler:{description:"The handler function",type:"function"}},required:["event","handler"],type:"object"}}),a.getServiceSchema=(0,_utils_schema_js__WEBPACK_IMPORTED_MODULE_2__.schemaFunction)(o.get_service_schema,{name:"getServiceSchema",description:"Get the service schema.",parameters:{properties:{service:{description:"The service to extract schema",type:"object"}},required:["service"],type:"object"}}),a.registerService=(0,_utils_schema_js__WEBPACK_IMPORTED_MODULE_2__.schemaFunction)(o.register_service.bind(o),{name:"registerService",description:"Register a service.",parameters:{properties:{service:{description:"The service to register",type:"object"},force:{default:!1,description:"Force to register the service",type:"boolean"}},required:["service"],type:"object"}}),a.unregisterService=(0,_utils_schema_js__WEBPACK_IMPORTED_MODULE_2__.schemaFunction)(o.unregister_service.bind(o),{name:"unregisterService",description:"Unregister a service.",parameters:{properties:{service:{description:"The service id to unregister",type:"string"},notify:{default:!0,description:"Notify the workspace manager",type:"boolean"}},required:["service"],type:"object"}}),r.manager_id&&o.on("force-exit",(async e=>{e.from==="*/"+r.manager_id&&(console.log("Disconnecting from server, reason:",e.reason),await o.disconnect())})),e.webrtc){await(0,_webrtc_client_js__WEBPACK_IMPORTED_MODULE_3__.registerRTCService)(a,`${t}-rtc`,e.webrtc_config);const n=Object.assign({},a),r=n.getService.__schema__.description,i=n.getService.__schema__.parameters;a.getService=(0,_utils_schema_js__WEBPACK_IMPORTED_MODULE_2__.schemaFunction)(webrtcGetService.bind(null,n,`${s}/${t}-rtc`),{name:"getService",description:r,parameters:i}),a.getRTCService=(0,_utils_schema_js__WEBPACK_IMPORTED_MODULE_2__.schemaFunction)(_webrtc_client_js__WEBPACK_IMPORTED_MODULE_3__.getRTCService.bind(null,a),{name:"getRTCService",description:"Get the webrtc connection, returns a peer connection.",parameters:{properties:{config:{description:"The config for the webrtc service",type:"object"}},required:["config"],type:"object"}})}else{const e=a.getService;a.getService=(t,n)=>e(t,n=n||{}),a.getService.__schema__=e.__schema__}return a.registerProbes=(0,_utils_schema_js__WEBPACK_IMPORTED_MODULE_2__.schemaFunction)((async function(e){return e.id="probes",e.name="Probes",e.config={visibility:"public"},e.type="probes",e.description=`Probes Service, visit ${n}/${s}services/probes for the available probes.`,await a.registerService(e,{overwrite:!0})}),{name:"registerProbes",description:"Register probes service",parameters:{properties:{probes:{description:"The probes to register, e.g. {'liveness': {'type': 'function', 'description': 'Check the liveness of the service'}}",type:"object"}},required:["probes"],type:"object"}}),a}async function getRemoteService(e,t={}){const{serverUrl:n,workspace:r,clientId:i,serviceId:s,appId:o}=(0,_utils__WEBPACK_IMPORTED_MODULE_1__.parseServiceUrl)(e),a=`${r}/${i}:${s}@${o}`;if(t.serverUrl&&t.serverUrl!==n)throw new Error("server_url in config does not match the server_url in the url");t.serverUrl=n;const c=await connectToServer(t);return await c.getService(a)}class LocalWebSocket{constructor(e,t,n){this.url=e,this.onopen=()=>{},this.onmessage=()=>{},this.onclose=()=>{},this.onerror=()=>{},this.client_id=t,this.workspace=n;const r="undefined"!=typeof window?window:self,i="undefined"!=typeof window;if(this.postMessage=e=>{i?window.parent.postMessage(e,"*"):self.postMessage(e)},this.readyState=WebSocket.CONNECTING,r.addEventListener("message",(e=>{const{type:t,data:n,to:r}=e.data;if(r===this.client_id)switch(t){case"message":this.readyState===WebSocket.OPEN&&this.onmessage&&this.onmessage({data:n});break;case"connected":this.readyState=WebSocket.OPEN,this.onopen(e);break;case"closed":this.readyState=WebSocket.CLOSED,this.onclose(e)}else console.debug("message not for me",r,this.client_id)}),!1),!this.client_id)throw new Error("client_id is required");if(!this.workspace)throw new Error("workspace is required");this.postMessage({type:"connect",url:this.url,from:this.client_id,workspace:this.workspace})}send(e){this.readyState===WebSocket.OPEN&&this.postMessage({type:"message",data:e,from:this.client_id,workspace:this.workspace})}close(){this.readyState=WebSocket.CLOSING,this.postMessage({type:"close",from:this.client_id,workspace:this.workspace}),this.onclose()}addEventListener(e,t){"message"===e&&(this.onmessage=t),"open"===e&&(this.onopen=t),"close"===e&&(this.onclose=t),"error"===e&&(this.onerror=t)}}function setupLocalClient({enable_execution=!1,on_ready=null}){return new Promise(((resolve,reject)=>{const context="undefined"!=typeof window?window:self,isWindow="undefined"!=typeof window;context.addEventListener("message",(event=>{const{type,server_url,workspace,client_id,token,method_timeout,name,config}=event.data;if("initializeHyphaClient"===type){if(!server_url||!workspace||!client_id)return void console.error("server_url, workspace, and client_id are required.");if(!server_url.startsWith("https://local-hypha-server:"))return void console.error("server_url should start with https://local-hypha-server:");class FixedLocalWebSocket extends LocalWebSocket{constructor(e){super(e,client_id,workspace)}}connectToServer({server_url,workspace,client_id,token,method_timeout,name,WebSocketClass:FixedLocalWebSocket}).then((async server=>{globalThis.api=server;try{if(isWindow&&enable_execution){function e(e){return new Promise(((t,n)=>{const r=document.createElement("script");r.innerHTML=e.content,r.lang=e.lang,r.onload=()=>t(),r.onerror=e=>n(e),document.head.appendChild(r)}))}if(config.styles&&config.styles.length>0)for(const t of config.styles){const n=document.createElement("style");n.innerHTML=t.content,n.lang=t.lang,document.head.appendChild(n)}if(config.links&&config.links.length>0)for(const r of config.links){const i=document.createElement("a");i.href=r.url,i.innerText=r.text,document.body.appendChild(i)}if(config.windows&&config.windows.length>0)for(const s of config.windows){document.body.innerHTML=s.content;break}if(config.scripts&&config.scripts.length>0)for(const o of config.scripts){if("javascript"!==o.lang)throw new Error("Only javascript scripts are supported");await e(o)}}else if(!isWindow&&enable_execution&&config.scripts&&config.scripts.length>0)for(const script of config.scripts){if("javascript"!==script.lang)throw new Error("Only javascript scripts are supported");eval(script.content)}on_ready&&await on_ready(server,config),resolve(server)}catch(a){reject(a)}}))}}),!1),isWindow?window.parent.postMessage({type:"hyphaClientReady"},"*"):self.postMessage({type:"hyphaClientReady"})}))}return __nested_webpack_exports__})(),module.exports=factory()},515:(e,t,n)=>{e.exports={hyphaWebsocketClient:n(42)}},18:function(module){var factory;factory=function(){return function(e){var t={};function n(r){if(t[r])return t[r].exports;var i=t[r]={i:r,l:!1,exports:{}};return e[r].call(i.exports,i,i.exports,n),i.l=!0,i.exports}return n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)n.d(r,i,function(t){return e[t]}.bind(null,i));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s="./src/hypha/sse-client.js")}({"./node_modules/@msgpack/msgpack/dist.es5+esm/CachedKeyDecoder.mjs":function(e,t,n){n.r(t),n.d(t,"CachedKeyDecoder",(function(){return i}));var r=n("./node_modules/@msgpack/msgpack/dist.es5+esm/utils/utf8.mjs"),i=function(){function e(e,t){void 0===e&&(e=16),void 0===t&&(t=16),this.maxKeyLength=e,this.maxLengthPerKey=t,this.hit=0,this.miss=0,this.caches=[];for(var n=0;n<this.maxKeyLength;n++)this.caches.push([])}return e.prototype.canBeCached=function(e){return e>0&&e<=this.maxKeyLength},e.prototype.find=function(e,t,n){e:for(var r=0,i=this.caches[n-1];r<i.length;r++){for(var s=i[r],o=s.bytes,a=0;a<n;a++)if(o[a]!==e[t+a])continue e;return s.str}return null},e.prototype.store=function(e,t){var n=this.caches[e.length-1],r={bytes:e,str:t};n.length>=this.maxLengthPerKey?n[Math.random()*n.length|0]=r:n.push(r)},e.prototype.decode=function(e,t,n){var i=this.find(e,t,n);if(null!=i)return this.hit++,i;this.miss++;var s=Object(r.utf8DecodeJs)(e,t,n),o=Uint8Array.prototype.slice.call(e,t,t+n);return this.store(o,s),s},e}()},"./node_modules/@msgpack/msgpack/dist.es5+esm/DecodeError.mjs":function(e,t,n){n.r(t),n.d(t,"DecodeError",(function(){return s}));var r,i=(r=function(e,t){return r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])},r(e,t)},function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function n(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}),s=function(e){function t(n){var r=e.call(this,n)||this,i=Object.create(t.prototype);return Object.setPrototypeOf(r,i),Object.defineProperty(r,"name",{configurable:!0,enumerable:!1,value:t.name}),r}return i(t,e),t}(Error)},"./node_modules/@msgpack/msgpack/dist.es5+esm/Decoder.mjs":function(e,t,n){n.r(t),n.d(t,"DataViewIndexOutOfBoundsError",(function(){return _})),n.d(t,"Decoder",(function(){return g}));var r=n("./node_modules/@msgpack/msgpack/dist.es5+esm/utils/prettyByte.mjs"),i=n("./node_modules/@msgpack/msgpack/dist.es5+esm/ExtensionCodec.mjs"),s=n("./node_modules/@msgpack/msgpack/dist.es5+esm/utils/int.mjs"),o=n("./node_modules/@msgpack/msgpack/dist.es5+esm/utils/utf8.mjs"),a=n("./node_modules/@msgpack/msgpack/dist.es5+esm/utils/typedArrays.mjs"),c=n("./node_modules/@msgpack/msgpack/dist.es5+esm/CachedKeyDecoder.mjs"),l=n("./node_modules/@msgpack/msgpack/dist.es5+esm/DecodeError.mjs"),u=function(e,t){var n,r,i,s,o={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return s={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function a(s){return function(a){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;o;)try{if(n=1,r&&(i=2&s[0]?r.return:s[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,s[1])).done)return i;switch(r=0,i&&(s=[2&s[0],i.value]),s[0]){case 0:case 1:i=s;break;case 4:return o.label++,{value:s[1],done:!1};case 5:o.label++,r=s[1],s=[0];continue;case 7:s=o.ops.pop(),o.trys.pop();continue;default:if(!((i=(i=o.trys).length>0&&i[i.length-1])||6!==s[0]&&2!==s[0])){o=0;continue}if(3===s[0]&&(!i||s[1]>i[0]&&s[1]<i[3])){o.label=s[1];break}if(6===s[0]&&o.label<i[1]){o.label=i[1],i=s;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(s);break}i[2]&&o.ops.pop(),o.trys.pop();continue}s=t.call(e,o)}catch(e){s=[6,e],r=0}finally{n=i=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,a])}}},d=function(e){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var t,n=e[Symbol.asyncIterator];return n?n.call(e):(e="function"==typeof __values?__values(e):e[Symbol.iterator](),t={},r("next"),r("throw"),r("return"),t[Symbol.asyncIterator]=function(){return this},t);function r(n){t[n]=e[n]&&function(t){return new Promise((function(r,i){!function(e,t,n,r){Promise.resolve(r).then((function(t){e({value:t,done:n})}),t)}(r,i,(t=e[n](t)).done,t.value)}))}}},h=function(e){return this instanceof h?(this.v=e,this):new h(e)},p=new DataView(new ArrayBuffer(0)),f=new Uint8Array(p.buffer),_=function(){try{p.getInt8(0)}catch(e){return e.constructor}throw new Error("never reached")}(),m=new _("Insufficient data"),y=new c.CachedKeyDecoder,g=function(){function e(e,t,n,r,o,a,c,l){void 0===e&&(e=i.ExtensionCodec.defaultCodec),void 0===t&&(t=void 0),void 0===n&&(n=s.UINT32_MAX),void 0===r&&(r=s.UINT32_MAX),void 0===o&&(o=s.UINT32_MAX),void 0===a&&(a=s.UINT32_MAX),void 0===c&&(c=s.UINT32_MAX),void 0===l&&(l=y),this.extensionCodec=e,this.context=t,this.maxStrLength=n,this.maxBinLength=r,this.maxArrayLength=o,this.maxMapLength=a,this.maxExtLength=c,this.keyDecoder=l,this.totalPos=0,this.pos=0,this.view=p,this.bytes=f,this.headByte=-1,this.stack=[]}return e.prototype.reinitializeState=function(){this.totalPos=0,this.headByte=-1,this.stack.length=0},e.prototype.setBuffer=function(e){this.bytes=Object(a.ensureUint8Array)(e),this.view=Object(a.createDataView)(this.bytes),this.pos=0},e.prototype.appendBuffer=function(e){if(-1!==this.headByte||this.hasRemaining(1)){var t=this.bytes.subarray(this.pos),n=Object(a.ensureUint8Array)(e),r=new Uint8Array(t.length+n.length);r.set(t),r.set(n,t.length),this.setBuffer(r)}else this.setBuffer(e)},e.prototype.hasRemaining=function(e){return this.view.byteLength-this.pos>=e},e.prototype.createExtraByteError=function(e){var t=this.view,n=this.pos;return new RangeError("Extra "+(t.byteLength-n)+" of "+t.byteLength+" byte(s) found at buffer["+e+"]")},e.prototype.decode=function(e){this.reinitializeState(),this.setBuffer(e);var t=this.doDecodeSync();if(this.hasRemaining(1))throw this.createExtraByteError(this.pos);return t},e.prototype.decodeMulti=function(e){return u(this,(function(t){switch(t.label){case 0:this.reinitializeState(),this.setBuffer(e),t.label=1;case 1:return this.hasRemaining(1)?[4,this.doDecodeSync()]:[3,3];case 2:return t.sent(),[3,1];case 3:return[2]}}))},e.prototype.decodeAsync=function(e){var t,n,i,s,o,a,c,l;return o=this,a=void 0,l=function(){var o,a,c,l,h,p,f,m;return u(this,(function(u){switch(u.label){case 0:o=!1,u.label=1;case 1:u.trys.push([1,6,7,12]),t=d(e),u.label=2;case 2:return[4,t.next()];case 3:if((n=u.sent()).done)return[3,5];if(c=n.value,o)throw this.createExtraByteError(this.totalPos);this.appendBuffer(c);try{a=this.doDecodeSync(),o=!0}catch(e){if(!(e instanceof _))throw e}this.totalPos+=this.pos,u.label=4;case 4:return[3,2];case 5:return[3,12];case 6:return l=u.sent(),i={error:l},[3,12];case 7:return u.trys.push([7,,10,11]),n&&!n.done&&(s=t.return)?[4,s.call(t)]:[3,9];case 8:u.sent(),u.label=9;case 9:return[3,11];case 10:if(i)throw i.error;return[7];case 11:return[7];case 12:if(o){if(this.hasRemaining(1))throw this.createExtraByteError(this.totalPos);return[2,a]}throw p=(h=this).headByte,f=h.pos,m=h.totalPos,new RangeError("Insufficient data in parsing "+Object(r.prettyByte)(p)+" at "+m+" ("+f+" in the current buffer)")}}))},new((c=void 0)||(c=Promise))((function(e,t){function n(e){try{i(l.next(e))}catch(e){t(e)}}function r(e){try{i(l.throw(e))}catch(e){t(e)}}function i(t){var i;t.done?e(t.value):(i=t.value,i instanceof c?i:new c((function(e){e(i)}))).then(n,r)}i((l=l.apply(o,a||[])).next())}))},e.prototype.decodeArrayStream=function(e){return this.decodeMultiAsync(e,!0)},e.prototype.decodeStream=function(e){return this.decodeMultiAsync(e,!1)},e.prototype.decodeMultiAsync=function(e,t){return function(e,t,n){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var r,i=n.apply(e,t||[]),s=[];return r={},o("next"),o("throw"),o("return"),r[Symbol.asyncIterator]=function(){return this},r;function o(e){i[e]&&(r[e]=function(t){return new Promise((function(n,r){s.push([e,t,n,r])>1||a(e,t)}))})}function a(e,t){try{(n=i[e](t)).value instanceof h?Promise.resolve(n.value.v).then(c,l):u(s[0][2],n)}catch(e){u(s[0][3],e)}var n}function c(e){a("next",e)}function l(e){a("throw",e)}function u(e,t){e(t),s.shift(),s.length&&a(s[0][0],s[0][1])}}(this,arguments,(function(){var n,r,i,s,o,a,c,l,p;return u(this,(function(u){switch(u.label){case 0:n=t,r=-1,u.label=1;case 1:u.trys.push([1,13,14,19]),i=d(e),u.label=2;case 2:return[4,h(i.next())];case 3:if((s=u.sent()).done)return[3,12];if(o=s.value,t&&0===r)throw this.createExtraByteError(this.totalPos);this.appendBuffer(o),n&&(r=this.readArraySize(),n=!1,this.complete()),u.label=4;case 4:u.trys.push([4,9,,10]),u.label=5;case 5:return[4,h(this.doDecodeSync())];case 6:return[4,u.sent()];case 7:return u.sent(),0==--r?[3,8]:[3,5];case 8:return[3,10];case 9:if(!((a=u.sent())instanceof _))throw a;return[3,10];case 10:this.totalPos+=this.pos,u.label=11;case 11:return[3,2];case 12:return[3,19];case 13:return c=u.sent(),l={error:c},[3,19];case 14:return u.trys.push([14,,17,18]),s&&!s.done&&(p=i.return)?[4,h(p.call(i))]:[3,16];case 15:u.sent(),u.label=16;case 16:return[3,18];case 17:if(l)throw l.error;return[7];case 18:return[7];case 19:return[2]}}))}))},e.prototype.doDecodeSync=function(){e:for(;;){var e=this.readHeadByte(),t=void 0;if(e>=224)t=e-256;else if(e<192)if(e<128)t=e;else if(e<144){if(0!=(i=e-128)){this.pushMapState(i),this.complete();continue e}t={}}else if(e<160){if(0!=(i=e-144)){this.pushArrayState(i),this.complete();continue e}t=[]}else{var n=e-160;t=this.decodeUtf8String(n,0)}else if(192===e)t=null;else if(194===e)t=!1;else if(195===e)t=!0;else if(202===e)t=this.readF32();else if(203===e)t=this.readF64();else if(204===e)t=this.readU8();else if(205===e)t=this.readU16();else if(206===e)t=this.readU32();else if(207===e)t=this.readU64();else if(208===e)t=this.readI8();else if(209===e)t=this.readI16();else if(210===e)t=this.readI32();else if(211===e)t=this.readI64();else if(217===e)n=this.lookU8(),t=this.decodeUtf8String(n,1);else if(218===e)n=this.lookU16(),t=this.decodeUtf8String(n,2);else if(219===e)n=this.lookU32(),t=this.decodeUtf8String(n,4);else if(220===e){if(0!==(i=this.readU16())){this.pushArrayState(i),this.complete();continue e}t=[]}else if(221===e){if(0!==(i=this.readU32())){this.pushArrayState(i),this.complete();continue e}t=[]}else if(222===e){if(0!==(i=this.readU16())){this.pushMapState(i),this.complete();continue e}t={}}else if(223===e){if(0!==(i=this.readU32())){this.pushMapState(i),this.complete();continue e}t={}}else if(196===e){var i=this.lookU8();t=this.decodeBinary(i,1)}else if(197===e)i=this.lookU16(),t=this.decodeBinary(i,2);else if(198===e)i=this.lookU32(),t=this.decodeBinary(i,4);else if(212===e)t=this.decodeExtension(1,0);else if(213===e)t=this.decodeExtension(2,0);else if(214===e)t=this.decodeExtension(4,0);else if(215===e)t=this.decodeExtension(8,0);else if(216===e)t=this.decodeExtension(16,0);else if(199===e)i=this.lookU8(),t=this.decodeExtension(i,1);else if(200===e)i=this.lookU16(),t=this.decodeExtension(i,2);else{if(201!==e)throw new l.DecodeError("Unrecognized type byte: "+Object(r.prettyByte)(e));i=this.lookU32(),t=this.decodeExtension(i,4)}this.complete();for(var s=this.stack;s.length>0;){var o=s[s.length-1];if(0===o.type){if(o.array[o.position]=t,o.position++,o.position!==o.size)continue e;s.pop(),t=o.array}else{if(1===o.type){if(void 0,"string"!=(a=typeof t)&&"number"!==a)throw new l.DecodeError("The type of key must be string or number but "+typeof t);if("__proto__"===t)throw new l.DecodeError("The key __proto__ is not allowed");o.key=t,o.type=2;continue e}if(o.map[o.key]=t,o.readCount++,o.readCount!==o.size){o.key=null,o.type=1;continue e}s.pop(),t=o.map}}return t}var a},e.prototype.readHeadByte=function(){return-1===this.headByte&&(this.headByte=this.readU8()),this.headByte},e.prototype.complete=function(){this.headByte=-1},e.prototype.readArraySize=function(){var e=this.readHeadByte();switch(e){case 220:return this.readU16();case 221:return this.readU32();default:if(e<160)return e-144;throw new l.DecodeError("Unrecognized array type byte: "+Object(r.prettyByte)(e))}},e.prototype.pushMapState=function(e){if(e>this.maxMapLength)throw new l.DecodeError("Max length exceeded: map length ("+e+") > maxMapLengthLength ("+this.maxMapLength+")");this.stack.push({type:1,size:e,key:null,readCount:0,map:{}})},e.prototype.pushArrayState=function(e){if(e>this.maxArrayLength)throw new l.DecodeError("Max length exceeded: array length ("+e+") > maxArrayLength ("+this.maxArrayLength+")");this.stack.push({type:0,size:e,array:new Array(e),position:0})},e.prototype.decodeUtf8String=function(e,t){var n;if(e>this.maxStrLength)throw new l.DecodeError("Max length exceeded: UTF-8 byte length ("+e+") > maxStrLength ("+this.maxStrLength+")");if(this.bytes.byteLength<this.pos+t+e)throw m;var r,i=this.pos+t;return r=this.stateIsMapKey()&&(null===(n=this.keyDecoder)||void 0===n?void 0:n.canBeCached(e))?this.keyDecoder.decode(this.bytes,i,e):e>o.TEXT_DECODER_THRESHOLD?Object(o.utf8DecodeTD)(this.bytes,i,e):Object(o.utf8DecodeJs)(this.bytes,i,e),this.pos+=t+e,r},e.prototype.stateIsMapKey=function(){return this.stack.length>0&&1===this.stack[this.stack.length-1].type},e.prototype.decodeBinary=function(e,t){if(e>this.maxBinLength)throw new l.DecodeError("Max length exceeded: bin length ("+e+") > maxBinLength ("+this.maxBinLength+")");if(!this.hasRemaining(e+t))throw m;var n=this.pos+t,r=this.bytes.subarray(n,n+e);return this.pos+=t+e,r},e.prototype.decodeExtension=function(e,t){if(e>this.maxExtLength)throw new l.DecodeError("Max length exceeded: ext length ("+e+") > maxExtLength ("+this.maxExtLength+")");var n=this.view.getInt8(this.pos+t),r=this.decodeBinary(e,t+1);return this.extensionCodec.decode(r,n,this.context)},e.prototype.lookU8=function(){return this.view.getUint8(this.pos)},e.prototype.lookU16=function(){return this.view.getUint16(this.pos)},e.prototype.lookU32=function(){return this.view.getUint32(this.pos)},e.prototype.readU8=function(){var e=this.view.getUint8(this.pos);return this.pos++,e},e.prototype.readI8=function(){var e=this.view.getInt8(this.pos);return this.pos++,e},e.prototype.readU16=function(){var e=this.view.getUint16(this.pos);return this.pos+=2,e},e.prototype.readI16=function(){var e=this.view.getInt16(this.pos);return this.pos+=2,e},e.prototype.readU32=function(){var e=this.view.getUint32(this.pos);return this.pos+=4,e},e.prototype.readI32=function(){var e=this.view.getInt32(this.pos);return this.pos+=4,e},e.prototype.readU64=function(){var e=Object(s.getUint64)(this.view,this.pos);return this.pos+=8,e},e.prototype.readI64=function(){var e=Object(s.getInt64)(this.view,this.pos);return this.pos+=8,e},e.prototype.readF32=function(){var e=this.view.getFloat32(this.pos);return this.pos+=4,e},e.prototype.readF64=function(){var e=this.view.getFloat64(this.pos);return this.pos+=8,e},e}()},"./node_modules/@msgpack/msgpack/dist.es5+esm/Encoder.mjs":function(e,t,n){n.r(t),n.d(t,"DEFAULT_MAX_DEPTH",(function(){return a})),n.d(t,"DEFAULT_INITIAL_BUFFER_SIZE",(function(){return c})),n.d(t,"Encoder",(function(){return l}));var r=n("./node_modules/@msgpack/msgpack/dist.es5+esm/utils/utf8.mjs"),i=n("./node_modules/@msgpack/msgpack/dist.es5+esm/ExtensionCodec.mjs"),s=n("./node_modules/@msgpack/msgpack/dist.es5+esm/utils/int.mjs"),o=n("./node_modules/@msgpack/msgpack/dist.es5+esm/utils/typedArrays.mjs"),a=100,c=2048,l=function(){function e(e,t,n,r,s,o,l,u){void 0===e&&(e=i.ExtensionCodec.defaultCodec),void 0===t&&(t=void 0),void 0===n&&(n=a),void 0===r&&(r=c),void 0===s&&(s=!1),void 0===o&&(o=!1),void 0===l&&(l=!1),void 0===u&&(u=!1),this.extensionCodec=e,this.context=t,this.maxDepth=n,this.initialBufferSize=r,this.sortKeys=s,this.forceFloat32=o,this.ignoreUndefined=l,this.forceIntegerToFloat=u,this.pos=0,this.view=new DataView(new ArrayBuffer(this.initialBufferSize)),this.bytes=new Uint8Array(this.view.buffer)}return e.prototype.getUint8Array=function(){return this.bytes.subarray(0,this.pos)},e.prototype.reinitializeState=function(){this.pos=0},e.prototype.encode=function(e){return this.reinitializeState(),this.doEncode(e,1),this.getUint8Array()},e.prototype.doEncode=function(e,t){if(t>this.maxDepth)throw new Error("Too deep objects in depth "+t);null==e?this.encodeNil():"boolean"==typeof e?this.encodeBoolean(e):"number"==typeof e?this.encodeNumber(e):"string"==typeof e?this.encodeString(e):this.encodeObject(e,t)},e.prototype.ensureBufferSizeToWrite=function(e){var t=this.pos+e;this.view.byteLength<t&&this.resizeBuffer(2*t)},e.prototype.resizeBuffer=function(e){var t=new ArrayBuffer(e),n=new Uint8Array(t),r=new DataView(t);n.set(this.bytes),this.view=r,this.bytes=n},e.prototype.encodeNil=function(){this.writeU8(192)},e.prototype.encodeBoolean=function(e){!1===e?this.writeU8(194):this.writeU8(195)},e.prototype.encodeNumber=function(e){Number.isSafeInteger(e)&&!this.forceIntegerToFloat?e>=0?e<128?this.writeU8(e):e<256?(this.writeU8(204),this.writeU8(e)):e<65536?(this.writeU8(205),this.writeU16(e)):e<4294967296?(this.writeU8(206),this.writeU32(e)):(this.writeU8(207),this.writeU64(e)):e>=-32?this.writeU8(224|e+32):e>=-128?(this.writeU8(208),this.writeI8(e)):e>=-32768?(this.writeU8(209),this.writeI16(e)):e>=-2147483648?(this.writeU8(210),this.writeI32(e)):(this.writeU8(211),this.writeI64(e)):this.forceFloat32?(this.writeU8(202),this.writeF32(e)):(this.writeU8(203),this.writeF64(e))},e.prototype.writeStringHeader=function(e){if(e<32)this.writeU8(160+e);else if(e<256)this.writeU8(217),this.writeU8(e);else if(e<65536)this.writeU8(218),this.writeU16(e);else{if(!(e<4294967296))throw new Error("Too long string: "+e+" bytes in UTF-8");this.writeU8(219),this.writeU32(e)}},e.prototype.encodeString=function(e){if(e.length>r.TEXT_ENCODER_THRESHOLD){var t=Object(r.utf8Count)(e);this.ensureBufferSizeToWrite(5+t),this.writeStringHeader(t),Object(r.utf8EncodeTE)(e,this.bytes,this.pos),this.pos+=t}else t=Object(r.utf8Count)(e),this.ensureBufferSizeToWrite(5+t),this.writeStringHeader(t),Object(r.utf8EncodeJs)(e,this.bytes,this.pos),this.pos+=t},e.prototype.encodeObject=function(e,t){var n=this.extensionCodec.tryToEncode(e,this.context);if(null!=n)this.encodeExtension(n);else if(Array.isArray(e))this.encodeArray(e,t);else if(ArrayBuffer.isView(e))this.encodeBinary(e);else{if("object"!=typeof e)throw new Error("Unrecognized object: "+Object.prototype.toString.apply(e));this.encodeMap(e,t)}},e.prototype.encodeBinary=function(e){var t=e.byteLength;if(t<256)this.writeU8(196),this.writeU8(t);else if(t<65536)this.writeU8(197),this.writeU16(t);else{if(!(t<4294967296))throw new Error("Too large binary: "+t);this.writeU8(198),this.writeU32(t)}var n=Object(o.ensureUint8Array)(e);this.writeU8a(n)},e.prototype.encodeArray=function(e,t){var n=e.length;if(n<16)this.writeU8(144+n);else if(n<65536)this.writeU8(220),this.writeU16(n);else{if(!(n<4294967296))throw new Error("Too large array: "+n);this.writeU8(221),this.writeU32(n)}for(var r=0,i=e;r<i.length;r++){var s=i[r];this.doEncode(s,t+1)}},e.prototype.countWithoutUndefined=function(e,t){for(var n=0,r=0,i=t;r<i.length;r++)void 0!==e[i[r]]&&n++;return n},e.prototype.encodeMap=function(e,t){var n=Object.keys(e);this.sortKeys&&n.sort();var r=this.ignoreUndefined?this.countWithoutUndefined(e,n):n.length;if(r<16)this.writeU8(128+r);else if(r<65536)this.writeU8(222),this.writeU16(r);else{if(!(r<4294967296))throw new Error("Too large map object: "+r);this.writeU8(223),this.writeU32(r)}for(var i=0,s=n;i<s.length;i++){var o=s[i],a=e[o];this.ignoreUndefined&&void 0===a||(this.encodeString(o),this.doEncode(a,t+1))}},e.prototype.encodeExtension=function(e){var t=e.data.length;if(1===t)this.writeU8(212);else if(2===t)this.writeU8(213);else if(4===t)this.writeU8(214);else if(8===t)this.writeU8(215);else if(16===t)this.writeU8(216);else if(t<256)this.writeU8(199),this.writeU8(t);else if(t<65536)this.writeU8(200),this.writeU16(t);else{if(!(t<4294967296))throw new Error("Too large extension object: "+t);this.writeU8(201),this.writeU32(t)}this.writeI8(e.type),this.writeU8a(e.data)},e.prototype.writeU8=function(e){this.ensureBufferSizeToWrite(1),this.view.setUint8(this.pos,e),this.pos++},e.prototype.writeU8a=function(e){var t=e.length;this.ensureBufferSizeToWrite(t),this.bytes.set(e,this.pos),this.pos+=t},e.prototype.writeI8=function(e){this.ensureBufferSizeToWrite(1),this.view.setInt8(this.pos,e),this.pos++},e.prototype.writeU16=function(e){this.ensureBufferSizeToWrite(2),this.view.setUint16(this.pos,e),this.pos+=2},e.prototype.writeI16=function(e){this.ensureBufferSizeToWrite(2),this.view.setInt16(this.pos,e),this.pos+=2},e.prototype.writeU32=function(e){this.ensureBufferSizeToWrite(4),this.view.setUint32(this.pos,e),this.pos+=4},e.prototype.writeI32=function(e){this.ensureBufferSizeToWrite(4),this.view.setInt32(this.pos,e),this.pos+=4},e.prototype.writeF32=function(e){this.ensureBufferSizeToWrite(4),this.view.setFloat32(this.pos,e),this.pos+=4},e.prototype.writeF64=function(e){this.ensureBufferSizeToWrite(8),this.view.setFloat64(this.pos,e),this.pos+=8},e.prototype.writeU64=function(e){this.ensureBufferSizeToWrite(8),Object(s.setUint64)(this.view,this.pos,e),this.pos+=8},e.prototype.writeI64=function(e){this.ensureBufferSizeToWrite(8),Object(s.setInt64)(this.view,this.pos,e),this.pos+=8},e}()},"./node_modules/@msgpack/msgpack/dist.es5+esm/ExtData.mjs":function(e,t,n){n.r(t),n.d(t,"ExtData",(function(){return r}));var r=function(e,t){this.type=e,this.data=t}},"./node_modules/@msgpack/msgpack/dist.es5+esm/ExtensionCodec.mjs":function(e,t,n){n.r(t),n.d(t,"ExtensionCodec",(function(){return s}));var r=n("./node_modules/@msgpack/msgpack/dist.es5+esm/ExtData.mjs"),i=n("./node_modules/@msgpack/msgpack/dist.es5+esm/timestamp.mjs"),s=function(){function e(){this.builtInEncoders=[],this.builtInDecoders=[],this.encoders=[],this.decoders=[],this.register(i.timestampExtension)}return e.prototype.register=function(e){var t=e.type,n=e.encode,r=e.decode;if(t>=0)this.encoders[t]=n,this.decoders[t]=r;else{var i=1+t;this.builtInEncoders[i]=n,this.builtInDecoders[i]=r}},e.prototype.tryToEncode=function(e,t){for(var n=0;n<this.builtInEncoders.length;n++)if(null!=(s=this.builtInEncoders[n])&&null!=(o=s(e,t))){var i=-1-n;return new r.ExtData(i,o)}for(n=0;n<this.encoders.length;n++){var s,o;if(null!=(s=this.encoders[n])&&null!=(o=s(e,t)))return i=n,new r.ExtData(i,o)}return e instanceof r.ExtData?e:null},e.prototype.decode=function(e,t,n){var i=t<0?this.builtInDecoders[-1-t]:this.decoders[t];return i?i(e,t,n):new r.ExtData(t,e)},e.defaultCodec=new e,e}()},"./node_modules/@msgpack/msgpack/dist.es5+esm/decode.mjs":function(e,t,n){n.r(t),n.d(t,"defaultDecodeOptions",(function(){return i})),n.d(t,"decode",(function(){return s})),n.d(t,"decodeMulti",(function(){return o}));var r=n("./node_modules/@msgpack/msgpack/dist.es5+esm/Decoder.mjs"),i={};function s(e,t){return void 0===t&&(t=i),new r.Decoder(t.extensionCodec,t.context,t.maxStrLength,t.maxBinLength,t.maxArrayLength,t.maxMapLength,t.maxExtLength).decode(e)}function o(e,t){return void 0===t&&(t=i),new r.Decoder(t.extensionCodec,t.context,t.maxStrLength,t.maxBinLength,t.maxArrayLength,t.maxMapLength,t.maxExtLength).decodeMulti(e)}},"./node_modules/@msgpack/msgpack/dist.es5+esm/decodeAsync.mjs":function(e,t,n){n.r(t),n.d(t,"decodeAsync",(function(){return c})),n.d(t,"decodeArrayStream",(function(){return l})),n.d(t,"decodeMultiStream",(function(){return u})),n.d(t,"decodeStream",(function(){return d}));var r=n("./node_modules/@msgpack/msgpack/dist.es5+esm/Decoder.mjs"),i=n("./node_modules/@msgpack/msgpack/dist.es5+esm/utils/stream.mjs"),s=n("./node_modules/@msgpack/msgpack/dist.es5+esm/decode.mjs"),o=function(e,t,n,r){return new(n||(n=Promise))((function(i,s){function o(e){try{c(r.next(e))}catch(e){s(e)}}function a(e){try{c(r.throw(e))}catch(e){s(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}c((r=r.apply(e,t||[])).next())}))},a=function(e,t){var n,r,i,s,o={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return s={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function a(s){return function(a){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;o;)try{if(n=1,r&&(i=2&s[0]?r.return:s[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,s[1])).done)return i;switch(r=0,i&&(s=[2&s[0],i.value]),s[0]){case 0:case 1:i=s;break;case 4:return o.label++,{value:s[1],done:!1};case 5:o.label++,r=s[1],s=[0];continue;case 7:s=o.ops.pop(),o.trys.pop();continue;default:if(!((i=(i=o.trys).length>0&&i[i.length-1])||6!==s[0]&&2!==s[0])){o=0;continue}if(3===s[0]&&(!i||s[1]>i[0]&&s[1]<i[3])){o.label=s[1];break}if(6===s[0]&&o.label<i[1]){o.label=i[1],i=s;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(s);break}i[2]&&o.ops.pop(),o.trys.pop();continue}s=t.call(e,o)}catch(e){s=[6,e],r=0}finally{n=i=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,a])}}};function c(e,t){return void 0===t&&(t=s.defaultDecodeOptions),o(this,void 0,void 0,(function(){var n;return a(this,(function(s){return n=Object(i.ensureAsyncIterable)(e),[2,new r.Decoder(t.extensionCodec,t.context,t.maxStrLength,t.maxBinLength,t.maxArrayLength,t.maxMapLength,t.maxExtLength).decodeAsync(n)]}))}))}function l(e,t){void 0===t&&(t=s.defaultDecodeOptions);var n=Object(i.ensureAsyncIterable)(e);return new r.Decoder(t.extensionCodec,t.context,t.maxStrLength,t.maxBinLength,t.maxArrayLength,t.maxMapLength,t.maxExtLength).decodeArrayStream(n)}function u(e,t){void 0===t&&(t=s.defaultDecodeOptions);var n=Object(i.ensureAsyncIterable)(e);return new r.Decoder(t.extensionCodec,t.context,t.maxStrLength,t.maxBinLength,t.maxArrayLength,t.maxMapLength,t.maxExtLength).decodeStream(n)}function d(e,t){return void 0===t&&(t=s.defaultDecodeOptions),u(e,t)}},"./node_modules/@msgpack/msgpack/dist.es5+esm/encode.mjs":function(e,t,n){n.r(t),n.d(t,"encode",(function(){return s}));var r=n("./node_modules/@msgpack/msgpack/dist.es5+esm/Encoder.mjs"),i={};function s(e,t){return void 0===t&&(t=i),new r.Encoder(t.extensionCodec,t.context,t.maxDepth,t.initialBufferSize,t.sortKeys,t.forceFloat32,t.ignoreUndefined,t.forceIntegerToFloat).encode(e)}},"./node_modules/@msgpack/msgpack/dist.es5+esm/index.mjs":function(e,t,n){n.r(t);var r=n("./node_modules/@msgpack/msgpack/dist.es5+esm/encode.mjs");n.d(t,"encode",(function(){return r.encode}));var i=n("./node_modules/@msgpack/msgpack/dist.es5+esm/decode.mjs");n.d(t,"decode",(function(){return i.decode})),n.d(t,"decodeMulti",(function(){return i.decodeMulti}));var s=n("./node_modules/@msgpack/msgpack/dist.es5+esm/decodeAsync.mjs");n.d(t,"decodeAsync",(function(){return s.decodeAsync})),n.d(t,"decodeArrayStream",(function(){return s.decodeArrayStream})),n.d(t,"decodeMultiStream",(function(){return s.decodeMultiStream})),n.d(t,"decodeStream",(function(){return s.decodeStream}));var o=n("./node_modules/@msgpack/msgpack/dist.es5+esm/Decoder.mjs");n.d(t,"Decoder",(function(){return o.Decoder})),n.d(t,"DataViewIndexOutOfBoundsError",(function(){return o.DataViewIndexOutOfBoundsError}));var a=n("./node_modules/@msgpack/msgpack/dist.es5+esm/DecodeError.mjs");n.d(t,"DecodeError",(function(){return a.DecodeError}));var c=n("./node_modules/@msgpack/msgpack/dist.es5+esm/Encoder.mjs");n.d(t,"Encoder",(function(){return c.Encoder}));var l=n("./node_modules/@msgpack/msgpack/dist.es5+esm/ExtensionCodec.mjs");n.d(t,"ExtensionCodec",(function(){return l.ExtensionCodec}));var u=n("./node_modules/@msgpack/msgpack/dist.es5+esm/ExtData.mjs");n.d(t,"ExtData",(function(){return u.ExtData}));var d=n("./node_modules/@msgpack/msgpack/dist.es5+esm/timestamp.mjs");n.d(t,"EXT_TIMESTAMP",(function(){return d.EXT_TIMESTAMP})),n.d(t,"encodeDateToTimeSpec",(function(){return d.encodeDateToTimeSpec})),n.d(t,"encodeTimeSpecToTimestamp",(function(){return d.encodeTimeSpecToTimestamp})),n.d(t,"decodeTimestampToTimeSpec",(function(){return d.decodeTimestampToTimeSpec})),n.d(t,"encodeTimestampExtension",(function(){return d.encodeTimestampExtension})),n.d(t,"decodeTimestampExtension",(function(){return d.decodeTimestampExtension}))},"./node_modules/@msgpack/msgpack/dist.es5+esm/timestamp.mjs":function(e,t,n){n.r(t),n.d(t,"EXT_TIMESTAMP",(function(){return s})),n.d(t,"encodeTimeSpecToTimestamp",(function(){return c})),n.d(t,"encodeDateToTimeSpec",(function(){return l})),n.d(t,"encodeTimestampExtension",(function(){return u})),n.d(t,"decodeTimestampToTimeSpec",(function(){return d})),n.d(t,"decodeTimestampExtension",(function(){return h})),n.d(t,"timestampExtension",(function(){return p}));var r=n("./node_modules/@msgpack/msgpack/dist.es5+esm/DecodeError.mjs"),i=n("./node_modules/@msgpack/msgpack/dist.es5+esm/utils/int.mjs"),s=-1,o=4294967295,a=17179869183;function c(e){var t,n=e.sec,r=e.nsec;if(n>=0&&r>=0&&n<=a){if(0===r&&n<=o){var s=new Uint8Array(4);return(t=new DataView(s.buffer)).setUint32(0,n),s}var c=n/4294967296,l=4294967295&n;return s=new Uint8Array(8),(t=new DataView(s.buffer)).setUint32(0,r<<2|3&c),t.setUint32(4,l),s}return s=new Uint8Array(12),(t=new DataView(s.buffer)).setUint32(0,r),Object(i.setInt64)(t,4,n),s}function l(e){var t=e.getTime(),n=Math.floor(t/1e3),r=1e6*(t-1e3*n),i=Math.floor(r/1e9);return{sec:n+i,nsec:r-1e9*i}}function u(e){return e instanceof Date?c(l(e)):null}function d(e){var t=new DataView(e.buffer,e.byteOffset,e.byteLength);switch(e.byteLength){case 4:return{sec:t.getUint32(0),nsec:0};case 8:var n=t.getUint32(0);return{sec:4294967296*(3&n)+t.getUint32(4),nsec:n>>>2};case 12:return{sec:Object(i.getInt64)(t,4),nsec:t.getUint32(0)};default:throw new r.DecodeError("Unrecognized data size for timestamp (expected 4, 8, or 12): "+e.length)}}function h(e){var t=d(e);return new Date(1e3*t.sec+t.nsec/1e6)}var p={type:s,encode:u,decode:h}},"./node_modules/@msgpack/msgpack/dist.es5+esm/utils/int.mjs":function(e,t,n){n.r(t),n.d(t,"UINT32_MAX",(function(){return r})),n.d(t,"setUint64",(function(){return i})),n.d(t,"setInt64",(function(){return s})),n.d(t,"getInt64",(function(){return o})),n.d(t,"getUint64",(function(){return a}));var r=4294967295;function i(e,t,n){var r=n/4294967296,i=n;e.setUint32(t,r),e.setUint32(t+4,i)}function s(e,t,n){var r=Math.floor(n/4294967296),i=n;e.setUint32(t,r),e.setUint32(t+4,i)}function o(e,t){return 4294967296*e.getInt32(t)+e.getUint32(t+4)}function a(e,t){return 4294967296*e.getUint32(t)+e.getUint32(t+4)}},"./node_modules/@msgpack/msgpack/dist.es5+esm/utils/prettyByte.mjs":function(e,t,n){function r(e){return(e<0?"-":"")+"0x"+Math.abs(e).toString(16).padStart(2,"0")}n.r(t),n.d(t,"prettyByte",(function(){return r}))},"./node_modules/@msgpack/msgpack/dist.es5+esm/utils/stream.mjs":function(e,t,n){n.r(t),n.d(t,"isAsyncIterable",(function(){return o})),n.d(t,"asyncIterableFromStream",(function(){return a})),n.d(t,"ensureAsyncIterable",(function(){return c}));var r=function(e,t){var n,r,i,s,o={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return s={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function a(s){return function(a){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;o;)try{if(n=1,r&&(i=2&s[0]?r.return:s[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,s[1])).done)return i;switch(r=0,i&&(s=[2&s[0],i.value]),s[0]){case 0:case 1:i=s;break;case 4:return o.label++,{value:s[1],done:!1};case 5:o.label++,r=s[1],s=[0];continue;case 7:s=o.ops.pop(),o.trys.pop();continue;default:if(!((i=(i=o.trys).length>0&&i[i.length-1])||6!==s[0]&&2!==s[0])){o=0;continue}if(3===s[0]&&(!i||s[1]>i[0]&&s[1]<i[3])){o.label=s[1];break}if(6===s[0]&&o.label<i[1]){o.label=i[1],i=s;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(s);break}i[2]&&o.ops.pop(),o.trys.pop();continue}s=t.call(e,o)}catch(e){s=[6,e],r=0}finally{n=i=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,a])}}},i=function(e){return this instanceof i?(this.v=e,this):new i(e)},s=function(e,t,n){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var r,s=n.apply(e,t||[]),o=[];return r={},a("next"),a("throw"),a("return"),r[Symbol.asyncIterator]=function(){return this},r;function a(e){s[e]&&(r[e]=function(t){return new Promise((function(n,r){o.push([e,t,n,r])>1||c(e,t)}))})}function c(e,t){try{(n=s[e](t)).value instanceof i?Promise.resolve(n.value.v).then(l,u):d(o[0][2],n)}catch(e){d(o[0][3],e)}var n}function l(e){c("next",e)}function u(e){c("throw",e)}function d(e,t){e(t),o.shift(),o.length&&c(o[0][0],o[0][1])}};function o(e){return null!=e[Symbol.asyncIterator]}function a(e){return s(this,arguments,(function(){var t,n,s,o;return r(this,(function(r){switch(r.label){case 0:t=e.getReader(),r.label=1;case 1:r.trys.push([1,,9,10]),r.label=2;case 2:return[4,i(t.read())];case 3:return n=r.sent(),s=n.done,o=n.value,s?[4,i(void 0)]:[3,5];case 4:return[2,r.sent()];case 5:return function(e){if(null==e)throw new Error("Assertion Failure: value must not be null nor undefined")}(o),[4,i(o)];case 6:return[4,r.sent()];case 7:return r.sent(),[3,2];case 8:return[3,10];case 9:return t.releaseLock(),[7];case 10:return[2]}}))}))}function c(e){return o(e)?e:a(e)}},"./node_modules/@msgpack/msgpack/dist.es5+esm/utils/typedArrays.mjs":function(e,t,n){function r(e){return e instanceof Uint8Array?e:ArrayBuffer.isView(e)?new Uint8Array(e.buffer,e.byteOffset,e.byteLength):e instanceof ArrayBuffer?new Uint8Array(e):Uint8Array.from(e)}function i(e){if(e instanceof ArrayBuffer)return new DataView(e);var t=r(e);return new DataView(t.buffer,t.byteOffset,t.byteLength)}n.r(t),n.d(t,"ensureUint8Array",(function(){return r})),n.d(t,"createDataView",(function(){return i}))},"./node_modules/@msgpack/msgpack/dist.es5+esm/utils/utf8.mjs":function(e,t,n){n.r(t),n.d(t,"utf8Count",(function(){return s})),n.d(t,"utf8EncodeJs",(function(){return o})),n.d(t,"TEXT_ENCODER_THRESHOLD",(function(){return c})),n.d(t,"utf8EncodeTE",(function(){return l})),n.d(t,"utf8DecodeJs",(function(){return d})),n.d(t,"TEXT_DECODER_THRESHOLD",(function(){return p})),n.d(t,"utf8DecodeTD",(function(){return f}));var r=n("./node_modules/@msgpack/msgpack/dist.es5+esm/utils/int.mjs"),i=("undefined"==typeof process||"never"!==process.env.TEXT_ENCODING)&&"undefined"!=typeof TextEncoder&&"undefined"!=typeof TextDecoder;function s(e){for(var t=e.length,n=0,r=0;r<t;){var i=e.charCodeAt(r++);if(4294967168&i)if(4294965248&i){if(i>=55296&&i<=56319&&r<t){var s=e.charCodeAt(r);56320==(64512&s)&&(++r,i=((1023&i)<<10)+(1023&s)+65536)}n+=4294901760&i?4:3}else n+=2;else n++}return n}function o(e,t,n){for(var r=e.length,i=n,s=0;s<r;){var o=e.charCodeAt(s++);if(4294967168&o){if(4294965248&o){if(o>=55296&&o<=56319&&s<r){var a=e.charCodeAt(s);56320==(64512&a)&&(++s,o=((1023&o)<<10)+(1023&a)+65536)}4294901760&o?(t[i++]=o>>18&7|240,t[i++]=o>>12&63|128,t[i++]=o>>6&63|128):(t[i++]=o>>12&15|224,t[i++]=o>>6&63|128)}else t[i++]=o>>6&31|192;t[i++]=63&o|128}else t[i++]=o}}var a=i?new TextEncoder:void 0,c=i?"undefined"!=typeof process&&"force"!==process.env.TEXT_ENCODING?200:0:r.UINT32_MAX,l=(null==a?void 0:a.encodeInto)?function(e,t,n){a.encodeInto(e,t.subarray(n))}:function(e,t,n){t.set(a.encode(e),n)},u=4096;function d(e,t,n){for(var r=t,i=r+n,s=[],o="";r<i;){var a=e[r++];if(128&a)if(192==(224&a)){var c=63&e[r++];s.push((31&a)<<6|c)}else if(224==(240&a)){c=63&e[r++];var l=63&e[r++];s.push((31&a)<<12|c<<6|l)}else if(240==(248&a)){var d=(7&a)<<18|(c=63&e[r++])<<12|(l=63&e[r++])<<6|63&e[r++];d>65535&&(d-=65536,s.push(d>>>10&1023|55296),d=56320|1023&d),s.push(d)}else s.push(a);else s.push(a);s.length>=u&&(o+=String.fromCharCode.apply(String,s),s.length=0)}return s.length>0&&(o+=String.fromCharCode.apply(String,s)),o}var h=i?new TextDecoder:null,p=i?"undefined"!=typeof process&&"force"!==process.env.TEXT_DECODER?200:0:r.UINT32_MAX;function f(e,t,n){var r=e.subarray(t,t+n);return h.decode(r)}},"./package.json":function(e){e.exports=JSON.parse('{"name":"imjoy-rpc","version":"0.5.59","description":"Remote procedure calls for ImJoy.","module":"index.js","types":"index.d.ts","scripts":{"build":"rm -rf dist && npm run build-umd","build-umd":"webpack --config webpack.config.js --mode development && NODE_ENV=production webpack --config webpack.config.js --mode production --devtool source-map ","watch":"NODE_ENV=production webpack --watch --progress --config webpack.config.js --mode production --devtool source-map","publish-npm":"npm install && npm run build && npm publish","serve":"webpack-dev-server","stats":"webpack --profile --json > stats.json","stats-prod":"webpack --profile --json --mode production > stats-prod.json","analyze":"webpack-bundle-analyzer -p 9999 stats.json","analyze-prod":"webpack-bundle-analyzer -p 9999 stats-prod.json","clean":"rimraf dist/*","deploy":"npm run build && node deploy-site.js","format":"prettier --write \\"{src,tests}/**/**\\"","check-format":"prettier --check \\"{src,tests}/**/**\\"","test":"karma start --single-run --browsers ChromeHeadless,FirefoxHeadless karma.conf.js","test-watch":"karma start --auto-watch --browsers ChromeDebugging karma.conf.js --debug"},"repository":{"type":"git","url":"git+https://github.com/imjoy-team/imjoy-rpc.git"},"keywords":["imjoy","rpc"],"author":"imjoy-team <imjoy.team@gmail.com>","license":"MIT","bugs":{"url":"https://github.com/imjoy-team/imjoy-rpc/issues"},"homepage":"https://github.com/imjoy-team/imjoy-rpc","dependencies":{"@msgpack/msgpack":"^2.7.1","socket.io-client":"^4.6.2"},"devDependencies":{"@babel/core":"^7.16.12","@babel/plugin-syntax-dynamic-import":"^7.8.3","@babel/polyfill":"^7.12.1","@babel/preset-env":"^7.16.11","@types/requirejs":"^2.1.34","babel-core":"^6.26.0","babel-eslint":"^10.1.0","babel-loader":"^8.2.3","babel-runtime":"^6.26.0","chai":"^4.3.6","clean-webpack-plugin":"^0.1.19","copy-webpack-plugin":"^5.1.2","eslint":"^6.8.0","eslint-config-prettier":"^4.2.0","eslint-loader":"^4.0.2","file-loader":"^0.11.2","fs-extra":"^0.30.0","gh-pages":"^2.0.1","html-loader":"^0.5.5","html-webpack-plugin":"^3.2.0","json-loader":"^0.5.4","karma":"^6.3.12","karma-chrome-launcher":"^3.1.0","karma-firefox-launcher":"^1.3.0","karma-mocha":"^2.0.1","karma-sourcemap-loader":"^0.3.8","karma-spec-reporter":"0.0.32","karma-webpack":"^4.0.2","lerna":"^6.0.3","lodash.debounce":"^4.0.8","mocha":"^10.1.0","postcss":"^7.0.36","prettier":"^1.6.1","rimraf":"^2.6.2","schema-utils":"^0.4.3","style-loader":"^0.18.1","ts-loader":"^9.4.3","url-loader":"^0.5.9","webpack":"^4.46.0","webpack-bundle-analyzer":"^4.7.0","webpack-cli":"^3.3.12","webpack-dev-server":"^3.11.3","webpack-merge":"^4.1.1","workbox-webpack-plugin":"^4.3.1","worker-loader":"^2.0.0","write-file-webpack-plugin":"^4.5.1"},"eslintConfig":{"globals":{"document":true,"window":true}}}')},"./src/hypha/rpc.js":function(e,t,n){n.r(t),n.d(t,"API_VERSION",(function(){return s})),n.d(t,"RPC",(function(){return d}));var r=n("./src/hypha/utils.js"),i=n("./node_modules/@msgpack/msgpack/dist.es5+esm/index.mjs");const s="0.3.0",o=512e3,a=Object.getPrototypeOf(Object.getPrototypeOf(new Uint8Array)).constructor;function c(e,t){const n=new Uint8Array(e.byteLength+t.byteLength);return n.set(new Uint8Array(e),0),n.set(new Uint8Array(t),e.byteLength),n.buffer}function l(e,t){if(!t)throw new Error("undefined index");return"string"==typeof t?l(e,t.split(".")):0===t.length?e:l(e[t[0]],t.slice(1))}class u{constructor(e,t,n,r){this._timeout=e,this._callback=t,this._args=n,this._label=r||"timer",this._task=null,this.started=!1}start(){this.started?this.reset():(this._task=setTimeout((()=>{this._callback.apply(this,this._args)}),1e3*this._timeout),this.started=!0)}clear(){this._task?(clearTimeout(this._task),this._task=null,this.started=!1):console.warn(`Clearing a timer (${this._label}) which is not started`)}reset(){this._task&&clearTimeout(this._task),this._task=setTimeout((()=>{this._callback.apply(this,this._args)}),1e3*this._timeout),this.started=!0}}class d extends r.MessageEmitter{constructor(e,{client_id:t=null,manager_id:n=null,default_context:i=null,name:s=null,codecs:o=null,method_timeout:a=null,max_message_buffer_size:c=0,debug:l=!1,workspace:u=null}){super(l),this._codecs=o||{},Object(r.assert)(t&&"string"==typeof t),Object(r.assert)(t,"client_id is required"),this._client_id=t,this._name=s,this._connection_info=null,this._workspace=null,this._local_workspace=u,this.manager_id=n,this.default_context=i||{},this._method_annotations=new WeakMap,this._manager_service=null,this._max_message_buffer_size=c,this._chunk_store={},this._method_timeout=a||30,this._services={},this._object_store={services:this._services},e?(this.add_service({id:"built-in",type:"built-in",name:"RPC built-in services",config:{require_context:!0,visibility:"public"},ping:this._ping.bind(this),get_service:this.get_local_service.bind(this),register_service:this.register_service.bind(this),message_cache:{create:this._create_message.bind(this),append:this._append_message.bind(this),process:this._process_message.bind(this),remove:this._remove_message.bind(this)}}),this.on("method",this._handle_method.bind(this)),Object(r.assert)(e.emit_message&&e.on_message),this._emit_message=e.emit_message.bind(e),e.on_message(this._on_message.bind(this)),this._connection=e,this._get_connection_info()):this._emit_message=function(){console.log("No connection to emit message")}}async _get_connection_info(){if(this.manager_id)try{if(await this.get_manager_service(30),Object(r.assert)(this._manager_service),this._connection_info=await this._manager_service.get_connection_info(),!this._local_workspace&&this._connection_info&&this._connection_info.workspace&&(this._local_workspace=this._connection_info.workspace),this._connection_info.reconnection_token&&this._connection.set_reconnection_token){this._connection.set_reconnection_token(this._connection_info.reconnection_token);const e=.8*this._connection_info.reconnection_expires_in;this._get_connection_info_task=setTimeout(this._get_connection_info.bind(this),1e3*e)}}catch(e){console.warn("Failed to fetch user info from ",this.manager_id,e)}}register_codec(e){if(!e.name||!e.encoder&&!e.decoder)throw new Error("Invalid codec format, please make sure you provide a name, type, encoder and decoder.");if(e.type)for(let t of Object.keys(this._codecs))this._codecs[t].type!==e.type&&t!==e.name||(delete this._codecs[t],console.warn("Remove duplicated codec: "+t));this._codecs[e.name]=e}async _ping(e,t){return Object(r.assert)("ping"==e),"pong"}async ping(e,t){let n=this._generate_remote_method({_rtarget:e,_rmethod:"services.built-in.ping",_rpromise:!0,_rdoc:"Ping a remote client",_rsig:"ping(msg)"});Object(r.assert)("pong"==await n("ping",t))}_create_message(e,t,n,r){if(t){if(!this._object_store[e])throw new Error(`session does not exist anymore: ${e}`);this._object_store[e].timer.reset()}if(this._object_store.message_cache||(this._object_store.message_cache={}),!n&&this._object_store.message_cache[e])throw new Error(`Message with the same key (${e}) already exists in the cache store, please use overwrite=true or remove it first.`);this._object_store.message_cache[e]=[]}_append_message(e,t,n,i){if(n){if(!this._object_store[e])throw new Error(`session does not exist anymore: ${e}`);this._object_store[e].timer.reset()}const s=this._object_store.message_cache;if(!s[e])throw new Error(`Message with key ${e} does not exists.`);Object(r.assert)(t instanceof a),s[e].push(t)}_remove_message(e,t){const n=this._object_store.message_cache;if(!n[e])throw new Error(`Message with key ${e} does not exists.`);delete n[e]}_process_message(e,t,n){if(t){if(!this._object_store[e])throw new Error(`session does not exist anymore: ${e}`);this._object_store[e].timer.reset()}const s=this._object_store.message_cache;if(Object(r.assert)(!!n,"Context is required"),!s[e])throw new Error(`Message with key ${e} does not exists.`);var o,a,c,l;s[e]=(c=(a=(o=s[e]).map((function(e){return e.byteLength}))).reduce((function(e,t){return e+t}),0),l=new Uint8Array(c),a.reduce((function(e,t,n){return l.set(new Uint8Array(o[n]),e),e+t}),0),l.buffer),console.debug(`Processing message ${e} (size=${s[e].length})`);let u=Object(i.decodeMulti)(s[e]);const{done:d,value:h}=u.next(),p=h;if(Object.assign(p,{from:n.from,to:n.to,user:n.user}),p.ctx=JSON.parse(JSON.stringify(p)),Object.assign(p.ctx,this.default_context),!d){let e=u.next();Object.assign(p,e.value)}this._fire(p.type,p),delete s[e]}_on_message(e){try{Object(r.assert)(e instanceof ArrayBuffer);let t=Object(i.decodeMulti)(e);const{done:n,value:s}=t.next(),o=s;if(o.ctx=JSON.parse(JSON.stringify(o)),Object.assign(o.ctx,this.default_context),!n){let e=t.next();Object.assign(o,e.value)}this._fire(o.type,o)}catch(e){console.error(e)}}reset(){this._event_handlers={},this._services={}}async disconnect(){this._get_connection_info_task&&(clearTimeout(this._get_connection_info_task),this._get_connection_info_task=null),this._fire("disconnect")}async get_manager_service(e){this.manager_id&&!this._manager_service&&(this._manager_service=await this.get_remote_service(`${this.manager_id}:default`,e))}get_all_local_services(){return this._services}get_local_service(e,t){Object(r.assert)(e);const[n,i]=t.to.split("/");Object(r.assert)(i===this._client_id,"Services can only be accessed locally");const s=this._services[e];if(!s)throw new Error("Service not found: "+e);if("public"==s.config.visibility)return s;if(t.from.startsWith(n+"/"))return s;throw new Error("Permission denied for service: "+e)}async get_remote_service(e,t){t=void 0===t?this._method_timeout:t,!e&&this.manager_id?e=this.manager_id:e.includes(":")||(e=this._client_id+":"+e);const n=e.split(":")[0];Object(r.assert)(n);try{const i=this._generate_remote_method({_rtarget:n,_rmethod:"services.built-in.get_service",_rpromise:!0,_rdoc:"Get a remote service",_rsig:"get_service(service_id)"}),s=await Object(r.waitFor)(i(e.split(":")[1]),t,"Timeout Error: Failed to get remote service: "+e);return s.id=e,s}catch(t){throw console.error("Failed to get remote service: "+e,t),t}}_annotate_service_methods(e,t,n,r,i){if("function"==typeof e){let s=t.split(".")[1];this._method_annotations.set(e,{require_context:Array.isArray(n)?n.includes(s):!!n,run_in_executor:r,method_id:"services."+t,visibility:i})}else if(e instanceof Array||e instanceof Object)for(let s of Object.keys(e)){let o=e[s];if("function"==typeof o&&o.__rpc_object__){let t=o.__rpc_object__._rtarget;if(t.includes("/")&&(t=t.split("/")[1]),this._client_id!==t)throw new Error(`Local method not found: ${o.__rpc_object__._rmethod}, client id mismatch ${this._client_id} != ${t}`);e instanceof Array&&(e=e.slice()),e[s]=l(this._object_store,o.__rpc_object__._rmethod),o=e[s]}this._annotate_service_methods(o,t+"."+s,n,r,i)}}add_service(e,t){if(!e||Array.isArray(e))throw new Error("Invalid service object");if(e.constructor===Object)e=Object.assign({},e);else{const t={},n=Object.getOwnPropertyNames(e).concat(Object.getOwnPropertyNames(Object.getPrototypeOf(e)));for(let r of n)"constructor"!==r&&("function"==typeof e[r]?t[r]=e[r].bind(e):t[r]=e[r]);e.id=e.id||"default",e=t}Object(r.assert)(e.id&&"string"==typeof e.id,`Service id not found: ${e}`),e.name||(e.name=e.id),e.config||(e.config={}),e.type||(e.type="generic");let n=!1,i=!1;e.config.require_context&&(n=e.config.require_context),e.config.run_in_executor&&(i=!0);const s=e.config.visibility||"protected";if(Object(r.assert)(["protected","public"].includes(s)),this._annotate_service_methods(e,e.id,n,i,s),this._services[e.id]){if(!t)throw new Error(`Service already exists: ${e.id}, please specify a different id (not ${e.id}) or overwrite=true`);delete this._services[e.id]}return this._services[e.id]=e,e}async register_service(e,t,n,i){if(void 0===n&&(n=!0),i){const[e,t]=i.to.split("/");Object(r.assert)(t===this._client_id),Object(r.assert)(e===i.from.split("/")[0],"Services can only be registered from the same workspace")}const s=this.add_service(e,t);return n&&(this._fire("service-updated",{service_id:s.id,api:s,type:"add"}),await this._notify_service_update()),{id:`${this._client_id}:${s.id}`,type:s.type,name:s.name,description:s.description||"",config:s.config}}async unregister_service(e,t){if(e instanceof Object&&(e=e.id),!this._services[e])throw new Error(`Service not found: ${e}`);const n=this._services[e];delete this._services[e],this._fire("service-updated",{service_id:e,api:n,type:"remove"}),await this._notify_service_update()}_ndarray(e,t,n){const i=Object(r.typedArrayToDtype)(e);if(n&&n!==i)throw"dtype doesn't match the type of the array: "+i+" != "+n;return t=t||[e.length],{_rtype:"ndarray",_rvalue:e.buffer,_rshape:t,_rdtype:i}}_encode_callback(e,t,n,r,i,s){let o=`${n}.${e}`,a={_rtype:"method",_rtarget:s?`${s}/${this._client_id}`:this._client_id,_rmethod:o,_rpromise:!1};const c=this;return[a,function(){try{t.apply(null,Array.prototype.slice.call(arguments))}catch(e){console.error("Error in callback:",o,e)}finally{r&&c._object_store[n]&&delete c._object_store[n],i&&i.started&&i.clear()}}]}async _encode_promise(e,t,n,i,s,o){let a=this._get_session_store(n,!0);Object(r.assert)(a,`Failed to create session store ${n} due to invalid parent`);let c={};return s&&t&&this._method_timeout?(c.heartbeat=await this._encode(s.reset.bind(s),n,o),c.interval=this._method_timeout/2,a.timer=s):s=null,[c.resolve,a.resolve]=this._encode_callback("resolve",e,n,i,s,o),[c.reject,a.reject]=this._encode_callback("reject",t,n,i,s,o),c}async _send_chunks(e,t,n){let i=await this.get_remote_service(`${t}:built-in`);Object(r.assert)(i.message_cache,"Remote client does not support message caching for long message.");let s=i.message_cache,a=n||Object(r.randId)();await s.create(a,!!n);let c=e.length,l=Math.ceil(c/o);for(let t=0;t<l;t++){let r=t*o;await s.append(a,e.slice(r,r+o),!!n)}await s.process(a,!!n)}emit(e,t){Object(r.assert)("object"==typeof e&&e.type,"Invalid message, must be an object with a type field.");let n=Object(i.encode)(e);if(t){const e=Object(i.encode)(t);n=new Uint8Array([...n,...e])}if(n.length<=513024)return this._emit_message(n);throw new Error("Message is too large to send in one go.")}_generate_remote_method(e,t,n,s,o){let a=e._rtarget;s&&!a.includes("/")&&(s!==a&&(a=s+"/"+a),e._rtarget=a);let c=e._rmethod,l=e._rpromise;const d=this;function h(){return new Promise((async(e,s)=>{let h=Object(r.randId)();n&&(h=n+"."+h);let p=d._get_session_store(h,!0);if(!p)return void s(new Error(`Runtime Error: Failed to get session store ${h}`));p.target_id=a;const f=await d._encode(Array.prototype.slice.call(arguments),h,o),_=f.length,m=_>0&&"object"==typeof f[_-1]&&null!==f[_-1]&&f[_-1]._rkwargs;m&&delete f[_-1]._rkwargs;let y={type:"method",from:d._local_workspace?d._local_workspace+"/"+d._client_id:d._client_id,to:a,method:c},g={};f&&(g.args=f),m&&(g.with_kwargs=m),t&&(y.parent=t);let b=null;if(l){y.session=h;let t=`${a}:${c}`;b=new u(d._method_timeout,s,[`Method call time out: ${t}`],t);let n=!0;for(let e of f)if("object"==typeof e&&!0===e._rintf){n=!1;break}g.promise=await d._encode_promise(e,s,h,n,b,o)}let w=Object(i.encode)(y);if(g){const e=Object(i.encode)(g);w=new Uint8Array([...w,...e])}w.length<=513024?d._emit_message(w).then((function(){b&&b.start()})):d._send_chunks(w,a,t).then((function(){b&&b.start()}))}))}h.__rpc_object__=e;const p=c.split(".");return h.__name__=p[p.length-1],h.__doc__=e._rdoc,h.__sig__=e._rsig,h}async _notify_service_update(){if(this.manager_id)try{await this.get_manager_service(30),Object(r.assert)(this._manager_service),await this._manager_service.update_client_info(this.get_client_info())}catch(e){console.warn("Failed to notify service update to",this.manager_id,e)}}get_client_info(){const e=[];for(let t of Object.values(this._services))e.push({id:`${this._client_id}:${t.id}`,type:t.type,name:t.name,description:t.description||"",config:t.config});return{id:this._client_id,services:e}}async _handle_method(e){let t=null;try{Object(r.assert)(e.method&&e.ctx&&e.from);const n=e.from+":"+e.method,i=e.from.split("/")[0];e.to=e.to.includes("/")?e.to:i+"/"+e.to,e.ctx.to=e.to;const s=e.to.split("/")[0],o=e.parent;let a,c,u,d;if(e.promise){const h=await this._decode(e.promise,e.session,o,i,s);if(a=h.resolve,c=h.reject,h.heartbeat&&h.interval){async function p(){try{await h.heartbeat()}catch(e){console.error(e)}}t=setInterval(p,1e3*h.interval)}}try{u=l(this._object_store,e.method)}catch(f){throw console.debug("Failed to find method",n,f),new Error(`Method not found: ${n}`)}if(Object(r.assert)(u&&"function"==typeof u,"Invalid method: "+n),this._method_annotations.has(u)){if("protected"===this._method_annotations.get(u).visibility&&s!==i)throw new Error("Permission denied for protected method "+n+", workspace mismatch: "+s+" != "+i)}else{let _=this._object_store[e.method.split(".")[0]].target_id;if(s===i&&_&&-1===_.indexOf("/")&&(_=s+"/"+_),_!==e.from)throw new Error("Access denied for method call ("+n+") from "+e.from)}if(o&&Object(r.assert)(null!==this._get_session_store(o,!0),"Parent session was closed: "+o),d=e.args?await this._decode(e.args,e.session,null,i,null):[],this._method_annotations.has(u)&&this._method_annotations.get(u).require_context&&d.push(e.ctx),e.promise){const m=u.apply(null,d);m instanceof Promise?m.then((e=>{a(e),clearInterval(t)})).catch((e=>{c(e),clearInterval(t)})):(a(m),clearInterval(t))}else u.apply(null,d),clearInterval(t)}catch(y){console.error("Error during calling method: ",y),clearInterval(t)}}encode(e,t){return this._encode(e,t)}_get_session_store(e,t){let n=this._object_store;const r=e.split(".");if(t){const e=r.length-1;for(let t of r.slice(0,e)){if(!n[t])return null;n=n[t]}return n[r[e]]||(n[r[e]]={}),n[r[e]]}for(let e of r){if(!n[e])return null;n=n[e]}return n}async _encode(e,t,n){const i=typeof e;if("number"===i||"string"===i||"boolean"===i||null==e||e instanceof Uint8Array)return e;if(e instanceof ArrayBuffer)return{_rtype:"memoryview",_rvalue:new Uint8Array(e)};if(e.__rpc_object__)return e.__rpc_object__;let s;if(e.constructor instanceof Object&&e._rtype){const c=e._rtype;return delete e._rtype,s=await this._encode(e,t,n),s._rtype=c,s}if("function"==typeof e){if(this._method_annotations.has(e)){let l=this._method_annotations.get(e);s={_rtype:"method",_rtarget:this._client_id,_rmethod:l.method_id,_rpromise:!0}}else{let u;Object(r.assert)("string"==typeof t),u=e.__name__?`${Object(r.randId)()}-${e.__name__}`:Object(r.randId)(),s={_rtype:"method",_rtarget:this._client_id,_rmethod:`${t}.${u}`,_rpromise:!0};let d=this._get_session_store(t,!0);Object(r.assert)(null!==d,`Failed to create session store ${t} due to invalid parent`),d[u]=e}if(s._rdoc=e.__doc__,s._rsig=e.__sig__,!s._rdoc||!s._rsig)try{const h=function(e){const t=e.toString(),n=t.match(/function\s*(\w*)/),r=n&&n[1]||"",i=t.match(/\(([^)]*)\)/);let s="";i&&(s=i[1].split(",").map((e=>e.replace(/\/\*.*?\*\//g,"").replace(/\/\/.*$/g,""))).filter((e=>e.trim().length>0)).map((e=>e.trim())).join(", "));let o=t.match(/\)\s*\{\s*\/\*([\s\S]*?)\*\//);const a=o&&o[1].trim()||"";o=t.match(/\)\s*\{\s*(\/\/[\s\S]*?)\n\s*[^\s\/]/);const c=o&&o[1].split("\n").map((e=>e.replace(/^\/\/\s*/,"").trim())).join("\n")||"",l=a||c;return r&&s.length>0&&{name:r,sig:s,doc:l}}(e);h&&!s._rdoc&&(s._rdoc=`${h.doc}`),h&&!s._rsig&&(s._rsig=`${h.name}(${h.sig})`)}catch(p){console.error("Failed to extract function docstring:",e)}return s}const o=Array.isArray(e);for(let f of Object.keys(this._codecs)){const _=this._codecs[f];if(_.encoder&&e instanceof _.type){let m=await Promise.resolve(_.encoder(e));if(m&&!m._rtype&&(m._rtype=_.name),"object"==typeof m){const y=m._rtype;delete m._rtype,m=await this._encode(m,t,n),m._rtype=y}return s=m,s}}if("undefined"!=typeof tf&&tf.Tensor&&e instanceof tf.Tensor){const g=e.dataSync();s={_rtype:"ndarray",_rvalue:new Uint8Array(g.buffer),_rshape:e.shape,_rdtype:e.dtype}}else if("undefined"!=typeof nj&&nj.NdArray&&e instanceof nj.NdArray){const b=Object(r.typedArrayToDtype)(e.selection.data);s={_rtype:"ndarray",_rvalue:new Uint8Array(e.selection.data.buffer),_rshape:e.shape,_rdtype:b}}else if(e instanceof Error)console.error(e),s={_rtype:"error",_rvalue:e.toString(),_rtrace:e.stack};else if(e!==Object(e)||e instanceof Boolean||e instanceof String||e instanceof Date||e instanceof RegExp||e instanceof ImageData||"undefined"!=typeof FileList&&e instanceof FileList||"undefined"!=typeof FileSystemDirectoryHandle&&e instanceof FileSystemDirectoryHandle||"undefined"!=typeof FileSystemFileHandle&&e instanceof FileSystemFileHandle||"undefined"!=typeof FileSystemHandle&&e instanceof FileSystemHandle||"undefined"!=typeof FileSystemWritableFileStream&&e instanceof FileSystemWritableFileStream)s=e;else if(e instanceof Blob){let w=0;async function v(t){let n;n=t?e.slice(w,w+t):e.slice(w);const r=new Uint8Array(await n.arrayBuffer());return w+=r.byteLength,r}function k(e){w=e}s={_rtype:"iostream",_rnative:"js:blob",type:e.type,name:e.name,size:e.size,path:e._path||e.webkitRelativePath,read:await this._encode(v,t,n),seek:await this._encode(k,t,n)}}else if(e instanceof a){const j=Object(r.typedArrayToDtype)(e);s={_rtype:"typedarray",_rvalue:new Uint8Array(e.buffer),_rdtype:j}}else if(e instanceof DataView)s={_rtype:"memoryview",_rvalue:new Uint8Array(e.buffer)};else if(e instanceof Set)s={_rtype:"set",_rvalue:await this._encode(Array.from(e),t,n)};else if(e instanceof Map)s={_rtype:"orderedmap",_rvalue:await this._encode(Array.from(e),t,n)};else{if(!(e.constructor instanceof Object||Array.isArray(e)))throw`imjoy-rpc: Unsupported data type: ${e}, you can register a custom codec to encode/decode the object.`;{s=o?[]:{};const E=Object.keys(e);for(let O of E)s[O]=await this._encode(e[O],t,n)}}if(!s)throw new Error("Failed to encode object");return s}async decode(e){return await this._decode(e)}async _decode(e,t,n,i,s){if(!e)return e;let o;if(e._rtype)if(this._codecs[e._rtype]&&this._codecs[e._rtype].decoder){const r=e._rtype;delete e._rtype,(e=await this._decode(e,t,n,i,s))._rtype=r,o=await Promise.resolve(this._codecs[e._rtype].decoder(e))}else if("method"===e._rtype)o=this._generate_remote_method(e,t,n,i,s);else if("ndarray"===e._rtype)if("undefined"!=typeof nj&&nj.array)Array.isArray(e._rvalue)&&(e._rvalue=e._rvalue.reduce(c)),o=nj.array(new Uint8(e._rvalue),e._rdtype).reshape(e._rshape);else if("undefined"!=typeof tf&&tf.Tensor){Array.isArray(e._rvalue)&&(e._rvalue=e._rvalue.reduce(c));const t=r.dtypeToTypedArray[e._rdtype];o=tf.tensor(new t(e._rvalue),e._rshape,e._rdtype)}else o=e;else if("error"===e._rtype)o=new Error("RemoteError: "+e._rvalue+"\n"+(e._rtrace||""));else if("typedarray"===e._rtype){const t=r.dtypeToTypedArray[e._rdtype];if(!t)throw new Error("unsupported dtype: "+e._rdtype);o=new t(e._rvalue.buffer.slice(e._rvalue.byteOffset,e._rvalue.byteOffset+e._rvalue.byteLength))}else if("memoryview"===e._rtype)o=e._rvalue.buffer.slice(e._rvalue.byteOffset,e._rvalue.byteOffset+e._rvalue.byteLength);else if("iostream"===e._rtype){if("js:blob"===e._rnative){const r=await this._generate_remote_method(e.read,t,n,i,s),a=await r();o=new Blob([a],{type:e.type,name:e.name})}else{o={};for(let r of Object.keys(e))r.startsWith("_")||(o[r]=await this._decode(e[r],t,n,i,s))}o.__rpc_object__=e}else if("orderedmap"===e._rtype)o=new Map(await this._decode(e._rvalue,t,n,i,s));else if("set"===e._rtype)o=new Set(await this._decode(e._rvalue,t,n,i,s));else{const r=e._rtype;delete e._rtype,o=await this._decode(e,t,n,i,s),o._rtype=r}else if(e.constructor===Object||Array.isArray(e)){const r=Array.isArray(e);o=r?[]:{};for(let a of Object.keys(e))if(r||e.hasOwnProperty(a)){const r=e[a];o[a]=await this._decode(r,t,n,i,s)}}else o=e;if(void 0===o)throw new Error("Failed to decode object");return o}}},"./src/hypha/sse-client.js":function(e,t,n){n.r(t),n.d(t,"login",(function(){return c})),n.d(t,"connectToServer",(function(){return l}));var r=n("./src/hypha/rpc.js");n.d(t,"RPC",(function(){return r.RPC})),n.d(t,"API_VERSION",(function(){return r.API_VERSION}));var i=n("./src/hypha/utils.js");n.d(t,"loadRequirements",(function(){return i.loadRequirements}));var s=n("./src/hypha/webrtc-client.js");n.d(t,"getRTCService",(function(){return s.getRTCService})),n.d(t,"registerRTCService",(function(){return s.registerRTCService}));var o=n("./package.json");n.d(t,"VERSION",(function(){return o.version}));class a{constructor(e,t,n,r,s=120){Object(i.assert)(e&&t,"server_url and client_id are required"),e=e+"?client_id="+t,n&&(e+="&workspace="+n),r&&(e+="&token="+r),e+="&session_id="+Object(i.randId)(),this._events=null,this._handle_message=null,this._reconnection_token=null,this._server_url=e,this._timeout=1e3*s,this._opening=!1,this._retry_count=0,this._closing=!1}set_reconnection_token(e){this._reconnection_token=e}on_message(e){Object(i.assert)(e,"handler is required"),this._handle_message=e}open(){return this._opening||(this._opening=new Promise(((e,t)=>{const n=this._reconnection_token?`${this._server_url}&reconnection_token=${this._reconnection_token}`:this._server_url;console.info("Creating a new connection to ",n.split("?")[0]),this._events=new EventSource(n),this._events.onmessage=async e=>{const t=await function(e,t="application/octet-stream"){return fetch(`data:${t};base64,${e}`).then((e=>e.arrayBuffer()))}(e.data);this._handle_message(t)},this._events.onclose=e=>{console.log("eventsource closed"),this._closing||(console.log("Connection interrupted, retrying..."),this._retry_count++,setTimeout((()=>this.open()),this._timeout)),this._events=null,this._opening=!1,t("closed")},this._events.onerror=e=>{console.trace(),console.log("Error occurred in eventsource connection: ",e.message),t(e.toString())},this._events.onopen=t=>{e(!0)}}))),this._opening}async _send(e){await fetch(this._server_url,{method:"POST",mode:"cors",cache:"no-cache",credentials:"same-origin",headers:{"Content-Type":"octet-stream"},redirect:"follow",referrerPolicy:"no-referrer",body:e})}async emit_message(e){Object(i.assert)(this._handle_message,"No handler for message"),this._events&&this._events.readyState!==EventSource.CLOSED||await this.open(),await this._send(e)}disconnect(e){this._closing=!0;const t=this._events;this._events=null,t&&t.readyState===EventSource.OPEN&&t.close(),console.info(`EventSource connection disconnected (${e})`)}}async function c(e){const t=e.login_service_id||"public/*:hypha-login",n=e.login_timeout||120,r=e.login_callback,i=await l({name:"initial login client",server_url:e.server_url,method_timeout:n});try{const e=await i.get_service(t),s=await e.start();return r?await r(s):console.log(`Please open your browser and login at ${s.login_url}`),await e.check(s.key,n)}catch(e){throw e}finally{await i.disconnect()}}async function l(e){let t=e.client_id;t||(t=Object(i.randId)());let n=function(e){if(!e)throw new Error("server_url is required");return e.replace(/\/$/,"")+"/sse"}(e.server_url),o=new a(n,t,e.workspace,e.token,e.method_timeout||120);await o.open();const c=new r.RPC(o,{client_id:t,manager_id:"workspace-manager",default_context:{connection_type:"eventsource"},name:e.name,method_timeout:e.method_timeout}),l=await c.get_remote_service("workspace-manager:default",e.method_timeout);if(l.rpc=c,l.export=async function(t){t.id="default",t.name=e.name||t.id,await c.register_service(t,!0)},l.getPlugin=async function(e){return await l.get_service(e+":default")},l.listPlugins=l.listServices,l.disconnect=async function(){await c.disconnect(),await o.disconnect()},l.registerCodec=c.register_codec.bind(c),e.webrtc&&await Object(s.registerRTCService)(l,t+"-rtc",e.webrtc_config),l.get_service||l.getService){const e=l.get_service||l.getService;l.get_service=async function(t,n,r){Object(i.assert)([void 0,!0,!1,"auto"].includes(n),"webrtc must be true, false or 'auto'");const o=await e(t);if(!0===n||"auto"===n){if(o.id.includes(":")&&o.id.includes("/")){const e=o.id.split(":")[0];try{const t=await Object(s.getRTCService)(l,e+":"+e.split("/")[1]+"-rtc",r),n=await t.get_service(o.id.split(":")[1]);return n._webrtc=!0,n._peer=t,n._service=o,n}catch(e){console.warn("Failed to get webrtc service, using eventsource connection",e)}}if(!0===n)throw new Error("Failed to get the service via webrtc")}return o},l.getService=l.get_service}return l}},"./src/hypha/utils.js":function(module,__nested_webpack_exports__,__nested_webpack_require_162063__){function randId(){return Math.random().toString(36).substr(2,10)+(new Date).getTime()}__nested_webpack_require_162063__.r(__nested_webpack_exports__),__nested_webpack_require_162063__.d(__nested_webpack_exports__,"randId",(function(){return randId})),__nested_webpack_require_162063__.d(__nested_webpack_exports__,"dtypeToTypedArray",(function(){return dtypeToTypedArray})),__nested_webpack_require_162063__.d(__nested_webpack_exports__,"loadRequirementsInWindow",(function(){return loadRequirementsInWindow})),__nested_webpack_require_162063__.d(__nested_webpack_exports__,"loadRequirementsInWebworker",(function(){return loadRequirementsInWebworker})),__nested_webpack_require_162063__.d(__nested_webpack_exports__,"loadRequirements",(function(){return loadRequirements})),__nested_webpack_require_162063__.d(__nested_webpack_exports__,"normalizeConfig",(function(){return normalizeConfig})),__nested_webpack_require_162063__.d(__nested_webpack_exports__,"typedArrayToDtypeMapping",(function(){return typedArrayToDtypeMapping})),__nested_webpack_require_162063__.d(__nested_webpack_exports__,"typedArrayToDtype",(function(){return typedArrayToDtype})),__nested_webpack_require_162063__.d(__nested_webpack_exports__,"cacheRequirements",(function(){return cacheRequirements})),__nested_webpack_require_162063__.d(__nested_webpack_exports__,"setupServiceWorker",(function(){return setupServiceWorker})),__nested_webpack_require_162063__.d(__nested_webpack_exports__,"assert",(function(){return assert})),__nested_webpack_require_162063__.d(__nested_webpack_exports__,"urlJoin",(function(){return urlJoin})),__nested_webpack_require_162063__.d(__nested_webpack_exports__,"waitFor",(function(){return waitFor})),__nested_webpack_require_162063__.d(__nested_webpack_exports__,"MessageEmitter",(function(){return MessageEmitter}));const dtypeToTypedArray={int8:Int8Array,int16:Int16Array,int32:Int32Array,uint8:Uint8Array,uint16:Uint16Array,uint32:Uint32Array,float32:Float32Array,float64:Float64Array,array:Array};async function loadRequirementsInWindow(e){function t(e){return new Promise(((t,n)=>{var r=document.createElement("script");r.src=e,r.type="text/javascript",r.onload=t,r.onreadystatechange=function(){"loaded"!==this.readyState&&"complete"!==this.readyState||t()},r.onerror=n,document.head.appendChild(r)}))}async function n(){for(var e=Array.prototype.slice.call(arguments),n=e.length,r=0;r<n;r++)await t(e[r])}if(e&&(Array.isArray(e)||"string"==typeof e))try{var r;if(e="string"==typeof e?[e]:e,!Array.isArray(e))throw"unsupported requirements definition";for(var i=0;i<e.length;i++)e[i].toLowerCase().endsWith(".css")||e[i].startsWith("css:")?(e[i].startsWith("css:")&&(e[i]=e[i].slice(4)),(r=document.createElement("link")).rel="stylesheet",r.href=e[i],document.head.appendChild(r)):e[i].toLowerCase().endsWith(".mjs")||e[i].startsWith("mjs:")?(e[i].startsWith("mjs:")&&(e[i]=e[i].slice(4)),await import(e[i])):e[i].toLowerCase().endsWith(".js")||e[i].startsWith("js:")?(e[i].startsWith("js:")&&(e[i]=e[i].slice(3)),await n(e[i])):e[i].startsWith("http")?await n(e[i]):e[i].startsWith("cache:")||console.log("Unprocessed requirements url: "+e[i])}catch(t){throw"failed to import required scripts: "+e.toString()}}async function loadRequirementsInWebworker(e){if(e&&(Array.isArray(e)||"string"==typeof e))try{Array.isArray(e)||(e=[e]);for(var t=0;t<e.length;t++){if(e[t].toLowerCase().endsWith(".css")||e[t].startsWith("css:"))throw"unable to import css in a webworker";e[t].toLowerCase().endsWith(".js")||e[t].startsWith("js:")?(e[t].startsWith("js:")&&(e[t]=e[t].slice(3)),importScripts(e[t])):e[t].startsWith("http")?importScripts(e[t]):e[t].startsWith("cache:")||console.log("Unprocessed requirements url: "+e[t])}}catch(t){throw"failed to import required scripts: "+e.toString()}}function loadRequirements(e){return"undefined"!=typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope?loadRequirementsInWebworker(e):loadRequirementsInWindow(e)}function normalizeConfig(e){return e.version=e.version||"0.1.0",e.description=e.description||`[TODO: add description for ${e.name} ]`,e.type=e.type||"rpc-window",e.id=e.id||randId(),e.target_origin=e.target_origin||"*",e.allow_execution=e.allow_execution||!1,e=Object.keys(e).reduce(((t,n)=>("function"!=typeof e[n]&&(t[n]=e[n]),t)),{})}const typedArrayToDtypeMapping={Int8Array:"int8",Int16Array:"int16",Int32Array:"int32",Uint8Array:"uint8",Uint16Array:"uint16",Uint32Array:"uint32",Float32Array:"float32",Float64Array:"float64",Array:"array"},typedArrayToDtypeKeys=[];for(const arrType of Object.keys(typedArrayToDtypeMapping))typedArrayToDtypeKeys.push(eval(arrType));function typedArrayToDtype(e){let t=typedArrayToDtypeMapping[e.constructor.name];if(!t){const n=Object.getPrototypeOf(e);for(const e of typedArrayToDtypeKeys)if(n instanceof e){t=typedArrayToDtypeMapping[e.name];break}}return t}function cacheUrlInServiceWorker(e){return new Promise((function(t,n){const r={command:"add",url:e};if(!navigator.serviceWorker||!navigator.serviceWorker.register)return void n("Service worker is not supported.");const i=new MessageChannel;i.port1.onmessage=function(e){e.data&&e.data.error?n(e.data.error):t(e.data&&e.data.result)},navigator.serviceWorker&&navigator.serviceWorker.controller?navigator.serviceWorker.controller.postMessage(r,[i.port2]):n("Service worker controller is not available")}))}async function cacheRequirements(e){e=e||[],Array.isArray(e)||(e=[e]);for(let t of e)t.startsWith("js:")&&(t=t.slice(3)),t.startsWith("css:")&&(t=t.slice(4)),t.startsWith("cache:")&&(t=t.slice(6)),t.startsWith("http")&&await cacheUrlInServiceWorker(t).catch((e=>{console.error(e)}))}function setupServiceWorker(e,t,n){if("serviceWorker"in navigator){if(e=e||"/",navigator.serviceWorker.register(e+"plugin-service-worker.js").then((function(e){console.log("ServiceWorker registration successful with scope: ",e.scope)}),(function(e){console.log("ServiceWorker registration failed: ",e)})),t=t||"*",(n=n||cacheRequirements)&&"function"!=typeof n)throw new Error("config.cache_requirements must be a function");window.addEventListener("message",(function(e){if("*"===t||e.origin===t){const t=e.data;"cacheRequirements"===t.type&&n(t.requirements)}}))}}function assert(e,t){if(!e)throw new Error(t||"Assertion failed")}function urlJoin(...e){return e.join("/").replace(/[\/]+/g,"/").replace(/^(.+):\//,"$1://").replace(/^file:/,"file:/").replace(/\/(\?|&|#[^!])/g,"$1").replace(/\?/g,"&").replace("&","?")}function waitFor(e,t,n){let r;return Promise.race([e,new Promise(((e,i)=>r=setTimeout((()=>{i(n||"Timeout Error")}),1e3*t)))]).finally((()=>clearTimeout(r)))}class MessageEmitter{constructor(e){this._event_handlers={},this._once_handlers={},this._debug=e}emit(){throw new Error("emit is not implemented")}on(e,t){this._event_handlers[e]||(this._event_handlers[e]=[]),this._event_handlers[e].push(t)}once(e,t){t.___event_run_once=!0,this.on(e,t)}off(e,t){if(e||t){if(e&&!t)this._event_handlers[e]&&(this._event_handlers[e]=[]);else if(this._event_handlers[e]){const n=this._event_handlers[e].indexOf(t);n>=0&&this._event_handlers[e].splice(n,1)}}else this._event_handlers={}}_fire(e,t){if(this._event_handlers[e])for(var n=this._event_handlers[e].length;n--;){const r=this._event_handlers[e][n];try{r(t)}catch(e){console.error(e)}finally{r.___event_run_once&&this._event_handlers[e].splice(n,1)}}else this._debug&&console.warn("unhandled event",e,t)}}},"./src/hypha/webrtc-client.js":function(e,t,n){n.r(t),n.d(t,"getRTCService",(function(){return a})),n.d(t,"registerRTCService",(function(){return c}));var r=n("./src/hypha/rpc.js"),i=n("./src/hypha/utils.js");class s{constructor(e){this._data_channel=e,this._handle_message=null,this._reconnection_token=null,this._data_channel.onmessage=async e=>{let t=e.data;t instanceof Blob&&(t=await t.arrayBuffer()),this._handle_message(t)};const t=this;this._data_channel.onclose=function(){console.log("websocket closed"),t._data_channel=null}}set_reconnection_token(e){this._reconnection_token=e}on_message(e){Object(i.assert)(e,"handler is required"),this._handle_message=e}async emit_message(e){Object(i.assert)(this._handle_message,"No handler for message");try{this._data_channel.send(e)}catch(e){throw console.error(`Failed to send data, error: ${e}`),e}}async disconnect(e){this._data_channel=null,console.info(`data channel connection disconnected (${e})`)}}async function o(e){Object(i.assert)(e.channel,"No channel provided"),Object(i.assert)(e.workspace,"No workspace provided");const t=e.channel,n=e.client_id||Object(i.randId)(),o=new s(t);return e.context=e.context||{},e.context.connection_type="webrtc",new r.RPC(o,{client_id:n,manager_id:null,default_context:e.context,name:e.name,method_timeout:e.method_timeout||10,workspace:e.workspace})}async function a(e,t,n){(n=n||{}).peer_id=n.peer_id||Object(i.randId)();const r=new RTCPeerConnection({iceServers:n.ice_servers||[{urls:["stun:stun.l.google.com:19302"]}],sdpSemantics:"unified-plan"});return new Promise((async(i,s)=>{try{r.addEventListener("connectionstatechange",(()=>{"failed"===r.connectionState&&(r.close(),s(new Error("Connection failed")))}),!1),n.on_init&&(await n.on_init(r),delete n.on_init);let a=r.createDataChannel(n.peer_id,{ordered:!0});a.binaryType="arraybuffer";const c=await r.createOffer();await r.setLocalDescription(c);const l=await e.getService(t),u=await l.offer({sdp:r.localDescription.sdp,type:r.localDescription.type});a.onopen=()=>{n.channel=a,n.workspace=u.workspace,setTimeout((async()=>{const e=await o(n);async function t(t){return await e.get_remote_service(n.peer_id+":"+t)}r.rpc=e,r.get_service=t,r.getService=t,r.disconnect=async function(){await e.disconnect(),r.close()},r.register_codec=e.register_codec,r.registerCodec=e.register_codec,i(r)}),500)},a.onclose=()=>s(new Error("Data channel closed")),await r.setRemoteDescription(new RTCSessionDescription({sdp:u.sdp,type:u.type}))}catch(e){s(e)}}))}async function c(e,t,n){const r=(n=n||{visibility:"protected",require_context:!0}).on_init;delete n.on_init,await e.registerService({id:t,config:n,offer:(t,i)=>async function(e,t,n,r,i){n=n||{};let s=new RTCSessionDescription({sdp:e.sdp,type:e.type}),a=new RTCPeerConnection({iceServers:n.ice_servers||[{urls:["stun:stun.l.google.com:19302"]}],sdpSemantics:"unified-plan"});t&&a.addEventListener("datachannel",(async e=>{const n=e.channel;let r=null;i&&i.user&&(r={user:i.user}),(await o({channel:n,client_id:n.label,workspace:t.config.workspace,context:r}))._services=t.rpc._services})),r&&await r(a),await a.setRemoteDescription(s);let c=await a.createAnswer();return await a.setLocalDescription(c),{sdp:a.localDescription.sdp,type:a.localDescription.type,workspace:t.config.workspace}}(t,e,n,r,i)})}}})},module.exports=factory()},140:function(module){var factory;factory=function(){return function(e){var t={};function n(r){if(t[r])return t[r].exports;var i=t[r]={i:r,l:!1,exports:{}};return e[r].call(i.exports,i,i.exports,n),i.l=!0,i.exports}return n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)n.d(r,i,function(t){return e[t]}.bind(null,i));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s="./src/hypha/websocket-client.js")}({"./node_modules/@msgpack/msgpack/dist.es5+esm/CachedKeyDecoder.mjs":function(e,t,n){n.r(t),n.d(t,"CachedKeyDecoder",(function(){return i}));var r=n("./node_modules/@msgpack/msgpack/dist.es5+esm/utils/utf8.mjs"),i=function(){function e(e,t){void 0===e&&(e=16),void 0===t&&(t=16),this.maxKeyLength=e,this.maxLengthPerKey=t,this.hit=0,this.miss=0,this.caches=[];for(var n=0;n<this.maxKeyLength;n++)this.caches.push([])}return e.prototype.canBeCached=function(e){return e>0&&e<=this.maxKeyLength},e.prototype.find=function(e,t,n){e:for(var r=0,i=this.caches[n-1];r<i.length;r++){for(var s=i[r],o=s.bytes,a=0;a<n;a++)if(o[a]!==e[t+a])continue e;return s.str}return null},e.prototype.store=function(e,t){var n=this.caches[e.length-1],r={bytes:e,str:t};n.length>=this.maxLengthPerKey?n[Math.random()*n.length|0]=r:n.push(r)},e.prototype.decode=function(e,t,n){var i=this.find(e,t,n);if(null!=i)return this.hit++,i;this.miss++;var s=Object(r.utf8DecodeJs)(e,t,n),o=Uint8Array.prototype.slice.call(e,t,t+n);return this.store(o,s),s},e}()},"./node_modules/@msgpack/msgpack/dist.es5+esm/DecodeError.mjs":function(e,t,n){n.r(t),n.d(t,"DecodeError",(function(){return s}));var r,i=(r=function(e,t){return r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])},r(e,t)},function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function n(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}),s=function(e){function t(n){var r=e.call(this,n)||this,i=Object.create(t.prototype);return Object.setPrototypeOf(r,i),Object.defineProperty(r,"name",{configurable:!0,enumerable:!1,value:t.name}),r}return i(t,e),t}(Error)},"./node_modules/@msgpack/msgpack/dist.es5+esm/Decoder.mjs":function(e,t,n){n.r(t),n.d(t,"DataViewIndexOutOfBoundsError",(function(){return _})),n.d(t,"Decoder",(function(){return g}));var r=n("./node_modules/@msgpack/msgpack/dist.es5+esm/utils/prettyByte.mjs"),i=n("./node_modules/@msgpack/msgpack/dist.es5+esm/ExtensionCodec.mjs"),s=n("./node_modules/@msgpack/msgpack/dist.es5+esm/utils/int.mjs"),o=n("./node_modules/@msgpack/msgpack/dist.es5+esm/utils/utf8.mjs"),a=n("./node_modules/@msgpack/msgpack/dist.es5+esm/utils/typedArrays.mjs"),c=n("./node_modules/@msgpack/msgpack/dist.es5+esm/CachedKeyDecoder.mjs"),l=n("./node_modules/@msgpack/msgpack/dist.es5+esm/DecodeError.mjs"),u=function(e,t){var n,r,i,s,o={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return s={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function a(s){return function(a){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;o;)try{if(n=1,r&&(i=2&s[0]?r.return:s[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,s[1])).done)return i;switch(r=0,i&&(s=[2&s[0],i.value]),s[0]){case 0:case 1:i=s;break;case 4:return o.label++,{value:s[1],done:!1};case 5:o.label++,r=s[1],s=[0];continue;case 7:s=o.ops.pop(),o.trys.pop();continue;default:if(!((i=(i=o.trys).length>0&&i[i.length-1])||6!==s[0]&&2!==s[0])){o=0;continue}if(3===s[0]&&(!i||s[1]>i[0]&&s[1]<i[3])){o.label=s[1];break}if(6===s[0]&&o.label<i[1]){o.label=i[1],i=s;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(s);break}i[2]&&o.ops.pop(),o.trys.pop();continue}s=t.call(e,o)}catch(e){s=[6,e],r=0}finally{n=i=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,a])}}},d=function(e){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var t,n=e[Symbol.asyncIterator];return n?n.call(e):(e="function"==typeof __values?__values(e):e[Symbol.iterator](),t={},r("next"),r("throw"),r("return"),t[Symbol.asyncIterator]=function(){return this},t);function r(n){t[n]=e[n]&&function(t){return new Promise((function(r,i){!function(e,t,n,r){Promise.resolve(r).then((function(t){e({value:t,done:n})}),t)}(r,i,(t=e[n](t)).done,t.value)}))}}},h=function(e){return this instanceof h?(this.v=e,this):new h(e)},p=new DataView(new ArrayBuffer(0)),f=new Uint8Array(p.buffer),_=function(){try{p.getInt8(0)}catch(e){return e.constructor}throw new Error("never reached")}(),m=new _("Insufficient data"),y=new c.CachedKeyDecoder,g=function(){function e(e,t,n,r,o,a,c,l){void 0===e&&(e=i.ExtensionCodec.defaultCodec),void 0===t&&(t=void 0),void 0===n&&(n=s.UINT32_MAX),void 0===r&&(r=s.UINT32_MAX),void 0===o&&(o=s.UINT32_MAX),void 0===a&&(a=s.UINT32_MAX),void 0===c&&(c=s.UINT32_MAX),void 0===l&&(l=y),this.extensionCodec=e,this.context=t,this.maxStrLength=n,this.maxBinLength=r,this.maxArrayLength=o,this.maxMapLength=a,this.maxExtLength=c,this.keyDecoder=l,this.totalPos=0,this.pos=0,this.view=p,this.bytes=f,this.headByte=-1,this.stack=[]}return e.prototype.reinitializeState=function(){this.totalPos=0,this.headByte=-1,this.stack.length=0},e.prototype.setBuffer=function(e){this.bytes=Object(a.ensureUint8Array)(e),this.view=Object(a.createDataView)(this.bytes),this.pos=0},e.prototype.appendBuffer=function(e){if(-1!==this.headByte||this.hasRemaining(1)){var t=this.bytes.subarray(this.pos),n=Object(a.ensureUint8Array)(e),r=new Uint8Array(t.length+n.length);r.set(t),r.set(n,t.length),this.setBuffer(r)}else this.setBuffer(e)},e.prototype.hasRemaining=function(e){return this.view.byteLength-this.pos>=e},e.prototype.createExtraByteError=function(e){var t=this.view,n=this.pos;return new RangeError("Extra "+(t.byteLength-n)+" of "+t.byteLength+" byte(s) found at buffer["+e+"]")},e.prototype.decode=function(e){this.reinitializeState(),this.setBuffer(e);var t=this.doDecodeSync();if(this.hasRemaining(1))throw this.createExtraByteError(this.pos);return t},e.prototype.decodeMulti=function(e){return u(this,(function(t){switch(t.label){case 0:this.reinitializeState(),this.setBuffer(e),t.label=1;case 1:return this.hasRemaining(1)?[4,this.doDecodeSync()]:[3,3];case 2:return t.sent(),[3,1];case 3:return[2]}}))},e.prototype.decodeAsync=function(e){var t,n,i,s,o,a,c,l;return o=this,a=void 0,l=function(){var o,a,c,l,h,p,f,m;return u(this,(function(u){switch(u.label){case 0:o=!1,u.label=1;case 1:u.trys.push([1,6,7,12]),t=d(e),u.label=2;case 2:return[4,t.next()];case 3:if((n=u.sent()).done)return[3,5];if(c=n.value,o)throw this.createExtraByteError(this.totalPos);this.appendBuffer(c);try{a=this.doDecodeSync(),o=!0}catch(e){if(!(e instanceof _))throw e}this.totalPos+=this.pos,u.label=4;case 4:return[3,2];case 5:return[3,12];case 6:return l=u.sent(),i={error:l},[3,12];case 7:return u.trys.push([7,,10,11]),n&&!n.done&&(s=t.return)?[4,s.call(t)]:[3,9];case 8:u.sent(),u.label=9;case 9:return[3,11];case 10:if(i)throw i.error;return[7];case 11:return[7];case 12:if(o){if(this.hasRemaining(1))throw this.createExtraByteError(this.totalPos);return[2,a]}throw p=(h=this).headByte,f=h.pos,m=h.totalPos,new RangeError("Insufficient data in parsing "+Object(r.prettyByte)(p)+" at "+m+" ("+f+" in the current buffer)")}}))},new((c=void 0)||(c=Promise))((function(e,t){function n(e){try{i(l.next(e))}catch(e){t(e)}}function r(e){try{i(l.throw(e))}catch(e){t(e)}}function i(t){var i;t.done?e(t.value):(i=t.value,i instanceof c?i:new c((function(e){e(i)}))).then(n,r)}i((l=l.apply(o,a||[])).next())}))},e.prototype.decodeArrayStream=function(e){return this.decodeMultiAsync(e,!0)},e.prototype.decodeStream=function(e){return this.decodeMultiAsync(e,!1)},e.prototype.decodeMultiAsync=function(e,t){return function(e,t,n){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var r,i=n.apply(e,t||[]),s=[];return r={},o("next"),o("throw"),o("return"),r[Symbol.asyncIterator]=function(){return this},r;function o(e){i[e]&&(r[e]=function(t){return new Promise((function(n,r){s.push([e,t,n,r])>1||a(e,t)}))})}function a(e,t){try{(n=i[e](t)).value instanceof h?Promise.resolve(n.value.v).then(c,l):u(s[0][2],n)}catch(e){u(s[0][3],e)}var n}function c(e){a("next",e)}function l(e){a("throw",e)}function u(e,t){e(t),s.shift(),s.length&&a(s[0][0],s[0][1])}}(this,arguments,(function(){var n,r,i,s,o,a,c,l,p;return u(this,(function(u){switch(u.label){case 0:n=t,r=-1,u.label=1;case 1:u.trys.push([1,13,14,19]),i=d(e),u.label=2;case 2:return[4,h(i.next())];case 3:if((s=u.sent()).done)return[3,12];if(o=s.value,t&&0===r)throw this.createExtraByteError(this.totalPos);this.appendBuffer(o),n&&(r=this.readArraySize(),n=!1,this.complete()),u.label=4;case 4:u.trys.push([4,9,,10]),u.label=5;case 5:return[4,h(this.doDecodeSync())];case 6:return[4,u.sent()];case 7:return u.sent(),0==--r?[3,8]:[3,5];case 8:return[3,10];case 9:if(!((a=u.sent())instanceof _))throw a;return[3,10];case 10:this.totalPos+=this.pos,u.label=11;case 11:return[3,2];case 12:return[3,19];case 13:return c=u.sent(),l={error:c},[3,19];case 14:return u.trys.push([14,,17,18]),s&&!s.done&&(p=i.return)?[4,h(p.call(i))]:[3,16];case 15:u.sent(),u.label=16;case 16:return[3,18];case 17:if(l)throw l.error;return[7];case 18:return[7];case 19:return[2]}}))}))},e.prototype.doDecodeSync=function(){e:for(;;){var e=this.readHeadByte(),t=void 0;if(e>=224)t=e-256;else if(e<192)if(e<128)t=e;else if(e<144){if(0!=(i=e-128)){this.pushMapState(i),this.complete();continue e}t={}}else if(e<160){if(0!=(i=e-144)){this.pushArrayState(i),this.complete();continue e}t=[]}else{var n=e-160;t=this.decodeUtf8String(n,0)}else if(192===e)t=null;else if(194===e)t=!1;else if(195===e)t=!0;else if(202===e)t=this.readF32();else if(203===e)t=this.readF64();else if(204===e)t=this.readU8();else if(205===e)t=this.readU16();else if(206===e)t=this.readU32();else if(207===e)t=this.readU64();else if(208===e)t=this.readI8();else if(209===e)t=this.readI16();else if(210===e)t=this.readI32();else if(211===e)t=this.readI64();else if(217===e)n=this.lookU8(),t=this.decodeUtf8String(n,1);else if(218===e)n=this.lookU16(),t=this.decodeUtf8String(n,2);else if(219===e)n=this.lookU32(),t=this.decodeUtf8String(n,4);else if(220===e){if(0!==(i=this.readU16())){this.pushArrayState(i),this.complete();continue e}t=[]}else if(221===e){if(0!==(i=this.readU32())){this.pushArrayState(i),this.complete();continue e}t=[]}else if(222===e){if(0!==(i=this.readU16())){this.pushMapState(i),this.complete();continue e}t={}}else if(223===e){if(0!==(i=this.readU32())){this.pushMapState(i),this.complete();continue e}t={}}else if(196===e){var i=this.lookU8();t=this.decodeBinary(i,1)}else if(197===e)i=this.lookU16(),t=this.decodeBinary(i,2);else if(198===e)i=this.lookU32(),t=this.decodeBinary(i,4);else if(212===e)t=this.decodeExtension(1,0);else if(213===e)t=this.decodeExtension(2,0);else if(214===e)t=this.decodeExtension(4,0);else if(215===e)t=this.decodeExtension(8,0);else if(216===e)t=this.decodeExtension(16,0);else if(199===e)i=this.lookU8(),t=this.decodeExtension(i,1);else if(200===e)i=this.lookU16(),t=this.decodeExtension(i,2);else{if(201!==e)throw new l.DecodeError("Unrecognized type byte: "+Object(r.prettyByte)(e));i=this.lookU32(),t=this.decodeExtension(i,4)}this.complete();for(var s=this.stack;s.length>0;){var o=s[s.length-1];if(0===o.type){if(o.array[o.position]=t,o.position++,o.position!==o.size)continue e;s.pop(),t=o.array}else{if(1===o.type){if(void 0,"string"!=(a=typeof t)&&"number"!==a)throw new l.DecodeError("The type of key must be string or number but "+typeof t);if("__proto__"===t)throw new l.DecodeError("The key __proto__ is not allowed");o.key=t,o.type=2;continue e}if(o.map[o.key]=t,o.readCount++,o.readCount!==o.size){o.key=null,o.type=1;continue e}s.pop(),t=o.map}}return t}var a},e.prototype.readHeadByte=function(){return-1===this.headByte&&(this.headByte=this.readU8()),this.headByte},e.prototype.complete=function(){this.headByte=-1},e.prototype.readArraySize=function(){var e=this.readHeadByte();switch(e){case 220:return this.readU16();case 221:return this.readU32();default:if(e<160)return e-144;throw new l.DecodeError("Unrecognized array type byte: "+Object(r.prettyByte)(e))}},e.prototype.pushMapState=function(e){if(e>this.maxMapLength)throw new l.DecodeError("Max length exceeded: map length ("+e+") > maxMapLengthLength ("+this.maxMapLength+")");this.stack.push({type:1,size:e,key:null,readCount:0,map:{}})},e.prototype.pushArrayState=function(e){if(e>this.maxArrayLength)throw new l.DecodeError("Max length exceeded: array length ("+e+") > maxArrayLength ("+this.maxArrayLength+")");this.stack.push({type:0,size:e,array:new Array(e),position:0})},e.prototype.decodeUtf8String=function(e,t){var n;if(e>this.maxStrLength)throw new l.DecodeError("Max length exceeded: UTF-8 byte length ("+e+") > maxStrLength ("+this.maxStrLength+")");if(this.bytes.byteLength<this.pos+t+e)throw m;var r,i=this.pos+t;return r=this.stateIsMapKey()&&(null===(n=this.keyDecoder)||void 0===n?void 0:n.canBeCached(e))?this.keyDecoder.decode(this.bytes,i,e):e>o.TEXT_DECODER_THRESHOLD?Object(o.utf8DecodeTD)(this.bytes,i,e):Object(o.utf8DecodeJs)(this.bytes,i,e),this.pos+=t+e,r},e.prototype.stateIsMapKey=function(){return this.stack.length>0&&1===this.stack[this.stack.length-1].type},e.prototype.decodeBinary=function(e,t){if(e>this.maxBinLength)throw new l.DecodeError("Max length exceeded: bin length ("+e+") > maxBinLength ("+this.maxBinLength+")");if(!this.hasRemaining(e+t))throw m;var n=this.pos+t,r=this.bytes.subarray(n,n+e);return this.pos+=t+e,r},e.prototype.decodeExtension=function(e,t){if(e>this.maxExtLength)throw new l.DecodeError("Max length exceeded: ext length ("+e+") > maxExtLength ("+this.maxExtLength+")");var n=this.view.getInt8(this.pos+t),r=this.decodeBinary(e,t+1);return this.extensionCodec.decode(r,n,this.context)},e.prototype.lookU8=function(){return this.view.getUint8(this.pos)},e.prototype.lookU16=function(){return this.view.getUint16(this.pos)},e.prototype.lookU32=function(){return this.view.getUint32(this.pos)},e.prototype.readU8=function(){var e=this.view.getUint8(this.pos);return this.pos++,e},e.prototype.readI8=function(){var e=this.view.getInt8(this.pos);return this.pos++,e},e.prototype.readU16=function(){var e=this.view.getUint16(this.pos);return this.pos+=2,e},e.prototype.readI16=function(){var e=this.view.getInt16(this.pos);return this.pos+=2,e},e.prototype.readU32=function(){var e=this.view.getUint32(this.pos);return this.pos+=4,e},e.prototype.readI32=function(){var e=this.view.getInt32(this.pos);return this.pos+=4,e},e.prototype.readU64=function(){var e=Object(s.getUint64)(this.view,this.pos);return this.pos+=8,e},e.prototype.readI64=function(){var e=Object(s.getInt64)(this.view,this.pos);return this.pos+=8,e},e.prototype.readF32=function(){var e=this.view.getFloat32(this.pos);return this.pos+=4,e},e.prototype.readF64=function(){var e=this.view.getFloat64(this.pos);return this.pos+=8,e},e}()},"./node_modules/@msgpack/msgpack/dist.es5+esm/Encoder.mjs":function(e,t,n){n.r(t),n.d(t,"DEFAULT_MAX_DEPTH",(function(){return a})),n.d(t,"DEFAULT_INITIAL_BUFFER_SIZE",(function(){return c})),n.d(t,"Encoder",(function(){return l}));var r=n("./node_modules/@msgpack/msgpack/dist.es5+esm/utils/utf8.mjs"),i=n("./node_modules/@msgpack/msgpack/dist.es5+esm/ExtensionCodec.mjs"),s=n("./node_modules/@msgpack/msgpack/dist.es5+esm/utils/int.mjs"),o=n("./node_modules/@msgpack/msgpack/dist.es5+esm/utils/typedArrays.mjs"),a=100,c=2048,l=function(){function e(e,t,n,r,s,o,l,u){void 0===e&&(e=i.ExtensionCodec.defaultCodec),void 0===t&&(t=void 0),void 0===n&&(n=a),void 0===r&&(r=c),void 0===s&&(s=!1),void 0===o&&(o=!1),void 0===l&&(l=!1),void 0===u&&(u=!1),this.extensionCodec=e,this.context=t,this.maxDepth=n,this.initialBufferSize=r,this.sortKeys=s,this.forceFloat32=o,this.ignoreUndefined=l,this.forceIntegerToFloat=u,this.pos=0,this.view=new DataView(new ArrayBuffer(this.initialBufferSize)),this.bytes=new Uint8Array(this.view.buffer)}return e.prototype.getUint8Array=function(){return this.bytes.subarray(0,this.pos)},e.prototype.reinitializeState=function(){this.pos=0},e.prototype.encode=function(e){return this.reinitializeState(),this.doEncode(e,1),this.getUint8Array()},e.prototype.doEncode=function(e,t){if(t>this.maxDepth)throw new Error("Too deep objects in depth "+t);null==e?this.encodeNil():"boolean"==typeof e?this.encodeBoolean(e):"number"==typeof e?this.encodeNumber(e):"string"==typeof e?this.encodeString(e):this.encodeObject(e,t)},e.prototype.ensureBufferSizeToWrite=function(e){var t=this.pos+e;this.view.byteLength<t&&this.resizeBuffer(2*t)},e.prototype.resizeBuffer=function(e){var t=new ArrayBuffer(e),n=new Uint8Array(t),r=new DataView(t);n.set(this.bytes),this.view=r,this.bytes=n},e.prototype.encodeNil=function(){this.writeU8(192)},e.prototype.encodeBoolean=function(e){!1===e?this.writeU8(194):this.writeU8(195)},e.prototype.encodeNumber=function(e){Number.isSafeInteger(e)&&!this.forceIntegerToFloat?e>=0?e<128?this.writeU8(e):e<256?(this.writeU8(204),this.writeU8(e)):e<65536?(this.writeU8(205),this.writeU16(e)):e<4294967296?(this.writeU8(206),this.writeU32(e)):(this.writeU8(207),this.writeU64(e)):e>=-32?this.writeU8(224|e+32):e>=-128?(this.writeU8(208),this.writeI8(e)):e>=-32768?(this.writeU8(209),this.writeI16(e)):e>=-2147483648?(this.writeU8(210),this.writeI32(e)):(this.writeU8(211),this.writeI64(e)):this.forceFloat32?(this.writeU8(202),this.writeF32(e)):(this.writeU8(203),this.writeF64(e))},e.prototype.writeStringHeader=function(e){if(e<32)this.writeU8(160+e);else if(e<256)this.writeU8(217),this.writeU8(e);else if(e<65536)this.writeU8(218),this.writeU16(e);else{if(!(e<4294967296))throw new Error("Too long string: "+e+" bytes in UTF-8");this.writeU8(219),this.writeU32(e)}},e.prototype.encodeString=function(e){if(e.length>r.TEXT_ENCODER_THRESHOLD){var t=Object(r.utf8Count)(e);this.ensureBufferSizeToWrite(5+t),this.writeStringHeader(t),Object(r.utf8EncodeTE)(e,this.bytes,this.pos),this.pos+=t}else t=Object(r.utf8Count)(e),this.ensureBufferSizeToWrite(5+t),this.writeStringHeader(t),Object(r.utf8EncodeJs)(e,this.bytes,this.pos),this.pos+=t},e.prototype.encodeObject=function(e,t){var n=this.extensionCodec.tryToEncode(e,this.context);if(null!=n)this.encodeExtension(n);else if(Array.isArray(e))this.encodeArray(e,t);else if(ArrayBuffer.isView(e))this.encodeBinary(e);else{if("object"!=typeof e)throw new Error("Unrecognized object: "+Object.prototype.toString.apply(e));this.encodeMap(e,t)}},e.prototype.encodeBinary=function(e){var t=e.byteLength;if(t<256)this.writeU8(196),this.writeU8(t);else if(t<65536)this.writeU8(197),this.writeU16(t);else{if(!(t<4294967296))throw new Error("Too large binary: "+t);this.writeU8(198),this.writeU32(t)}var n=Object(o.ensureUint8Array)(e);this.writeU8a(n)},e.prototype.encodeArray=function(e,t){var n=e.length;if(n<16)this.writeU8(144+n);else if(n<65536)this.writeU8(220),this.writeU16(n);else{if(!(n<4294967296))throw new Error("Too large array: "+n);this.writeU8(221),this.writeU32(n)}for(var r=0,i=e;r<i.length;r++){var s=i[r];this.doEncode(s,t+1)}},e.prototype.countWithoutUndefined=function(e,t){for(var n=0,r=0,i=t;r<i.length;r++)void 0!==e[i[r]]&&n++;return n},e.prototype.encodeMap=function(e,t){var n=Object.keys(e);this.sortKeys&&n.sort();var r=this.ignoreUndefined?this.countWithoutUndefined(e,n):n.length;if(r<16)this.writeU8(128+r);else if(r<65536)this.writeU8(222),this.writeU16(r);else{if(!(r<4294967296))throw new Error("Too large map object: "+r);this.writeU8(223),this.writeU32(r)}for(var i=0,s=n;i<s.length;i++){var o=s[i],a=e[o];this.ignoreUndefined&&void 0===a||(this.encodeString(o),this.doEncode(a,t+1))}},e.prototype.encodeExtension=function(e){var t=e.data.length;if(1===t)this.writeU8(212);else if(2===t)this.writeU8(213);else if(4===t)this.writeU8(214);else if(8===t)this.writeU8(215);else if(16===t)this.writeU8(216);else if(t<256)this.writeU8(199),this.writeU8(t);else if(t<65536)this.writeU8(200),this.writeU16(t);else{if(!(t<4294967296))throw new Error("Too large extension object: "+t);this.writeU8(201),this.writeU32(t)}this.writeI8(e.type),this.writeU8a(e.data)},e.prototype.writeU8=function(e){this.ensureBufferSizeToWrite(1),this.view.setUint8(this.pos,e),this.pos++},e.prototype.writeU8a=function(e){var t=e.length;this.ensureBufferSizeToWrite(t),this.bytes.set(e,this.pos),this.pos+=t},e.prototype.writeI8=function(e){this.ensureBufferSizeToWrite(1),this.view.setInt8(this.pos,e),this.pos++},e.prototype.writeU16=function(e){this.ensureBufferSizeToWrite(2),this.view.setUint16(this.pos,e),this.pos+=2},e.prototype.writeI16=function(e){this.ensureBufferSizeToWrite(2),this.view.setInt16(this.pos,e),this.pos+=2},e.prototype.writeU32=function(e){this.ensureBufferSizeToWrite(4),this.view.setUint32(this.pos,e),this.pos+=4},e.prototype.writeI32=function(e){this.ensureBufferSizeToWrite(4),this.view.setInt32(this.pos,e),this.pos+=4},e.prototype.writeF32=function(e){this.ensureBufferSizeToWrite(4),this.view.setFloat32(this.pos,e),this.pos+=4},e.prototype.writeF64=function(e){this.ensureBufferSizeToWrite(8),this.view.setFloat64(this.pos,e),this.pos+=8},e.prototype.writeU64=function(e){this.ensureBufferSizeToWrite(8),Object(s.setUint64)(this.view,this.pos,e),this.pos+=8},e.prototype.writeI64=function(e){this.ensureBufferSizeToWrite(8),Object(s.setInt64)(this.view,this.pos,e),this.pos+=8},e}()},"./node_modules/@msgpack/msgpack/dist.es5+esm/ExtData.mjs":function(e,t,n){n.r(t),n.d(t,"ExtData",(function(){return r}));var r=function(e,t){this.type=e,this.data=t}},"./node_modules/@msgpack/msgpack/dist.es5+esm/ExtensionCodec.mjs":function(e,t,n){n.r(t),n.d(t,"ExtensionCodec",(function(){return s}));var r=n("./node_modules/@msgpack/msgpack/dist.es5+esm/ExtData.mjs"),i=n("./node_modules/@msgpack/msgpack/dist.es5+esm/timestamp.mjs"),s=function(){function e(){this.builtInEncoders=[],this.builtInDecoders=[],this.encoders=[],this.decoders=[],this.register(i.timestampExtension)}return e.prototype.register=function(e){var t=e.type,n=e.encode,r=e.decode;if(t>=0)this.encoders[t]=n,this.decoders[t]=r;else{var i=1+t;this.builtInEncoders[i]=n,this.builtInDecoders[i]=r}},e.prototype.tryToEncode=function(e,t){for(var n=0;n<this.builtInEncoders.length;n++)if(null!=(s=this.builtInEncoders[n])&&null!=(o=s(e,t))){var i=-1-n;return new r.ExtData(i,o)}for(n=0;n<this.encoders.length;n++){var s,o;if(null!=(s=this.encoders[n])&&null!=(o=s(e,t)))return i=n,new r.ExtData(i,o)}return e instanceof r.ExtData?e:null},e.prototype.decode=function(e,t,n){var i=t<0?this.builtInDecoders[-1-t]:this.decoders[t];return i?i(e,t,n):new r.ExtData(t,e)},e.defaultCodec=new e,e}()},"./node_modules/@msgpack/msgpack/dist.es5+esm/decode.mjs":function(e,t,n){n.r(t),n.d(t,"defaultDecodeOptions",(function(){return i})),n.d(t,"decode",(function(){return s})),n.d(t,"decodeMulti",(function(){return o}));var r=n("./node_modules/@msgpack/msgpack/dist.es5+esm/Decoder.mjs"),i={};function s(e,t){return void 0===t&&(t=i),new r.Decoder(t.extensionCodec,t.context,t.maxStrLength,t.maxBinLength,t.maxArrayLength,t.maxMapLength,t.maxExtLength).decode(e)}function o(e,t){return void 0===t&&(t=i),new r.Decoder(t.extensionCodec,t.context,t.maxStrLength,t.maxBinLength,t.maxArrayLength,t.maxMapLength,t.maxExtLength).decodeMulti(e)}},"./node_modules/@msgpack/msgpack/dist.es5+esm/decodeAsync.mjs":function(e,t,n){n.r(t),n.d(t,"decodeAsync",(function(){return c})),n.d(t,"decodeArrayStream",(function(){return l})),n.d(t,"decodeMultiStream",(function(){return u})),n.d(t,"decodeStream",(function(){return d}));var r=n("./node_modules/@msgpack/msgpack/dist.es5+esm/Decoder.mjs"),i=n("./node_modules/@msgpack/msgpack/dist.es5+esm/utils/stream.mjs"),s=n("./node_modules/@msgpack/msgpack/dist.es5+esm/decode.mjs"),o=function(e,t,n,r){return new(n||(n=Promise))((function(i,s){function o(e){try{c(r.next(e))}catch(e){s(e)}}function a(e){try{c(r.throw(e))}catch(e){s(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}c((r=r.apply(e,t||[])).next())}))},a=function(e,t){var n,r,i,s,o={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return s={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function a(s){return function(a){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;o;)try{if(n=1,r&&(i=2&s[0]?r.return:s[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,s[1])).done)return i;switch(r=0,i&&(s=[2&s[0],i.value]),s[0]){case 0:case 1:i=s;break;case 4:return o.label++,{value:s[1],done:!1};case 5:o.label++,r=s[1],s=[0];continue;case 7:s=o.ops.pop(),o.trys.pop();continue;default:if(!((i=(i=o.trys).length>0&&i[i.length-1])||6!==s[0]&&2!==s[0])){o=0;continue}if(3===s[0]&&(!i||s[1]>i[0]&&s[1]<i[3])){o.label=s[1];break}if(6===s[0]&&o.label<i[1]){o.label=i[1],i=s;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(s);break}i[2]&&o.ops.pop(),o.trys.pop();continue}s=t.call(e,o)}catch(e){s=[6,e],r=0}finally{n=i=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,a])}}};function c(e,t){return void 0===t&&(t=s.defaultDecodeOptions),o(this,void 0,void 0,(function(){var n;return a(this,(function(s){return n=Object(i.ensureAsyncIterable)(e),[2,new r.Decoder(t.extensionCodec,t.context,t.maxStrLength,t.maxBinLength,t.maxArrayLength,t.maxMapLength,t.maxExtLength).decodeAsync(n)]}))}))}function l(e,t){void 0===t&&(t=s.defaultDecodeOptions);var n=Object(i.ensureAsyncIterable)(e);return new r.Decoder(t.extensionCodec,t.context,t.maxStrLength,t.maxBinLength,t.maxArrayLength,t.maxMapLength,t.maxExtLength).decodeArrayStream(n)}function u(e,t){void 0===t&&(t=s.defaultDecodeOptions);var n=Object(i.ensureAsyncIterable)(e);return new r.Decoder(t.extensionCodec,t.context,t.maxStrLength,t.maxBinLength,t.maxArrayLength,t.maxMapLength,t.maxExtLength).decodeStream(n)}function d(e,t){return void 0===t&&(t=s.defaultDecodeOptions),u(e,t)}},"./node_modules/@msgpack/msgpack/dist.es5+esm/encode.mjs":function(e,t,n){n.r(t),n.d(t,"encode",(function(){return s}));var r=n("./node_modules/@msgpack/msgpack/dist.es5+esm/Encoder.mjs"),i={};function s(e,t){return void 0===t&&(t=i),new r.Encoder(t.extensionCodec,t.context,t.maxDepth,t.initialBufferSize,t.sortKeys,t.forceFloat32,t.ignoreUndefined,t.forceIntegerToFloat).encode(e)}},"./node_modules/@msgpack/msgpack/dist.es5+esm/index.mjs":function(e,t,n){n.r(t);var r=n("./node_modules/@msgpack/msgpack/dist.es5+esm/encode.mjs");n.d(t,"encode",(function(){return r.encode}));var i=n("./node_modules/@msgpack/msgpack/dist.es5+esm/decode.mjs");n.d(t,"decode",(function(){return i.decode})),n.d(t,"decodeMulti",(function(){return i.decodeMulti}));var s=n("./node_modules/@msgpack/msgpack/dist.es5+esm/decodeAsync.mjs");n.d(t,"decodeAsync",(function(){return s.decodeAsync})),n.d(t,"decodeArrayStream",(function(){return s.decodeArrayStream})),n.d(t,"decodeMultiStream",(function(){return s.decodeMultiStream})),n.d(t,"decodeStream",(function(){return s.decodeStream}));var o=n("./node_modules/@msgpack/msgpack/dist.es5+esm/Decoder.mjs");n.d(t,"Decoder",(function(){return o.Decoder})),n.d(t,"DataViewIndexOutOfBoundsError",(function(){return o.DataViewIndexOutOfBoundsError}));var a=n("./node_modules/@msgpack/msgpack/dist.es5+esm/DecodeError.mjs");n.d(t,"DecodeError",(function(){return a.DecodeError}));var c=n("./node_modules/@msgpack/msgpack/dist.es5+esm/Encoder.mjs");n.d(t,"Encoder",(function(){return c.Encoder}));var l=n("./node_modules/@msgpack/msgpack/dist.es5+esm/ExtensionCodec.mjs");n.d(t,"ExtensionCodec",(function(){return l.ExtensionCodec}));var u=n("./node_modules/@msgpack/msgpack/dist.es5+esm/ExtData.mjs");n.d(t,"ExtData",(function(){return u.ExtData}));var d=n("./node_modules/@msgpack/msgpack/dist.es5+esm/timestamp.mjs");n.d(t,"EXT_TIMESTAMP",(function(){return d.EXT_TIMESTAMP})),n.d(t,"encodeDateToTimeSpec",(function(){return d.encodeDateToTimeSpec})),n.d(t,"encodeTimeSpecToTimestamp",(function(){return d.encodeTimeSpecToTimestamp})),n.d(t,"decodeTimestampToTimeSpec",(function(){return d.decodeTimestampToTimeSpec})),n.d(t,"encodeTimestampExtension",(function(){return d.encodeTimestampExtension})),n.d(t,"decodeTimestampExtension",(function(){return d.decodeTimestampExtension}))},"./node_modules/@msgpack/msgpack/dist.es5+esm/timestamp.mjs":function(e,t,n){n.r(t),n.d(t,"EXT_TIMESTAMP",(function(){return s})),n.d(t,"encodeTimeSpecToTimestamp",(function(){return c})),n.d(t,"encodeDateToTimeSpec",(function(){return l})),n.d(t,"encodeTimestampExtension",(function(){return u})),n.d(t,"decodeTimestampToTimeSpec",(function(){return d})),n.d(t,"decodeTimestampExtension",(function(){return h})),n.d(t,"timestampExtension",(function(){return p}));var r=n("./node_modules/@msgpack/msgpack/dist.es5+esm/DecodeError.mjs"),i=n("./node_modules/@msgpack/msgpack/dist.es5+esm/utils/int.mjs"),s=-1,o=4294967295,a=17179869183;function c(e){var t,n=e.sec,r=e.nsec;if(n>=0&&r>=0&&n<=a){if(0===r&&n<=o){var s=new Uint8Array(4);return(t=new DataView(s.buffer)).setUint32(0,n),s}var c=n/4294967296,l=4294967295&n;return s=new Uint8Array(8),(t=new DataView(s.buffer)).setUint32(0,r<<2|3&c),t.setUint32(4,l),s}return s=new Uint8Array(12),(t=new DataView(s.buffer)).setUint32(0,r),Object(i.setInt64)(t,4,n),s}function l(e){var t=e.getTime(),n=Math.floor(t/1e3),r=1e6*(t-1e3*n),i=Math.floor(r/1e9);return{sec:n+i,nsec:r-1e9*i}}function u(e){return e instanceof Date?c(l(e)):null}function d(e){var t=new DataView(e.buffer,e.byteOffset,e.byteLength);switch(e.byteLength){case 4:return{sec:t.getUint32(0),nsec:0};case 8:var n=t.getUint32(0);return{sec:4294967296*(3&n)+t.getUint32(4),nsec:n>>>2};case 12:return{sec:Object(i.getInt64)(t,4),nsec:t.getUint32(0)};default:throw new r.DecodeError("Unrecognized data size for timestamp (expected 4, 8, or 12): "+e.length)}}function h(e){var t=d(e);return new Date(1e3*t.sec+t.nsec/1e6)}var p={type:s,encode:u,decode:h}},"./node_modules/@msgpack/msgpack/dist.es5+esm/utils/int.mjs":function(e,t,n){n.r(t),n.d(t,"UINT32_MAX",(function(){return r})),n.d(t,"setUint64",(function(){return i})),n.d(t,"setInt64",(function(){return s})),n.d(t,"getInt64",(function(){return o})),n.d(t,"getUint64",(function(){return a}));var r=4294967295;function i(e,t,n){var r=n/4294967296,i=n;e.setUint32(t,r),e.setUint32(t+4,i)}function s(e,t,n){var r=Math.floor(n/4294967296),i=n;e.setUint32(t,r),e.setUint32(t+4,i)}function o(e,t){return 4294967296*e.getInt32(t)+e.getUint32(t+4)}function a(e,t){return 4294967296*e.getUint32(t)+e.getUint32(t+4)}},"./node_modules/@msgpack/msgpack/dist.es5+esm/utils/prettyByte.mjs":function(e,t,n){function r(e){return(e<0?"-":"")+"0x"+Math.abs(e).toString(16).padStart(2,"0")}n.r(t),n.d(t,"prettyByte",(function(){return r}))},"./node_modules/@msgpack/msgpack/dist.es5+esm/utils/stream.mjs":function(e,t,n){n.r(t),n.d(t,"isAsyncIterable",(function(){return o})),n.d(t,"asyncIterableFromStream",(function(){return a})),n.d(t,"ensureAsyncIterable",(function(){return c}));var r=function(e,t){var n,r,i,s,o={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return s={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function a(s){return function(a){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;o;)try{if(n=1,r&&(i=2&s[0]?r.return:s[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,s[1])).done)return i;switch(r=0,i&&(s=[2&s[0],i.value]),s[0]){case 0:case 1:i=s;break;case 4:return o.label++,{value:s[1],done:!1};case 5:o.label++,r=s[1],s=[0];continue;case 7:s=o.ops.pop(),o.trys.pop();continue;default:if(!((i=(i=o.trys).length>0&&i[i.length-1])||6!==s[0]&&2!==s[0])){o=0;continue}if(3===s[0]&&(!i||s[1]>i[0]&&s[1]<i[3])){o.label=s[1];break}if(6===s[0]&&o.label<i[1]){o.label=i[1],i=s;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(s);break}i[2]&&o.ops.pop(),o.trys.pop();continue}s=t.call(e,o)}catch(e){s=[6,e],r=0}finally{n=i=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,a])}}},i=function(e){return this instanceof i?(this.v=e,this):new i(e)},s=function(e,t,n){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var r,s=n.apply(e,t||[]),o=[];return r={},a("next"),a("throw"),a("return"),r[Symbol.asyncIterator]=function(){return this},r;function a(e){s[e]&&(r[e]=function(t){return new Promise((function(n,r){o.push([e,t,n,r])>1||c(e,t)}))})}function c(e,t){try{(n=s[e](t)).value instanceof i?Promise.resolve(n.value.v).then(l,u):d(o[0][2],n)}catch(e){d(o[0][3],e)}var n}function l(e){c("next",e)}function u(e){c("throw",e)}function d(e,t){e(t),o.shift(),o.length&&c(o[0][0],o[0][1])}};function o(e){return null!=e[Symbol.asyncIterator]}function a(e){return s(this,arguments,(function(){var t,n,s,o;return r(this,(function(r){switch(r.label){case 0:t=e.getReader(),r.label=1;case 1:r.trys.push([1,,9,10]),r.label=2;case 2:return[4,i(t.read())];case 3:return n=r.sent(),s=n.done,o=n.value,s?[4,i(void 0)]:[3,5];case 4:return[2,r.sent()];case 5:return function(e){if(null==e)throw new Error("Assertion Failure: value must not be null nor undefined")}(o),[4,i(o)];case 6:return[4,r.sent()];case 7:return r.sent(),[3,2];case 8:return[3,10];case 9:return t.releaseLock(),[7];case 10:return[2]}}))}))}function c(e){return o(e)?e:a(e)}},"./node_modules/@msgpack/msgpack/dist.es5+esm/utils/typedArrays.mjs":function(e,t,n){function r(e){return e instanceof Uint8Array?e:ArrayBuffer.isView(e)?new Uint8Array(e.buffer,e.byteOffset,e.byteLength):e instanceof ArrayBuffer?new Uint8Array(e):Uint8Array.from(e)}function i(e){if(e instanceof ArrayBuffer)return new DataView(e);var t=r(e);return new DataView(t.buffer,t.byteOffset,t.byteLength)}n.r(t),n.d(t,"ensureUint8Array",(function(){return r})),n.d(t,"createDataView",(function(){return i}))},"./node_modules/@msgpack/msgpack/dist.es5+esm/utils/utf8.mjs":function(e,t,n){n.r(t),n.d(t,"utf8Count",(function(){return s})),n.d(t,"utf8EncodeJs",(function(){return o})),n.d(t,"TEXT_ENCODER_THRESHOLD",(function(){return c})),n.d(t,"utf8EncodeTE",(function(){return l})),n.d(t,"utf8DecodeJs",(function(){return d})),n.d(t,"TEXT_DECODER_THRESHOLD",(function(){return p})),n.d(t,"utf8DecodeTD",(function(){return f}));var r=n("./node_modules/@msgpack/msgpack/dist.es5+esm/utils/int.mjs"),i=("undefined"==typeof process||"never"!==process.env.TEXT_ENCODING)&&"undefined"!=typeof TextEncoder&&"undefined"!=typeof TextDecoder;function s(e){for(var t=e.length,n=0,r=0;r<t;){var i=e.charCodeAt(r++);if(4294967168&i)if(4294965248&i){if(i>=55296&&i<=56319&&r<t){var s=e.charCodeAt(r);56320==(64512&s)&&(++r,i=((1023&i)<<10)+(1023&s)+65536)}n+=4294901760&i?4:3}else n+=2;else n++}return n}function o(e,t,n){for(var r=e.length,i=n,s=0;s<r;){var o=e.charCodeAt(s++);if(4294967168&o){if(4294965248&o){if(o>=55296&&o<=56319&&s<r){var a=e.charCodeAt(s);56320==(64512&a)&&(++s,o=((1023&o)<<10)+(1023&a)+65536)}4294901760&o?(t[i++]=o>>18&7|240,t[i++]=o>>12&63|128,t[i++]=o>>6&63|128):(t[i++]=o>>12&15|224,t[i++]=o>>6&63|128)}else t[i++]=o>>6&31|192;t[i++]=63&o|128}else t[i++]=o}}var a=i?new TextEncoder:void 0,c=i?"undefined"!=typeof process&&"force"!==process.env.TEXT_ENCODING?200:0:r.UINT32_MAX,l=(null==a?void 0:a.encodeInto)?function(e,t,n){a.encodeInto(e,t.subarray(n))}:function(e,t,n){t.set(a.encode(e),n)},u=4096;function d(e,t,n){for(var r=t,i=r+n,s=[],o="";r<i;){var a=e[r++];if(128&a)if(192==(224&a)){var c=63&e[r++];s.push((31&a)<<6|c)}else if(224==(240&a)){c=63&e[r++];var l=63&e[r++];s.push((31&a)<<12|c<<6|l)}else if(240==(248&a)){var d=(7&a)<<18|(c=63&e[r++])<<12|(l=63&e[r++])<<6|63&e[r++];d>65535&&(d-=65536,s.push(d>>>10&1023|55296),d=56320|1023&d),s.push(d)}else s.push(a);else s.push(a);s.length>=u&&(o+=String.fromCharCode.apply(String,s),s.length=0)}return s.length>0&&(o+=String.fromCharCode.apply(String,s)),o}var h=i?new TextDecoder:null,p=i?"undefined"!=typeof process&&"force"!==process.env.TEXT_DECODER?200:0:r.UINT32_MAX;function f(e,t,n){var r=e.subarray(t,t+n);return h.decode(r)}},"./package.json":function(e){e.exports=JSON.parse('{"name":"imjoy-rpc","version":"0.5.59","description":"Remote procedure calls for ImJoy.","module":"index.js","types":"index.d.ts","scripts":{"build":"rm -rf dist && npm run build-umd","build-umd":"webpack --config webpack.config.js --mode development && NODE_ENV=production webpack --config webpack.config.js --mode production --devtool source-map ","watch":"NODE_ENV=production webpack --watch --progress --config webpack.config.js --mode production --devtool source-map","publish-npm":"npm install && npm run build && npm publish","serve":"webpack-dev-server","stats":"webpack --profile --json > stats.json","stats-prod":"webpack --profile --json --mode production > stats-prod.json","analyze":"webpack-bundle-analyzer -p 9999 stats.json","analyze-prod":"webpack-bundle-analyzer -p 9999 stats-prod.json","clean":"rimraf dist/*","deploy":"npm run build && node deploy-site.js","format":"prettier --write \\"{src,tests}/**/**\\"","check-format":"prettier --check \\"{src,tests}/**/**\\"","test":"karma start --single-run --browsers ChromeHeadless,FirefoxHeadless karma.conf.js","test-watch":"karma start --auto-watch --browsers ChromeDebugging karma.conf.js --debug"},"repository":{"type":"git","url":"git+https://github.com/imjoy-team/imjoy-rpc.git"},"keywords":["imjoy","rpc"],"author":"imjoy-team <imjoy.team@gmail.com>","license":"MIT","bugs":{"url":"https://github.com/imjoy-team/imjoy-rpc/issues"},"homepage":"https://github.com/imjoy-team/imjoy-rpc","dependencies":{"@msgpack/msgpack":"^2.7.1","socket.io-client":"^4.6.2"},"devDependencies":{"@babel/core":"^7.16.12","@babel/plugin-syntax-dynamic-import":"^7.8.3","@babel/polyfill":"^7.12.1","@babel/preset-env":"^7.16.11","@types/requirejs":"^2.1.34","babel-core":"^6.26.0","babel-eslint":"^10.1.0","babel-loader":"^8.2.3","babel-runtime":"^6.26.0","chai":"^4.3.6","clean-webpack-plugin":"^0.1.19","copy-webpack-plugin":"^5.1.2","eslint":"^6.8.0","eslint-config-prettier":"^4.2.0","eslint-loader":"^4.0.2","file-loader":"^0.11.2","fs-extra":"^0.30.0","gh-pages":"^2.0.1","html-loader":"^0.5.5","html-webpack-plugin":"^3.2.0","json-loader":"^0.5.4","karma":"^6.3.12","karma-chrome-launcher":"^3.1.0","karma-firefox-launcher":"^1.3.0","karma-mocha":"^2.0.1","karma-sourcemap-loader":"^0.3.8","karma-spec-reporter":"0.0.32","karma-webpack":"^4.0.2","lerna":"^6.0.3","lodash.debounce":"^4.0.8","mocha":"^10.1.0","postcss":"^7.0.36","prettier":"^1.6.1","rimraf":"^2.6.2","schema-utils":"^0.4.3","style-loader":"^0.18.1","ts-loader":"^9.4.3","url-loader":"^0.5.9","webpack":"^4.46.0","webpack-bundle-analyzer":"^4.7.0","webpack-cli":"^3.3.12","webpack-dev-server":"^3.11.3","webpack-merge":"^4.1.1","workbox-webpack-plugin":"^4.3.1","worker-loader":"^2.0.0","write-file-webpack-plugin":"^4.5.1"},"eslintConfig":{"globals":{"document":true,"window":true}}}')},"./src/hypha/rpc.js":function(e,t,n){n.r(t),n.d(t,"API_VERSION",(function(){return s})),n.d(t,"RPC",(function(){return d}));var r=n("./src/hypha/utils.js"),i=n("./node_modules/@msgpack/msgpack/dist.es5+esm/index.mjs");const s="0.3.0",o=512e3,a=Object.getPrototypeOf(Object.getPrototypeOf(new Uint8Array)).constructor;function c(e,t){const n=new Uint8Array(e.byteLength+t.byteLength);return n.set(new Uint8Array(e),0),n.set(new Uint8Array(t),e.byteLength),n.buffer}function l(e,t){if(!t)throw new Error("undefined index");return"string"==typeof t?l(e,t.split(".")):0===t.length?e:l(e[t[0]],t.slice(1))}class u{constructor(e,t,n,r){this._timeout=e,this._callback=t,this._args=n,this._label=r||"timer",this._task=null,this.started=!1}start(){this.started?this.reset():(this._task=setTimeout((()=>{this._callback.apply(this,this._args)}),1e3*this._timeout),this.started=!0)}clear(){this._task?(clearTimeout(this._task),this._task=null,this.started=!1):console.warn(`Clearing a timer (${this._label}) which is not started`)}reset(){this._task&&clearTimeout(this._task),this._task=setTimeout((()=>{this._callback.apply(this,this._args)}),1e3*this._timeout),this.started=!0}}class d extends r.MessageEmitter{constructor(e,{client_id:t=null,manager_id:n=null,default_context:i=null,name:s=null,codecs:o=null,method_timeout:a=null,max_message_buffer_size:c=0,debug:l=!1,workspace:u=null}){super(l),this._codecs=o||{},Object(r.assert)(t&&"string"==typeof t),Object(r.assert)(t,"client_id is required"),this._client_id=t,this._name=s,this._connection_info=null,this._workspace=null,this._local_workspace=u,this.manager_id=n,this.default_context=i||{},this._method_annotations=new WeakMap,this._manager_service=null,this._max_message_buffer_size=c,this._chunk_store={},this._method_timeout=a||30,this._services={},this._object_store={services:this._services},e?(this.add_service({id:"built-in",type:"built-in",name:"RPC built-in services",config:{require_context:!0,visibility:"public"},ping:this._ping.bind(this),get_service:this.get_local_service.bind(this),register_service:this.register_service.bind(this),message_cache:{create:this._create_message.bind(this),append:this._append_message.bind(this),process:this._process_message.bind(this),remove:this._remove_message.bind(this)}}),this.on("method",this._handle_method.bind(this)),Object(r.assert)(e.emit_message&&e.on_message),this._emit_message=e.emit_message.bind(e),e.on_message(this._on_message.bind(this)),this._connection=e,this._get_connection_info()):this._emit_message=function(){console.log("No connection to emit message")}}async _get_connection_info(){if(this.manager_id)try{if(await this.get_manager_service(30),Object(r.assert)(this._manager_service),this._connection_info=await this._manager_service.get_connection_info(),!this._local_workspace&&this._connection_info&&this._connection_info.workspace&&(this._local_workspace=this._connection_info.workspace),this._connection_info.reconnection_token&&this._connection.set_reconnection_token){this._connection.set_reconnection_token(this._connection_info.reconnection_token);const e=.8*this._connection_info.reconnection_expires_in;this._get_connection_info_task=setTimeout(this._get_connection_info.bind(this),1e3*e)}}catch(e){console.warn("Failed to fetch user info from ",this.manager_id,e)}}register_codec(e){if(!e.name||!e.encoder&&!e.decoder)throw new Error("Invalid codec format, please make sure you provide a name, type, encoder and decoder.");if(e.type)for(let t of Object.keys(this._codecs))this._codecs[t].type!==e.type&&t!==e.name||(delete this._codecs[t],console.warn("Remove duplicated codec: "+t));this._codecs[e.name]=e}async _ping(e,t){return Object(r.assert)("ping"==e),"pong"}async ping(e,t){let n=this._generate_remote_method({_rtarget:e,_rmethod:"services.built-in.ping",_rpromise:!0,_rdoc:"Ping a remote client",_rsig:"ping(msg)"});Object(r.assert)("pong"==await n("ping",t))}_create_message(e,t,n,r){if(t){if(!this._object_store[e])throw new Error(`session does not exist anymore: ${e}`);this._object_store[e].timer.reset()}if(this._object_store.message_cache||(this._object_store.message_cache={}),!n&&this._object_store.message_cache[e])throw new Error(`Message with the same key (${e}) already exists in the cache store, please use overwrite=true or remove it first.`);this._object_store.message_cache[e]=[]}_append_message(e,t,n,i){if(n){if(!this._object_store[e])throw new Error(`session does not exist anymore: ${e}`);this._object_store[e].timer.reset()}const s=this._object_store.message_cache;if(!s[e])throw new Error(`Message with key ${e} does not exists.`);Object(r.assert)(t instanceof a),s[e].push(t)}_remove_message(e,t){const n=this._object_store.message_cache;if(!n[e])throw new Error(`Message with key ${e} does not exists.`);delete n[e]}_process_message(e,t,n){if(t){if(!this._object_store[e])throw new Error(`session does not exist anymore: ${e}`);this._object_store[e].timer.reset()}const s=this._object_store.message_cache;if(Object(r.assert)(!!n,"Context is required"),!s[e])throw new Error(`Message with key ${e} does not exists.`);var o,a,c,l;s[e]=(c=(a=(o=s[e]).map((function(e){return e.byteLength}))).reduce((function(e,t){return e+t}),0),l=new Uint8Array(c),a.reduce((function(e,t,n){return l.set(new Uint8Array(o[n]),e),e+t}),0),l.buffer),console.debug(`Processing message ${e} (size=${s[e].length})`);let u=Object(i.decodeMulti)(s[e]);const{done:d,value:h}=u.next(),p=h;if(Object.assign(p,{from:n.from,to:n.to,user:n.user}),p.ctx=JSON.parse(JSON.stringify(p)),Object.assign(p.ctx,this.default_context),!d){let e=u.next();Object.assign(p,e.value)}this._fire(p.type,p),delete s[e]}_on_message(e){try{Object(r.assert)(e instanceof ArrayBuffer);let t=Object(i.decodeMulti)(e);const{done:n,value:s}=t.next(),o=s;if(o.ctx=JSON.parse(JSON.stringify(o)),Object.assign(o.ctx,this.default_context),!n){let e=t.next();Object.assign(o,e.value)}this._fire(o.type,o)}catch(e){console.error(e)}}reset(){this._event_handlers={},this._services={}}async disconnect(){this._get_connection_info_task&&(clearTimeout(this._get_connection_info_task),this._get_connection_info_task=null),this._fire("disconnect")}async get_manager_service(e){this.manager_id&&!this._manager_service&&(this._manager_service=await this.get_remote_service(`${this.manager_id}:default`,e))}get_all_local_services(){return this._services}get_local_service(e,t){Object(r.assert)(e);const[n,i]=t.to.split("/");Object(r.assert)(i===this._client_id,"Services can only be accessed locally");const s=this._services[e];if(!s)throw new Error("Service not found: "+e);if("public"==s.config.visibility)return s;if(t.from.startsWith(n+"/"))return s;throw new Error("Permission denied for service: "+e)}async get_remote_service(e,t){t=void 0===t?this._method_timeout:t,!e&&this.manager_id?e=this.manager_id:e.includes(":")||(e=this._client_id+":"+e);const n=e.split(":")[0];Object(r.assert)(n);try{const i=this._generate_remote_method({_rtarget:n,_rmethod:"services.built-in.get_service",_rpromise:!0,_rdoc:"Get a remote service",_rsig:"get_service(service_id)"}),s=await Object(r.waitFor)(i(e.split(":")[1]),t,"Timeout Error: Failed to get remote service: "+e);return s.id=e,s}catch(t){throw console.error("Failed to get remote service: "+e,t),t}}_annotate_service_methods(e,t,n,r,i){if("function"==typeof e){let s=t.split(".")[1];this._method_annotations.set(e,{require_context:Array.isArray(n)?n.includes(s):!!n,run_in_executor:r,method_id:"services."+t,visibility:i})}else if(e instanceof Array||e instanceof Object)for(let s of Object.keys(e)){let o=e[s];if("function"==typeof o&&o.__rpc_object__){let t=o.__rpc_object__._rtarget;if(t.includes("/")&&(t=t.split("/")[1]),this._client_id!==t)throw new Error(`Local method not found: ${o.__rpc_object__._rmethod}, client id mismatch ${this._client_id} != ${t}`);e instanceof Array&&(e=e.slice()),e[s]=l(this._object_store,o.__rpc_object__._rmethod),o=e[s]}this._annotate_service_methods(o,t+"."+s,n,r,i)}}add_service(e,t){if(!e||Array.isArray(e))throw new Error("Invalid service object");if(e.constructor===Object)e=Object.assign({},e);else{const t={},n=Object.getOwnPropertyNames(e).concat(Object.getOwnPropertyNames(Object.getPrototypeOf(e)));for(let r of n)"constructor"!==r&&("function"==typeof e[r]?t[r]=e[r].bind(e):t[r]=e[r]);e.id=e.id||"default",e=t}Object(r.assert)(e.id&&"string"==typeof e.id,`Service id not found: ${e}`),e.name||(e.name=e.id),e.config||(e.config={}),e.type||(e.type="generic");let n=!1,i=!1;e.config.require_context&&(n=e.config.require_context),e.config.run_in_executor&&(i=!0);const s=e.config.visibility||"protected";if(Object(r.assert)(["protected","public"].includes(s)),this._annotate_service_methods(e,e.id,n,i,s),this._services[e.id]){if(!t)throw new Error(`Service already exists: ${e.id}, please specify a different id (not ${e.id}) or overwrite=true`);delete this._services[e.id]}return this._services[e.id]=e,e}async register_service(e,t,n,i){if(void 0===n&&(n=!0),i){const[e,t]=i.to.split("/");Object(r.assert)(t===this._client_id),Object(r.assert)(e===i.from.split("/")[0],"Services can only be registered from the same workspace")}const s=this.add_service(e,t);return n&&(this._fire("service-updated",{service_id:s.id,api:s,type:"add"}),await this._notify_service_update()),{id:`${this._client_id}:${s.id}`,type:s.type,name:s.name,description:s.description||"",config:s.config}}async unregister_service(e,t){if(e instanceof Object&&(e=e.id),!this._services[e])throw new Error(`Service not found: ${e}`);const n=this._services[e];delete this._services[e],this._fire("service-updated",{service_id:e,api:n,type:"remove"}),await this._notify_service_update()}_ndarray(e,t,n){const i=Object(r.typedArrayToDtype)(e);if(n&&n!==i)throw"dtype doesn't match the type of the array: "+i+" != "+n;return t=t||[e.length],{_rtype:"ndarray",_rvalue:e.buffer,_rshape:t,_rdtype:i}}_encode_callback(e,t,n,r,i,s){let o=`${n}.${e}`,a={_rtype:"method",_rtarget:s?`${s}/${this._client_id}`:this._client_id,_rmethod:o,_rpromise:!1};const c=this;return[a,function(){try{t.apply(null,Array.prototype.slice.call(arguments))}catch(e){console.error("Error in callback:",o,e)}finally{r&&c._object_store[n]&&delete c._object_store[n],i&&i.started&&i.clear()}}]}async _encode_promise(e,t,n,i,s,o){let a=this._get_session_store(n,!0);Object(r.assert)(a,`Failed to create session store ${n} due to invalid parent`);let c={};return s&&t&&this._method_timeout?(c.heartbeat=await this._encode(s.reset.bind(s),n,o),c.interval=this._method_timeout/2,a.timer=s):s=null,[c.resolve,a.resolve]=this._encode_callback("resolve",e,n,i,s,o),[c.reject,a.reject]=this._encode_callback("reject",t,n,i,s,o),c}async _send_chunks(e,t,n){let i=await this.get_remote_service(`${t}:built-in`);Object(r.assert)(i.message_cache,"Remote client does not support message caching for long message.");let s=i.message_cache,a=n||Object(r.randId)();await s.create(a,!!n);let c=e.length,l=Math.ceil(c/o);for(let t=0;t<l;t++){let r=t*o;await s.append(a,e.slice(r,r+o),!!n)}await s.process(a,!!n)}emit(e,t){Object(r.assert)("object"==typeof e&&e.type,"Invalid message, must be an object with a type field.");let n=Object(i.encode)(e);if(t){const e=Object(i.encode)(t);n=new Uint8Array([...n,...e])}if(n.length<=513024)return this._emit_message(n);throw new Error("Message is too large to send in one go.")}_generate_remote_method(e,t,n,s,o){let a=e._rtarget;s&&!a.includes("/")&&(s!==a&&(a=s+"/"+a),e._rtarget=a);let c=e._rmethod,l=e._rpromise;const d=this;function h(){return new Promise((async(e,s)=>{let h=Object(r.randId)();n&&(h=n+"."+h);let p=d._get_session_store(h,!0);if(!p)return void s(new Error(`Runtime Error: Failed to get session store ${h}`));p.target_id=a;const f=await d._encode(Array.prototype.slice.call(arguments),h,o),_=f.length,m=_>0&&"object"==typeof f[_-1]&&null!==f[_-1]&&f[_-1]._rkwargs;m&&delete f[_-1]._rkwargs;let y={type:"method",from:d._local_workspace?d._local_workspace+"/"+d._client_id:d._client_id,to:a,method:c},g={};f&&(g.args=f),m&&(g.with_kwargs=m),t&&(y.parent=t);let b=null;if(l){y.session=h;let t=`${a}:${c}`;b=new u(d._method_timeout,s,[`Method call time out: ${t}`],t);let n=!0;for(let e of f)if("object"==typeof e&&!0===e._rintf){n=!1;break}g.promise=await d._encode_promise(e,s,h,n,b,o)}let w=Object(i.encode)(y);if(g){const e=Object(i.encode)(g);w=new Uint8Array([...w,...e])}w.length<=513024?d._emit_message(w).then((function(){b&&b.start()})):d._send_chunks(w,a,t).then((function(){b&&b.start()}))}))}h.__rpc_object__=e;const p=c.split(".");return h.__name__=p[p.length-1],h.__doc__=e._rdoc,h.__sig__=e._rsig,h}async _notify_service_update(){if(this.manager_id)try{await this.get_manager_service(30),Object(r.assert)(this._manager_service),await this._manager_service.update_client_info(this.get_client_info())}catch(e){console.warn("Failed to notify service update to",this.manager_id,e)}}get_client_info(){const e=[];for(let t of Object.values(this._services))e.push({id:`${this._client_id}:${t.id}`,type:t.type,name:t.name,description:t.description||"",config:t.config});return{id:this._client_id,services:e}}async _handle_method(e){let t=null;try{Object(r.assert)(e.method&&e.ctx&&e.from);const n=e.from+":"+e.method,i=e.from.split("/")[0];e.to=e.to.includes("/")?e.to:i+"/"+e.to,e.ctx.to=e.to;const s=e.to.split("/")[0],o=e.parent;let a,c,u,d;if(e.promise){const h=await this._decode(e.promise,e.session,o,i,s);if(a=h.resolve,c=h.reject,h.heartbeat&&h.interval){async function p(){try{await h.heartbeat()}catch(e){console.error(e)}}t=setInterval(p,1e3*h.interval)}}try{u=l(this._object_store,e.method)}catch(f){throw console.debug("Failed to find method",n,f),new Error(`Method not found: ${n}`)}if(Object(r.assert)(u&&"function"==typeof u,"Invalid method: "+n),this._method_annotations.has(u)){if("protected"===this._method_annotations.get(u).visibility&&s!==i)throw new Error("Permission denied for protected method "+n+", workspace mismatch: "+s+" != "+i)}else{let _=this._object_store[e.method.split(".")[0]].target_id;if(s===i&&_&&-1===_.indexOf("/")&&(_=s+"/"+_),_!==e.from)throw new Error("Access denied for method call ("+n+") from "+e.from)}if(o&&Object(r.assert)(null!==this._get_session_store(o,!0),"Parent session was closed: "+o),d=e.args?await this._decode(e.args,e.session,null,i,null):[],this._method_annotations.has(u)&&this._method_annotations.get(u).require_context&&d.push(e.ctx),e.promise){const m=u.apply(null,d);m instanceof Promise?m.then((e=>{a(e),clearInterval(t)})).catch((e=>{c(e),clearInterval(t)})):(a(m),clearInterval(t))}else u.apply(null,d),clearInterval(t)}catch(y){console.error("Error during calling method: ",y),clearInterval(t)}}encode(e,t){return this._encode(e,t)}_get_session_store(e,t){let n=this._object_store;const r=e.split(".");if(t){const e=r.length-1;for(let t of r.slice(0,e)){if(!n[t])return null;n=n[t]}return n[r[e]]||(n[r[e]]={}),n[r[e]]}for(let e of r){if(!n[e])return null;n=n[e]}return n}async _encode(e,t,n){const i=typeof e;if("number"===i||"string"===i||"boolean"===i||null==e||e instanceof Uint8Array)return e;if(e instanceof ArrayBuffer)return{_rtype:"memoryview",_rvalue:new Uint8Array(e)};if(e.__rpc_object__)return e.__rpc_object__;let s;if(e.constructor instanceof Object&&e._rtype){const c=e._rtype;return delete e._rtype,s=await this._encode(e,t,n),s._rtype=c,s}if("function"==typeof e){if(this._method_annotations.has(e)){let l=this._method_annotations.get(e);s={_rtype:"method",_rtarget:this._client_id,_rmethod:l.method_id,_rpromise:!0}}else{let u;Object(r.assert)("string"==typeof t),u=e.__name__?`${Object(r.randId)()}-${e.__name__}`:Object(r.randId)(),s={_rtype:"method",_rtarget:this._client_id,_rmethod:`${t}.${u}`,_rpromise:!0};let d=this._get_session_store(t,!0);Object(r.assert)(null!==d,`Failed to create session store ${t} due to invalid parent`),d[u]=e}if(s._rdoc=e.__doc__,s._rsig=e.__sig__,!s._rdoc||!s._rsig)try{const h=function(e){const t=e.toString(),n=t.match(/function\s*(\w*)/),r=n&&n[1]||"",i=t.match(/\(([^)]*)\)/);let s="";i&&(s=i[1].split(",").map((e=>e.replace(/\/\*.*?\*\//g,"").replace(/\/\/.*$/g,""))).filter((e=>e.trim().length>0)).map((e=>e.trim())).join(", "));let o=t.match(/\)\s*\{\s*\/\*([\s\S]*?)\*\//);const a=o&&o[1].trim()||"";o=t.match(/\)\s*\{\s*(\/\/[\s\S]*?)\n\s*[^\s\/]/);const c=o&&o[1].split("\n").map((e=>e.replace(/^\/\/\s*/,"").trim())).join("\n")||"",l=a||c;return r&&s.length>0&&{name:r,sig:s,doc:l}}(e);h&&!s._rdoc&&(s._rdoc=`${h.doc}`),h&&!s._rsig&&(s._rsig=`${h.name}(${h.sig})`)}catch(p){console.error("Failed to extract function docstring:",e)}return s}const o=Array.isArray(e);for(let f of Object.keys(this._codecs)){const _=this._codecs[f];if(_.encoder&&e instanceof _.type){let m=await Promise.resolve(_.encoder(e));if(m&&!m._rtype&&(m._rtype=_.name),"object"==typeof m){const y=m._rtype;delete m._rtype,m=await this._encode(m,t,n),m._rtype=y}return s=m,s}}if("undefined"!=typeof tf&&tf.Tensor&&e instanceof tf.Tensor){const g=e.dataSync();s={_rtype:"ndarray",_rvalue:new Uint8Array(g.buffer),_rshape:e.shape,_rdtype:e.dtype}}else if("undefined"!=typeof nj&&nj.NdArray&&e instanceof nj.NdArray){const b=Object(r.typedArrayToDtype)(e.selection.data);s={_rtype:"ndarray",_rvalue:new Uint8Array(e.selection.data.buffer),_rshape:e.shape,_rdtype:b}}else if(e instanceof Error)console.error(e),s={_rtype:"error",_rvalue:e.toString(),_rtrace:e.stack};else if(e!==Object(e)||e instanceof Boolean||e instanceof String||e instanceof Date||e instanceof RegExp||e instanceof ImageData||"undefined"!=typeof FileList&&e instanceof FileList||"undefined"!=typeof FileSystemDirectoryHandle&&e instanceof FileSystemDirectoryHandle||"undefined"!=typeof FileSystemFileHandle&&e instanceof FileSystemFileHandle||"undefined"!=typeof FileSystemHandle&&e instanceof FileSystemHandle||"undefined"!=typeof FileSystemWritableFileStream&&e instanceof FileSystemWritableFileStream)s=e;else if(e instanceof Blob){let w=0;async function v(t){let n;n=t?e.slice(w,w+t):e.slice(w);const r=new Uint8Array(await n.arrayBuffer());return w+=r.byteLength,r}function k(e){w=e}s={_rtype:"iostream",_rnative:"js:blob",type:e.type,name:e.name,size:e.size,path:e._path||e.webkitRelativePath,read:await this._encode(v,t,n),seek:await this._encode(k,t,n)}}else if(e instanceof a){const j=Object(r.typedArrayToDtype)(e);s={_rtype:"typedarray",_rvalue:new Uint8Array(e.buffer),_rdtype:j}}else if(e instanceof DataView)s={_rtype:"memoryview",_rvalue:new Uint8Array(e.buffer)};else if(e instanceof Set)s={_rtype:"set",_rvalue:await this._encode(Array.from(e),t,n)};else if(e instanceof Map)s={_rtype:"orderedmap",_rvalue:await this._encode(Array.from(e),t,n)};else{if(!(e.constructor instanceof Object||Array.isArray(e)))throw`imjoy-rpc: Unsupported data type: ${e}, you can register a custom codec to encode/decode the object.`;{s=o?[]:{};const E=Object.keys(e);for(let O of E)s[O]=await this._encode(e[O],t,n)}}if(!s)throw new Error("Failed to encode object");return s}async decode(e){return await this._decode(e)}async _decode(e,t,n,i,s){if(!e)return e;let o;if(e._rtype)if(this._codecs[e._rtype]&&this._codecs[e._rtype].decoder){const r=e._rtype;delete e._rtype,(e=await this._decode(e,t,n,i,s))._rtype=r,o=await Promise.resolve(this._codecs[e._rtype].decoder(e))}else if("method"===e._rtype)o=this._generate_remote_method(e,t,n,i,s);else if("ndarray"===e._rtype)if("undefined"!=typeof nj&&nj.array)Array.isArray(e._rvalue)&&(e._rvalue=e._rvalue.reduce(c)),o=nj.array(new Uint8(e._rvalue),e._rdtype).reshape(e._rshape);else if("undefined"!=typeof tf&&tf.Tensor){Array.isArray(e._rvalue)&&(e._rvalue=e._rvalue.reduce(c));const t=r.dtypeToTypedArray[e._rdtype];o=tf.tensor(new t(e._rvalue),e._rshape,e._rdtype)}else o=e;else if("error"===e._rtype)o=new Error("RemoteError: "+e._rvalue+"\n"+(e._rtrace||""));else if("typedarray"===e._rtype){const t=r.dtypeToTypedArray[e._rdtype];if(!t)throw new Error("unsupported dtype: "+e._rdtype);o=new t(e._rvalue.buffer.slice(e._rvalue.byteOffset,e._rvalue.byteOffset+e._rvalue.byteLength))}else if("memoryview"===e._rtype)o=e._rvalue.buffer.slice(e._rvalue.byteOffset,e._rvalue.byteOffset+e._rvalue.byteLength);else if("iostream"===e._rtype){if("js:blob"===e._rnative){const r=await this._generate_remote_method(e.read,t,n,i,s),a=await r();o=new Blob([a],{type:e.type,name:e.name})}else{o={};for(let r of Object.keys(e))r.startsWith("_")||(o[r]=await this._decode(e[r],t,n,i,s))}o.__rpc_object__=e}else if("orderedmap"===e._rtype)o=new Map(await this._decode(e._rvalue,t,n,i,s));else if("set"===e._rtype)o=new Set(await this._decode(e._rvalue,t,n,i,s));else{const r=e._rtype;delete e._rtype,o=await this._decode(e,t,n,i,s),o._rtype=r}else if(e.constructor===Object||Array.isArray(e)){const r=Array.isArray(e);o=r?[]:{};for(let a of Object.keys(e))if(r||e.hasOwnProperty(a)){const r=e[a];o[a]=await this._decode(r,t,n,i,s)}}else o=e;if(void 0===o)throw new Error("Failed to decode object");return o}}},"./src/hypha/utils.js":function(module,__nested_webpack_exports__,__nested_webpack_require_152121__){function randId(){return Math.random().toString(36).substr(2,10)+(new Date).getTime()}__nested_webpack_require_152121__.r(__nested_webpack_exports__),__nested_webpack_require_152121__.d(__nested_webpack_exports__,"randId",(function(){return randId})),__nested_webpack_require_152121__.d(__nested_webpack_exports__,"dtypeToTypedArray",(function(){return dtypeToTypedArray})),__nested_webpack_require_152121__.d(__nested_webpack_exports__,"loadRequirementsInWindow",(function(){return loadRequirementsInWindow})),__nested_webpack_require_152121__.d(__nested_webpack_exports__,"loadRequirementsInWebworker",(function(){return loadRequirementsInWebworker})),__nested_webpack_require_152121__.d(__nested_webpack_exports__,"loadRequirements",(function(){return loadRequirements})),__nested_webpack_require_152121__.d(__nested_webpack_exports__,"normalizeConfig",(function(){return normalizeConfig})),__nested_webpack_require_152121__.d(__nested_webpack_exports__,"typedArrayToDtypeMapping",(function(){return typedArrayToDtypeMapping})),__nested_webpack_require_152121__.d(__nested_webpack_exports__,"typedArrayToDtype",(function(){return typedArrayToDtype})),__nested_webpack_require_152121__.d(__nested_webpack_exports__,"cacheRequirements",(function(){return cacheRequirements})),__nested_webpack_require_152121__.d(__nested_webpack_exports__,"setupServiceWorker",(function(){return setupServiceWorker})),__nested_webpack_require_152121__.d(__nested_webpack_exports__,"assert",(function(){return assert})),__nested_webpack_require_152121__.d(__nested_webpack_exports__,"urlJoin",(function(){return urlJoin})),__nested_webpack_require_152121__.d(__nested_webpack_exports__,"waitFor",(function(){return waitFor})),__nested_webpack_require_152121__.d(__nested_webpack_exports__,"MessageEmitter",(function(){return MessageEmitter}));const dtypeToTypedArray={int8:Int8Array,int16:Int16Array,int32:Int32Array,uint8:Uint8Array,uint16:Uint16Array,uint32:Uint32Array,float32:Float32Array,float64:Float64Array,array:Array};async function loadRequirementsInWindow(e){function t(e){return new Promise(((t,n)=>{var r=document.createElement("script");r.src=e,r.type="text/javascript",r.onload=t,r.onreadystatechange=function(){"loaded"!==this.readyState&&"complete"!==this.readyState||t()},r.onerror=n,document.head.appendChild(r)}))}async function n(){for(var e=Array.prototype.slice.call(arguments),n=e.length,r=0;r<n;r++)await t(e[r])}if(e&&(Array.isArray(e)||"string"==typeof e))try{var r;if(e="string"==typeof e?[e]:e,!Array.isArray(e))throw"unsupported requirements definition";for(var i=0;i<e.length;i++)e[i].toLowerCase().endsWith(".css")||e[i].startsWith("css:")?(e[i].startsWith("css:")&&(e[i]=e[i].slice(4)),(r=document.createElement("link")).rel="stylesheet",r.href=e[i],document.head.appendChild(r)):e[i].toLowerCase().endsWith(".mjs")||e[i].startsWith("mjs:")?(e[i].startsWith("mjs:")&&(e[i]=e[i].slice(4)),await import(e[i])):e[i].toLowerCase().endsWith(".js")||e[i].startsWith("js:")?(e[i].startsWith("js:")&&(e[i]=e[i].slice(3)),await n(e[i])):e[i].startsWith("http")?await n(e[i]):e[i].startsWith("cache:")||console.log("Unprocessed requirements url: "+e[i])}catch(t){throw"failed to import required scripts: "+e.toString()}}async function loadRequirementsInWebworker(e){if(e&&(Array.isArray(e)||"string"==typeof e))try{Array.isArray(e)||(e=[e]);for(var t=0;t<e.length;t++){if(e[t].toLowerCase().endsWith(".css")||e[t].startsWith("css:"))throw"unable to import css in a webworker";e[t].toLowerCase().endsWith(".js")||e[t].startsWith("js:")?(e[t].startsWith("js:")&&(e[t]=e[t].slice(3)),importScripts(e[t])):e[t].startsWith("http")?importScripts(e[t]):e[t].startsWith("cache:")||console.log("Unprocessed requirements url: "+e[t])}}catch(t){throw"failed to import required scripts: "+e.toString()}}function loadRequirements(e){return"undefined"!=typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope?loadRequirementsInWebworker(e):loadRequirementsInWindow(e)}function normalizeConfig(e){return e.version=e.version||"0.1.0",e.description=e.description||`[TODO: add description for ${e.name} ]`,e.type=e.type||"rpc-window",e.id=e.id||randId(),e.target_origin=e.target_origin||"*",e.allow_execution=e.allow_execution||!1,e=Object.keys(e).reduce(((t,n)=>("function"!=typeof e[n]&&(t[n]=e[n]),t)),{})}const typedArrayToDtypeMapping={Int8Array:"int8",Int16Array:"int16",Int32Array:"int32",Uint8Array:"uint8",Uint16Array:"uint16",Uint32Array:"uint32",Float32Array:"float32",Float64Array:"float64",Array:"array"},typedArrayToDtypeKeys=[];for(const arrType of Object.keys(typedArrayToDtypeMapping))typedArrayToDtypeKeys.push(eval(arrType));function typedArrayToDtype(e){let t=typedArrayToDtypeMapping[e.constructor.name];if(!t){const n=Object.getPrototypeOf(e);for(const e of typedArrayToDtypeKeys)if(n instanceof e){t=typedArrayToDtypeMapping[e.name];break}}return t}function cacheUrlInServiceWorker(e){return new Promise((function(t,n){const r={command:"add",url:e};if(!navigator.serviceWorker||!navigator.serviceWorker.register)return void n("Service worker is not supported.");const i=new MessageChannel;i.port1.onmessage=function(e){e.data&&e.data.error?n(e.data.error):t(e.data&&e.data.result)},navigator.serviceWorker&&navigator.serviceWorker.controller?navigator.serviceWorker.controller.postMessage(r,[i.port2]):n("Service worker controller is not available")}))}async function cacheRequirements(e){e=e||[],Array.isArray(e)||(e=[e]);for(let t of e)t.startsWith("js:")&&(t=t.slice(3)),t.startsWith("css:")&&(t=t.slice(4)),t.startsWith("cache:")&&(t=t.slice(6)),t.startsWith("http")&&await cacheUrlInServiceWorker(t).catch((e=>{console.error(e)}))}function setupServiceWorker(e,t,n){if("serviceWorker"in navigator){if(e=e||"/",navigator.serviceWorker.register(e+"plugin-service-worker.js").then((function(e){console.log("ServiceWorker registration successful with scope: ",e.scope)}),(function(e){console.log("ServiceWorker registration failed: ",e)})),t=t||"*",(n=n||cacheRequirements)&&"function"!=typeof n)throw new Error("config.cache_requirements must be a function");window.addEventListener("message",(function(e){if("*"===t||e.origin===t){const t=e.data;"cacheRequirements"===t.type&&n(t.requirements)}}))}}function assert(e,t){if(!e)throw new Error(t||"Assertion failed")}function urlJoin(...e){return e.join("/").replace(/[\/]+/g,"/").replace(/^(.+):\//,"$1://").replace(/^file:/,"file:/").replace(/\/(\?|&|#[^!])/g,"$1").replace(/\?/g,"&").replace("&","?")}function waitFor(e,t,n){let r;return Promise.race([e,new Promise(((e,i)=>r=setTimeout((()=>{i(n||"Timeout Error")}),1e3*t)))]).finally((()=>clearTimeout(r)))}class MessageEmitter{constructor(e){this._event_handlers={},this._once_handlers={},this._debug=e}emit(){throw new Error("emit is not implemented")}on(e,t){this._event_handlers[e]||(this._event_handlers[e]=[]),this._event_handlers[e].push(t)}once(e,t){t.___event_run_once=!0,this.on(e,t)}off(e,t){if(e||t){if(e&&!t)this._event_handlers[e]&&(this._event_handlers[e]=[]);else if(this._event_handlers[e]){const n=this._event_handlers[e].indexOf(t);n>=0&&this._event_handlers[e].splice(n,1)}}else this._event_handlers={}}_fire(e,t){if(this._event_handlers[e])for(var n=this._event_handlers[e].length;n--;){const r=this._event_handlers[e][n];try{r(t)}catch(e){console.error(e)}finally{r.___event_run_once&&this._event_handlers[e].splice(n,1)}}else this._debug&&console.warn("unhandled event",e,t)}}},"./src/hypha/webrtc-client.js":function(e,t,n){n.r(t),n.d(t,"getRTCService",(function(){return a})),n.d(t,"registerRTCService",(function(){return c}));var r=n("./src/hypha/rpc.js"),i=n("./src/hypha/utils.js");class s{constructor(e){this._data_channel=e,this._handle_message=null,this._reconnection_token=null,this._data_channel.onmessage=async e=>{let t=e.data;t instanceof Blob&&(t=await t.arrayBuffer()),this._handle_message(t)};const t=this;this._data_channel.onclose=function(){console.log("websocket closed"),t._data_channel=null}}set_reconnection_token(e){this._reconnection_token=e}on_message(e){Object(i.assert)(e,"handler is required"),this._handle_message=e}async emit_message(e){Object(i.assert)(this._handle_message,"No handler for message");try{this._data_channel.send(e)}catch(e){throw console.error(`Failed to send data, error: ${e}`),e}}async disconnect(e){this._data_channel=null,console.info(`data channel connection disconnected (${e})`)}}async function o(e){Object(i.assert)(e.channel,"No channel provided"),Object(i.assert)(e.workspace,"No workspace provided");const t=e.channel,n=e.client_id||Object(i.randId)(),o=new s(t);return e.context=e.context||{},e.context.connection_type="webrtc",new r.RPC(o,{client_id:n,manager_id:null,default_context:e.context,name:e.name,method_timeout:e.method_timeout||10,workspace:e.workspace})}async function a(e,t,n){(n=n||{}).peer_id=n.peer_id||Object(i.randId)();const r=new RTCPeerConnection({iceServers:n.ice_servers||[{urls:["stun:stun.l.google.com:19302"]}],sdpSemantics:"unified-plan"});return new Promise((async(i,s)=>{try{r.addEventListener("connectionstatechange",(()=>{"failed"===r.connectionState&&(r.close(),s(new Error("Connection failed")))}),!1),n.on_init&&(await n.on_init(r),delete n.on_init);let a=r.createDataChannel(n.peer_id,{ordered:!0});a.binaryType="arraybuffer";const c=await r.createOffer();await r.setLocalDescription(c);const l=await e.getService(t),u=await l.offer({sdp:r.localDescription.sdp,type:r.localDescription.type});a.onopen=()=>{n.channel=a,n.workspace=u.workspace,setTimeout((async()=>{const e=await o(n);async function t(t){return await e.get_remote_service(n.peer_id+":"+t)}r.rpc=e,r.get_service=t,r.getService=t,r.disconnect=async function(){await e.disconnect(),r.close()},r.register_codec=e.register_codec,r.registerCodec=e.register_codec,i(r)}),500)},a.onclose=()=>s(new Error("Data channel closed")),await r.setRemoteDescription(new RTCSessionDescription({sdp:u.sdp,type:u.type}))}catch(e){s(e)}}))}async function c(e,t,n){const r=(n=n||{visibility:"protected",require_context:!0}).on_init;delete n.on_init,await e.registerService({id:t,config:n,offer:(t,i)=>async function(e,t,n,r,i){n=n||{};let s=new RTCSessionDescription({sdp:e.sdp,type:e.type}),a=new RTCPeerConnection({iceServers:n.ice_servers||[{urls:["stun:stun.l.google.com:19302"]}],sdpSemantics:"unified-plan"});t&&a.addEventListener("datachannel",(async e=>{const n=e.channel;let r=null;i&&i.user&&(r={user:i.user}),(await o({channel:n,client_id:n.label,workspace:t.config.workspace,context:r}))._services=t.rpc._services})),r&&await r(a),await a.setRemoteDescription(s);let c=await a.createAnswer();return await a.setLocalDescription(c),{sdp:a.localDescription.sdp,type:a.localDescription.type,workspace:t.config.workspace}}(t,e,n,r,i)})}},"./src/hypha/websocket-client.js":function(module,__nested_webpack_exports__,__nested_webpack_require_171376__){__nested_webpack_require_171376__.r(__nested_webpack_exports__),__nested_webpack_require_171376__.d(__nested_webpack_exports__,"login",(function(){return login})),__nested_webpack_require_171376__.d(__nested_webpack_exports__,"connectToServer",(function(){return connectToServer})),__nested_webpack_require_171376__.d(__nested_webpack_exports__,"setupLocalClient",(function(){return setupLocalClient}));var _rpc_js__WEBPACK_IMPORTED_MODULE_0__=__nested_webpack_require_171376__("./src/hypha/rpc.js");__nested_webpack_require_171376__.d(__nested_webpack_exports__,"RPC",(function(){return _rpc_js__WEBPACK_IMPORTED_MODULE_0__.RPC})),__nested_webpack_require_171376__.d(__nested_webpack_exports__,"API_VERSION",(function(){return _rpc_js__WEBPACK_IMPORTED_MODULE_0__.API_VERSION}));var _utils_js__WEBPACK_IMPORTED_MODULE_1__=__nested_webpack_require_171376__("./src/hypha/utils.js");__nested_webpack_require_171376__.d(__nested_webpack_exports__,"loadRequirements",(function(){return _utils_js__WEBPACK_IMPORTED_MODULE_1__.loadRequirements}));var _webrtc_client_js__WEBPACK_IMPORTED_MODULE_2__=__nested_webpack_require_171376__("./src/hypha/webrtc-client.js");__nested_webpack_require_171376__.d(__nested_webpack_exports__,"getRTCService",(function(){return _webrtc_client_js__WEBPACK_IMPORTED_MODULE_2__.getRTCService})),__nested_webpack_require_171376__.d(__nested_webpack_exports__,"registerRTCService",(function(){return _webrtc_client_js__WEBPACK_IMPORTED_MODULE_2__.registerRTCService}));var _package_json__WEBPACK_IMPORTED_MODULE_3__=__nested_webpack_require_171376__("./package.json"),_package_json__WEBPACK_IMPORTED_MODULE_3___namespace=__nested_webpack_require_171376__.t("./package.json",1);__nested_webpack_require_171376__.d(__nested_webpack_exports__,"VERSION",(function(){return _package_json__WEBPACK_IMPORTED_MODULE_3__.version}));const MAX_RETRY=1e4;class WebsocketRPCConnection{constructor(e,t,n,r,i=60,s=null){Object(_utils_js__WEBPACK_IMPORTED_MODULE_1__.assert)(e&&t,"server_url and client_id are required"),e=e+"?client_id="+t,n&&(e+="&workspace="+n),r&&(e+="&token="+r),this._websocket=null,this._handle_message=null,this._reconnection_token=null,this._server_url=e,this._timeout=1e3*i,this._opening=null,this._retry_count=0,this._closing=!1,this._client_id=t,this._workspace=n,this._WebSocketClass=s}set_reconnection_token(e){this._reconnection_token=e}on_message(e){Object(_utils_js__WEBPACK_IMPORTED_MODULE_1__.assert)(e,"handler is required"),this._handle_message=e}async open(){return this._opening||(this._opening=new Promise(((e,t)=>{const n=this._reconnection_token?`${this._server_url}&reconnection_token=${this._reconnection_token}`:this._server_url;console.info("Creating a new connection to ",n.split("?")[0]);let r=null;n.startsWith("wss://local-hypha-server:")?this._WebSocketClass?r=new this._WebSocketClass(n):(console.log("Using local websocket"),console.log("Connecting to local websocket "+n),r=new LocalWebSocket(n,this._client_id,this._workspace)):r=this._WebSocketClass?new this._WebSocketClass(n):new WebSocket(n),r.binaryType="arraybuffer",r.onmessage=e=>{const t=e.data;this._handle_message(t)},r.onopen=()=>{this._websocket=r,console.info("WebSocket connection established"),this._retry_count=0,e()},r.onclose=e=>{console.log("websocket closed"),this._closing||(console.log("Websocket connection interrupted, retrying..."),this._retry_count++,setTimeout((()=>this.open()),this._timeout)),this._websocket=null},r.onerror=e=>{console.log("Error occurred in websocket connection: ",e),t(new Error("Websocket connection failed.")),this._websocket=null}})).finally((()=>{this._opening=null}))),this._opening}async emit_message(e){return Object(_utils_js__WEBPACK_IMPORTED_MODULE_1__.assert)(this._handle_message,"No handler for message"),this._websocket&&this._websocket.readyState===WebSocket.OPEN||await this.open(),new Promise(((t,n)=>{if(this._websocket)if(this._websocket.readyState===WebSocket.CONNECTING){const r=setTimeout((()=>{n(new Error("WebSocket connection timed out"))}),this._timeout);this._websocket.addEventListener("open",(()=>{clearTimeout(r);try{this._websocket.send(e),t()}catch(e){console.error(`Failed to send data, error: ${e}`),n(e)}}))}else if(this._websocket.readyState===WebSocket.OPEN)try{this._websocket.send(e),t()}catch(e){console.error(`Failed to send data, error: ${e}`),n(e)}else n(new Error("WebSocket is not in the OPEN or CONNECTING state"));else n(new Error("Websocket connection not available"))}))}disconnect(e){this._closing=!0;const t=this._websocket;this._websocket=null,t&&t.readyState===WebSocket.OPEN&&t.close(1e3,e),console.info(`Websocket connection disconnected (${e})`)}}function normalizeServerUrl(e){if(!e)throw new Error("server_url is required");return e.startsWith("http://")?e=e.replace("http://","ws://").replace(/\/$/,"")+"/ws":e.startsWith("https://")&&(e=e.replace("https://","wss://").replace(/\/$/,"")+"/ws"),e}async function login(e){const t=e.login_service_id||"public/*:hypha-login",n=e.login_timeout||60,r=e.login_callback,i=await connectToServer({name:"initial login client",server_url:e.server_url});try{const e=await i.get_service(t),s=await e.start();return r?await r(s):console.log(`Please open your browser and login at ${s.login_url}`),await e.check(s.key,n)}catch(e){throw e}finally{await i.disconnect()}}async function connectToServer(e){e.server&&(e.server_url=e.server_url||e.server.url,e.WebSocketClass=e.WebSocketClass||e.server.WebSocketClass);let t=e.client_id;t||(t=Object(_utils_js__WEBPACK_IMPORTED_MODULE_1__.randId)(),e.client_id=t);let n=normalizeServerUrl(e.server_url),r=new WebsocketRPCConnection(n,t,e.workspace,e.token,e.method_timeout||60,e.WebSocketClass);await r.open();const i=new _rpc_js__WEBPACK_IMPORTED_MODULE_0__.RPC(r,{client_id:t,manager_id:"workspace-manager",default_context:{connection_type:"websocket"},name:e.name,method_timeout:e.method_timeout}),s=await i.get_remote_service("workspace-manager:default");if(s.rpc=i,s.config.client_id=t,s.export=async function(t){t.id="default",t.name=e.name||t.id,await i.register_service(t,!0)},s.getPlugin=async function(e){return await s.get_service(e+":default")},s.listPlugins=s.listServices,s.disconnect=async function(){await i.disconnect(),await r.disconnect()},s.registerCodec=i.register_codec.bind(i),s.emit=async function(e){return Object(_utils_js__WEBPACK_IMPORTED_MODULE_1__.assert)(e&&"object"==typeof e,"message must be a dictionary"),Object(_utils_js__WEBPACK_IMPORTED_MODULE_1__.assert)("to"in e,"message must have a 'to' field"),Object(_utils_js__WEBPACK_IMPORTED_MODULE_1__.assert)("type"in e,"message must have a 'type' field"),Object(_utils_js__WEBPACK_IMPORTED_MODULE_1__.assert)("method"!==type,"message type cannot be 'method'"),await i.emit(e)},s.on=function(e,t){Object(_utils_js__WEBPACK_IMPORTED_MODULE_1__.assert)("method"!==e,"message type cannot be 'method'"),i.on(e,t)},e.webrtc&&await Object(_webrtc_client_js__WEBPACK_IMPORTED_MODULE_2__.registerRTCService)(s,t+"-rtc",e.webrtc_config),s.get_service||s.getService){const e=s.get_service||s.getService;s.get_service=async function(t,n,r){Object(_utils_js__WEBPACK_IMPORTED_MODULE_1__.assert)([void 0,!0,!1,"auto"].includes(n),"webrtc must be true, false or 'auto'");const i=await e(t);if(!0===n||"auto"===n){if(i.id.includes(":")&&i.id.includes("/")){const e=i.id.split(":")[0];try{const t=await Object(_webrtc_client_js__WEBPACK_IMPORTED_MODULE_2__.getRTCService)(s,e+":"+e.split("/")[1]+"-rtc",r),n=await t.get_service(i.id.split(":")[1]);return n._webrtc=!0,n._peer=t,n._service=i,n}catch(e){console.warn("Failed to get webrtc service, using websocket connection",e)}}if(!0===n)throw new Error("Failed to get the service via webrtc")}return i},s.getService=s.get_service}return s}class LocalWebSocket{constructor(e,t,n){this.url=e,this.onopen=()=>{},this.onmessage=()=>{},this.onclose=()=>{},this.onerror=()=>{},this.client_id=t,this.workspace=n;const r="undefined"!=typeof window?window:self,i="undefined"!=typeof window;if(this.postMessage=e=>{i?window.parent.postMessage(e,"*"):self.postMessage(e)},this.readyState=WebSocket.CONNECTING,r.addEventListener("message",(e=>{const{type:t,data:n,to:r}=e.data;if(r===this.client_id)switch(t){case"message":this.readyState===WebSocket.OPEN&&this.onmessage&&this.onmessage({data:n});break;case"connected":this.readyState=WebSocket.OPEN,this.onopen(e);break;case"closed":this.readyState=WebSocket.CLOSED,this.onclose(e)}else console.debug("message not for me",r,this.client_id)}),!1),!this.client_id)throw new Error("client_id is required");if(!this.workspace)throw new Error("workspace is required");this.postMessage({type:"connect",url:this.url,from:this.client_id,workspace:this.workspace})}send(e){this.readyState===WebSocket.OPEN&&this.postMessage({type:"message",data:e,from:this.client_id,workspace:this.workspace})}close(){this.readyState=WebSocket.CLOSING,this.postMessage({type:"close",from:this.client_id,workspace:this.workspace}),this.onclose()}addEventListener(e,t){"message"===e&&(this.onmessage=t),"open"===e&&(this.onopen=t),"close"===e&&(this.onclose=t),"error"===e&&(this.onerror=t)}}function setupLocalClient({enable_execution=!1,on_ready=null}){return new Promise(((resolve,reject)=>{const context="undefined"!=typeof window?window:self,isWindow="undefined"!=typeof window;context.addEventListener("message",(event=>{const{type,server_url,workspace,client_id,token,method_timeout,name,config}=event.data;if("initializeHyphaClient"===type){if(!server_url||!workspace||!client_id)return void console.error("server_url, workspace, and client_id are required.");if(!server_url.startsWith("https://local-hypha-server:"))return void console.error("server_url should start with https://local-hypha-server:");connectToServer({server_url,workspace,client_id,token,method_timeout,name}).then((async server=>{globalThis.api=server;try{if(isWindow&&enable_execution){function e(e){return new Promise(((t,n)=>{const r=document.createElement("script");r.innerHTML=e.content,r.lang=e.lang,r.onload=()=>t(),r.onerror=e=>n(e),document.head.appendChild(r)}))}if(config.styles&&config.styles.length>0)for(const t of config.styles){const n=document.createElement("style");n.innerHTML=t.content,n.lang=t.lang,document.head.appendChild(n)}if(config.links&&config.links.length>0)for(const r of config.links){const i=document.createElement("a");i.href=r.url,i.innerText=r.text,document.body.appendChild(i)}if(config.windows&&config.windows.length>0)for(const s of config.windows){document.body.innerHTML=s.content;break}if(config.scripts&&config.scripts.length>0)for(const o of config.scripts){if("javascript"!==o.lang)throw new Error("Only javascript scripts are supported");await e(o)}}else if(!isWindow&&enable_execution&&config.scripts&&config.scripts.length>0)for(const script of config.scripts){if("javascript"!==script.lang)throw new Error("Only javascript scripts are supported");eval(script.content)}on_ready&&await on_ready(server,config),resolve(server)}catch(a){await server.update_client_info({id:client_id,error:a.message}),reject(a)}}))}}),!1),isWindow?window.parent.postMessage({type:"hyphaClientReady"},"*"):self.postMessage({type:"hyphaClientReady"})}))}}})},module.exports=factory()},822:function(module){var factory;factory=function(){return function(e){var t={};function n(r){if(t[r])return t[r].exports;var i=t[r]={i:r,l:!1,exports:{}};return e[r].call(i.exports,i,i.exports,n),i.l=!0,i.exports}return n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)n.d(r,i,function(t){return e[t]}.bind(null,i));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s="./src/hypha/rpc.js")}({"./node_modules/@msgpack/msgpack/dist.es5+esm/CachedKeyDecoder.mjs":function(e,t,n){n.r(t),n.d(t,"CachedKeyDecoder",(function(){return i}));var r=n("./node_modules/@msgpack/msgpack/dist.es5+esm/utils/utf8.mjs"),i=function(){function e(e,t){void 0===e&&(e=16),void 0===t&&(t=16),this.maxKeyLength=e,this.maxLengthPerKey=t,this.hit=0,this.miss=0,this.caches=[];for(var n=0;n<this.maxKeyLength;n++)this.caches.push([])}return e.prototype.canBeCached=function(e){return e>0&&e<=this.maxKeyLength},e.prototype.find=function(e,t,n){e:for(var r=0,i=this.caches[n-1];r<i.length;r++){for(var s=i[r],o=s.bytes,a=0;a<n;a++)if(o[a]!==e[t+a])continue e;return s.str}return null},e.prototype.store=function(e,t){var n=this.caches[e.length-1],r={bytes:e,str:t};n.length>=this.maxLengthPerKey?n[Math.random()*n.length|0]=r:n.push(r)},e.prototype.decode=function(e,t,n){var i=this.find(e,t,n);if(null!=i)return this.hit++,i;this.miss++;var s=Object(r.utf8DecodeJs)(e,t,n),o=Uint8Array.prototype.slice.call(e,t,t+n);return this.store(o,s),s},e}()},"./node_modules/@msgpack/msgpack/dist.es5+esm/DecodeError.mjs":function(e,t,n){n.r(t),n.d(t,"DecodeError",(function(){return s}));var r,i=(r=function(e,t){return r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])},r(e,t)},function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function n(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}),s=function(e){function t(n){var r=e.call(this,n)||this,i=Object.create(t.prototype);return Object.setPrototypeOf(r,i),Object.defineProperty(r,"name",{configurable:!0,enumerable:!1,value:t.name}),r}return i(t,e),t}(Error)},"./node_modules/@msgpack/msgpack/dist.es5+esm/Decoder.mjs":function(e,t,n){n.r(t),n.d(t,"DataViewIndexOutOfBoundsError",(function(){return _})),n.d(t,"Decoder",(function(){return g}));var r=n("./node_modules/@msgpack/msgpack/dist.es5+esm/utils/prettyByte.mjs"),i=n("./node_modules/@msgpack/msgpack/dist.es5+esm/ExtensionCodec.mjs"),s=n("./node_modules/@msgpack/msgpack/dist.es5+esm/utils/int.mjs"),o=n("./node_modules/@msgpack/msgpack/dist.es5+esm/utils/utf8.mjs"),a=n("./node_modules/@msgpack/msgpack/dist.es5+esm/utils/typedArrays.mjs"),c=n("./node_modules/@msgpack/msgpack/dist.es5+esm/CachedKeyDecoder.mjs"),l=n("./node_modules/@msgpack/msgpack/dist.es5+esm/DecodeError.mjs"),u=function(e,t){var n,r,i,s,o={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return s={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function a(s){return function(a){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;o;)try{if(n=1,r&&(i=2&s[0]?r.return:s[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,s[1])).done)return i;switch(r=0,i&&(s=[2&s[0],i.value]),s[0]){case 0:case 1:i=s;break;case 4:return o.label++,{value:s[1],done:!1};case 5:o.label++,r=s[1],s=[0];continue;case 7:s=o.ops.pop(),o.trys.pop();continue;default:if(!((i=(i=o.trys).length>0&&i[i.length-1])||6!==s[0]&&2!==s[0])){o=0;continue}if(3===s[0]&&(!i||s[1]>i[0]&&s[1]<i[3])){o.label=s[1];break}if(6===s[0]&&o.label<i[1]){o.label=i[1],i=s;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(s);break}i[2]&&o.ops.pop(),o.trys.pop();continue}s=t.call(e,o)}catch(e){s=[6,e],r=0}finally{n=i=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,a])}}},d=function(e){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var t,n=e[Symbol.asyncIterator];return n?n.call(e):(e="function"==typeof __values?__values(e):e[Symbol.iterator](),t={},r("next"),r("throw"),r("return"),t[Symbol.asyncIterator]=function(){return this},t);function r(n){t[n]=e[n]&&function(t){return new Promise((function(r,i){!function(e,t,n,r){Promise.resolve(r).then((function(t){e({value:t,done:n})}),t)}(r,i,(t=e[n](t)).done,t.value)}))}}},h=function(e){return this instanceof h?(this.v=e,this):new h(e)},p=new DataView(new ArrayBuffer(0)),f=new Uint8Array(p.buffer),_=function(){try{p.getInt8(0)}catch(e){return e.constructor}throw new Error("never reached")}(),m=new _("Insufficient data"),y=new c.CachedKeyDecoder,g=function(){function e(e,t,n,r,o,a,c,l){void 0===e&&(e=i.ExtensionCodec.defaultCodec),void 0===t&&(t=void 0),void 0===n&&(n=s.UINT32_MAX),void 0===r&&(r=s.UINT32_MAX),void 0===o&&(o=s.UINT32_MAX),void 0===a&&(a=s.UINT32_MAX),void 0===c&&(c=s.UINT32_MAX),void 0===l&&(l=y),this.extensionCodec=e,this.context=t,this.maxStrLength=n,this.maxBinLength=r,this.maxArrayLength=o,this.maxMapLength=a,this.maxExtLength=c,this.keyDecoder=l,this.totalPos=0,this.pos=0,this.view=p,this.bytes=f,this.headByte=-1,this.stack=[]}return e.prototype.reinitializeState=function(){this.totalPos=0,this.headByte=-1,this.stack.length=0},e.prototype.setBuffer=function(e){this.bytes=Object(a.ensureUint8Array)(e),this.view=Object(a.createDataView)(this.bytes),this.pos=0},e.prototype.appendBuffer=function(e){if(-1!==this.headByte||this.hasRemaining(1)){var t=this.bytes.subarray(this.pos),n=Object(a.ensureUint8Array)(e),r=new Uint8Array(t.length+n.length);r.set(t),r.set(n,t.length),this.setBuffer(r)}else this.setBuffer(e)},e.prototype.hasRemaining=function(e){return this.view.byteLength-this.pos>=e},e.prototype.createExtraByteError=function(e){var t=this.view,n=this.pos;return new RangeError("Extra "+(t.byteLength-n)+" of "+t.byteLength+" byte(s) found at buffer["+e+"]")},e.prototype.decode=function(e){this.reinitializeState(),this.setBuffer(e);var t=this.doDecodeSync();if(this.hasRemaining(1))throw this.createExtraByteError(this.pos);return t},e.prototype.decodeMulti=function(e){return u(this,(function(t){switch(t.label){case 0:this.reinitializeState(),this.setBuffer(e),t.label=1;case 1:return this.hasRemaining(1)?[4,this.doDecodeSync()]:[3,3];case 2:return t.sent(),[3,1];case 3:return[2]}}))},e.prototype.decodeAsync=function(e){var t,n,i,s,o,a,c,l;return o=this,a=void 0,l=function(){var o,a,c,l,h,p,f,m;return u(this,(function(u){switch(u.label){case 0:o=!1,u.label=1;case 1:u.trys.push([1,6,7,12]),t=d(e),u.label=2;case 2:return[4,t.next()];case 3:if((n=u.sent()).done)return[3,5];if(c=n.value,o)throw this.createExtraByteError(this.totalPos);this.appendBuffer(c);try{a=this.doDecodeSync(),o=!0}catch(e){if(!(e instanceof _))throw e}this.totalPos+=this.pos,u.label=4;case 4:return[3,2];case 5:return[3,12];case 6:return l=u.sent(),i={error:l},[3,12];case 7:return u.trys.push([7,,10,11]),n&&!n.done&&(s=t.return)?[4,s.call(t)]:[3,9];case 8:u.sent(),u.label=9;case 9:return[3,11];case 10:if(i)throw i.error;return[7];case 11:return[7];case 12:if(o){if(this.hasRemaining(1))throw this.createExtraByteError(this.totalPos);return[2,a]}throw p=(h=this).headByte,f=h.pos,m=h.totalPos,new RangeError("Insufficient data in parsing "+Object(r.prettyByte)(p)+" at "+m+" ("+f+" in the current buffer)")}}))},new((c=void 0)||(c=Promise))((function(e,t){function n(e){try{i(l.next(e))}catch(e){t(e)}}function r(e){try{i(l.throw(e))}catch(e){t(e)}}function i(t){var i;t.done?e(t.value):(i=t.value,i instanceof c?i:new c((function(e){e(i)}))).then(n,r)}i((l=l.apply(o,a||[])).next())}))},e.prototype.decodeArrayStream=function(e){return this.decodeMultiAsync(e,!0)},e.prototype.decodeStream=function(e){return this.decodeMultiAsync(e,!1)},e.prototype.decodeMultiAsync=function(e,t){return function(e,t,n){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var r,i=n.apply(e,t||[]),s=[];return r={},o("next"),o("throw"),o("return"),r[Symbol.asyncIterator]=function(){return this},r;function o(e){i[e]&&(r[e]=function(t){return new Promise((function(n,r){s.push([e,t,n,r])>1||a(e,t)}))})}function a(e,t){try{(n=i[e](t)).value instanceof h?Promise.resolve(n.value.v).then(c,l):u(s[0][2],n)}catch(e){u(s[0][3],e)}var n}function c(e){a("next",e)}function l(e){a("throw",e)}function u(e,t){e(t),s.shift(),s.length&&a(s[0][0],s[0][1])}}(this,arguments,(function(){var n,r,i,s,o,a,c,l,p;return u(this,(function(u){switch(u.label){case 0:n=t,r=-1,u.label=1;case 1:u.trys.push([1,13,14,19]),i=d(e),u.label=2;case 2:return[4,h(i.next())];case 3:if((s=u.sent()).done)return[3,12];if(o=s.value,t&&0===r)throw this.createExtraByteError(this.totalPos);this.appendBuffer(o),n&&(r=this.readArraySize(),n=!1,this.complete()),u.label=4;case 4:u.trys.push([4,9,,10]),u.label=5;case 5:return[4,h(this.doDecodeSync())];case 6:return[4,u.sent()];case 7:return u.sent(),0==--r?[3,8]:[3,5];case 8:return[3,10];case 9:if(!((a=u.sent())instanceof _))throw a;return[3,10];case 10:this.totalPos+=this.pos,u.label=11;case 11:return[3,2];case 12:return[3,19];case 13:return c=u.sent(),l={error:c},[3,19];case 14:return u.trys.push([14,,17,18]),s&&!s.done&&(p=i.return)?[4,h(p.call(i))]:[3,16];case 15:u.sent(),u.label=16;case 16:return[3,18];case 17:if(l)throw l.error;return[7];case 18:return[7];case 19:return[2]}}))}))},e.prototype.doDecodeSync=function(){e:for(;;){var e=this.readHeadByte(),t=void 0;if(e>=224)t=e-256;else if(e<192)if(e<128)t=e;else if(e<144){if(0!=(i=e-128)){this.pushMapState(i),this.complete();continue e}t={}}else if(e<160){if(0!=(i=e-144)){this.pushArrayState(i),this.complete();continue e}t=[]}else{var n=e-160;t=this.decodeUtf8String(n,0)}else if(192===e)t=null;else if(194===e)t=!1;else if(195===e)t=!0;else if(202===e)t=this.readF32();else if(203===e)t=this.readF64();else if(204===e)t=this.readU8();else if(205===e)t=this.readU16();else if(206===e)t=this.readU32();else if(207===e)t=this.readU64();else if(208===e)t=this.readI8();else if(209===e)t=this.readI16();else if(210===e)t=this.readI32();else if(211===e)t=this.readI64();else if(217===e)n=this.lookU8(),t=this.decodeUtf8String(n,1);else if(218===e)n=this.lookU16(),t=this.decodeUtf8String(n,2);else if(219===e)n=this.lookU32(),t=this.decodeUtf8String(n,4);else if(220===e){if(0!==(i=this.readU16())){this.pushArrayState(i),this.complete();continue e}t=[]}else if(221===e){if(0!==(i=this.readU32())){this.pushArrayState(i),this.complete();continue e}t=[]}else if(222===e){if(0!==(i=this.readU16())){this.pushMapState(i),this.complete();continue e}t={}}else if(223===e){if(0!==(i=this.readU32())){this.pushMapState(i),this.complete();continue e}t={}}else if(196===e){var i=this.lookU8();t=this.decodeBinary(i,1)}else if(197===e)i=this.lookU16(),t=this.decodeBinary(i,2);else if(198===e)i=this.lookU32(),t=this.decodeBinary(i,4);else if(212===e)t=this.decodeExtension(1,0);else if(213===e)t=this.decodeExtension(2,0);else if(214===e)t=this.decodeExtension(4,0);else if(215===e)t=this.decodeExtension(8,0);else if(216===e)t=this.decodeExtension(16,0);else if(199===e)i=this.lookU8(),t=this.decodeExtension(i,1);else if(200===e)i=this.lookU16(),t=this.decodeExtension(i,2);else{if(201!==e)throw new l.DecodeError("Unrecognized type byte: "+Object(r.prettyByte)(e));i=this.lookU32(),t=this.decodeExtension(i,4)}this.complete();for(var s=this.stack;s.length>0;){var o=s[s.length-1];if(0===o.type){if(o.array[o.position]=t,o.position++,o.position!==o.size)continue e;s.pop(),t=o.array}else{if(1===o.type){if(void 0,"string"!=(a=typeof t)&&"number"!==a)throw new l.DecodeError("The type of key must be string or number but "+typeof t);if("__proto__"===t)throw new l.DecodeError("The key __proto__ is not allowed");o.key=t,o.type=2;continue e}if(o.map[o.key]=t,o.readCount++,o.readCount!==o.size){o.key=null,o.type=1;continue e}s.pop(),t=o.map}}return t}var a},e.prototype.readHeadByte=function(){return-1===this.headByte&&(this.headByte=this.readU8()),this.headByte},e.prototype.complete=function(){this.headByte=-1},e.prototype.readArraySize=function(){var e=this.readHeadByte();switch(e){case 220:return this.readU16();case 221:return this.readU32();default:if(e<160)return e-144;throw new l.DecodeError("Unrecognized array type byte: "+Object(r.prettyByte)(e))}},e.prototype.pushMapState=function(e){if(e>this.maxMapLength)throw new l.DecodeError("Max length exceeded: map length ("+e+") > maxMapLengthLength ("+this.maxMapLength+")");this.stack.push({type:1,size:e,key:null,readCount:0,map:{}})},e.prototype.pushArrayState=function(e){if(e>this.maxArrayLength)throw new l.DecodeError("Max length exceeded: array length ("+e+") > maxArrayLength ("+this.maxArrayLength+")");this.stack.push({type:0,size:e,array:new Array(e),position:0})},e.prototype.decodeUtf8String=function(e,t){var n;if(e>this.maxStrLength)throw new l.DecodeError("Max length exceeded: UTF-8 byte length ("+e+") > maxStrLength ("+this.maxStrLength+")");if(this.bytes.byteLength<this.pos+t+e)throw m;var r,i=this.pos+t;return r=this.stateIsMapKey()&&(null===(n=this.keyDecoder)||void 0===n?void 0:n.canBeCached(e))?this.keyDecoder.decode(this.bytes,i,e):e>o.TEXT_DECODER_THRESHOLD?Object(o.utf8DecodeTD)(this.bytes,i,e):Object(o.utf8DecodeJs)(this.bytes,i,e),this.pos+=t+e,r},e.prototype.stateIsMapKey=function(){return this.stack.length>0&&1===this.stack[this.stack.length-1].type},e.prototype.decodeBinary=function(e,t){if(e>this.maxBinLength)throw new l.DecodeError("Max length exceeded: bin length ("+e+") > maxBinLength ("+this.maxBinLength+")");if(!this.hasRemaining(e+t))throw m;var n=this.pos+t,r=this.bytes.subarray(n,n+e);return this.pos+=t+e,r},e.prototype.decodeExtension=function(e,t){if(e>this.maxExtLength)throw new l.DecodeError("Max length exceeded: ext length ("+e+") > maxExtLength ("+this.maxExtLength+")");var n=this.view.getInt8(this.pos+t),r=this.decodeBinary(e,t+1);return this.extensionCodec.decode(r,n,this.context)},e.prototype.lookU8=function(){return this.view.getUint8(this.pos)},e.prototype.lookU16=function(){return this.view.getUint16(this.pos)},e.prototype.lookU32=function(){return this.view.getUint32(this.pos)},e.prototype.readU8=function(){var e=this.view.getUint8(this.pos);return this.pos++,e},e.prototype.readI8=function(){var e=this.view.getInt8(this.pos);return this.pos++,e},e.prototype.readU16=function(){var e=this.view.getUint16(this.pos);return this.pos+=2,e},e.prototype.readI16=function(){var e=this.view.getInt16(this.pos);return this.pos+=2,e},e.prototype.readU32=function(){var e=this.view.getUint32(this.pos);return this.pos+=4,e},e.prototype.readI32=function(){var e=this.view.getInt32(this.pos);return this.pos+=4,e},e.prototype.readU64=function(){var e=Object(s.getUint64)(this.view,this.pos);return this.pos+=8,e},e.prototype.readI64=function(){var e=Object(s.getInt64)(this.view,this.pos);return this.pos+=8,e},e.prototype.readF32=function(){var e=this.view.getFloat32(this.pos);return this.pos+=4,e},e.prototype.readF64=function(){var e=this.view.getFloat64(this.pos);return this.pos+=8,e},e}()},"./node_modules/@msgpack/msgpack/dist.es5+esm/Encoder.mjs":function(e,t,n){n.r(t),n.d(t,"DEFAULT_MAX_DEPTH",(function(){return a})),n.d(t,"DEFAULT_INITIAL_BUFFER_SIZE",(function(){return c})),n.d(t,"Encoder",(function(){return l}));var r=n("./node_modules/@msgpack/msgpack/dist.es5+esm/utils/utf8.mjs"),i=n("./node_modules/@msgpack/msgpack/dist.es5+esm/ExtensionCodec.mjs"),s=n("./node_modules/@msgpack/msgpack/dist.es5+esm/utils/int.mjs"),o=n("./node_modules/@msgpack/msgpack/dist.es5+esm/utils/typedArrays.mjs"),a=100,c=2048,l=function(){function e(e,t,n,r,s,o,l,u){void 0===e&&(e=i.ExtensionCodec.defaultCodec),void 0===t&&(t=void 0),void 0===n&&(n=a),void 0===r&&(r=c),void 0===s&&(s=!1),void 0===o&&(o=!1),void 0===l&&(l=!1),void 0===u&&(u=!1),this.extensionCodec=e,this.context=t,this.maxDepth=n,this.initialBufferSize=r,this.sortKeys=s,this.forceFloat32=o,this.ignoreUndefined=l,this.forceIntegerToFloat=u,this.pos=0,this.view=new DataView(new ArrayBuffer(this.initialBufferSize)),this.bytes=new Uint8Array(this.view.buffer)}return e.prototype.getUint8Array=function(){return this.bytes.subarray(0,this.pos)},e.prototype.reinitializeState=function(){this.pos=0},e.prototype.encode=function(e){return this.reinitializeState(),this.doEncode(e,1),this.getUint8Array()},e.prototype.doEncode=function(e,t){if(t>this.maxDepth)throw new Error("Too deep objects in depth "+t);null==e?this.encodeNil():"boolean"==typeof e?this.encodeBoolean(e):"number"==typeof e?this.encodeNumber(e):"string"==typeof e?this.encodeString(e):this.encodeObject(e,t)},e.prototype.ensureBufferSizeToWrite=function(e){var t=this.pos+e;this.view.byteLength<t&&this.resizeBuffer(2*t)},e.prototype.resizeBuffer=function(e){var t=new ArrayBuffer(e),n=new Uint8Array(t),r=new DataView(t);n.set(this.bytes),this.view=r,this.bytes=n},e.prototype.encodeNil=function(){this.writeU8(192)},e.prototype.encodeBoolean=function(e){!1===e?this.writeU8(194):this.writeU8(195)},e.prototype.encodeNumber=function(e){Number.isSafeInteger(e)&&!this.forceIntegerToFloat?e>=0?e<128?this.writeU8(e):e<256?(this.writeU8(204),this.writeU8(e)):e<65536?(this.writeU8(205),this.writeU16(e)):e<4294967296?(this.writeU8(206),this.writeU32(e)):(this.writeU8(207),this.writeU64(e)):e>=-32?this.writeU8(224|e+32):e>=-128?(this.writeU8(208),this.writeI8(e)):e>=-32768?(this.writeU8(209),this.writeI16(e)):e>=-2147483648?(this.writeU8(210),this.writeI32(e)):(this.writeU8(211),this.writeI64(e)):this.forceFloat32?(this.writeU8(202),this.writeF32(e)):(this.writeU8(203),this.writeF64(e))},e.prototype.writeStringHeader=function(e){if(e<32)this.writeU8(160+e);else if(e<256)this.writeU8(217),this.writeU8(e);else if(e<65536)this.writeU8(218),this.writeU16(e);else{if(!(e<4294967296))throw new Error("Too long string: "+e+" bytes in UTF-8");this.writeU8(219),this.writeU32(e)}},e.prototype.encodeString=function(e){if(e.length>r.TEXT_ENCODER_THRESHOLD){var t=Object(r.utf8Count)(e);this.ensureBufferSizeToWrite(5+t),this.writeStringHeader(t),Object(r.utf8EncodeTE)(e,this.bytes,this.pos),this.pos+=t}else t=Object(r.utf8Count)(e),this.ensureBufferSizeToWrite(5+t),this.writeStringHeader(t),Object(r.utf8EncodeJs)(e,this.bytes,this.pos),this.pos+=t},e.prototype.encodeObject=function(e,t){var n=this.extensionCodec.tryToEncode(e,this.context);if(null!=n)this.encodeExtension(n);else if(Array.isArray(e))this.encodeArray(e,t);else if(ArrayBuffer.isView(e))this.encodeBinary(e);else{if("object"!=typeof e)throw new Error("Unrecognized object: "+Object.prototype.toString.apply(e));this.encodeMap(e,t)}},e.prototype.encodeBinary=function(e){var t=e.byteLength;if(t<256)this.writeU8(196),this.writeU8(t);else if(t<65536)this.writeU8(197),this.writeU16(t);else{if(!(t<4294967296))throw new Error("Too large binary: "+t);this.writeU8(198),this.writeU32(t)}var n=Object(o.ensureUint8Array)(e);this.writeU8a(n)},e.prototype.encodeArray=function(e,t){var n=e.length;if(n<16)this.writeU8(144+n);else if(n<65536)this.writeU8(220),this.writeU16(n);else{if(!(n<4294967296))throw new Error("Too large array: "+n);this.writeU8(221),this.writeU32(n)}for(var r=0,i=e;r<i.length;r++){var s=i[r];this.doEncode(s,t+1)}},e.prototype.countWithoutUndefined=function(e,t){for(var n=0,r=0,i=t;r<i.length;r++)void 0!==e[i[r]]&&n++;return n},e.prototype.encodeMap=function(e,t){var n=Object.keys(e);this.sortKeys&&n.sort();var r=this.ignoreUndefined?this.countWithoutUndefined(e,n):n.length;if(r<16)this.writeU8(128+r);else if(r<65536)this.writeU8(222),this.writeU16(r);else{if(!(r<4294967296))throw new Error("Too large map object: "+r);this.writeU8(223),this.writeU32(r)}for(var i=0,s=n;i<s.length;i++){var o=s[i],a=e[o];this.ignoreUndefined&&void 0===a||(this.encodeString(o),this.doEncode(a,t+1))}},e.prototype.encodeExtension=function(e){var t=e.data.length;if(1===t)this.writeU8(212);else if(2===t)this.writeU8(213);else if(4===t)this.writeU8(214);else if(8===t)this.writeU8(215);else if(16===t)this.writeU8(216);else if(t<256)this.writeU8(199),this.writeU8(t);else if(t<65536)this.writeU8(200),this.writeU16(t);else{if(!(t<4294967296))throw new Error("Too large extension object: "+t);this.writeU8(201),this.writeU32(t)}this.writeI8(e.type),this.writeU8a(e.data)},e.prototype.writeU8=function(e){this.ensureBufferSizeToWrite(1),this.view.setUint8(this.pos,e),this.pos++},e.prototype.writeU8a=function(e){var t=e.length;this.ensureBufferSizeToWrite(t),this.bytes.set(e,this.pos),this.pos+=t},e.prototype.writeI8=function(e){this.ensureBufferSizeToWrite(1),this.view.setInt8(this.pos,e),this.pos++},e.prototype.writeU16=function(e){this.ensureBufferSizeToWrite(2),this.view.setUint16(this.pos,e),this.pos+=2},e.prototype.writeI16=function(e){this.ensureBufferSizeToWrite(2),this.view.setInt16(this.pos,e),this.pos+=2},e.prototype.writeU32=function(e){this.ensureBufferSizeToWrite(4),this.view.setUint32(this.pos,e),this.pos+=4},e.prototype.writeI32=function(e){this.ensureBufferSizeToWrite(4),this.view.setInt32(this.pos,e),this.pos+=4},e.prototype.writeF32=function(e){this.ensureBufferSizeToWrite(4),this.view.setFloat32(this.pos,e),this.pos+=4},e.prototype.writeF64=function(e){this.ensureBufferSizeToWrite(8),this.view.setFloat64(this.pos,e),this.pos+=8},e.prototype.writeU64=function(e){this.ensureBufferSizeToWrite(8),Object(s.setUint64)(this.view,this.pos,e),this.pos+=8},e.prototype.writeI64=function(e){this.ensureBufferSizeToWrite(8),Object(s.setInt64)(this.view,this.pos,e),this.pos+=8},e}()},"./node_modules/@msgpack/msgpack/dist.es5+esm/ExtData.mjs":function(e,t,n){n.r(t),n.d(t,"ExtData",(function(){return r}));var r=function(e,t){this.type=e,this.data=t}},"./node_modules/@msgpack/msgpack/dist.es5+esm/ExtensionCodec.mjs":function(e,t,n){n.r(t),n.d(t,"ExtensionCodec",(function(){return s}));var r=n("./node_modules/@msgpack/msgpack/dist.es5+esm/ExtData.mjs"),i=n("./node_modules/@msgpack/msgpack/dist.es5+esm/timestamp.mjs"),s=function(){function e(){this.builtInEncoders=[],this.builtInDecoders=[],this.encoders=[],this.decoders=[],this.register(i.timestampExtension)}return e.prototype.register=function(e){var t=e.type,n=e.encode,r=e.decode;if(t>=0)this.encoders[t]=n,this.decoders[t]=r;else{var i=1+t;this.builtInEncoders[i]=n,this.builtInDecoders[i]=r}},e.prototype.tryToEncode=function(e,t){for(var n=0;n<this.builtInEncoders.length;n++)if(null!=(s=this.builtInEncoders[n])&&null!=(o=s(e,t))){var i=-1-n;return new r.ExtData(i,o)}for(n=0;n<this.encoders.length;n++){var s,o;if(null!=(s=this.encoders[n])&&null!=(o=s(e,t)))return i=n,new r.ExtData(i,o)}return e instanceof r.ExtData?e:null},e.prototype.decode=function(e,t,n){var i=t<0?this.builtInDecoders[-1-t]:this.decoders[t];return i?i(e,t,n):new r.ExtData(t,e)},e.defaultCodec=new e,e}()},"./node_modules/@msgpack/msgpack/dist.es5+esm/decode.mjs":function(e,t,n){n.r(t),n.d(t,"defaultDecodeOptions",(function(){return i})),n.d(t,"decode",(function(){return s})),n.d(t,"decodeMulti",(function(){return o}));var r=n("./node_modules/@msgpack/msgpack/dist.es5+esm/Decoder.mjs"),i={};function s(e,t){return void 0===t&&(t=i),new r.Decoder(t.extensionCodec,t.context,t.maxStrLength,t.maxBinLength,t.maxArrayLength,t.maxMapLength,t.maxExtLength).decode(e)}function o(e,t){return void 0===t&&(t=i),new r.Decoder(t.extensionCodec,t.context,t.maxStrLength,t.maxBinLength,t.maxArrayLength,t.maxMapLength,t.maxExtLength).decodeMulti(e)}},"./node_modules/@msgpack/msgpack/dist.es5+esm/decodeAsync.mjs":function(e,t,n){n.r(t),n.d(t,"decodeAsync",(function(){return c})),n.d(t,"decodeArrayStream",(function(){return l})),n.d(t,"decodeMultiStream",(function(){return u})),n.d(t,"decodeStream",(function(){return d}));var r=n("./node_modules/@msgpack/msgpack/dist.es5+esm/Decoder.mjs"),i=n("./node_modules/@msgpack/msgpack/dist.es5+esm/utils/stream.mjs"),s=n("./node_modules/@msgpack/msgpack/dist.es5+esm/decode.mjs"),o=function(e,t,n,r){return new(n||(n=Promise))((function(i,s){function o(e){try{c(r.next(e))}catch(e){s(e)}}function a(e){try{c(r.throw(e))}catch(e){s(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}c((r=r.apply(e,t||[])).next())}))},a=function(e,t){var n,r,i,s,o={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return s={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function a(s){return function(a){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;o;)try{if(n=1,r&&(i=2&s[0]?r.return:s[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,s[1])).done)return i;switch(r=0,i&&(s=[2&s[0],i.value]),s[0]){case 0:case 1:i=s;break;case 4:return o.label++,{value:s[1],done:!1};case 5:o.label++,r=s[1],s=[0];continue;case 7:s=o.ops.pop(),o.trys.pop();continue;default:if(!((i=(i=o.trys).length>0&&i[i.length-1])||6!==s[0]&&2!==s[0])){o=0;continue}if(3===s[0]&&(!i||s[1]>i[0]&&s[1]<i[3])){o.label=s[1];break}if(6===s[0]&&o.label<i[1]){o.label=i[1],i=s;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(s);break}i[2]&&o.ops.pop(),o.trys.pop();continue}s=t.call(e,o)}catch(e){s=[6,e],r=0}finally{n=i=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,a])}}};function c(e,t){return void 0===t&&(t=s.defaultDecodeOptions),o(this,void 0,void 0,(function(){var n;return a(this,(function(s){return n=Object(i.ensureAsyncIterable)(e),[2,new r.Decoder(t.extensionCodec,t.context,t.maxStrLength,t.maxBinLength,t.maxArrayLength,t.maxMapLength,t.maxExtLength).decodeAsync(n)]}))}))}function l(e,t){void 0===t&&(t=s.defaultDecodeOptions);var n=Object(i.ensureAsyncIterable)(e);return new r.Decoder(t.extensionCodec,t.context,t.maxStrLength,t.maxBinLength,t.maxArrayLength,t.maxMapLength,t.maxExtLength).decodeArrayStream(n)}function u(e,t){void 0===t&&(t=s.defaultDecodeOptions);var n=Object(i.ensureAsyncIterable)(e);return new r.Decoder(t.extensionCodec,t.context,t.maxStrLength,t.maxBinLength,t.maxArrayLength,t.maxMapLength,t.maxExtLength).decodeStream(n)}function d(e,t){return void 0===t&&(t=s.defaultDecodeOptions),u(e,t)}},"./node_modules/@msgpack/msgpack/dist.es5+esm/encode.mjs":function(e,t,n){n.r(t),n.d(t,"encode",(function(){return s}));var r=n("./node_modules/@msgpack/msgpack/dist.es5+esm/Encoder.mjs"),i={};function s(e,t){return void 0===t&&(t=i),new r.Encoder(t.extensionCodec,t.context,t.maxDepth,t.initialBufferSize,t.sortKeys,t.forceFloat32,t.ignoreUndefined,t.forceIntegerToFloat).encode(e)}},"./node_modules/@msgpack/msgpack/dist.es5+esm/index.mjs":function(e,t,n){n.r(t);var r=n("./node_modules/@msgpack/msgpack/dist.es5+esm/encode.mjs");n.d(t,"encode",(function(){return r.encode}));var i=n("./node_modules/@msgpack/msgpack/dist.es5+esm/decode.mjs");n.d(t,"decode",(function(){return i.decode})),n.d(t,"decodeMulti",(function(){return i.decodeMulti}));var s=n("./node_modules/@msgpack/msgpack/dist.es5+esm/decodeAsync.mjs");n.d(t,"decodeAsync",(function(){return s.decodeAsync})),n.d(t,"decodeArrayStream",(function(){return s.decodeArrayStream})),n.d(t,"decodeMultiStream",(function(){return s.decodeMultiStream})),n.d(t,"decodeStream",(function(){return s.decodeStream}));var o=n("./node_modules/@msgpack/msgpack/dist.es5+esm/Decoder.mjs");n.d(t,"Decoder",(function(){return o.Decoder})),n.d(t,"DataViewIndexOutOfBoundsError",(function(){return o.DataViewIndexOutOfBoundsError}));var a=n("./node_modules/@msgpack/msgpack/dist.es5+esm/DecodeError.mjs");n.d(t,"DecodeError",(function(){return a.DecodeError}));var c=n("./node_modules/@msgpack/msgpack/dist.es5+esm/Encoder.mjs");n.d(t,"Encoder",(function(){return c.Encoder}));var l=n("./node_modules/@msgpack/msgpack/dist.es5+esm/ExtensionCodec.mjs");n.d(t,"ExtensionCodec",(function(){return l.ExtensionCodec}));var u=n("./node_modules/@msgpack/msgpack/dist.es5+esm/ExtData.mjs");n.d(t,"ExtData",(function(){return u.ExtData}));var d=n("./node_modules/@msgpack/msgpack/dist.es5+esm/timestamp.mjs");n.d(t,"EXT_TIMESTAMP",(function(){return d.EXT_TIMESTAMP})),n.d(t,"encodeDateToTimeSpec",(function(){return d.encodeDateToTimeSpec})),n.d(t,"encodeTimeSpecToTimestamp",(function(){return d.encodeTimeSpecToTimestamp})),n.d(t,"decodeTimestampToTimeSpec",(function(){return d.decodeTimestampToTimeSpec})),n.d(t,"encodeTimestampExtension",(function(){return d.encodeTimestampExtension})),n.d(t,"decodeTimestampExtension",(function(){return d.decodeTimestampExtension}))},"./node_modules/@msgpack/msgpack/dist.es5+esm/timestamp.mjs":function(e,t,n){n.r(t),n.d(t,"EXT_TIMESTAMP",(function(){return s})),n.d(t,"encodeTimeSpecToTimestamp",(function(){return c})),n.d(t,"encodeDateToTimeSpec",(function(){return l})),n.d(t,"encodeTimestampExtension",(function(){return u})),n.d(t,"decodeTimestampToTimeSpec",(function(){return d})),n.d(t,"decodeTimestampExtension",(function(){return h})),n.d(t,"timestampExtension",(function(){return p}));var r=n("./node_modules/@msgpack/msgpack/dist.es5+esm/DecodeError.mjs"),i=n("./node_modules/@msgpack/msgpack/dist.es5+esm/utils/int.mjs"),s=-1,o=4294967295,a=17179869183;function c(e){var t,n=e.sec,r=e.nsec;if(n>=0&&r>=0&&n<=a){if(0===r&&n<=o){var s=new Uint8Array(4);return(t=new DataView(s.buffer)).setUint32(0,n),s}var c=n/4294967296,l=4294967295&n;return s=new Uint8Array(8),(t=new DataView(s.buffer)).setUint32(0,r<<2|3&c),t.setUint32(4,l),s}return s=new Uint8Array(12),(t=new DataView(s.buffer)).setUint32(0,r),Object(i.setInt64)(t,4,n),s}function l(e){var t=e.getTime(),n=Math.floor(t/1e3),r=1e6*(t-1e3*n),i=Math.floor(r/1e9);return{sec:n+i,nsec:r-1e9*i}}function u(e){return e instanceof Date?c(l(e)):null}function d(e){var t=new DataView(e.buffer,e.byteOffset,e.byteLength);switch(e.byteLength){case 4:return{sec:t.getUint32(0),nsec:0};case 8:var n=t.getUint32(0);return{sec:4294967296*(3&n)+t.getUint32(4),nsec:n>>>2};case 12:return{sec:Object(i.getInt64)(t,4),nsec:t.getUint32(0)};default:throw new r.DecodeError("Unrecognized data size for timestamp (expected 4, 8, or 12): "+e.length)}}function h(e){var t=d(e);return new Date(1e3*t.sec+t.nsec/1e6)}var p={type:s,encode:u,decode:h}},"./node_modules/@msgpack/msgpack/dist.es5+esm/utils/int.mjs":function(e,t,n){n.r(t),n.d(t,"UINT32_MAX",(function(){return r})),n.d(t,"setUint64",(function(){return i})),n.d(t,"setInt64",(function(){return s})),n.d(t,"getInt64",(function(){return o})),n.d(t,"getUint64",(function(){return a}));var r=4294967295;function i(e,t,n){var r=n/4294967296,i=n;e.setUint32(t,r),e.setUint32(t+4,i)}function s(e,t,n){var r=Math.floor(n/4294967296),i=n;e.setUint32(t,r),e.setUint32(t+4,i)}function o(e,t){return 4294967296*e.getInt32(t)+e.getUint32(t+4)}function a(e,t){return 4294967296*e.getUint32(t)+e.getUint32(t+4)}},"./node_modules/@msgpack/msgpack/dist.es5+esm/utils/prettyByte.mjs":function(e,t,n){function r(e){return(e<0?"-":"")+"0x"+Math.abs(e).toString(16).padStart(2,"0")}n.r(t),n.d(t,"prettyByte",(function(){return r}))},"./node_modules/@msgpack/msgpack/dist.es5+esm/utils/stream.mjs":function(e,t,n){n.r(t),n.d(t,"isAsyncIterable",(function(){return o})),n.d(t,"asyncIterableFromStream",(function(){return a})),n.d(t,"ensureAsyncIterable",(function(){return c}));var r=function(e,t){var n,r,i,s,o={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return s={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function a(s){return function(a){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;o;)try{if(n=1,r&&(i=2&s[0]?r.return:s[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,s[1])).done)return i;switch(r=0,i&&(s=[2&s[0],i.value]),s[0]){case 0:case 1:i=s;break;case 4:return o.label++,{value:s[1],done:!1};case 5:o.label++,r=s[1],s=[0];continue;case 7:s=o.ops.pop(),o.trys.pop();continue;default:if(!((i=(i=o.trys).length>0&&i[i.length-1])||6!==s[0]&&2!==s[0])){o=0;continue}if(3===s[0]&&(!i||s[1]>i[0]&&s[1]<i[3])){o.label=s[1];break}if(6===s[0]&&o.label<i[1]){o.label=i[1],i=s;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(s);break}i[2]&&o.ops.pop(),o.trys.pop();continue}s=t.call(e,o)}catch(e){s=[6,e],r=0}finally{n=i=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,a])}}},i=function(e){return this instanceof i?(this.v=e,this):new i(e)},s=function(e,t,n){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var r,s=n.apply(e,t||[]),o=[];return r={},a("next"),a("throw"),a("return"),r[Symbol.asyncIterator]=function(){return this},r;function a(e){s[e]&&(r[e]=function(t){return new Promise((function(n,r){o.push([e,t,n,r])>1||c(e,t)}))})}function c(e,t){try{(n=s[e](t)).value instanceof i?Promise.resolve(n.value.v).then(l,u):d(o[0][2],n)}catch(e){d(o[0][3],e)}var n}function l(e){c("next",e)}function u(e){c("throw",e)}function d(e,t){e(t),o.shift(),o.length&&c(o[0][0],o[0][1])}};function o(e){return null!=e[Symbol.asyncIterator]}function a(e){return s(this,arguments,(function(){var t,n,s,o;return r(this,(function(r){switch(r.label){case 0:t=e.getReader(),r.label=1;case 1:r.trys.push([1,,9,10]),r.label=2;case 2:return[4,i(t.read())];case 3:return n=r.sent(),s=n.done,o=n.value,s?[4,i(void 0)]:[3,5];case 4:return[2,r.sent()];case 5:return function(e){if(null==e)throw new Error("Assertion Failure: value must not be null nor undefined")}(o),[4,i(o)];case 6:return[4,r.sent()];case 7:return r.sent(),[3,2];case 8:return[3,10];case 9:return t.releaseLock(),[7];case 10:return[2]}}))}))}function c(e){return o(e)?e:a(e)}},"./node_modules/@msgpack/msgpack/dist.es5+esm/utils/typedArrays.mjs":function(e,t,n){function r(e){return e instanceof Uint8Array?e:ArrayBuffer.isView(e)?new Uint8Array(e.buffer,e.byteOffset,e.byteLength):e instanceof ArrayBuffer?new Uint8Array(e):Uint8Array.from(e)}function i(e){if(e instanceof ArrayBuffer)return new DataView(e);var t=r(e);return new DataView(t.buffer,t.byteOffset,t.byteLength)}n.r(t),n.d(t,"ensureUint8Array",(function(){return r})),n.d(t,"createDataView",(function(){return i}))},"./node_modules/@msgpack/msgpack/dist.es5+esm/utils/utf8.mjs":function(e,t,n){n.r(t),n.d(t,"utf8Count",(function(){return s})),n.d(t,"utf8EncodeJs",(function(){return o})),n.d(t,"TEXT_ENCODER_THRESHOLD",(function(){return c})),n.d(t,"utf8EncodeTE",(function(){return l})),n.d(t,"utf8DecodeJs",(function(){return d})),n.d(t,"TEXT_DECODER_THRESHOLD",(function(){return p})),n.d(t,"utf8DecodeTD",(function(){return f}));var r=n("./node_modules/@msgpack/msgpack/dist.es5+esm/utils/int.mjs"),i=("undefined"==typeof process||"never"!==process.env.TEXT_ENCODING)&&"undefined"!=typeof TextEncoder&&"undefined"!=typeof TextDecoder;function s(e){for(var t=e.length,n=0,r=0;r<t;){var i=e.charCodeAt(r++);if(4294967168&i)if(4294965248&i){if(i>=55296&&i<=56319&&r<t){var s=e.charCodeAt(r);56320==(64512&s)&&(++r,i=((1023&i)<<10)+(1023&s)+65536)}n+=4294901760&i?4:3}else n+=2;else n++}return n}function o(e,t,n){for(var r=e.length,i=n,s=0;s<r;){var o=e.charCodeAt(s++);if(4294967168&o){if(4294965248&o){if(o>=55296&&o<=56319&&s<r){var a=e.charCodeAt(s);56320==(64512&a)&&(++s,o=((1023&o)<<10)+(1023&a)+65536)}4294901760&o?(t[i++]=o>>18&7|240,t[i++]=o>>12&63|128,t[i++]=o>>6&63|128):(t[i++]=o>>12&15|224,t[i++]=o>>6&63|128)}else t[i++]=o>>6&31|192;t[i++]=63&o|128}else t[i++]=o}}var a=i?new TextEncoder:void 0,c=i?"undefined"!=typeof process&&"force"!==process.env.TEXT_ENCODING?200:0:r.UINT32_MAX,l=(null==a?void 0:a.encodeInto)?function(e,t,n){a.encodeInto(e,t.subarray(n))}:function(e,t,n){t.set(a.encode(e),n)},u=4096;function d(e,t,n){for(var r=t,i=r+n,s=[],o="";r<i;){var a=e[r++];if(128&a)if(192==(224&a)){var c=63&e[r++];s.push((31&a)<<6|c)}else if(224==(240&a)){c=63&e[r++];var l=63&e[r++];s.push((31&a)<<12|c<<6|l)}else if(240==(248&a)){var d=(7&a)<<18|(c=63&e[r++])<<12|(l=63&e[r++])<<6|63&e[r++];d>65535&&(d-=65536,s.push(d>>>10&1023|55296),d=56320|1023&d),s.push(d)}else s.push(a);else s.push(a);s.length>=u&&(o+=String.fromCharCode.apply(String,s),s.length=0)}return s.length>0&&(o+=String.fromCharCode.apply(String,s)),o}var h=i?new TextDecoder:null,p=i?"undefined"!=typeof process&&"force"!==process.env.TEXT_DECODER?200:0:r.UINT32_MAX;function f(e,t,n){var r=e.subarray(t,t+n);return h.decode(r)}},"./src/hypha/rpc.js":function(e,t,n){n.r(t),n.d(t,"API_VERSION",(function(){return s})),n.d(t,"RPC",(function(){return d}));var r=n("./src/hypha/utils.js"),i=n("./node_modules/@msgpack/msgpack/dist.es5+esm/index.mjs");const s="0.3.0",o=512e3,a=Object.getPrototypeOf(Object.getPrototypeOf(new Uint8Array)).constructor;function c(e,t){const n=new Uint8Array(e.byteLength+t.byteLength);return n.set(new Uint8Array(e),0),n.set(new Uint8Array(t),e.byteLength),n.buffer}function l(e,t){if(!t)throw new Error("undefined index");return"string"==typeof t?l(e,t.split(".")):0===t.length?e:l(e[t[0]],t.slice(1))}class u{constructor(e,t,n,r){this._timeout=e,this._callback=t,this._args=n,this._label=r||"timer",this._task=null,this.started=!1}start(){this.started?this.reset():(this._task=setTimeout((()=>{this._callback.apply(this,this._args)}),1e3*this._timeout),this.started=!0)}clear(){this._task?(clearTimeout(this._task),this._task=null,this.started=!1):console.warn(`Clearing a timer (${this._label}) which is not started`)}reset(){this._task&&clearTimeout(this._task),this._task=setTimeout((()=>{this._callback.apply(this,this._args)}),1e3*this._timeout),this.started=!0}}class d extends r.MessageEmitter{constructor(e,{client_id:t=null,manager_id:n=null,default_context:i=null,name:s=null,codecs:o=null,method_timeout:a=null,max_message_buffer_size:c=0,debug:l=!1,workspace:u=null}){super(l),this._codecs=o||{},Object(r.assert)(t&&"string"==typeof t),Object(r.assert)(t,"client_id is required"),this._client_id=t,this._name=s,this._connection_info=null,this._workspace=null,this._local_workspace=u,this.manager_id=n,this.default_context=i||{},this._method_annotations=new WeakMap,this._manager_service=null,this._max_message_buffer_size=c,this._chunk_store={},this._method_timeout=a||30,this._services={},this._object_store={services:this._services},e?(this.add_service({id:"built-in",type:"built-in",name:"RPC built-in services",config:{require_context:!0,visibility:"public"},ping:this._ping.bind(this),get_service:this.get_local_service.bind(this),register_service:this.register_service.bind(this),message_cache:{create:this._create_message.bind(this),append:this._append_message.bind(this),process:this._process_message.bind(this),remove:this._remove_message.bind(this)}}),this.on("method",this._handle_method.bind(this)),Object(r.assert)(e.emit_message&&e.on_message),this._emit_message=e.emit_message.bind(e),e.on_message(this._on_message.bind(this)),this._connection=e,this._get_connection_info()):this._emit_message=function(){console.log("No connection to emit message")}}async _get_connection_info(){if(this.manager_id)try{if(await this.get_manager_service(30),Object(r.assert)(this._manager_service),this._connection_info=await this._manager_service.get_connection_info(),!this._local_workspace&&this._connection_info&&this._connection_info.workspace&&(this._local_workspace=this._connection_info.workspace),this._connection_info.reconnection_token&&this._connection.set_reconnection_token){this._connection.set_reconnection_token(this._connection_info.reconnection_token);const e=.8*this._connection_info.reconnection_expires_in;this._get_connection_info_task=setTimeout(this._get_connection_info.bind(this),1e3*e)}}catch(e){console.warn("Failed to fetch user info from ",this.manager_id,e)}}register_codec(e){if(!e.name||!e.encoder&&!e.decoder)throw new Error("Invalid codec format, please make sure you provide a name, type, encoder and decoder.");if(e.type)for(let t of Object.keys(this._codecs))this._codecs[t].type!==e.type&&t!==e.name||(delete this._codecs[t],console.warn("Remove duplicated codec: "+t));this._codecs[e.name]=e}async _ping(e,t){return Object(r.assert)("ping"==e),"pong"}async ping(e,t){let n=this._generate_remote_method({_rtarget:e,_rmethod:"services.built-in.ping",_rpromise:!0,_rdoc:"Ping a remote client",_rsig:"ping(msg)"});Object(r.assert)("pong"==await n("ping",t))}_create_message(e,t,n,r){if(t){if(!this._object_store[e])throw new Error(`session does not exist anymore: ${e}`);this._object_store[e].timer.reset()}if(this._object_store.message_cache||(this._object_store.message_cache={}),!n&&this._object_store.message_cache[e])throw new Error(`Message with the same key (${e}) already exists in the cache store, please use overwrite=true or remove it first.`);this._object_store.message_cache[e]=[]}_append_message(e,t,n,i){if(n){if(!this._object_store[e])throw new Error(`session does not exist anymore: ${e}`);this._object_store[e].timer.reset()}const s=this._object_store.message_cache;if(!s[e])throw new Error(`Message with key ${e} does not exists.`);Object(r.assert)(t instanceof a),s[e].push(t)}_remove_message(e,t){const n=this._object_store.message_cache;if(!n[e])throw new Error(`Message with key ${e} does not exists.`);delete n[e]}_process_message(e,t,n){if(t){if(!this._object_store[e])throw new Error(`session does not exist anymore: ${e}`);this._object_store[e].timer.reset()}const s=this._object_store.message_cache;if(Object(r.assert)(!!n,"Context is required"),!s[e])throw new Error(`Message with key ${e} does not exists.`);var o,a,c,l;s[e]=(c=(a=(o=s[e]).map((function(e){return e.byteLength}))).reduce((function(e,t){return e+t}),0),l=new Uint8Array(c),a.reduce((function(e,t,n){return l.set(new Uint8Array(o[n]),e),e+t}),0),l.buffer),console.debug(`Processing message ${e} (size=${s[e].length})`);let u=Object(i.decodeMulti)(s[e]);const{done:d,value:h}=u.next(),p=h;if(Object.assign(p,{from:n.from,to:n.to,user:n.user}),p.ctx=JSON.parse(JSON.stringify(p)),Object.assign(p.ctx,this.default_context),!d){let e=u.next();Object.assign(p,e.value)}this._fire(p.type,p),delete s[e]}_on_message(e){try{Object(r.assert)(e instanceof ArrayBuffer);let t=Object(i.decodeMulti)(e);const{done:n,value:s}=t.next(),o=s;if(o.ctx=JSON.parse(JSON.stringify(o)),Object.assign(o.ctx,this.default_context),!n){let e=t.next();Object.assign(o,e.value)}this._fire(o.type,o)}catch(e){console.error(e)}}reset(){this._event_handlers={},this._services={}}async disconnect(){this._get_connection_info_task&&(clearTimeout(this._get_connection_info_task),this._get_connection_info_task=null),this._fire("disconnect")}async get_manager_service(e){this.manager_id&&!this._manager_service&&(this._manager_service=await this.get_remote_service(`${this.manager_id}:default`,e))}get_all_local_services(){return this._services}get_local_service(e,t){Object(r.assert)(e);const[n,i]=t.to.split("/");Object(r.assert)(i===this._client_id,"Services can only be accessed locally");const s=this._services[e];if(!s)throw new Error("Service not found: "+e);if("public"==s.config.visibility)return s;if(t.from.startsWith(n+"/"))return s;throw new Error("Permission denied for service: "+e)}async get_remote_service(e,t){t=void 0===t?this._method_timeout:t,!e&&this.manager_id?e=this.manager_id:e.includes(":")||(e=this._client_id+":"+e);const n=e.split(":")[0];Object(r.assert)(n);try{const i=this._generate_remote_method({_rtarget:n,_rmethod:"services.built-in.get_service",_rpromise:!0,_rdoc:"Get a remote service",_rsig:"get_service(service_id)"}),s=await Object(r.waitFor)(i(e.split(":")[1]),t,"Timeout Error: Failed to get remote service: "+e);return s.id=e,s}catch(t){throw console.error("Failed to get remote service: "+e,t),t}}_annotate_service_methods(e,t,n,r,i){if("function"==typeof e){let s=t.split(".")[1];this._method_annotations.set(e,{require_context:Array.isArray(n)?n.includes(s):!!n,run_in_executor:r,method_id:"services."+t,visibility:i})}else if(e instanceof Array||e instanceof Object)for(let s of Object.keys(e)){let o=e[s];if("function"==typeof o&&o.__rpc_object__){let t=o.__rpc_object__._rtarget;if(t.includes("/")&&(t=t.split("/")[1]),this._client_id!==t)throw new Error(`Local method not found: ${o.__rpc_object__._rmethod}, client id mismatch ${this._client_id} != ${t}`);e instanceof Array&&(e=e.slice()),e[s]=l(this._object_store,o.__rpc_object__._rmethod),o=e[s]}this._annotate_service_methods(o,t+"."+s,n,r,i)}}add_service(e,t){if(!e||Array.isArray(e))throw new Error("Invalid service object");if(e.constructor===Object)e=Object.assign({},e);else{const t={},n=Object.getOwnPropertyNames(e).concat(Object.getOwnPropertyNames(Object.getPrototypeOf(e)));for(let r of n)"constructor"!==r&&("function"==typeof e[r]?t[r]=e[r].bind(e):t[r]=e[r]);e.id=e.id||"default",e=t}Object(r.assert)(e.id&&"string"==typeof e.id,`Service id not found: ${e}`),e.name||(e.name=e.id),e.config||(e.config={}),e.type||(e.type="generic");let n=!1,i=!1;e.config.require_context&&(n=e.config.require_context),e.config.run_in_executor&&(i=!0);const s=e.config.visibility||"protected";if(Object(r.assert)(["protected","public"].includes(s)),this._annotate_service_methods(e,e.id,n,i,s),this._services[e.id]){if(!t)throw new Error(`Service already exists: ${e.id}, please specify a different id (not ${e.id}) or overwrite=true`);delete this._services[e.id]}return this._services[e.id]=e,e}async register_service(e,t,n,i){if(void 0===n&&(n=!0),i){const[e,t]=i.to.split("/");Object(r.assert)(t===this._client_id),Object(r.assert)(e===i.from.split("/")[0],"Services can only be registered from the same workspace")}const s=this.add_service(e,t);return n&&(this._fire("service-updated",{service_id:s.id,api:s,type:"add"}),await this._notify_service_update()),{id:`${this._client_id}:${s.id}`,type:s.type,name:s.name,description:s.description||"",config:s.config}}async unregister_service(e,t){if(e instanceof Object&&(e=e.id),!this._services[e])throw new Error(`Service not found: ${e}`);const n=this._services[e];delete this._services[e],this._fire("service-updated",{service_id:e,api:n,type:"remove"}),await this._notify_service_update()}_ndarray(e,t,n){const i=Object(r.typedArrayToDtype)(e);if(n&&n!==i)throw"dtype doesn't match the type of the array: "+i+" != "+n;return t=t||[e.length],{_rtype:"ndarray",_rvalue:e.buffer,_rshape:t,_rdtype:i}}_encode_callback(e,t,n,r,i,s){let o=`${n}.${e}`,a={_rtype:"method",_rtarget:s?`${s}/${this._client_id}`:this._client_id,_rmethod:o,_rpromise:!1};const c=this;return[a,function(){try{t.apply(null,Array.prototype.slice.call(arguments))}catch(e){console.error("Error in callback:",o,e)}finally{r&&c._object_store[n]&&delete c._object_store[n],i&&i.started&&i.clear()}}]}async _encode_promise(e,t,n,i,s,o){let a=this._get_session_store(n,!0);Object(r.assert)(a,`Failed to create session store ${n} due to invalid parent`);let c={};return s&&t&&this._method_timeout?(c.heartbeat=await this._encode(s.reset.bind(s),n,o),c.interval=this._method_timeout/2,a.timer=s):s=null,[c.resolve,a.resolve]=this._encode_callback("resolve",e,n,i,s,o),[c.reject,a.reject]=this._encode_callback("reject",t,n,i,s,o),c}async _send_chunks(e,t,n){let i=await this.get_remote_service(`${t}:built-in`);Object(r.assert)(i.message_cache,"Remote client does not support message caching for long message.");let s=i.message_cache,a=n||Object(r.randId)();await s.create(a,!!n);let c=e.length,l=Math.ceil(c/o);for(let t=0;t<l;t++){let r=t*o;await s.append(a,e.slice(r,r+o),!!n)}await s.process(a,!!n)}emit(e,t){Object(r.assert)("object"==typeof e&&e.type,"Invalid message, must be an object with a type field.");let n=Object(i.encode)(e);if(t){const e=Object(i.encode)(t);n=new Uint8Array([...n,...e])}if(n.length<=513024)return this._emit_message(n);throw new Error("Message is too large to send in one go.")}_generate_remote_method(e,t,n,s,o){let a=e._rtarget;s&&!a.includes("/")&&(s!==a&&(a=s+"/"+a),e._rtarget=a);let c=e._rmethod,l=e._rpromise;const d=this;function h(){return new Promise((async(e,s)=>{let h=Object(r.randId)();n&&(h=n+"."+h);let p=d._get_session_store(h,!0);if(!p)return void s(new Error(`Runtime Error: Failed to get session store ${h}`));p.target_id=a;const f=await d._encode(Array.prototype.slice.call(arguments),h,o),_=f.length,m=_>0&&"object"==typeof f[_-1]&&null!==f[_-1]&&f[_-1]._rkwargs;m&&delete f[_-1]._rkwargs;let y={type:"method",from:d._local_workspace?d._local_workspace+"/"+d._client_id:d._client_id,to:a,method:c},g={};f&&(g.args=f),m&&(g.with_kwargs=m),t&&(y.parent=t);let b=null;if(l){y.session=h;let t=`${a}:${c}`;b=new u(d._method_timeout,s,[`Method call time out: ${t}`],t);let n=!0;for(let e of f)if("object"==typeof e&&!0===e._rintf){n=!1;break}g.promise=await d._encode_promise(e,s,h,n,b,o)}let w=Object(i.encode)(y);if(g){const e=Object(i.encode)(g);w=new Uint8Array([...w,...e])}w.length<=513024?d._emit_message(w).then((function(){b&&b.start()})):d._send_chunks(w,a,t).then((function(){b&&b.start()}))}))}h.__rpc_object__=e;const p=c.split(".");return h.__name__=p[p.length-1],h.__doc__=e._rdoc,h.__sig__=e._rsig,h}async _notify_service_update(){if(this.manager_id)try{await this.get_manager_service(30),Object(r.assert)(this._manager_service),await this._manager_service.update_client_info(this.get_client_info())}catch(e){console.warn("Failed to notify service update to",this.manager_id,e)}}get_client_info(){const e=[];for(let t of Object.values(this._services))e.push({id:`${this._client_id}:${t.id}`,type:t.type,name:t.name,description:t.description||"",config:t.config});return{id:this._client_id,services:e}}async _handle_method(e){let t=null;try{Object(r.assert)(e.method&&e.ctx&&e.from);const n=e.from+":"+e.method,i=e.from.split("/")[0];e.to=e.to.includes("/")?e.to:i+"/"+e.to,e.ctx.to=e.to;const s=e.to.split("/")[0],o=e.parent;let a,c,u,d;if(e.promise){const h=await this._decode(e.promise,e.session,o,i,s);if(a=h.resolve,c=h.reject,h.heartbeat&&h.interval){async function p(){try{await h.heartbeat()}catch(e){console.error(e)}}t=setInterval(p,1e3*h.interval)}}try{u=l(this._object_store,e.method)}catch(f){throw console.debug("Failed to find method",n,f),new Error(`Method not found: ${n}`)}if(Object(r.assert)(u&&"function"==typeof u,"Invalid method: "+n),this._method_annotations.has(u)){if("protected"===this._method_annotations.get(u).visibility&&s!==i)throw new Error("Permission denied for protected method "+n+", workspace mismatch: "+s+" != "+i)}else{let _=this._object_store[e.method.split(".")[0]].target_id;if(s===i&&_&&-1===_.indexOf("/")&&(_=s+"/"+_),_!==e.from)throw new Error("Access denied for method call ("+n+") from "+e.from)}if(o&&Object(r.assert)(null!==this._get_session_store(o,!0),"Parent session was closed: "+o),d=e.args?await this._decode(e.args,e.session,null,i,null):[],this._method_annotations.has(u)&&this._method_annotations.get(u).require_context&&d.push(e.ctx),e.promise){const m=u.apply(null,d);m instanceof Promise?m.then((e=>{a(e),clearInterval(t)})).catch((e=>{c(e),clearInterval(t)})):(a(m),clearInterval(t))}else u.apply(null,d),clearInterval(t)}catch(y){console.error("Error during calling method: ",y),clearInterval(t)}}encode(e,t){return this._encode(e,t)}_get_session_store(e,t){let n=this._object_store;const r=e.split(".");if(t){const e=r.length-1;for(let t of r.slice(0,e)){if(!n[t])return null;n=n[t]}return n[r[e]]||(n[r[e]]={}),n[r[e]]}for(let e of r){if(!n[e])return null;n=n[e]}return n}async _encode(e,t,n){const i=typeof e;if("number"===i||"string"===i||"boolean"===i||null==e||e instanceof Uint8Array)return e;if(e instanceof ArrayBuffer)return{_rtype:"memoryview",_rvalue:new Uint8Array(e)};if(e.__rpc_object__)return e.__rpc_object__;let s;if(e.constructor instanceof Object&&e._rtype){const c=e._rtype;return delete e._rtype,s=await this._encode(e,t,n),s._rtype=c,s}if("function"==typeof e){if(this._method_annotations.has(e)){let l=this._method_annotations.get(e);s={_rtype:"method",_rtarget:this._client_id,_rmethod:l.method_id,_rpromise:!0}}else{let u;Object(r.assert)("string"==typeof t),u=e.__name__?`${Object(r.randId)()}-${e.__name__}`:Object(r.randId)(),s={_rtype:"method",_rtarget:this._client_id,_rmethod:`${t}.${u}`,_rpromise:!0};let d=this._get_session_store(t,!0);Object(r.assert)(null!==d,`Failed to create session store ${t} due to invalid parent`),d[u]=e}if(s._rdoc=e.__doc__,s._rsig=e.__sig__,!s._rdoc||!s._rsig)try{const h=function(e){const t=e.toString(),n=t.match(/function\s*(\w*)/),r=n&&n[1]||"",i=t.match(/\(([^)]*)\)/);let s="";i&&(s=i[1].split(",").map((e=>e.replace(/\/\*.*?\*\//g,"").replace(/\/\/.*$/g,""))).filter((e=>e.trim().length>0)).map((e=>e.trim())).join(", "));let o=t.match(/\)\s*\{\s*\/\*([\s\S]*?)\*\//);const a=o&&o[1].trim()||"";o=t.match(/\)\s*\{\s*(\/\/[\s\S]*?)\n\s*[^\s\/]/);const c=o&&o[1].split("\n").map((e=>e.replace(/^\/\/\s*/,"").trim())).join("\n")||"",l=a||c;return r&&s.length>0&&{name:r,sig:s,doc:l}}(e);h&&!s._rdoc&&(s._rdoc=`${h.doc}`),h&&!s._rsig&&(s._rsig=`${h.name}(${h.sig})`)}catch(p){console.error("Failed to extract function docstring:",e)}return s}const o=Array.isArray(e);for(let f of Object.keys(this._codecs)){const _=this._codecs[f];if(_.encoder&&e instanceof _.type){let m=await Promise.resolve(_.encoder(e));if(m&&!m._rtype&&(m._rtype=_.name),"object"==typeof m){const y=m._rtype;delete m._rtype,m=await this._encode(m,t,n),m._rtype=y}return s=m,s}}if("undefined"!=typeof tf&&tf.Tensor&&e instanceof tf.Tensor){const g=e.dataSync();s={_rtype:"ndarray",_rvalue:new Uint8Array(g.buffer),_rshape:e.shape,_rdtype:e.dtype}}else if("undefined"!=typeof nj&&nj.NdArray&&e instanceof nj.NdArray){const b=Object(r.typedArrayToDtype)(e.selection.data);s={_rtype:"ndarray",_rvalue:new Uint8Array(e.selection.data.buffer),_rshape:e.shape,_rdtype:b}}else if(e instanceof Error)console.error(e),s={_rtype:"error",_rvalue:e.toString(),_rtrace:e.stack};else if(e!==Object(e)||e instanceof Boolean||e instanceof String||e instanceof Date||e instanceof RegExp||e instanceof ImageData||"undefined"!=typeof FileList&&e instanceof FileList||"undefined"!=typeof FileSystemDirectoryHandle&&e instanceof FileSystemDirectoryHandle||"undefined"!=typeof FileSystemFileHandle&&e instanceof FileSystemFileHandle||"undefined"!=typeof FileSystemHandle&&e instanceof FileSystemHandle||"undefined"!=typeof FileSystemWritableFileStream&&e instanceof FileSystemWritableFileStream)s=e;else if(e instanceof Blob){let w=0;async function v(t){let n;n=t?e.slice(w,w+t):e.slice(w);const r=new Uint8Array(await n.arrayBuffer());return w+=r.byteLength,r}function k(e){w=e}s={_rtype:"iostream",_rnative:"js:blob",type:e.type,name:e.name,size:e.size,path:e._path||e.webkitRelativePath,read:await this._encode(v,t,n),seek:await this._encode(k,t,n)}}else if(e instanceof a){const j=Object(r.typedArrayToDtype)(e);s={_rtype:"typedarray",_rvalue:new Uint8Array(e.buffer),_rdtype:j}}else if(e instanceof DataView)s={_rtype:"memoryview",_rvalue:new Uint8Array(e.buffer)};else if(e instanceof Set)s={_rtype:"set",_rvalue:await this._encode(Array.from(e),t,n)};else if(e instanceof Map)s={_rtype:"orderedmap",_rvalue:await this._encode(Array.from(e),t,n)};else{if(!(e.constructor instanceof Object||Array.isArray(e)))throw`imjoy-rpc: Unsupported data type: ${e}, you can register a custom codec to encode/decode the object.`;{s=o?[]:{};const E=Object.keys(e);for(let O of E)s[O]=await this._encode(e[O],t,n)}}if(!s)throw new Error("Failed to encode object");return s}async decode(e){return await this._decode(e)}async _decode(e,t,n,i,s){if(!e)return e;let o;if(e._rtype)if(this._codecs[e._rtype]&&this._codecs[e._rtype].decoder){const r=e._rtype;delete e._rtype,(e=await this._decode(e,t,n,i,s))._rtype=r,o=await Promise.resolve(this._codecs[e._rtype].decoder(e))}else if("method"===e._rtype)o=this._generate_remote_method(e,t,n,i,s);else if("ndarray"===e._rtype)if("undefined"!=typeof nj&&nj.array)Array.isArray(e._rvalue)&&(e._rvalue=e._rvalue.reduce(c)),o=nj.array(new Uint8(e._rvalue),e._rdtype).reshape(e._rshape);else if("undefined"!=typeof tf&&tf.Tensor){Array.isArray(e._rvalue)&&(e._rvalue=e._rvalue.reduce(c));const t=r.dtypeToTypedArray[e._rdtype];o=tf.tensor(new t(e._rvalue),e._rshape,e._rdtype)}else o=e;else if("error"===e._rtype)o=new Error("RemoteError: "+e._rvalue+"\n"+(e._rtrace||""));else if("typedarray"===e._rtype){const t=r.dtypeToTypedArray[e._rdtype];if(!t)throw new Error("unsupported dtype: "+e._rdtype);o=new t(e._rvalue.buffer.slice(e._rvalue.byteOffset,e._rvalue.byteOffset+e._rvalue.byteLength))}else if("memoryview"===e._rtype)o=e._rvalue.buffer.slice(e._rvalue.byteOffset,e._rvalue.byteOffset+e._rvalue.byteLength);else if("iostream"===e._rtype){if("js:blob"===e._rnative){const r=await this._generate_remote_method(e.read,t,n,i,s),a=await r();o=new Blob([a],{type:e.type,name:e.name})}else{o={};for(let r of Object.keys(e))r.startsWith("_")||(o[r]=await this._decode(e[r],t,n,i,s))}o.__rpc_object__=e}else if("orderedmap"===e._rtype)o=new Map(await this._decode(e._rvalue,t,n,i,s));else if("set"===e._rtype)o=new Set(await this._decode(e._rvalue,t,n,i,s));else{const r=e._rtype;delete e._rtype,o=await this._decode(e,t,n,i,s),o._rtype=r}else if(e.constructor===Object||Array.isArray(e)){const r=Array.isArray(e);o=r?[]:{};for(let a of Object.keys(e))if(r||e.hasOwnProperty(a)){const r=e[a];o[a]=await this._decode(r,t,n,i,s)}}else o=e;if(void 0===o)throw new Error("Failed to decode object");return o}}},"./src/hypha/utils.js":function(module,__nested_webpack_exports__,__nested_webpack_require_148577__){function randId(){return Math.random().toString(36).substr(2,10)+(new Date).getTime()}__nested_webpack_require_148577__.r(__nested_webpack_exports__),__nested_webpack_require_148577__.d(__nested_webpack_exports__,"randId",(function(){return randId})),__nested_webpack_require_148577__.d(__nested_webpack_exports__,"dtypeToTypedArray",(function(){return dtypeToTypedArray})),__nested_webpack_require_148577__.d(__nested_webpack_exports__,"loadRequirementsInWindow",(function(){return loadRequirementsInWindow})),__nested_webpack_require_148577__.d(__nested_webpack_exports__,"loadRequirementsInWebworker",(function(){return loadRequirementsInWebworker})),__nested_webpack_require_148577__.d(__nested_webpack_exports__,"loadRequirements",(function(){return loadRequirements})),__nested_webpack_require_148577__.d(__nested_webpack_exports__,"normalizeConfig",(function(){return normalizeConfig})),__nested_webpack_require_148577__.d(__nested_webpack_exports__,"typedArrayToDtypeMapping",(function(){return typedArrayToDtypeMapping})),__nested_webpack_require_148577__.d(__nested_webpack_exports__,"typedArrayToDtype",(function(){return typedArrayToDtype})),__nested_webpack_require_148577__.d(__nested_webpack_exports__,"cacheRequirements",(function(){return cacheRequirements})),__nested_webpack_require_148577__.d(__nested_webpack_exports__,"setupServiceWorker",(function(){return setupServiceWorker})),__nested_webpack_require_148577__.d(__nested_webpack_exports__,"assert",(function(){return assert})),__nested_webpack_require_148577__.d(__nested_webpack_exports__,"urlJoin",(function(){return urlJoin})),__nested_webpack_require_148577__.d(__nested_webpack_exports__,"waitFor",(function(){return waitFor})),__nested_webpack_require_148577__.d(__nested_webpack_exports__,"MessageEmitter",(function(){return MessageEmitter}));const dtypeToTypedArray={int8:Int8Array,int16:Int16Array,int32:Int32Array,uint8:Uint8Array,uint16:Uint16Array,uint32:Uint32Array,float32:Float32Array,float64:Float64Array,array:Array};async function loadRequirementsInWindow(e){function t(e){return new Promise(((t,n)=>{var r=document.createElement("script");r.src=e,r.type="text/javascript",r.onload=t,r.onreadystatechange=function(){"loaded"!==this.readyState&&"complete"!==this.readyState||t()},r.onerror=n,document.head.appendChild(r)}))}async function n(){for(var e=Array.prototype.slice.call(arguments),n=e.length,r=0;r<n;r++)await t(e[r])}if(e&&(Array.isArray(e)||"string"==typeof e))try{var r;if(e="string"==typeof e?[e]:e,!Array.isArray(e))throw"unsupported requirements definition";for(var i=0;i<e.length;i++)e[i].toLowerCase().endsWith(".css")||e[i].startsWith("css:")?(e[i].startsWith("css:")&&(e[i]=e[i].slice(4)),(r=document.createElement("link")).rel="stylesheet",r.href=e[i],document.head.appendChild(r)):e[i].toLowerCase().endsWith(".mjs")||e[i].startsWith("mjs:")?(e[i].startsWith("mjs:")&&(e[i]=e[i].slice(4)),await import(e[i])):e[i].toLowerCase().endsWith(".js")||e[i].startsWith("js:")?(e[i].startsWith("js:")&&(e[i]=e[i].slice(3)),await n(e[i])):e[i].startsWith("http")?await n(e[i]):e[i].startsWith("cache:")||console.log("Unprocessed requirements url: "+e[i])}catch(t){throw"failed to import required scripts: "+e.toString()}}async function loadRequirementsInWebworker(e){if(e&&(Array.isArray(e)||"string"==typeof e))try{Array.isArray(e)||(e=[e]);for(var t=0;t<e.length;t++){if(e[t].toLowerCase().endsWith(".css")||e[t].startsWith("css:"))throw"unable to import css in a webworker";e[t].toLowerCase().endsWith(".js")||e[t].startsWith("js:")?(e[t].startsWith("js:")&&(e[t]=e[t].slice(3)),importScripts(e[t])):e[t].startsWith("http")?importScripts(e[t]):e[t].startsWith("cache:")||console.log("Unprocessed requirements url: "+e[t])}}catch(t){throw"failed to import required scripts: "+e.toString()}}function loadRequirements(e){return"undefined"!=typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope?loadRequirementsInWebworker(e):loadRequirementsInWindow(e)}function normalizeConfig(e){return e.version=e.version||"0.1.0",e.description=e.description||`[TODO: add description for ${e.name} ]`,e.type=e.type||"rpc-window",e.id=e.id||randId(),e.target_origin=e.target_origin||"*",e.allow_execution=e.allow_execution||!1,e=Object.keys(e).reduce(((t,n)=>("function"!=typeof e[n]&&(t[n]=e[n]),t)),{})}const typedArrayToDtypeMapping={Int8Array:"int8",Int16Array:"int16",Int32Array:"int32",Uint8Array:"uint8",Uint16Array:"uint16",Uint32Array:"uint32",Float32Array:"float32",Float64Array:"float64",Array:"array"},typedArrayToDtypeKeys=[];for(const arrType of Object.keys(typedArrayToDtypeMapping))typedArrayToDtypeKeys.push(eval(arrType));function typedArrayToDtype(e){let t=typedArrayToDtypeMapping[e.constructor.name];if(!t){const n=Object.getPrototypeOf(e);for(const e of typedArrayToDtypeKeys)if(n instanceof e){t=typedArrayToDtypeMapping[e.name];break}}return t}function cacheUrlInServiceWorker(e){return new Promise((function(t,n){const r={command:"add",url:e};if(!navigator.serviceWorker||!navigator.serviceWorker.register)return void n("Service worker is not supported.");const i=new MessageChannel;i.port1.onmessage=function(e){e.data&&e.data.error?n(e.data.error):t(e.data&&e.data.result)},navigator.serviceWorker&&navigator.serviceWorker.controller?navigator.serviceWorker.controller.postMessage(r,[i.port2]):n("Service worker controller is not available")}))}async function cacheRequirements(e){e=e||[],Array.isArray(e)||(e=[e]);for(let t of e)t.startsWith("js:")&&(t=t.slice(3)),t.startsWith("css:")&&(t=t.slice(4)),t.startsWith("cache:")&&(t=t.slice(6)),t.startsWith("http")&&await cacheUrlInServiceWorker(t).catch((e=>{console.error(e)}))}function setupServiceWorker(e,t,n){if("serviceWorker"in navigator){if(e=e||"/",navigator.serviceWorker.register(e+"plugin-service-worker.js").then((function(e){console.log("ServiceWorker registration successful with scope: ",e.scope)}),(function(e){console.log("ServiceWorker registration failed: ",e)})),t=t||"*",(n=n||cacheRequirements)&&"function"!=typeof n)throw new Error("config.cache_requirements must be a function");window.addEventListener("message",(function(e){if("*"===t||e.origin===t){const t=e.data;"cacheRequirements"===t.type&&n(t.requirements)}}))}}function assert(e,t){if(!e)throw new Error(t||"Assertion failed")}function urlJoin(...e){return e.join("/").replace(/[\/]+/g,"/").replace(/^(.+):\//,"$1://").replace(/^file:/,"file:/").replace(/\/(\?|&|#[^!])/g,"$1").replace(/\?/g,"&").replace("&","?")}function waitFor(e,t,n){let r;return Promise.race([e,new Promise(((e,i)=>r=setTimeout((()=>{i(n||"Timeout Error")}),1e3*t)))]).finally((()=>clearTimeout(r)))}class MessageEmitter{constructor(e){this._event_handlers={},this._once_handlers={},this._debug=e}emit(){throw new Error("emit is not implemented")}on(e,t){this._event_handlers[e]||(this._event_handlers[e]=[]),this._event_handlers[e].push(t)}once(e,t){t.___event_run_once=!0,this.on(e,t)}off(e,t){if(e||t){if(e&&!t)this._event_handlers[e]&&(this._event_handlers[e]=[]);else if(this._event_handlers[e]){const n=this._event_handlers[e].indexOf(t);n>=0&&this._event_handlers[e].splice(n,1)}}else this._event_handlers={}}_fire(e,t){if(this._event_handlers[e])for(var n=this._event_handlers[e].length;n--;){const r=this._event_handlers[e][n];try{r(t)}catch(e){console.error(e)}finally{r.___event_run_once&&this._event_handlers[e].splice(n,1)}}else this._debug&&console.warn("unhandled event",e,t)}}}})},module.exports=factory()},64:function(module){var factory;factory=function(){return function(e){var t={};function n(r){if(t[r])return t[r].exports;var i=t[r]={i:r,l:!1,exports:{}};return e[r].call(i.exports,i,i.exports,n),i.l=!0,i.exports}return n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)n.d(r,i,function(t){return e[t]}.bind(null,i));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s="./src/socketIOMain.js")}({"./node_modules/@socket.io/base64-arraybuffer/dist/base64-arraybuffer.es5.js":function(e,t,n){n.r(t),n.d(t,"decode",(function(){return a})),n.d(t,"encode",(function(){return o}));for(var r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",i="undefined"==typeof Uint8Array?[]:new Uint8Array(256),s=0;s<64;s++)i[r.charCodeAt(s)]=s;var o=function(e){var t,n=new Uint8Array(e),i=n.length,s="";for(t=0;t<i;t+=3)s+=r[n[t]>>2],s+=r[(3&n[t])<<4|n[t+1]>>4],s+=r[(15&n[t+1])<<2|n[t+2]>>6],s+=r[63&n[t+2]];return i%3==2?s=s.substring(0,s.length-1)+"=":i%3==1&&(s=s.substring(0,s.length-2)+"=="),s},a=function(e){var t,n,r,s,o,a=.75*e.length,c=e.length,l=0;"="===e[e.length-1]&&(a--,"="===e[e.length-2]&&a--);var u=new ArrayBuffer(a),d=new Uint8Array(u);for(t=0;t<c;t+=4)n=i[e.charCodeAt(t)],r=i[e.charCodeAt(t+1)],s=i[e.charCodeAt(t+2)],o=i[e.charCodeAt(t+3)],d[l++]=n<<2|r>>4,d[l++]=(15&r)<<4|s>>2,d[l++]=(3&s)<<6|63&o;return u}},"./node_modules/@socket.io/component-emitter/index.mjs":function(e,t,n){function r(e){if(e)return function(e){for(var t in r.prototype)e[t]=r.prototype[t];return e}(e)}n.r(t),n.d(t,"Emitter",(function(){return r})),r.prototype.on=r.prototype.addEventListener=function(e,t){return this._callbacks=this._callbacks||{},(this._callbacks["$"+e]=this._callbacks["$"+e]||[]).push(t),this},r.prototype.once=function(e,t){function n(){this.off(e,n),t.apply(this,arguments)}return n.fn=t,this.on(e,n),this},r.prototype.off=r.prototype.removeListener=r.prototype.removeAllListeners=r.prototype.removeEventListener=function(e,t){if(this._callbacks=this._callbacks||{},0==arguments.length)return this._callbacks={},this;var n,r=this._callbacks["$"+e];if(!r)return this;if(1==arguments.length)return delete this._callbacks["$"+e],this;for(var i=0;i<r.length;i++)if((n=r[i])===t||n.fn===t){r.splice(i,1);break}return 0===r.length&&delete this._callbacks["$"+e],this},r.prototype.emit=function(e){this._callbacks=this._callbacks||{};for(var t=new Array(arguments.length-1),n=this._callbacks["$"+e],r=1;r<arguments.length;r++)t[r-1]=arguments[r];if(n){r=0;for(var i=(n=n.slice(0)).length;r<i;++r)n[r].apply(this,t)}return this},r.prototype.emitReserved=r.prototype.emit,r.prototype.listeners=function(e){return this._callbacks=this._callbacks||{},this._callbacks["$"+e]||[]},r.prototype.hasListeners=function(e){return!!this.listeners(e).length}},"./node_modules/base64-js/index.js":function(e,t,n){t.byteLength=function(e){var t=c(e),n=t[0],r=t[1];return 3*(n+r)/4-r},t.toByteArray=function(e){var t,n,r=c(e),o=r[0],a=r[1],l=new s(function(e,t,n){return 3*(t+n)/4-n}(0,o,a)),u=0,d=a>0?o-4:o;for(n=0;n<d;n+=4)t=i[e.charCodeAt(n)]<<18|i[e.charCodeAt(n+1)]<<12|i[e.charCodeAt(n+2)]<<6|i[e.charCodeAt(n+3)],l[u++]=t>>16&255,l[u++]=t>>8&255,l[u++]=255&t;return 2===a&&(t=i[e.charCodeAt(n)]<<2|i[e.charCodeAt(n+1)]>>4,l[u++]=255&t),1===a&&(t=i[e.charCodeAt(n)]<<10|i[e.charCodeAt(n+1)]<<4|i[e.charCodeAt(n+2)]>>2,l[u++]=t>>8&255,l[u++]=255&t),l},t.fromByteArray=function(e){for(var t,n=e.length,i=n%3,s=[],o=16383,a=0,c=n-i;a<c;a+=o)s.push(l(e,a,a+o>c?c:a+o));return 1===i?(t=e[n-1],s.push(r[t>>2]+r[t<<4&63]+"==")):2===i&&(t=(e[n-2]<<8)+e[n-1],s.push(r[t>>10]+r[t>>4&63]+r[t<<2&63]+"=")),s.join("")};for(var r=[],i=[],s="undefined"!=typeof Uint8Array?Uint8Array:Array,o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",a=0;a<64;++a)r[a]=o[a],i[o.charCodeAt(a)]=a;function c(e){var t=e.length;if(t%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var n=e.indexOf("=");return-1===n&&(n=t),[n,n===t?0:4-n%4]}function l(e,t,n){for(var i,s,o=[],a=t;a<n;a+=3)i=(e[a]<<16&16711680)+(e[a+1]<<8&65280)+(255&e[a+2]),o.push(r[(s=i)>>18&63]+r[s>>12&63]+r[s>>6&63]+r[63&s]);return o.join("")}i["-".charCodeAt(0)]=62,i["_".charCodeAt(0)]=63},"./node_modules/buffer/index.js":function(e,t,n){(function(e){var r=n("./node_modules/base64-js/index.js"),i=n("./node_modules/ieee754/index.js"),s=n("./node_modules/isarray/index.js");function o(){return c.TYPED_ARRAY_SUPPORT?2147483647:1073741823}function a(e,t){if(o()<t)throw new RangeError("Invalid typed array length");return c.TYPED_ARRAY_SUPPORT?(e=new Uint8Array(t)).__proto__=c.prototype:(null===e&&(e=new c(t)),e.length=t),e}function c(e,t,n){if(!(c.TYPED_ARRAY_SUPPORT||this instanceof c))return new c(e,t,n);if("number"==typeof e){if("string"==typeof t)throw new Error("If encoding is specified then the first argument must be a string");return d(this,e)}return l(this,e,t,n)}function l(e,t,n,r){if("number"==typeof t)throw new TypeError('"value" argument must not be a number');return"undefined"!=typeof ArrayBuffer&&t instanceof ArrayBuffer?function(e,t,n,r){if(t.byteLength,n<0||t.byteLength<n)throw new RangeError("'offset' is out of bounds");if(t.byteLength<n+(r||0))throw new RangeError("'length' is out of bounds");return t=void 0===n&&void 0===r?new Uint8Array(t):void 0===r?new Uint8Array(t,n):new Uint8Array(t,n,r),c.TYPED_ARRAY_SUPPORT?(e=t).__proto__=c.prototype:e=h(e,t),e}(e,t,n,r):"string"==typeof t?function(e,t,n){if("string"==typeof n&&""!==n||(n="utf8"),!c.isEncoding(n))throw new TypeError('"encoding" must be a valid string encoding');var r=0|f(t,n),i=(e=a(e,r)).write(t,n);return i!==r&&(e=e.slice(0,i)),e}(e,t,n):function(e,t){if(c.isBuffer(t)){var n=0|p(t.length);return 0===(e=a(e,n)).length||t.copy(e,0,0,n),e}if(t){if("undefined"!=typeof ArrayBuffer&&t.buffer instanceof ArrayBuffer||"length"in t)return"number"!=typeof t.length||(r=t.length)!=r?a(e,0):h(e,t);if("Buffer"===t.type&&s(t.data))return h(e,t.data)}var r;throw new TypeError("First argument must be a string, Buffer, ArrayBuffer, Array, or array-like object.")}(e,t)}function u(e){if("number"!=typeof e)throw new TypeError('"size" argument must be a number');if(e<0)throw new RangeError('"size" argument must not be negative')}function d(e,t){if(u(t),e=a(e,t<0?0:0|p(t)),!c.TYPED_ARRAY_SUPPORT)for(var n=0;n<t;++n)e[n]=0;return e}function h(e,t){var n=t.length<0?0:0|p(t.length);e=a(e,n);for(var r=0;r<n;r+=1)e[r]=255&t[r];return e}function p(e){if(e>=o())throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+o().toString(16)+" bytes");return 0|e}function f(e,t){if(c.isBuffer(e))return e.length;if("undefined"!=typeof ArrayBuffer&&"function"==typeof ArrayBuffer.isView&&(ArrayBuffer.isView(e)||e instanceof ArrayBuffer))return e.byteLength;"string"!=typeof e&&(e=""+e);var n=e.length;if(0===n)return 0;for(var r=!1;;)switch(t){case"ascii":case"latin1":case"binary":return n;case"utf8":case"utf-8":case void 0:return q(e).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return 2*n;case"hex":return n>>>1;case"base64":return N(e).length;default:if(r)return q(e).length;t=(""+t).toLowerCase(),r=!0}}function _(e,t,n){var r=!1;if((void 0===t||t<0)&&(t=0),t>this.length)return"";if((void 0===n||n>this.length)&&(n=this.length),n<=0)return"";if((n>>>=0)<=(t>>>=0))return"";for(e||(e="utf8");;)switch(e){case"hex":return I(this,t,n);case"utf8":case"utf-8":return x(this,t,n);case"ascii":return A(this,t,n);case"latin1":case"binary":return T(this,t,n);case"base64":return O(this,t,n);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return U(this,t,n);default:if(r)throw new TypeError("Unknown encoding: "+e);e=(e+"").toLowerCase(),r=!0}}function m(e,t,n){var r=e[t];e[t]=e[n],e[n]=r}function y(e,t,n,r,i){if(0===e.length)return-1;if("string"==typeof n?(r=n,n=0):n>2147483647?n=2147483647:n<-2147483648&&(n=-2147483648),n=+n,isNaN(n)&&(n=i?0:e.length-1),n<0&&(n=e.length+n),n>=e.length){if(i)return-1;n=e.length-1}else if(n<0){if(!i)return-1;n=0}if("string"==typeof t&&(t=c.from(t,r)),c.isBuffer(t))return 0===t.length?-1:g(e,t,n,r,i);if("number"==typeof t)return t&=255,c.TYPED_ARRAY_SUPPORT&&"function"==typeof Uint8Array.prototype.indexOf?i?Uint8Array.prototype.indexOf.call(e,t,n):Uint8Array.prototype.lastIndexOf.call(e,t,n):g(e,[t],n,r,i);throw new TypeError("val must be string, number or Buffer")}function g(e,t,n,r,i){var s,o=1,a=e.length,c=t.length;if(void 0!==r&&("ucs2"===(r=String(r).toLowerCase())||"ucs-2"===r||"utf16le"===r||"utf-16le"===r)){if(e.length<2||t.length<2)return-1;o=2,a/=2,c/=2,n/=2}function l(e,t){return 1===o?e[t]:e.readUInt16BE(t*o)}if(i){var u=-1;for(s=n;s<a;s++)if(l(e,s)===l(t,-1===u?0:s-u)){if(-1===u&&(u=s),s-u+1===c)return u*o}else-1!==u&&(s-=s-u),u=-1}else for(n+c>a&&(n=a-c),s=n;s>=0;s--){for(var d=!0,h=0;h<c;h++)if(l(e,s+h)!==l(t,h)){d=!1;break}if(d)return s}return-1}function b(e,t,n,r){n=Number(n)||0;var i=e.length-n;r?(r=Number(r))>i&&(r=i):r=i;var s=t.length;if(s%2!=0)throw new TypeError("Invalid hex string");r>s/2&&(r=s/2);for(var o=0;o<r;++o){var a=parseInt(t.substr(2*o,2),16);if(isNaN(a))return o;e[n+o]=a}return o}function w(e,t,n,r){return F(q(t,e.length-n),e,n,r)}function v(e,t,n,r){return F(function(e){for(var t=[],n=0;n<e.length;++n)t.push(255&e.charCodeAt(n));return t}(t),e,n,r)}function k(e,t,n,r){return v(e,t,n,r)}function j(e,t,n,r){return F(N(t),e,n,r)}function E(e,t,n,r){return F(function(e,t){for(var n,r,i,s=[],o=0;o<e.length&&!((t-=2)<0);++o)r=(n=e.charCodeAt(o))>>8,i=n%256,s.push(i),s.push(r);return s}(t,e.length-n),e,n,r)}function O(e,t,n){return 0===t&&n===e.length?r.fromByteArray(e):r.fromByteArray(e.slice(t,n))}function x(e,t,n){n=Math.min(e.length,n);for(var r=[],i=t;i<n;){var s,o,a,c,l=e[i],u=null,d=l>239?4:l>223?3:l>191?2:1;if(i+d<=n)switch(d){case 1:l<128&&(u=l);break;case 2:128==(192&(s=e[i+1]))&&(c=(31&l)<<6|63&s)>127&&(u=c);break;case 3:s=e[i+1],o=e[i+2],128==(192&s)&&128==(192&o)&&(c=(15&l)<<12|(63&s)<<6|63&o)>2047&&(c<55296||c>57343)&&(u=c);break;case 4:s=e[i+1],o=e[i+2],a=e[i+3],128==(192&s)&&128==(192&o)&&128==(192&a)&&(c=(15&l)<<18|(63&s)<<12|(63&o)<<6|63&a)>65535&&c<1114112&&(u=c)}null===u?(u=65533,d=1):u>65535&&(u-=65536,r.push(u>>>10&1023|55296),u=56320|1023&u),r.push(u),i+=d}return function(e){var t=e.length;if(t<=S)return String.fromCharCode.apply(String,e);for(var n="",r=0;r<t;)n+=String.fromCharCode.apply(String,e.slice(r,r+=S));return n}(r)}t.Buffer=c,t.SlowBuffer=function(e){return+e!=e&&(e=0),c.alloc(+e)},t.INSPECT_MAX_BYTES=50,c.TYPED_ARRAY_SUPPORT=void 0!==e.TYPED_ARRAY_SUPPORT?e.TYPED_ARRAY_SUPPORT:function(){try{var e=new Uint8Array(1);return e.__proto__={__proto__:Uint8Array.prototype,foo:function(){return 42}},42===e.foo()&&"function"==typeof e.subarray&&0===e.subarray(1,1).byteLength}catch(e){return!1}}(),t.kMaxLength=o(),c.poolSize=8192,c._augment=function(e){return e.__proto__=c.prototype,e},c.from=function(e,t,n){return l(null,e,t,n)},c.TYPED_ARRAY_SUPPORT&&(c.prototype.__proto__=Uint8Array.prototype,c.__proto__=Uint8Array,"undefined"!=typeof Symbol&&Symbol.species&&c[Symbol.species]===c&&Object.defineProperty(c,Symbol.species,{value:null,configurable:!0})),c.alloc=function(e,t,n){return function(e,t,n,r){return u(t),t<=0?a(e,t):void 0!==n?"string"==typeof r?a(e,t).fill(n,r):a(e,t).fill(n):a(e,t)}(null,e,t,n)},c.allocUnsafe=function(e){return d(null,e)},c.allocUnsafeSlow=function(e){return d(null,e)},c.isBuffer=function(e){return!(null==e||!e._isBuffer)},c.compare=function(e,t){if(!c.isBuffer(e)||!c.isBuffer(t))throw new TypeError("Arguments must be Buffers");if(e===t)return 0;for(var n=e.length,r=t.length,i=0,s=Math.min(n,r);i<s;++i)if(e[i]!==t[i]){n=e[i],r=t[i];break}return n<r?-1:r<n?1:0},c.isEncoding=function(e){switch(String(e).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},c.concat=function(e,t){if(!s(e))throw new TypeError('"list" argument must be an Array of Buffers');if(0===e.length)return c.alloc(0);var n;if(void 0===t)for(t=0,n=0;n<e.length;++n)t+=e[n].length;var r=c.allocUnsafe(t),i=0;for(n=0;n<e.length;++n){var o=e[n];if(!c.isBuffer(o))throw new TypeError('"list" argument must be an Array of Buffers');o.copy(r,i),i+=o.length}return r},c.byteLength=f,c.prototype._isBuffer=!0,c.prototype.swap16=function(){var e=this.length;if(e%2!=0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(var t=0;t<e;t+=2)m(this,t,t+1);return this},c.prototype.swap32=function(){var e=this.length;if(e%4!=0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(var t=0;t<e;t+=4)m(this,t,t+3),m(this,t+1,t+2);return this},c.prototype.swap64=function(){var e=this.length;if(e%8!=0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(var t=0;t<e;t+=8)m(this,t,t+7),m(this,t+1,t+6),m(this,t+2,t+5),m(this,t+3,t+4);return this},c.prototype.toString=function(){var e=0|this.length;return 0===e?"":0===arguments.length?x(this,0,e):_.apply(this,arguments)},c.prototype.equals=function(e){if(!c.isBuffer(e))throw new TypeError("Argument must be a Buffer");return this===e||0===c.compare(this,e)},c.prototype.inspect=function(){var e="",n=t.INSPECT_MAX_BYTES;return this.length>0&&(e=this.toString("hex",0,n).match(/.{2}/g).join(" "),this.length>n&&(e+=" ... ")),"<Buffer "+e+">"},c.prototype.compare=function(e,t,n,r,i){if(!c.isBuffer(e))throw new TypeError("Argument must be a Buffer");if(void 0===t&&(t=0),void 0===n&&(n=e?e.length:0),void 0===r&&(r=0),void 0===i&&(i=this.length),t<0||n>e.length||r<0||i>this.length)throw new RangeError("out of range index");if(r>=i&&t>=n)return 0;if(r>=i)return-1;if(t>=n)return 1;if(this===e)return 0;for(var s=(i>>>=0)-(r>>>=0),o=(n>>>=0)-(t>>>=0),a=Math.min(s,o),l=this.slice(r,i),u=e.slice(t,n),d=0;d<a;++d)if(l[d]!==u[d]){s=l[d],o=u[d];break}return s<o?-1:o<s?1:0},c.prototype.includes=function(e,t,n){return-1!==this.indexOf(e,t,n)},c.prototype.indexOf=function(e,t,n){return y(this,e,t,n,!0)},c.prototype.lastIndexOf=function(e,t,n){return y(this,e,t,n,!1)},c.prototype.write=function(e,t,n,r){if(void 0===t)r="utf8",n=this.length,t=0;else if(void 0===n&&"string"==typeof t)r=t,n=this.length,t=0;else{if(!isFinite(t))throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");t|=0,isFinite(n)?(n|=0,void 0===r&&(r="utf8")):(r=n,n=void 0)}var i=this.length-t;if((void 0===n||n>i)&&(n=i),e.length>0&&(n<0||t<0)||t>this.length)throw new RangeError("Attempt to write outside buffer bounds");r||(r="utf8");for(var s=!1;;)switch(r){case"hex":return b(this,e,t,n);case"utf8":case"utf-8":return w(this,e,t,n);case"ascii":return v(this,e,t,n);case"latin1":case"binary":return k(this,e,t,n);case"base64":return j(this,e,t,n);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return E(this,e,t,n);default:if(s)throw new TypeError("Unknown encoding: "+r);r=(""+r).toLowerCase(),s=!0}},c.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};var S=4096;function A(e,t,n){var r="";n=Math.min(e.length,n);for(var i=t;i<n;++i)r+=String.fromCharCode(127&e[i]);return r}function T(e,t,n){var r="";n=Math.min(e.length,n);for(var i=t;i<n;++i)r+=String.fromCharCode(e[i]);return r}function I(e,t,n){var r,i=e.length;(!t||t<0)&&(t=0),(!n||n<0||n>i)&&(n=i);for(var s="",o=t;o<n;++o)s+=(r=e[o])<16?"0"+r.toString(16):r.toString(16);return s}function U(e,t,n){for(var r=e.slice(t,n),i="",s=0;s<r.length;s+=2)i+=String.fromCharCode(r[s]+256*r[s+1]);return i}function C(e,t,n){if(e%1!=0||e<0)throw new RangeError("offset is not uint");if(e+t>n)throw new RangeError("Trying to access beyond buffer length")}function R(e,t,n,r,i,s){if(!c.isBuffer(e))throw new TypeError('"buffer" argument must be a Buffer instance');if(t>i||t<s)throw new RangeError('"value" argument is out of bounds');if(n+r>e.length)throw new RangeError("Index out of range")}function D(e,t,n,r){t<0&&(t=65535+t+1);for(var i=0,s=Math.min(e.length-n,2);i<s;++i)e[n+i]=(t&255<<8*(r?i:1-i))>>>8*(r?i:1-i)}function P(e,t,n,r){t<0&&(t=4294967295+t+1);for(var i=0,s=Math.min(e.length-n,4);i<s;++i)e[n+i]=t>>>8*(r?i:3-i)&255}function M(e,t,n,r,i,s){if(n+r>e.length)throw new RangeError("Index out of range");if(n<0)throw new RangeError("Index out of range")}function L(e,t,n,r,s){return s||M(e,0,n,4),i.write(e,t,n,r,23,4),n+4}function W(e,t,n,r,s){return s||M(e,0,n,8),i.write(e,t,n,r,52,8),n+8}c.prototype.slice=function(e,t){var n,r=this.length;if((e=~~e)<0?(e+=r)<0&&(e=0):e>r&&(e=r),(t=void 0===t?r:~~t)<0?(t+=r)<0&&(t=0):t>r&&(t=r),t<e&&(t=e),c.TYPED_ARRAY_SUPPORT)(n=this.subarray(e,t)).__proto__=c.prototype;else{var i=t-e;n=new c(i,void 0);for(var s=0;s<i;++s)n[s]=this[s+e]}return n},c.prototype.readUIntLE=function(e,t,n){e|=0,t|=0,n||C(e,t,this.length);for(var r=this[e],i=1,s=0;++s<t&&(i*=256);)r+=this[e+s]*i;return r},c.prototype.readUIntBE=function(e,t,n){e|=0,t|=0,n||C(e,t,this.length);for(var r=this[e+--t],i=1;t>0&&(i*=256);)r+=this[e+--t]*i;return r},c.prototype.readUInt8=function(e,t){return t||C(e,1,this.length),this[e]},c.prototype.readUInt16LE=function(e,t){return t||C(e,2,this.length),this[e]|this[e+1]<<8},c.prototype.readUInt16BE=function(e,t){return t||C(e,2,this.length),this[e]<<8|this[e+1]},c.prototype.readUInt32LE=function(e,t){return t||C(e,4,this.length),(this[e]|this[e+1]<<8|this[e+2]<<16)+16777216*this[e+3]},c.prototype.readUInt32BE=function(e,t){return t||C(e,4,this.length),16777216*this[e]+(this[e+1]<<16|this[e+2]<<8|this[e+3])},c.prototype.readIntLE=function(e,t,n){e|=0,t|=0,n||C(e,t,this.length);for(var r=this[e],i=1,s=0;++s<t&&(i*=256);)r+=this[e+s]*i;return r>=(i*=128)&&(r-=Math.pow(2,8*t)),r},c.prototype.readIntBE=function(e,t,n){e|=0,t|=0,n||C(e,t,this.length);for(var r=t,i=1,s=this[e+--r];r>0&&(i*=256);)s+=this[e+--r]*i;return s>=(i*=128)&&(s-=Math.pow(2,8*t)),s},c.prototype.readInt8=function(e,t){return t||C(e,1,this.length),128&this[e]?-1*(255-this[e]+1):this[e]},c.prototype.readInt16LE=function(e,t){t||C(e,2,this.length);var n=this[e]|this[e+1]<<8;return 32768&n?4294901760|n:n},c.prototype.readInt16BE=function(e,t){t||C(e,2,this.length);var n=this[e+1]|this[e]<<8;return 32768&n?4294901760|n:n},c.prototype.readInt32LE=function(e,t){return t||C(e,4,this.length),this[e]|this[e+1]<<8|this[e+2]<<16|this[e+3]<<24},c.prototype.readInt32BE=function(e,t){return t||C(e,4,this.length),this[e]<<24|this[e+1]<<16|this[e+2]<<8|this[e+3]},c.prototype.readFloatLE=function(e,t){return t||C(e,4,this.length),i.read(this,e,!0,23,4)},c.prototype.readFloatBE=function(e,t){return t||C(e,4,this.length),i.read(this,e,!1,23,4)},c.prototype.readDoubleLE=function(e,t){return t||C(e,8,this.length),i.read(this,e,!0,52,8)},c.prototype.readDoubleBE=function(e,t){return t||C(e,8,this.length),i.read(this,e,!1,52,8)},c.prototype.writeUIntLE=function(e,t,n,r){e=+e,t|=0,n|=0,r||R(this,e,t,n,Math.pow(2,8*n)-1,0);var i=1,s=0;for(this[t]=255&e;++s<n&&(i*=256);)this[t+s]=e/i&255;return t+n},c.prototype.writeUIntBE=function(e,t,n,r){e=+e,t|=0,n|=0,r||R(this,e,t,n,Math.pow(2,8*n)-1,0);var i=n-1,s=1;for(this[t+i]=255&e;--i>=0&&(s*=256);)this[t+i]=e/s&255;return t+n},c.prototype.writeUInt8=function(e,t,n){return e=+e,t|=0,n||R(this,e,t,1,255,0),c.TYPED_ARRAY_SUPPORT||(e=Math.floor(e)),this[t]=255&e,t+1},c.prototype.writeUInt16LE=function(e,t,n){return e=+e,t|=0,n||R(this,e,t,2,65535,0),c.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8):D(this,e,t,!0),t+2},c.prototype.writeUInt16BE=function(e,t,n){return e=+e,t|=0,n||R(this,e,t,2,65535,0),c.TYPED_ARRAY_SUPPORT?(this[t]=e>>>8,this[t+1]=255&e):D(this,e,t,!1),t+2},c.prototype.writeUInt32LE=function(e,t,n){return e=+e,t|=0,n||R(this,e,t,4,4294967295,0),c.TYPED_ARRAY_SUPPORT?(this[t+3]=e>>>24,this[t+2]=e>>>16,this[t+1]=e>>>8,this[t]=255&e):P(this,e,t,!0),t+4},c.prototype.writeUInt32BE=function(e,t,n){return e=+e,t|=0,n||R(this,e,t,4,4294967295,0),c.TYPED_ARRAY_SUPPORT?(this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e):P(this,e,t,!1),t+4},c.prototype.writeIntLE=function(e,t,n,r){if(e=+e,t|=0,!r){var i=Math.pow(2,8*n-1);R(this,e,t,n,i-1,-i)}var s=0,o=1,a=0;for(this[t]=255&e;++s<n&&(o*=256);)e<0&&0===a&&0!==this[t+s-1]&&(a=1),this[t+s]=(e/o|0)-a&255;return t+n},c.prototype.writeIntBE=function(e,t,n,r){if(e=+e,t|=0,!r){var i=Math.pow(2,8*n-1);R(this,e,t,n,i-1,-i)}var s=n-1,o=1,a=0;for(this[t+s]=255&e;--s>=0&&(o*=256);)e<0&&0===a&&0!==this[t+s+1]&&(a=1),this[t+s]=(e/o|0)-a&255;return t+n},c.prototype.writeInt8=function(e,t,n){return e=+e,t|=0,n||R(this,e,t,1,127,-128),c.TYPED_ARRAY_SUPPORT||(e=Math.floor(e)),e<0&&(e=255+e+1),this[t]=255&e,t+1},c.prototype.writeInt16LE=function(e,t,n){return e=+e,t|=0,n||R(this,e,t,2,32767,-32768),c.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8):D(this,e,t,!0),t+2},c.prototype.writeInt16BE=function(e,t,n){return e=+e,t|=0,n||R(this,e,t,2,32767,-32768),c.TYPED_ARRAY_SUPPORT?(this[t]=e>>>8,this[t+1]=255&e):D(this,e,t,!1),t+2},c.prototype.writeInt32LE=function(e,t,n){return e=+e,t|=0,n||R(this,e,t,4,2147483647,-2147483648),c.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8,this[t+2]=e>>>16,this[t+3]=e>>>24):P(this,e,t,!0),t+4},c.prototype.writeInt32BE=function(e,t,n){return e=+e,t|=0,n||R(this,e,t,4,2147483647,-2147483648),e<0&&(e=4294967295+e+1),c.TYPED_ARRAY_SUPPORT?(this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e):P(this,e,t,!1),t+4},c.prototype.writeFloatLE=function(e,t,n){return L(this,e,t,!0,n)},c.prototype.writeFloatBE=function(e,t,n){return L(this,e,t,!1,n)},c.prototype.writeDoubleLE=function(e,t,n){return W(this,e,t,!0,n)},c.prototype.writeDoubleBE=function(e,t,n){return W(this,e,t,!1,n)},c.prototype.copy=function(e,t,n,r){if(n||(n=0),r||0===r||(r=this.length),t>=e.length&&(t=e.length),t||(t=0),r>0&&r<n&&(r=n),r===n)return 0;if(0===e.length||0===this.length)return 0;if(t<0)throw new RangeError("targetStart out of bounds");if(n<0||n>=this.length)throw new RangeError("sourceStart out of bounds");if(r<0)throw new RangeError("sourceEnd out of bounds");r>this.length&&(r=this.length),e.length-t<r-n&&(r=e.length-t+n);var i,s=r-n;if(this===e&&n<t&&t<r)for(i=s-1;i>=0;--i)e[i+t]=this[i+n];else if(s<1e3||!c.TYPED_ARRAY_SUPPORT)for(i=0;i<s;++i)e[i+t]=this[i+n];else Uint8Array.prototype.set.call(e,this.subarray(n,n+s),t);return s},c.prototype.fill=function(e,t,n,r){if("string"==typeof e){if("string"==typeof t?(r=t,t=0,n=this.length):"string"==typeof n&&(r=n,n=this.length),1===e.length){var i=e.charCodeAt(0);i<256&&(e=i)}if(void 0!==r&&"string"!=typeof r)throw new TypeError("encoding must be a string");if("string"==typeof r&&!c.isEncoding(r))throw new TypeError("Unknown encoding: "+r)}else"number"==typeof e&&(e&=255);if(t<0||this.length<t||this.length<n)throw new RangeError("Out of range index");if(n<=t)return this;var s;if(t>>>=0,n=void 0===n?this.length:n>>>0,e||(e=0),"number"==typeof e)for(s=t;s<n;++s)this[s]=e;else{var o=c.isBuffer(e)?e:q(new c(e,r).toString()),a=o.length;for(s=0;s<n-t;++s)this[s+t]=o[s%a]}return this};var B=/[^+\/0-9A-Za-z-_]/g;function q(e,t){var n;t=t||1/0;for(var r=e.length,i=null,s=[],o=0;o<r;++o){if((n=e.charCodeAt(o))>55295&&n<57344){if(!i){if(n>56319){(t-=3)>-1&&s.push(239,191,189);continue}if(o+1===r){(t-=3)>-1&&s.push(239,191,189);continue}i=n;continue}if(n<56320){(t-=3)>-1&&s.push(239,191,189),i=n;continue}n=65536+(i-55296<<10|n-56320)}else i&&(t-=3)>-1&&s.push(239,191,189);if(i=null,n<128){if((t-=1)<0)break;s.push(n)}else if(n<2048){if((t-=2)<0)break;s.push(n>>6|192,63&n|128)}else if(n<65536){if((t-=3)<0)break;s.push(n>>12|224,n>>6&63|128,63&n|128)}else{if(!(n<1114112))throw new Error("Invalid code point");if((t-=4)<0)break;s.push(n>>18|240,n>>12&63|128,n>>6&63|128,63&n|128)}}return s}function N(e){return r.toByteArray(function(e){if((e=function(e){return e.trim?e.trim():e.replace(/^\s+|\s+$/g,"")}(e).replace(B,"")).length<2)return"";for(;e.length%4!=0;)e+="=";return e}(e))}function F(e,t,n,r){for(var i=0;i<r&&!(i+n>=t.length||i>=e.length);++i)t[i+n]=e[i];return i}}).call(this,n("./node_modules/webpack/buildin/global.js"))},"./node_modules/engine.io-client/build/esm/contrib/has-cors.js":function(e,t,n){n.r(t),n.d(t,"hasCORS",(function(){return i}));let r=!1;try{r="undefined"!=typeof XMLHttpRequest&&"withCredentials"in new XMLHttpRequest}catch(e){}const i=r},"./node_modules/engine.io-client/build/esm/contrib/parseqs.js":function(e,t,n){function r(e){let t="";for(let n in e)e.hasOwnProperty(n)&&(t.length&&(t+="&"),t+=encodeURIComponent(n)+"="+encodeURIComponent(e[n]));return t}function i(e){let t={},n=e.split("&");for(let e=0,r=n.length;e<r;e++){let r=n[e].split("=");t[decodeURIComponent(r[0])]=decodeURIComponent(r[1])}return t}n.r(t),n.d(t,"encode",(function(){return r})),n.d(t,"decode",(function(){return i}))},"./node_modules/engine.io-client/build/esm/contrib/parseuri.js":function(e,t,n){n.r(t),n.d(t,"parse",(function(){return s}));const r=/^(?:(?![^:@\/?#]+:[^:@\/]*@)(http|https|ws|wss):\/\/)?((?:(([^:@\/?#]*)(?::([^:@\/?#]*))?)?@)?((?:[a-f0-9]{0,4}:){2,7}[a-f0-9]{0,4}|[^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/,i=["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"];function s(e){const t=e,n=e.indexOf("["),s=e.indexOf("]");-1!=n&&-1!=s&&(e=e.substring(0,n)+e.substring(n,s).replace(/:/g,";")+e.substring(s,e.length));let o=r.exec(e||""),a={},c=14;for(;c--;)a[i[c]]=o[c]||"";return-1!=n&&-1!=s&&(a.source=t,a.host=a.host.substring(1,a.host.length-1).replace(/;/g,":"),a.authority=a.authority.replace("[","").replace("]","").replace(/;/g,":"),a.ipv6uri=!0),a.pathNames=function(e,t){const n=t.replace(/\/{2,9}/g,"/").split("/");return"/"!=t.slice(0,1)&&0!==t.length||n.splice(0,1),"/"==t.slice(-1)&&n.splice(n.length-1,1),n}(0,a.path),a.queryKey=function(e,t){const n={};return t.replace(/(?:^|&)([^&=]*)=?([^&]*)/g,(function(e,t,r){t&&(n[t]=r)})),n}(0,a.query),a}},"./node_modules/engine.io-client/build/esm/contrib/yeast.js":function(e,t,n){n.r(t),n.d(t,"encode",(function(){return l})),n.d(t,"decode",(function(){return u})),n.d(t,"yeast",(function(){return d}));const r="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz-_".split(""),i=64,s={};let o,a=0,c=0;function l(e){let t="";do{t=r[e%i]+t,e=Math.floor(e/i)}while(e>0);return t}function u(e){let t=0;for(c=0;c<e.length;c++)t=t*i+s[e.charAt(c)];return t}function d(){const e=l(+new Date);return e!==o?(a=0,o=e):e+"."+l(a++)}for(;c<i;c++)s[r[c]]=c},"./node_modules/engine.io-client/build/esm/globalThis.browser.js":function(e,t,n){n.r(t),n.d(t,"globalThisShim",(function(){return r}));const r="undefined"!=typeof self?self:"undefined"!=typeof window?window:Function("return this")()},"./node_modules/engine.io-client/build/esm/index.js":function(e,t,n){n.r(t),n.d(t,"protocol",(function(){return l}));var r=n("./node_modules/engine.io-client/build/esm/socket.js");n.d(t,"Socket",(function(){return r.Socket}));var i=n("./node_modules/engine.io-client/build/esm/transport.js");n.d(t,"Transport",(function(){return i.Transport}));var s=n("./node_modules/engine.io-client/build/esm/transports/index.js");n.d(t,"transports",(function(){return s.transports}));var o=n("./node_modules/engine.io-client/build/esm/util.js");n.d(t,"installTimerFunctions",(function(){return o.installTimerFunctions}));var a=n("./node_modules/engine.io-client/build/esm/contrib/parseuri.js");n.d(t,"parse",(function(){return a.parse}));var c=n("./node_modules/engine.io-client/build/esm/transports/websocket-constructor.browser.js");n.d(t,"nextTick",(function(){return c.nextTick}));const l=r.Socket.protocol},"./node_modules/engine.io-client/build/esm/socket.js":function(e,t,n){n.r(t),n.d(t,"Socket",(function(){return l}));var r=n("./node_modules/engine.io-client/build/esm/transports/index.js"),i=n("./node_modules/engine.io-client/build/esm/util.js"),s=n("./node_modules/engine.io-client/build/esm/contrib/parseqs.js"),o=n("./node_modules/engine.io-client/build/esm/contrib/parseuri.js"),a=n("./node_modules/@socket.io/component-emitter/index.mjs"),c=n("./node_modules/engine.io-parser/build/esm/index.js");class l extends a.Emitter{constructor(e,t={}){super(),this.writeBuffer=[],e&&"object"==typeof e&&(t=e,e=null),e?(e=Object(o.parse)(e),t.hostname=e.host,t.secure="https"===e.protocol||"wss"===e.protocol,t.port=e.port,e.query&&(t.query=e.query)):t.host&&(t.hostname=Object(o.parse)(t.host).host),Object(i.installTimerFunctions)(this,t),this.secure=null!=t.secure?t.secure:"undefined"!=typeof location&&"https:"===location.protocol,t.hostname&&!t.port&&(t.port=this.secure?"443":"80"),this.hostname=t.hostname||("undefined"!=typeof location?location.hostname:"localhost"),this.port=t.port||("undefined"!=typeof location&&location.port?location.port:this.secure?"443":"80"),this.transports=t.transports||["polling","websocket"],this.writeBuffer=[],this.prevBufferLen=0,this.opts=Object.assign({path:"/engine.io",agent:!1,withCredentials:!1,upgrade:!0,timestampParam:"t",rememberUpgrade:!1,addTrailingSlash:!0,rejectUnauthorized:!0,perMessageDeflate:{threshold:1024},transportOptions:{},closeOnBeforeunload:!0},t),this.opts.path=this.opts.path.replace(/\/$/,"")+(this.opts.addTrailingSlash?"/":""),"string"==typeof this.opts.query&&(this.opts.query=Object(s.decode)(this.opts.query)),this.id=null,this.upgrades=null,this.pingInterval=null,this.pingTimeout=null,this.pingTimeoutTimer=null,"function"==typeof addEventListener&&(this.opts.closeOnBeforeunload&&(this.beforeunloadEventListener=()=>{this.transport&&(this.transport.removeAllListeners(),this.transport.close())},addEventListener("beforeunload",this.beforeunloadEventListener,!1)),"localhost"!==this.hostname&&(this.offlineEventListener=()=>{this.onClose("transport close",{description:"network connection lost"})},addEventListener("offline",this.offlineEventListener,!1))),this.open()}createTransport(e){const t=Object.assign({},this.opts.query);t.EIO=c.protocol,t.transport=e,this.id&&(t.sid=this.id);const n=Object.assign({},this.opts.transportOptions[e],this.opts,{query:t,socket:this,hostname:this.hostname,secure:this.secure,port:this.port});return new r.transports[e](n)}open(){let e;if(this.opts.rememberUpgrade&&l.priorWebsocketSuccess&&-1!==this.transports.indexOf("websocket"))e="websocket";else{if(0===this.transports.length)return void this.setTimeoutFn((()=>{this.emitReserved("error","No transports available")}),0);e=this.transports[0]}this.readyState="opening";try{e=this.createTransport(e)}catch(e){return this.transports.shift(),void this.open()}e.open(),this.setTransport(e)}setTransport(e){this.transport&&this.transport.removeAllListeners(),this.transport=e,e.on("drain",this.onDrain.bind(this)).on("packet",this.onPacket.bind(this)).on("error",this.onError.bind(this)).on("close",(e=>this.onClose("transport close",e)))}probe(e){let t=this.createTransport(e),n=!1;l.priorWebsocketSuccess=!1;const r=()=>{n||(t.send([{type:"ping",data:"probe"}]),t.once("packet",(e=>{if(!n)if("pong"===e.type&&"probe"===e.data){if(this.upgrading=!0,this.emitReserved("upgrading",t),!t)return;l.priorWebsocketSuccess="websocket"===t.name,this.transport.pause((()=>{n||"closed"!==this.readyState&&(u(),this.setTransport(t),t.send([{type:"upgrade"}]),this.emitReserved("upgrade",t),t=null,this.upgrading=!1,this.flush())}))}else{const e=new Error("probe error");e.transport=t.name,this.emitReserved("upgradeError",e)}})))};function i(){n||(n=!0,u(),t.close(),t=null)}const s=e=>{const n=new Error("probe error: "+e);n.transport=t.name,i(),this.emitReserved("upgradeError",n)};function o(){s("transport closed")}function a(){s("socket closed")}function c(e){t&&e.name!==t.name&&i()}const u=()=>{t.removeListener("open",r),t.removeListener("error",s),t.removeListener("close",o),this.off("close",a),this.off("upgrading",c)};t.once("open",r),t.once("error",s),t.once("close",o),this.once("close",a),this.once("upgrading",c),t.open()}onOpen(){if(this.readyState="open",l.priorWebsocketSuccess="websocket"===this.transport.name,this.emitReserved("open"),this.flush(),"open"===this.readyState&&this.opts.upgrade){let e=0;const t=this.upgrades.length;for(;e<t;e++)this.probe(this.upgrades[e])}}onPacket(e){if("opening"===this.readyState||"open"===this.readyState||"closing"===this.readyState)switch(this.emitReserved("packet",e),this.emitReserved("heartbeat"),e.type){case"open":this.onHandshake(JSON.parse(e.data));break;case"ping":this.resetPingTimeout(),this.sendPacket("pong"),this.emitReserved("ping"),this.emitReserved("pong");break;case"error":const t=new Error("server error");t.code=e.data,this.onError(t);break;case"message":this.emitReserved("data",e.data),this.emitReserved("message",e.data)}}onHandshake(e){this.emitReserved("handshake",e),this.id=e.sid,this.transport.query.sid=e.sid,this.upgrades=this.filterUpgrades(e.upgrades),this.pingInterval=e.pingInterval,this.pingTimeout=e.pingTimeout,this.maxPayload=e.maxPayload,this.onOpen(),"closed"!==this.readyState&&this.resetPingTimeout()}resetPingTimeout(){this.clearTimeoutFn(this.pingTimeoutTimer),this.pingTimeoutTimer=this.setTimeoutFn((()=>{this.onClose("ping timeout")}),this.pingInterval+this.pingTimeout),this.opts.autoUnref&&this.pingTimeoutTimer.unref()}onDrain(){this.writeBuffer.splice(0,this.prevBufferLen),this.prevBufferLen=0,0===this.writeBuffer.length?this.emitReserved("drain"):this.flush()}flush(){if("closed"!==this.readyState&&this.transport.writable&&!this.upgrading&&this.writeBuffer.length){const e=this.getWritablePackets();this.transport.send(e),this.prevBufferLen=e.length,this.emitReserved("flush")}}getWritablePackets(){if(!(this.maxPayload&&"polling"===this.transport.name&&this.writeBuffer.length>1))return this.writeBuffer;let e=1;for(let t=0;t<this.writeBuffer.length;t++){const n=this.writeBuffer[t].data;if(n&&(e+=Object(i.byteLength)(n)),t>0&&e>this.maxPayload)return this.writeBuffer.slice(0,t);e+=2}return this.writeBuffer}write(e,t,n){return this.sendPacket("message",e,t,n),this}send(e,t,n){return this.sendPacket("message",e,t,n),this}sendPacket(e,t,n,r){if("function"==typeof t&&(r=t,t=void 0),"function"==typeof n&&(r=n,n=null),"closing"===this.readyState||"closed"===this.readyState)return;(n=n||{}).compress=!1!==n.compress;const i={type:e,data:t,options:n};this.emitReserved("packetCreate",i),this.writeBuffer.push(i),r&&this.once("flush",r),this.flush()}close(){const e=()=>{this.onClose("forced close"),this.transport.close()},t=()=>{this.off("upgrade",t),this.off("upgradeError",t),e()},n=()=>{this.once("upgrade",t),this.once("upgradeError",t)};return"opening"!==this.readyState&&"open"!==this.readyState||(this.readyState="closing",this.writeBuffer.length?this.once("drain",(()=>{this.upgrading?n():e()})):this.upgrading?n():e()),this}onError(e){l.priorWebsocketSuccess=!1,this.emitReserved("error",e),this.onClose("transport error",e)}onClose(e,t){"opening"!==this.readyState&&"open"!==this.readyState&&"closing"!==this.readyState||(this.clearTimeoutFn(this.pingTimeoutTimer),this.transport.removeAllListeners("close"),this.transport.close(),this.transport.removeAllListeners(),"function"==typeof removeEventListener&&(removeEventListener("beforeunload",this.beforeunloadEventListener,!1),removeEventListener("offline",this.offlineEventListener,!1)),this.readyState="closed",this.id=null,this.emitReserved("close",e,t),this.writeBuffer=[],this.prevBufferLen=0)}filterUpgrades(e){const t=[];let n=0;const r=e.length;for(;n<r;n++)~this.transports.indexOf(e[n])&&t.push(e[n]);return t}}l.protocol=c.protocol},"./node_modules/engine.io-client/build/esm/transport.js":function(e,t,n){n.r(t),n.d(t,"Transport",(function(){return a}));var r=n("./node_modules/engine.io-parser/build/esm/index.js"),i=n("./node_modules/@socket.io/component-emitter/index.mjs"),s=n("./node_modules/engine.io-client/build/esm/util.js");class o extends Error{constructor(e,t,n){super(e),this.description=t,this.context=n,this.type="TransportError"}}class a extends i.Emitter{constructor(e){super(),this.writable=!1,Object(s.installTimerFunctions)(this,e),this.opts=e,this.query=e.query,this.socket=e.socket}onError(e,t,n){return super.emitReserved("error",new o(e,t,n)),this}open(){return this.readyState="opening",this.doOpen(),this}close(){return"opening"!==this.readyState&&"open"!==this.readyState||(this.doClose(),this.onClose()),this}send(e){"open"===this.readyState&&this.write(e)}onOpen(){this.readyState="open",this.writable=!0,super.emitReserved("open")}onData(e){const t=Object(r.decodePacket)(e,this.socket.binaryType);this.onPacket(t)}onPacket(e){super.emitReserved("packet",e)}onClose(e){this.readyState="closed",super.emitReserved("close",e)}pause(e){}}},"./node_modules/engine.io-client/build/esm/transports/index.js":function(e,t,n){n.r(t),n.d(t,"transports",(function(){return i}));var r=n("./node_modules/engine.io-client/build/esm/transports/polling.js");const i={websocket:n("./node_modules/engine.io-client/build/esm/transports/websocket.js").WS,polling:r.Polling}},"./node_modules/engine.io-client/build/esm/transports/polling.js":function(e,t,n){n.r(t),n.d(t,"Polling",(function(){return p})),n.d(t,"Request",(function(){return f}));var r=n("./node_modules/engine.io-client/build/esm/transport.js"),i=n("./node_modules/engine.io-client/build/esm/contrib/yeast.js"),s=n("./node_modules/engine.io-client/build/esm/contrib/parseqs.js"),o=n("./node_modules/engine.io-parser/build/esm/index.js"),a=n("./node_modules/engine.io-client/build/esm/transports/xmlhttprequest.browser.js"),c=n("./node_modules/@socket.io/component-emitter/index.mjs"),l=n("./node_modules/engine.io-client/build/esm/util.js"),u=n("./node_modules/engine.io-client/build/esm/globalThis.browser.js");function d(){}const h=null!=new a.XHR({xdomain:!1}).responseType;class p extends r.Transport{constructor(e){if(super(e),this.polling=!1,"undefined"!=typeof location){const t="https:"===location.protocol;let n=location.port;n||(n=t?"443":"80"),this.xd="undefined"!=typeof location&&e.hostname!==location.hostname||n!==e.port,this.xs=e.secure!==t}const t=e&&e.forceBase64;this.supportsBinary=h&&!t}get name(){return"polling"}doOpen(){this.poll()}pause(e){this.readyState="pausing";const t=()=>{this.readyState="paused",e()};if(this.polling||!this.writable){let e=0;this.polling&&(e++,this.once("pollComplete",(function(){--e||t()}))),this.writable||(e++,this.once("drain",(function(){--e||t()})))}else t()}poll(){this.polling=!0,this.doPoll(),this.emitReserved("poll")}onData(e){Object(o.decodePayload)(e,this.socket.binaryType).forEach((e=>{if("opening"===this.readyState&&"open"===e.type&&this.onOpen(),"close"===e.type)return this.onClose({description:"transport closed by the server"}),!1;this.onPacket(e)})),"closed"!==this.readyState&&(this.polling=!1,this.emitReserved("pollComplete"),"open"===this.readyState&&this.poll())}doClose(){const e=()=>{this.write([{type:"close"}])};"open"===this.readyState?e():this.once("open",e)}write(e){this.writable=!1,Object(o.encodePayload)(e,(e=>{this.doWrite(e,(()=>{this.writable=!0,this.emitReserved("drain")}))}))}uri(){let e=this.query||{};const t=this.opts.secure?"https":"http";let n="";!1!==this.opts.timestampRequests&&(e[this.opts.timestampParam]=Object(i.yeast)()),this.supportsBinary||e.sid||(e.b64=1),this.opts.port&&("https"===t&&443!==Number(this.opts.port)||"http"===t&&80!==Number(this.opts.port))&&(n=":"+this.opts.port);const r=Object(s.encode)(e);return t+"://"+(-1!==this.opts.hostname.indexOf(":")?"["+this.opts.hostname+"]":this.opts.hostname)+n+this.opts.path+(r.length?"?"+r:"")}request(e={}){return Object.assign(e,{xd:this.xd,xs:this.xs},this.opts),new f(this.uri(),e)}doWrite(e,t){const n=this.request({method:"POST",data:e});n.on("success",t),n.on("error",((e,t)=>{this.onError("xhr post error",e,t)}))}doPoll(){const e=this.request();e.on("data",this.onData.bind(this)),e.on("error",((e,t)=>{this.onError("xhr poll error",e,t)})),this.pollXhr=e}}class f extends c.Emitter{constructor(e,t){super(),Object(l.installTimerFunctions)(this,t),this.opts=t,this.method=t.method||"GET",this.uri=e,this.async=!1!==t.async,this.data=void 0!==t.data?t.data:null,this.create()}create(){const e=Object(l.pick)(this.opts,"agent","pfx","key","passphrase","cert","ca","ciphers","rejectUnauthorized","autoUnref");e.xdomain=!!this.opts.xd,e.xscheme=!!this.opts.xs;const t=this.xhr=new a.XHR(e);try{t.open(this.method,this.uri,this.async);try{if(this.opts.extraHeaders){t.setDisableHeaderCheck&&t.setDisableHeaderCheck(!0);for(let e in this.opts.extraHeaders)this.opts.extraHeaders.hasOwnProperty(e)&&t.setRequestHeader(e,this.opts.extraHeaders[e])}}catch(e){}if("POST"===this.method)try{t.setRequestHeader("Content-type","text/plain;charset=UTF-8")}catch(e){}try{t.setRequestHeader("Accept","*/*")}catch(e){}"withCredentials"in t&&(t.withCredentials=this.opts.withCredentials),this.opts.requestTimeout&&(t.timeout=this.opts.requestTimeout),t.onreadystatechange=()=>{4===t.readyState&&(200===t.status||1223===t.status?this.onLoad():this.setTimeoutFn((()=>{this.onError("number"==typeof t.status?t.status:0)}),0))},t.send(this.data)}catch(e){return void this.setTimeoutFn((()=>{this.onError(e)}),0)}"undefined"!=typeof document&&(this.index=f.requestsCount++,f.requests[this.index]=this)}onError(e){this.emitReserved("error",e,this.xhr),this.cleanup(!0)}cleanup(e){if(void 0!==this.xhr&&null!==this.xhr){if(this.xhr.onreadystatechange=d,e)try{this.xhr.abort()}catch(e){}"undefined"!=typeof document&&delete f.requests[this.index],this.xhr=null}}onLoad(){const e=this.xhr.responseText;null!==e&&(this.emitReserved("data",e),this.emitReserved("success"),this.cleanup())}abort(){this.cleanup()}}if(f.requestsCount=0,f.requests={},"undefined"!=typeof document)if("function"==typeof attachEvent)attachEvent("onunload",_);else if("function"==typeof addEventListener){const e="onpagehide"in u.globalThisShim?"pagehide":"unload";addEventListener(e,_,!1)}function _(){for(let e in f.requests)f.requests.hasOwnProperty(e)&&f.requests[e].abort()}},"./node_modules/engine.io-client/build/esm/transports/websocket-constructor.browser.js":function(e,t,n){n.r(t),n.d(t,"nextTick",(function(){return i})),n.d(t,"WebSocket",(function(){return s})),n.d(t,"usingBrowserWebSocket",(function(){return o})),n.d(t,"defaultBinaryType",(function(){return a}));var r=n("./node_modules/engine.io-client/build/esm/globalThis.browser.js");const i="function"==typeof Promise&&"function"==typeof Promise.resolve?e=>Promise.resolve().then(e):(e,t)=>t(e,0),s=r.globalThisShim.WebSocket||r.globalThisShim.MozWebSocket,o=!0,a="arraybuffer"},"./node_modules/engine.io-client/build/esm/transports/websocket.js":function(e,t,n){n.r(t),function(e){n.d(t,"WS",(function(){return u}));var r=n("./node_modules/engine.io-client/build/esm/transport.js"),i=n("./node_modules/engine.io-client/build/esm/contrib/parseqs.js"),s=n("./node_modules/engine.io-client/build/esm/contrib/yeast.js"),o=n("./node_modules/engine.io-client/build/esm/util.js"),a=n("./node_modules/engine.io-client/build/esm/transports/websocket-constructor.browser.js"),c=n("./node_modules/engine.io-parser/build/esm/index.js");const l="undefined"!=typeof navigator&&"string"==typeof navigator.product&&"reactnative"===navigator.product.toLowerCase();class u extends r.Transport{constructor(e){super(e),this.supportsBinary=!e.forceBase64}get name(){return"websocket"}doOpen(){if(!this.check())return;const e=this.uri(),t=this.opts.protocols,n=l?{}:Object(o.pick)(this.opts,"agent","perMessageDeflate","pfx","key","passphrase","cert","ca","ciphers","rejectUnauthorized","localAddress","protocolVersion","origin","maxPayload","family","checkServerIdentity");this.opts.extraHeaders&&(n.headers=this.opts.extraHeaders);try{this.ws=a.usingBrowserWebSocket&&!l?t?new a.WebSocket(e,t):new a.WebSocket(e):new a.WebSocket(e,t,n)}catch(e){return this.emitReserved("error",e)}this.ws.binaryType=this.socket.binaryType||a.defaultBinaryType,this.addEventListeners()}addEventListeners(){this.ws.onopen=()=>{this.opts.autoUnref&&this.ws._socket.unref(),this.onOpen()},this.ws.onclose=e=>this.onClose({description:"websocket connection closed",context:e}),this.ws.onmessage=e=>this.onData(e.data),this.ws.onerror=e=>this.onError("websocket error",e)}write(t){this.writable=!1;for(let n=0;n<t.length;n++){const r=t[n],i=n===t.length-1;Object(c.encodePacket)(r,this.supportsBinary,(t=>{const n={};!a.usingBrowserWebSocket&&(r.options&&(n.compress=r.options.compress),this.opts.perMessageDeflate)&&("string"==typeof t?e.byteLength(t):t.length)<this.opts.perMessageDeflate.threshold&&(n.compress=!1);try{a.usingBrowserWebSocket?this.ws.send(t):this.ws.send(t,n)}catch(e){}i&&Object(a.nextTick)((()=>{this.writable=!0,this.emitReserved("drain")}),this.setTimeoutFn)}))}}doClose(){void 0!==this.ws&&(this.ws.close(),this.ws=null)}uri(){let e=this.query||{};const t=this.opts.secure?"wss":"ws";let n="";this.opts.port&&("wss"===t&&443!==Number(this.opts.port)||"ws"===t&&80!==Number(this.opts.port))&&(n=":"+this.opts.port),this.opts.timestampRequests&&(e[this.opts.timestampParam]=Object(s.yeast)()),this.supportsBinary||(e.b64=1);const r=Object(i.encode)(e);return t+"://"+(-1!==this.opts.hostname.indexOf(":")?"["+this.opts.hostname+"]":this.opts.hostname)+n+this.opts.path+(r.length?"?"+r:"")}check(){return!!a.WebSocket}}}.call(this,n("./node_modules/buffer/index.js").Buffer)},"./node_modules/engine.io-client/build/esm/transports/xmlhttprequest.browser.js":function(e,t,n){n.r(t),n.d(t,"XHR",(function(){return s}));var r=n("./node_modules/engine.io-client/build/esm/contrib/has-cors.js"),i=n("./node_modules/engine.io-client/build/esm/globalThis.browser.js");function s(e){const t=e.xdomain;try{if("undefined"!=typeof XMLHttpRequest&&(!t||r.hasCORS))return new XMLHttpRequest}catch(e){}if(!t)try{return new(i.globalThisShim[["Active"].concat("Object").join("X")])("Microsoft.XMLHTTP")}catch(e){}}},"./node_modules/engine.io-client/build/esm/util.js":function(e,t,n){n.r(t),n.d(t,"pick",(function(){return i})),n.d(t,"installTimerFunctions",(function(){return a})),n.d(t,"byteLength",(function(){return l}));var r=n("./node_modules/engine.io-client/build/esm/globalThis.browser.js");function i(e,...t){return t.reduce(((t,n)=>(e.hasOwnProperty(n)&&(t[n]=e[n]),t)),{})}const s=r.globalThisShim.setTimeout,o=r.globalThisShim.clearTimeout;function a(e,t){t.useNativeTimers?(e.setTimeoutFn=s.bind(r.globalThisShim),e.clearTimeoutFn=o.bind(r.globalThisShim)):(e.setTimeoutFn=r.globalThisShim.setTimeout.bind(r.globalThisShim),e.clearTimeoutFn=r.globalThisShim.clearTimeout.bind(r.globalThisShim))}const c=1.33;function l(e){return"string"==typeof e?function(e){let t=0,n=0;for(let r=0,i=e.length;r<i;r++)t=e.charCodeAt(r),t<128?n+=1:t<2048?n+=2:t<55296||t>=57344?n+=3:(r++,n+=4);return n}(e):Math.ceil((e.byteLength||e.size)*c)}},"./node_modules/engine.io-parser/build/esm/commons.js":function(e,t,n){n.r(t),n.d(t,"PACKET_TYPES",(function(){return r})),n.d(t,"PACKET_TYPES_REVERSE",(function(){return i})),n.d(t,"ERROR_PACKET",(function(){return s}));const r=Object.create(null);r.open="0",r.close="1",r.ping="2",r.pong="3",r.message="4",r.upgrade="5",r.noop="6";const i=Object.create(null);Object.keys(r).forEach((e=>{i[r[e]]=e}));const s={type:"error",data:"parser error"}},"./node_modules/engine.io-parser/build/esm/decodePacket.browser.js":function(e,t,n){n.r(t);var r=n("./node_modules/engine.io-parser/build/esm/commons.js"),i=n("./node_modules/@socket.io/base64-arraybuffer/dist/base64-arraybuffer.es5.js");const s="function"==typeof ArrayBuffer,o=(e,t)=>{if(s){const n=Object(i.decode)(e);return a(n,t)}return{base64:!0,data:e}},a=(e,t)=>"blob"===t&&e instanceof ArrayBuffer?new Blob([e]):e;t.default=(e,t)=>{if("string"!=typeof e)return{type:"message",data:a(e,t)};const n=e.charAt(0);return"b"===n?{type:"message",data:o(e.substring(1),t)}:r.PACKET_TYPES_REVERSE[n]?e.length>1?{type:r.PACKET_TYPES_REVERSE[n],data:e.substring(1)}:{type:r.PACKET_TYPES_REVERSE[n]}:r.ERROR_PACKET}},"./node_modules/engine.io-parser/build/esm/encodePacket.browser.js":function(e,t,n){n.r(t);var r=n("./node_modules/engine.io-parser/build/esm/commons.js");const i="function"==typeof Blob||"undefined"!=typeof Blob&&"[object BlobConstructor]"===Object.prototype.toString.call(Blob),s="function"==typeof ArrayBuffer,o=(e,t)=>{const n=new FileReader;return n.onload=function(){const e=n.result.split(",")[1];t("b"+e)},n.readAsDataURL(e)};t.default=({type:e,data:t},n,a)=>{return i&&t instanceof Blob?n?a(t):o(t,a):s&&(t instanceof ArrayBuffer||(c=t,"function"==typeof ArrayBuffer.isView?ArrayBuffer.isView(c):c&&c.buffer instanceof ArrayBuffer))?n?a(t):o(new Blob([t]),a):a(r.PACKET_TYPES[e]+(t||""));var c}},"./node_modules/engine.io-parser/build/esm/index.js":function(e,t,n){n.r(t),n.d(t,"protocol",(function(){return c})),n.d(t,"encodePayload",(function(){return o})),n.d(t,"decodePayload",(function(){return a}));var r=n("./node_modules/engine.io-parser/build/esm/encodePacket.browser.js");n.d(t,"encodePacket",(function(){return r.default}));var i=n("./node_modules/engine.io-parser/build/esm/decodePacket.browser.js");n.d(t,"decodePacket",(function(){return i.default}));const s=String.fromCharCode(30),o=(e,t)=>{const n=e.length,i=new Array(n);let o=0;e.forEach(((e,a)=>{Object(r.default)(e,!1,(e=>{i[a]=e,++o===n&&t(i.join(s))}))}))},a=(e,t)=>{const n=e.split(s),r=[];for(let e=0;e<n.length;e++){const s=Object(i.default)(n[e],t);if(r.push(s),"error"===s.type)break}return r},c=4},"./node_modules/ieee754/index.js":function(e,t){t.read=function(e,t,n,r,i){var s,o,a=8*i-r-1,c=(1<<a)-1,l=c>>1,u=-7,d=n?i-1:0,h=n?-1:1,p=e[t+d];for(d+=h,s=p&(1<<-u)-1,p>>=-u,u+=a;u>0;s=256*s+e[t+d],d+=h,u-=8);for(o=s&(1<<-u)-1,s>>=-u,u+=r;u>0;o=256*o+e[t+d],d+=h,u-=8);if(0===s)s=1-l;else{if(s===c)return o?NaN:1/0*(p?-1:1);o+=Math.pow(2,r),s-=l}return(p?-1:1)*o*Math.pow(2,s-r)},t.write=function(e,t,n,r,i,s){var o,a,c,l=8*s-i-1,u=(1<<l)-1,d=u>>1,h=23===i?Math.pow(2,-24)-Math.pow(2,-77):0,p=r?0:s-1,f=r?1:-1,_=t<0||0===t&&1/t<0?1:0;for(t=Math.abs(t),isNaN(t)||t===1/0?(a=isNaN(t)?1:0,o=u):(o=Math.floor(Math.log(t)/Math.LN2),t*(c=Math.pow(2,-o))<1&&(o--,c*=2),(t+=o+d>=1?h/c:h*Math.pow(2,1-d))*c>=2&&(o++,c/=2),o+d>=u?(a=0,o=u):o+d>=1?(a=(t*c-1)*Math.pow(2,i),o+=d):(a=t*Math.pow(2,d-1)*Math.pow(2,i),o=0));i>=8;e[n+p]=255&a,p+=f,a/=256,i-=8);for(o=o<<i|a,l+=i;l>0;e[n+p]=255&o,p+=f,o/=256,l-=8);e[n+p-f]|=128*_}},"./node_modules/isarray/index.js":function(e,t){var n={}.toString;e.exports=Array.isArray||function(e){return"[object Array]"==n.call(e)}},"./node_modules/socket.io-client/build/esm/contrib/backo2.js":function(e,t,n){function r(e){e=e||{},this.ms=e.min||100,this.max=e.max||1e4,this.factor=e.factor||2,this.jitter=e.jitter>0&&e.jitter<=1?e.jitter:0,this.attempts=0}n.r(t),n.d(t,"Backoff",(function(){return r})),r.prototype.duration=function(){var e=this.ms*Math.pow(this.factor,this.attempts++);if(this.jitter){var t=Math.random(),n=Math.floor(t*this.jitter*e);e=1&Math.floor(10*t)?e+n:e-n}return 0|Math.min(e,this.max)},r.prototype.reset=function(){this.attempts=0},r.prototype.setMin=function(e){this.ms=e},r.prototype.setMax=function(e){this.max=e},r.prototype.setJitter=function(e){this.jitter=e}},"./node_modules/socket.io-client/build/esm/index.js":function(e,t,n){n.r(t),n.d(t,"io",(function(){return c})),n.d(t,"connect",(function(){return c})),n.d(t,"default",(function(){return c}));var r=n("./node_modules/socket.io-client/build/esm/url.js"),i=n("./node_modules/socket.io-client/build/esm/manager.js");n.d(t,"Manager",(function(){return i.Manager}));var s=n("./node_modules/socket.io-client/build/esm/socket.js");n.d(t,"Socket",(function(){return s.Socket}));var o=n("./node_modules/socket.io-parser/build/esm/index.js");n.d(t,"protocol",(function(){return o.protocol}));const a={};function c(e,t){"object"==typeof e&&(t=e,e=void 0),t=t||{};const n=Object(r.url)(e,t.path||"/socket.io"),s=n.source,o=n.id,c=n.path,l=a[o]&&c in a[o].nsps;let u;return t.forceNew||t["force new connection"]||!1===t.multiplex||l?u=new i.Manager(s,t):(a[o]||(a[o]=new i.Manager(s,t)),u=a[o]),n.query&&!t.query&&(t.query=n.queryKey),u.socket(n.path,t)}Object.assign(c,{Manager:i.Manager,Socket:s.Socket,io:c,connect:c})},"./node_modules/socket.io-client/build/esm/manager.js":function(e,t,n){n.r(t),n.d(t,"Manager",(function(){return l}));var r=n("./node_modules/engine.io-client/build/esm/index.js"),i=n("./node_modules/socket.io-client/build/esm/socket.js"),s=n("./node_modules/socket.io-parser/build/esm/index.js"),o=n("./node_modules/socket.io-client/build/esm/on.js"),a=n("./node_modules/socket.io-client/build/esm/contrib/backo2.js"),c=n("./node_modules/@socket.io/component-emitter/index.mjs");class l extends c.Emitter{constructor(e,t){var n;super(),this.nsps={},this.subs=[],e&&"object"==typeof e&&(t=e,e=void 0),(t=t||{}).path=t.path||"/socket.io",this.opts=t,Object(r.installTimerFunctions)(this,t),this.reconnection(!1!==t.reconnection),this.reconnectionAttempts(t.reconnectionAttempts||1/0),this.reconnectionDelay(t.reconnectionDelay||1e3),this.reconnectionDelayMax(t.reconnectionDelayMax||5e3),this.randomizationFactor(null!==(n=t.randomizationFactor)&&void 0!==n?n:.5),this.backoff=new a.Backoff({min:this.reconnectionDelay(),max:this.reconnectionDelayMax(),jitter:this.randomizationFactor()}),this.timeout(null==t.timeout?2e4:t.timeout),this._readyState="closed",this.uri=e;const i=t.parser||s;this.encoder=new i.Encoder,this.decoder=new i.Decoder,this._autoConnect=!1!==t.autoConnect,this._autoConnect&&this.open()}reconnection(e){return arguments.length?(this._reconnection=!!e,this):this._reconnection}reconnectionAttempts(e){return void 0===e?this._reconnectionAttempts:(this._reconnectionAttempts=e,this)}reconnectionDelay(e){var t;return void 0===e?this._reconnectionDelay:(this._reconnectionDelay=e,null===(t=this.backoff)||void 0===t||t.setMin(e),this)}randomizationFactor(e){var t;return void 0===e?this._randomizationFactor:(this._randomizationFactor=e,null===(t=this.backoff)||void 0===t||t.setJitter(e),this)}reconnectionDelayMax(e){var t;return void 0===e?this._reconnectionDelayMax:(this._reconnectionDelayMax=e,null===(t=this.backoff)||void 0===t||t.setMax(e),this)}timeout(e){return arguments.length?(this._timeout=e,this):this._timeout}maybeReconnectOnOpen(){!this._reconnecting&&this._reconnection&&0===this.backoff.attempts&&this.reconnect()}open(e){if(~this._readyState.indexOf("open"))return this;this.engine=new r.Socket(this.uri,this.opts);const t=this.engine,n=this;this._readyState="opening",this.skipReconnect=!1;const i=Object(o.on)(t,"open",(function(){n.onopen(),e&&e()})),s=Object(o.on)(t,"error",(t=>{n.cleanup(),n._readyState="closed",this.emitReserved("error",t),e?e(t):n.maybeReconnectOnOpen()}));if(!1!==this._timeout){const e=this._timeout;0===e&&i();const n=this.setTimeoutFn((()=>{i(),t.close(),t.emit("error",new Error("timeout"))}),e);this.opts.autoUnref&&n.unref(),this.subs.push((function(){clearTimeout(n)}))}return this.subs.push(i),this.subs.push(s),this}connect(e){return this.open(e)}onopen(){this.cleanup(),this._readyState="open",this.emitReserved("open");const e=this.engine;this.subs.push(Object(o.on)(e,"ping",this.onping.bind(this)),Object(o.on)(e,"data",this.ondata.bind(this)),Object(o.on)(e,"error",this.onerror.bind(this)),Object(o.on)(e,"close",this.onclose.bind(this)),Object(o.on)(this.decoder,"decoded",this.ondecoded.bind(this)))}onping(){this.emitReserved("ping")}ondata(e){try{this.decoder.add(e)}catch(e){this.onclose("parse error",e)}}ondecoded(e){Object(r.nextTick)((()=>{this.emitReserved("packet",e)}),this.setTimeoutFn)}onerror(e){this.emitReserved("error",e)}socket(e,t){let n=this.nsps[e];return n?this._autoConnect&&!n.active&&n.connect():(n=new i.Socket(this,e,t),this.nsps[e]=n),n}_destroy(e){const t=Object.keys(this.nsps);for(const e of t)if(this.nsps[e].active)return;this._close()}_packet(e){const t=this.encoder.encode(e);for(let n=0;n<t.length;n++)this.engine.write(t[n],e.options)}cleanup(){this.subs.forEach((e=>e())),this.subs.length=0,this.decoder.destroy()}_close(){this.skipReconnect=!0,this._reconnecting=!1,this.onclose("forced close"),this.engine&&this.engine.close()}disconnect(){return this._close()}onclose(e,t){this.cleanup(),this.backoff.reset(),this._readyState="closed",this.emitReserved("close",e,t),this._reconnection&&!this.skipReconnect&&this.reconnect()}reconnect(){if(this._reconnecting||this.skipReconnect)return this;const e=this;if(this.backoff.attempts>=this._reconnectionAttempts)this.backoff.reset(),this.emitReserved("reconnect_failed"),this._reconnecting=!1;else{const t=this.backoff.duration();this._reconnecting=!0;const n=this.setTimeoutFn((()=>{e.skipReconnect||(this.emitReserved("reconnect_attempt",e.backoff.attempts),e.skipReconnect||e.open((t=>{t?(e._reconnecting=!1,e.reconnect(),this.emitReserved("reconnect_error",t)):e.onreconnect()})))}),t);this.opts.autoUnref&&n.unref(),this.subs.push((function(){clearTimeout(n)}))}}onreconnect(){const e=this.backoff.attempts;this._reconnecting=!1,this.backoff.reset(),this.emitReserved("reconnect",e)}}},"./node_modules/socket.io-client/build/esm/on.js":function(e,t,n){function r(e,t,n){return e.on(t,n),function(){e.off(t,n)}}n.r(t),n.d(t,"on",(function(){return r}))},"./node_modules/socket.io-client/build/esm/socket.js":function(e,t,n){n.r(t),n.d(t,"Socket",(function(){return a}));var r=n("./node_modules/socket.io-parser/build/esm/index.js"),i=n("./node_modules/socket.io-client/build/esm/on.js"),s=n("./node_modules/@socket.io/component-emitter/index.mjs");const o=Object.freeze({connect:1,connect_error:1,disconnect:1,disconnecting:1,newListener:1,removeListener:1});class a extends s.Emitter{constructor(e,t,n){super(),this.connected=!1,this.recovered=!1,this.receiveBuffer=[],this.sendBuffer=[],this._queue=[],this._queueSeq=0,this.ids=0,this.acks={},this.flags={},this.io=e,this.nsp=t,n&&n.auth&&(this.auth=n.auth),this._opts=Object.assign({},n),this.io._autoConnect&&this.open()}get disconnected(){return!this.connected}subEvents(){if(this.subs)return;const e=this.io;this.subs=[Object(i.on)(e,"open",this.onopen.bind(this)),Object(i.on)(e,"packet",this.onpacket.bind(this)),Object(i.on)(e,"error",this.onerror.bind(this)),Object(i.on)(e,"close",this.onclose.bind(this))]}get active(){return!!this.subs}connect(){return this.connected||(this.subEvents(),this.io._reconnecting||this.io.open(),"open"===this.io._readyState&&this.onopen()),this}open(){return this.connect()}send(...e){return e.unshift("message"),this.emit.apply(this,e),this}emit(e,...t){if(o.hasOwnProperty(e))throw new Error('"'+e.toString()+'" is a reserved event name');if(t.unshift(e),this._opts.retries&&!this.flags.fromQueue&&!this.flags.volatile)return this._addToQueue(t),this;const n={type:r.PacketType.EVENT,data:t,options:{}};if(n.options.compress=!1!==this.flags.compress,"function"==typeof t[t.length-1]){const e=this.ids++,r=t.pop();this._registerAckCallback(e,r),n.id=e}const i=this.io.engine&&this.io.engine.transport&&this.io.engine.transport.writable;return this.flags.volatile&&(!i||!this.connected)||(this.connected?(this.notifyOutgoingListeners(n),this.packet(n)):this.sendBuffer.push(n)),this.flags={},this}_registerAckCallback(e,t){var n;const r=null!==(n=this.flags.timeout)&&void 0!==n?n:this._opts.ackTimeout;if(void 0===r)return void(this.acks[e]=t);const i=this.io.setTimeoutFn((()=>{delete this.acks[e];for(let t=0;t<this.sendBuffer.length;t++)this.sendBuffer[t].id===e&&this.sendBuffer.splice(t,1);t.call(this,new Error("operation has timed out"))}),r);this.acks[e]=(...e)=>{this.io.clearTimeoutFn(i),t.apply(this,[null,...e])}}emitWithAck(e,...t){const n=void 0!==this.flags.timeout||void 0!==this._opts.ackTimeout;return new Promise(((r,i)=>{t.push(((e,t)=>n?e?i(e):r(t):r(e))),this.emit(e,...t)}))}_addToQueue(e){let t;"function"==typeof e[e.length-1]&&(t=e.pop());const n={id:this._queueSeq++,tryCount:0,pending:!1,args:e,flags:Object.assign({fromQueue:!0},this.flags)};e.push(((e,...r)=>{if(n===this._queue[0])return null!==e?n.tryCount>this._opts.retries&&(this._queue.shift(),t&&t(e)):(this._queue.shift(),t&&t(null,...r)),n.pending=!1,this._drainQueue()})),this._queue.push(n),this._drainQueue()}_drainQueue(e=!1){if(!this.connected||0===this._queue.length)return;const t=this._queue[0];t.pending&&!e||(t.pending=!0,t.tryCount++,this.flags=t.flags,this.emit.apply(this,t.args))}packet(e){e.nsp=this.nsp,this.io._packet(e)}onopen(){"function"==typeof this.auth?this.auth((e=>{this._sendConnectPacket(e)})):this._sendConnectPacket(this.auth)}_sendConnectPacket(e){this.packet({type:r.PacketType.CONNECT,data:this._pid?Object.assign({pid:this._pid,offset:this._lastOffset},e):e})}onerror(e){this.connected||this.emitReserved("connect_error",e)}onclose(e,t){this.connected=!1,delete this.id,this.emitReserved("disconnect",e,t)}onpacket(e){if(e.nsp===this.nsp)switch(e.type){case r.PacketType.CONNECT:e.data&&e.data.sid?this.onconnect(e.data.sid,e.data.pid):this.emitReserved("connect_error",new Error("It seems you are trying to reach a Socket.IO server in v2.x with a v3.x client, but they are not compatible (more information here: https://socket.io/docs/v3/migrating-from-2-x-to-3-0/)"));break;case r.PacketType.EVENT:case r.PacketType.BINARY_EVENT:this.onevent(e);break;case r.PacketType.ACK:case r.PacketType.BINARY_ACK:this.onack(e);break;case r.PacketType.DISCONNECT:this.ondisconnect();break;case r.PacketType.CONNECT_ERROR:this.destroy();const t=new Error(e.data.message);t.data=e.data.data,this.emitReserved("connect_error",t)}}onevent(e){const t=e.data||[];null!=e.id&&t.push(this.ack(e.id)),this.connected?this.emitEvent(t):this.receiveBuffer.push(Object.freeze(t))}emitEvent(e){if(this._anyListeners&&this._anyListeners.length){const t=this._anyListeners.slice();for(const n of t)n.apply(this,e)}super.emit.apply(this,e),this._pid&&e.length&&"string"==typeof e[e.length-1]&&(this._lastOffset=e[e.length-1])}ack(e){const t=this;let n=!1;return function(...i){n||(n=!0,t.packet({type:r.PacketType.ACK,id:e,data:i}))}}onack(e){const t=this.acks[e.id];"function"==typeof t&&(t.apply(this,e.data),delete this.acks[e.id])}onconnect(e,t){this.id=e,this.recovered=t&&this._pid===t,this._pid=t,this.connected=!0,this.emitBuffered(),this.emitReserved("connect"),this._drainQueue(!0)}emitBuffered(){this.receiveBuffer.forEach((e=>this.emitEvent(e))),this.receiveBuffer=[],this.sendBuffer.forEach((e=>{this.notifyOutgoingListeners(e),this.packet(e)})),this.sendBuffer=[]}ondisconnect(){this.destroy(),this.onclose("io server disconnect")}destroy(){this.subs&&(this.subs.forEach((e=>e())),this.subs=void 0),this.io._destroy(this)}disconnect(){return this.connected&&this.packet({type:r.PacketType.DISCONNECT}),this.destroy(),this.connected&&this.onclose("io client disconnect"),this}close(){return this.disconnect()}compress(e){return this.flags.compress=e,this}get volatile(){return this.flags.volatile=!0,this}timeout(e){return this.flags.timeout=e,this}onAny(e){return this._anyListeners=this._anyListeners||[],this._anyListeners.push(e),this}prependAny(e){return this._anyListeners=this._anyListeners||[],this._anyListeners.unshift(e),this}offAny(e){if(!this._anyListeners)return this;if(e){const t=this._anyListeners;for(let n=0;n<t.length;n++)if(e===t[n])return t.splice(n,1),this}else this._anyListeners=[];return this}listenersAny(){return this._anyListeners||[]}onAnyOutgoing(e){return this._anyOutgoingListeners=this._anyOutgoingListeners||[],this._anyOutgoingListeners.push(e),this}prependAnyOutgoing(e){return this._anyOutgoingListeners=this._anyOutgoingListeners||[],this._anyOutgoingListeners.unshift(e),this}offAnyOutgoing(e){if(!this._anyOutgoingListeners)return this;if(e){const t=this._anyOutgoingListeners;for(let n=0;n<t.length;n++)if(e===t[n])return t.splice(n,1),this}else this._anyOutgoingListeners=[];return this}listenersAnyOutgoing(){return this._anyOutgoingListeners||[]}notifyOutgoingListeners(e){if(this._anyOutgoingListeners&&this._anyOutgoingListeners.length){const t=this._anyOutgoingListeners.slice();for(const n of t)n.apply(this,e.data)}}}},"./node_modules/socket.io-client/build/esm/url.js":function(e,t,n){n.r(t),n.d(t,"url",(function(){return i}));var r=n("./node_modules/engine.io-client/build/esm/index.js");function i(e,t="",n){let i=e;n=n||"undefined"!=typeof location&&location,null==e&&(e=n.protocol+"//"+n.host),"string"==typeof e&&("/"===e.charAt(0)&&(e="/"===e.charAt(1)?n.protocol+e:n.host+e),/^(https?|wss?):\/\//.test(e)||(e=void 0!==n?n.protocol+"//"+e:"https://"+e),i=Object(r.parse)(e)),i.port||(/^(http|ws)$/.test(i.protocol)?i.port="80":/^(http|ws)s$/.test(i.protocol)&&(i.port="443")),i.path=i.path||"/";const s=-1!==i.host.indexOf(":")?"["+i.host+"]":i.host;return i.id=i.protocol+"://"+s+":"+i.port+t,i.href=i.protocol+"://"+s+(n&&n.port===i.port?"":":"+i.port),i}},"./node_modules/socket.io-parser/build/esm/binary.js":function(e,t,n){n.r(t),n.d(t,"deconstructPacket",(function(){return i})),n.d(t,"reconstructPacket",(function(){return o}));var r=n("./node_modules/socket.io-parser/build/esm/is-binary.js");function i(e){const t=[],n=e.data,r=e;return r.data=s(n,t),r.attachments=t.length,{packet:r,buffers:t}}function s(e,t){if(!e)return e;if(Object(r.isBinary)(e)){const n={_placeholder:!0,num:t.length};return t.push(e),n}if(Array.isArray(e)){const n=new Array(e.length);for(let r=0;r<e.length;r++)n[r]=s(e[r],t);return n}if("object"==typeof e&&!(e instanceof Date)){const n={};for(const r in e)Object.prototype.hasOwnProperty.call(e,r)&&(n[r]=s(e[r],t));return n}return e}function o(e,t){return e.data=a(e.data,t),delete e.attachments,e}function a(e,t){if(!e)return e;if(e&&!0===e._placeholder){if("number"==typeof e.num&&e.num>=0&&e.num<t.length)return t[e.num];throw new Error("illegal attachments")}if(Array.isArray(e))for(let n=0;n<e.length;n++)e[n]=a(e[n],t);else if("object"==typeof e)for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&(e[n]=a(e[n],t));return e}},"./node_modules/socket.io-parser/build/esm/index.js":function(e,t,n){n.r(t),n.d(t,"protocol",(function(){return a})),n.d(t,"PacketType",(function(){return c})),n.d(t,"Encoder",(function(){return l})),n.d(t,"Decoder",(function(){return d}));var r=n("./node_modules/@socket.io/component-emitter/index.mjs"),i=n("./node_modules/socket.io-parser/build/esm/binary.js"),s=n("./node_modules/socket.io-parser/build/esm/is-binary.js");const o=["connect","connect_error","disconnect","disconnecting","newListener","removeListener"],a=5;var c;!function(e){e[e.CONNECT=0]="CONNECT",e[e.DISCONNECT=1]="DISCONNECT",e[e.EVENT=2]="EVENT",e[e.ACK=3]="ACK",e[e.CONNECT_ERROR=4]="CONNECT_ERROR",e[e.BINARY_EVENT=5]="BINARY_EVENT",e[e.BINARY_ACK=6]="BINARY_ACK"}(c||(c={}));class l{constructor(e){this.replacer=e}encode(e){return e.type!==c.EVENT&&e.type!==c.ACK||!Object(s.hasBinary)(e)?[this.encodeAsString(e)]:this.encodeAsBinary({type:e.type===c.EVENT?c.BINARY_EVENT:c.BINARY_ACK,nsp:e.nsp,data:e.data,id:e.id})}encodeAsString(e){let t=""+e.type;return e.type!==c.BINARY_EVENT&&e.type!==c.BINARY_ACK||(t+=e.attachments+"-"),e.nsp&&"/"!==e.nsp&&(t+=e.nsp+","),null!=e.id&&(t+=e.id),null!=e.data&&(t+=JSON.stringify(e.data,this.replacer)),t}encodeAsBinary(e){const t=Object(i.deconstructPacket)(e),n=this.encodeAsString(t.packet),r=t.buffers;return r.unshift(n),r}}function u(e){return"[object Object]"===Object.prototype.toString.call(e)}class d extends r.Emitter{constructor(e){super(),this.reviver=e}add(e){let t;if("string"==typeof e){if(this.reconstructor)throw new Error("got plaintext data when reconstructing a packet");t=this.decodeString(e);const n=t.type===c.BINARY_EVENT;n||t.type===c.BINARY_ACK?(t.type=n?c.EVENT:c.ACK,this.reconstructor=new h(t),0===t.attachments&&super.emitReserved("decoded",t)):super.emitReserved("decoded",t)}else{if(!Object(s.isBinary)(e)&&!e.base64)throw new Error("Unknown type: "+e);if(!this.reconstructor)throw new Error("got binary data when not reconstructing a packet");t=this.reconstructor.takeBinaryData(e),t&&(this.reconstructor=null,super.emitReserved("decoded",t))}}decodeString(e){let t=0;const n={type:Number(e.charAt(0))};if(void 0===c[n.type])throw new Error("unknown packet type "+n.type);if(n.type===c.BINARY_EVENT||n.type===c.BINARY_ACK){const r=t+1;for(;"-"!==e.charAt(++t)&&t!=e.length;);const i=e.substring(r,t);if(i!=Number(i)||"-"!==e.charAt(t))throw new Error("Illegal attachments");n.attachments=Number(i)}if("/"===e.charAt(t+1)){const r=t+1;for(;++t&&","!==e.charAt(t)&&t!==e.length;);n.nsp=e.substring(r,t)}else n.nsp="/";const r=e.charAt(t+1);if(""!==r&&Number(r)==r){const r=t+1;for(;++t;){const n=e.charAt(t);if(null==n||Number(n)!=n){--t;break}if(t===e.length)break}n.id=Number(e.substring(r,t+1))}if(e.charAt(++t)){const r=this.tryParse(e.substr(t));if(!d.isPayloadValid(n.type,r))throw new Error("invalid payload");n.data=r}return n}tryParse(e){try{return JSON.parse(e,this.reviver)}catch(e){return!1}}static isPayloadValid(e,t){switch(e){case c.CONNECT:return u(t);case c.DISCONNECT:return void 0===t;case c.CONNECT_ERROR:return"string"==typeof t||u(t);case c.EVENT:case c.BINARY_EVENT:return Array.isArray(t)&&("number"==typeof t[0]||"string"==typeof t[0]&&-1===o.indexOf(t[0]));case c.ACK:case c.BINARY_ACK:return Array.isArray(t)}}destroy(){this.reconstructor&&(this.reconstructor.finishedReconstruction(),this.reconstructor=null)}}class h{constructor(e){this.packet=e,this.buffers=[],this.reconPack=e}takeBinaryData(e){if(this.buffers.push(e),this.buffers.length===this.reconPack.attachments){const e=Object(i.reconstructPacket)(this.reconPack,this.buffers);return this.finishedReconstruction(),e}return null}finishedReconstruction(){this.reconPack=null,this.buffers=[]}}},"./node_modules/socket.io-parser/build/esm/is-binary.js":function(e,t,n){n.r(t),n.d(t,"isBinary",(function(){return c})),n.d(t,"hasBinary",(function(){return l}));const r="function"==typeof ArrayBuffer,i=e=>"function"==typeof ArrayBuffer.isView?ArrayBuffer.isView(e):e.buffer instanceof ArrayBuffer,s=Object.prototype.toString,o="function"==typeof Blob||"undefined"!=typeof Blob&&"[object BlobConstructor]"===s.call(Blob),a="function"==typeof File||"undefined"!=typeof File&&"[object FileConstructor]"===s.call(File);function c(e){return r&&(e instanceof ArrayBuffer||i(e))||o&&e instanceof Blob||a&&e instanceof File}function l(e,t){if(!e||"object"!=typeof e)return!1;if(Array.isArray(e)){for(let t=0,n=e.length;t<n;t++)if(l(e[t]))return!0;return!1}if(c(e))return!0;if(e.toJSON&&"function"==typeof e.toJSON&&1===arguments.length)return l(e.toJSON(),!0);for(const t in e)if(Object.prototype.hasOwnProperty.call(e,t)&&l(e[t]))return!0;return!1}},"./node_modules/webpack/buildin/global.js":function(e,t){var n;n=function(){return this}();try{n=n||new Function("return this")()}catch(e){"object"==typeof window&&(n=window)}e.exports=n},"./node_modules/worker-loader/dist/workers/InlineWorker.js":function(e,t,n){var r=window.URL||window.webkitURL;e.exports=function(e,t){try{try{var n;try{(n=new(window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder)).append(e),n=n.getBlob()}catch(t){n=new Blob([e])}return new Worker(r.createObjectURL(n))}catch(t){return new Worker("data:application/javascript,"+encodeURIComponent(e))}}catch(e){if(!t)throw Error("Inline worker is not supported");return new Worker(t)}}},"./package.json":function(e){e.exports=JSON.parse('{"name":"imjoy-rpc","version":"0.5.59","description":"Remote procedure calls for ImJoy.","module":"index.js","types":"index.d.ts","scripts":{"build":"rm -rf dist && npm run build-umd","build-umd":"webpack --config webpack.config.js --mode development && NODE_ENV=production webpack --config webpack.config.js --mode production --devtool source-map ","watch":"NODE_ENV=production webpack --watch --progress --config webpack.config.js --mode production --devtool source-map","publish-npm":"npm install && npm run build && npm publish","serve":"webpack-dev-server","stats":"webpack --profile --json > stats.json","stats-prod":"webpack --profile --json --mode production > stats-prod.json","analyze":"webpack-bundle-analyzer -p 9999 stats.json","analyze-prod":"webpack-bundle-analyzer -p 9999 stats-prod.json","clean":"rimraf dist/*","deploy":"npm run build && node deploy-site.js","format":"prettier --write \\"{src,tests}/**/**\\"","check-format":"prettier --check \\"{src,tests}/**/**\\"","test":"karma start --single-run --browsers ChromeHeadless,FirefoxHeadless karma.conf.js","test-watch":"karma start --auto-watch --browsers ChromeDebugging karma.conf.js --debug"},"repository":{"type":"git","url":"git+https://github.com/imjoy-team/imjoy-rpc.git"},"keywords":["imjoy","rpc"],"author":"imjoy-team <imjoy.team@gmail.com>","license":"MIT","bugs":{"url":"https://github.com/imjoy-team/imjoy-rpc/issues"},"homepage":"https://github.com/imjoy-team/imjoy-rpc","dependencies":{"@msgpack/msgpack":"^2.7.1","socket.io-client":"^4.6.2"},"devDependencies":{"@babel/core":"^7.16.12","@babel/plugin-syntax-dynamic-import":"^7.8.3","@babel/polyfill":"^7.12.1","@babel/preset-env":"^7.16.11","@types/requirejs":"^2.1.34","babel-core":"^6.26.0","babel-eslint":"^10.1.0","babel-loader":"^8.2.3","babel-runtime":"^6.26.0","chai":"^4.3.6","clean-webpack-plugin":"^0.1.19","copy-webpack-plugin":"^5.1.2","eslint":"^6.8.0","eslint-config-prettier":"^4.2.0","eslint-loader":"^4.0.2","file-loader":"^0.11.2","fs-extra":"^0.30.0","gh-pages":"^2.0.1","html-loader":"^0.5.5","html-webpack-plugin":"^3.2.0","json-loader":"^0.5.4","karma":"^6.3.12","karma-chrome-launcher":"^3.1.0","karma-firefox-launcher":"^1.3.0","karma-mocha":"^2.0.1","karma-sourcemap-loader":"^0.3.8","karma-spec-reporter":"0.0.32","karma-webpack":"^4.0.2","lerna":"^6.0.3","lodash.debounce":"^4.0.8","mocha":"^10.1.0","postcss":"^7.0.36","prettier":"^1.6.1","rimraf":"^2.6.2","schema-utils":"^0.4.3","style-loader":"^0.18.1","ts-loader":"^9.4.3","url-loader":"^0.5.9","webpack":"^4.46.0","webpack-bundle-analyzer":"^4.7.0","webpack-cli":"^3.3.12","webpack-dev-server":"^3.11.3","webpack-merge":"^4.1.1","workbox-webpack-plugin":"^4.3.1","worker-loader":"^2.0.0","write-file-webpack-plugin":"^4.5.1"},"eslintConfig":{"globals":{"document":true,"window":true}}}')},"./src/main.js":function(e,t,n){n.r(t),n.d(t,"waitForInitialization",(function(){return u})),n.d(t,"setupRPC",(function(){return d}));var r=n("./src/plugin.webworker.js"),i=n.n(r),s=n("./src/pluginIframe.js"),o=n("./src/utils.js");n.d(t,"loadRequirements",(function(){return o.loadRequirements}));var a=n("./src/rpc.js");n.d(t,"RPC",(function(){return a.RPC})),n.d(t,"API_VERSION",(function(){return a.API_VERSION}));var c=n("./package.json");function l(){return"undefined"!=typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope}function u(e){l()&&(globalThis.parent=self),(e=e||{}).enable_service_worker&&(Object(o.setupServiceWorker)(e.base_url,e.target_origin,e.cache_requirements),e.enable_service_worker=!1),e.cache_requirements&&delete e.cache_requirements;const t=e.target_origin||"*";if(e.credential_required&&"function"!=typeof e.verify_credential)throw new Error("Please also provide the `verify_credential` function with `credential_required`.");if(e.credential_required&&"*"===t)throw new Error("`target_origin` was set to `*` with `credential_required=true`, there is a security risk that you may leak the credential to website from other origin. Please specify the `target_origin` explicitly.");const n=Object(o.randId)(),r=i=>{if("message"===i.type&&(!i.origin||"*"===t||i.origin===t)){if("initialize"!==i.data.type)throw new Error(`unrecognized message: ${i.data}`);{globalThis.removeEventListener("message",r),i.data.peer_id!==n&&console.warn(`${i.data.config&&i.data.config.name}: connection peer id mismatch ${i.data.peer_id} !== ${n}`);const s=i.data.config;"*"!==t&&(s.target_origin=t),e.credential_required?e.verify_credential(s.credential).then((e=>{if(!e||!e.auth||e.error)throw new Error("Failed to verify the credentail:"+(e&&e.error));s.auth=e.auth,d(s).then((()=>{console.log("ImJoy RPC loaded successfully!")}))})):d(s).then((()=>{console.log("ImJoy RPC loaded successfully!")}))}}};globalThis.addEventListener("message",r),l()?parent.postMessage({type:"imjoyRPCReady",config:e,peer_id:n}):parent.postMessage({type:"imjoyRPCReady",config:e,peer_id:n},"*")}function d(e){return(e=e||{}).name=e.name||Object(o.randId)(),(e=Object(o.normalizeConfig)(e)).enable_service_worker&&Object(o.setupServiceWorker)(e.base_url,e.target_origin,e.cache_requirements),e.cache_requirements&&delete e.cache_requirements,new Promise(((t,n)=>{const r=n=>{const i=n.detail;e.expose_api_globally&&(globalThis.api=i),t(i),globalThis.removeEventListener("imjoy_remote_api_ready",r)};if(function(){try{return window.self!==window.top}catch(e){return!0}}()){if("web-worker"===e.type)try{!function(e){if(!e.allow_execution)throw new Error("web-worker plugin can only work with allow_execution=true");let t=null;e.broadcastChannel&&(t=new BroadcastChannel(e.broadcastChannel));const n=new i.a,r=setTimeout((function(){n.terminate(),console.warn("Plugin failed to start as a web-worker, running in an iframe instead."),Object(s.default)(e)}),2e3),a=Object(o.randId)();n.addEventListener("message",(function(i){let s;const o=i.data;if("worker-ready"===o.type)return n.postMessage({type:"connectRPC",config:e}),void clearTimeout(r);"initialized"===o.type?(o.config=Object.assign({},e,o.config),o.origin=globalThis.location.origin,o.peer_id=a):"imjoy_remote_api_ready"===o.type?globalThis.dispatchEvent(new CustomEvent("imjoy_remote_api_ready",{detail:null})):"cacheRequirements"===o.type&&"function"==typeof cache_requirements?cache_requirements(o.requirements):"disconnect"===o.type?n.terminate():o.__transferables__&&(s=o.__transferables__,delete o.__transferables__),t?t.postMessage(o):parent.postMessage(o,e.target_origin||"*",s)})),(t||window).addEventListener("message",(function(r){if("message"===r.type&&(t||"*"===e.target_origin||r.origin===e.target_origin)){let t;const i=r.data;i.__transferables__&&(t=i.__transferables__,delete i.__transferables__),i.peer_id===a?n.postMessage(i,t):e.debug&&console.log(`connection peer id mismatch ${i.peer_id} !== ${a}`)}}))}(e)}catch(t){Object(s.default)(e)}else{if(!["rpc-window","rpc-worker","iframe","window"].includes(e.type))return console.error("Unsupported plugin type: "+e.type),void n("Unsupported plugin type: "+e.type);Object(s.default)(e)}globalThis.addEventListener("imjoy_remote_api_ready",r)}else l()?Object(s.default)(e):n(new Error("imjoy-rpc should only run inside an iframe or a webworker."))}))}n.d(t,"VERSION",(function(){return c.version}))},"./src/plugin.webworker.js":function(e,t,n){e.exports=function(){return n("./node_modules/worker-loader/dist/workers/InlineWorker.js")('/******/ (function(modules) { // webpackBootstrap\n/******/ \t// The module cache\n/******/ \tvar installedModules = {};\n/******/\n/******/ \t// The require function\n/******/ \tfunction __webpack_require__(moduleId) {\n/******/\n/******/ \t\t// Check if module is in cache\n/******/ \t\tif(installedModules[moduleId]) {\n/******/ \t\t\treturn installedModules[moduleId].exports;\n/******/ \t\t}\n/******/ \t\t// Create a new module (and put it into the cache)\n/******/ \t\tvar module = installedModules[moduleId] = {\n/******/ \t\t\ti: moduleId,\n/******/ \t\t\tl: false,\n/******/ \t\t\texports: {}\n/******/ \t\t};\n/******/\n/******/ \t\t// Execute the module function\n/******/ \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n/******/\n/******/ \t\t// Flag the module as loaded\n/******/ \t\tmodule.l = true;\n/******/\n/******/ \t\t// Return the exports of the module\n/******/ \t\treturn module.exports;\n/******/ \t}\n/******/\n/******/\n/******/ \t// expose the modules object (__webpack_modules__)\n/******/ \t__webpack_require__.m = modules;\n/******/\n/******/ \t// expose the module cache\n/******/ \t__webpack_require__.c = installedModules;\n/******/\n/******/ \t// define getter function for harmony exports\n/******/ \t__webpack_require__.d = function(exports, name, getter) {\n/******/ \t\tif(!__webpack_require__.o(exports, name)) {\n/******/ \t\t\tObject.defineProperty(exports, name, { enumerable: true, get: getter });\n/******/ \t\t}\n/******/ \t};\n/******/\n/******/ \t// define __esModule on exports\n/******/ \t__webpack_require__.r = function(exports) {\n/******/ \t\tif(typeof Symbol !== \'undefined\' && Symbol.toStringTag) {\n/******/ \t\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: \'Module\' });\n/******/ \t\t}\n/******/ \t\tObject.defineProperty(exports, \'__esModule\', { value: true });\n/******/ \t};\n/******/\n/******/ \t// create a fake namespace object\n/******/ \t// mode & 1: value is a module id, require it\n/******/ \t// mode & 2: merge all properties of value into the ns\n/******/ \t// mode & 4: return value when already ns object\n/******/ \t// mode & 8|1: behave like require\n/******/ \t__webpack_require__.t = function(value, mode) {\n/******/ \t\tif(mode & 1) value = __webpack_require__(value);\n/******/ \t\tif(mode & 8) return value;\n/******/ \t\tif((mode & 4) && typeof value === \'object\' && value && value.__esModule) return value;\n/******/ \t\tvar ns = Object.create(null);\n/******/ \t\t__webpack_require__.r(ns);\n/******/ \t\tObject.defineProperty(ns, \'default\', { enumerable: true, value: value });\n/******/ \t\tif(mode & 2 && typeof value != \'string\') for(var key in value) __webpack_require__.d(ns, key, function(key) { return value[key]; }.bind(null, key));\n/******/ \t\treturn ns;\n/******/ \t};\n/******/\n/******/ \t// getDefaultExport function for compatibility with non-harmony modules\n/******/ \t__webpack_require__.n = function(module) {\n/******/ \t\tvar getter = module && module.__esModule ?\n/******/ \t\t\tfunction getDefault() { return module[\'default\']; } :\n/******/ \t\t\tfunction getModuleExports() { return module; };\n/******/ \t\t__webpack_require__.d(getter, \'a\', getter);\n/******/ \t\treturn getter;\n/******/ \t};\n/******/\n/******/ \t// Object.prototype.hasOwnProperty.call\n/******/ \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n/******/\n/******/ \t// __webpack_public_path__\n/******/ \t__webpack_require__.p = "";\n/******/\n/******/\n/******/ \t// Load entry module and return exports\n/******/ \treturn __webpack_require__(__webpack_require__.s = "./src/plugin.webworker.js");\n/******/ })\n/************************************************************************/\n/******/ ({\n\n/***/ "./src/plugin.webworker.js":\n/*!*********************************!*\\\n  !*** ./src/plugin.webworker.js ***!\n  \\*********************************/\n/*! no exports provided */\n/***/ (function(module, __webpack_exports__, __webpack_require__) {\n\n"use strict";\n__webpack_require__.r(__webpack_exports__);\n/* harmony import */ var _pluginCore_js__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./pluginCore.js */ "./src/pluginCore.js");\n/* harmony import */ var _rpc_js__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./rpc.js */ "./src/rpc.js");\n/* harmony import */ var _utils_js__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ./utils.js */ "./src/utils.js");\n/**\n * Contains the routines loaded by the plugin Worker under web-browser.\n *\n * Initializes the web environment version of the platform-dependent\n * connection object for the plugin site\n */\n\n\n\n\n// make sure this runs inside a webworker\nif (\n  typeof WorkerGlobalScope === "undefined" ||\n  !self ||\n  !(self instanceof WorkerGlobalScope)\n) {\n  throw new Error("This script can only loaded in a webworker");\n}\n\nasync function executeEsModule(content) {\n  const dataUri =\n    "data:text/javascript;charset=utf-8," + encodeURIComponent(content);\n  await import(/* webpackIgnore: true */ dataUri);\n}\n\n/**\n * Connection object provided to the RPC constructor,\n * plugin site implementation for the web-based environment.\n * Global will be then cleared to prevent exposure into the\n * Worker, so we put this local connection object into a closure\n */\nclass Connection extends _utils_js__WEBPACK_IMPORTED_MODULE_2__["MessageEmitter"] {\n  constructor(config) {\n    super(config && config.debug);\n    this.config = config || {};\n  }\n  connect() {\n    self.addEventListener("message", e => {\n      this._fire(e.data.type, e.data);\n    });\n    this.emit({\n      type: "initialized",\n      config: this.config\n    });\n  }\n  disconnect() {\n    this._fire("beforeDisconnect");\n    self.close();\n    this._fire("disconnected");\n  }\n  emit(data) {\n    let transferables = undefined;\n    if (data.__transferables__) {\n      transferables = data.__transferables__;\n      delete data.__transferables__;\n    }\n    self.postMessage(data, transferables);\n  }\n  async execute(code) {\n    if (code.type === "requirements") {\n      await Object(_utils_js__WEBPACK_IMPORTED_MODULE_2__["loadRequirementsInWebworker"])(code.requirements);\n    } else if (code.type === "script") {\n      try {\n        if (code.attrs.type === "module") {\n          await executeEsModule(code.content);\n        } else {\n          eval(code.content);\n        }\n      } catch (e) {\n        console.error(e.message, e.stack);\n        throw e;\n      }\n    } else {\n      throw "unsupported code type.";\n    }\n    if (code.type === "requirements") {\n      self.postMessage({\n        type: "cacheRequirements",\n        requirements: code.requirements\n      });\n    }\n  }\n}\nconst config = {\n  type: "web-worker",\n  dedicated_thread: true,\n  allow_execution: true,\n  lang: "javascript",\n  api_version: _rpc_js__WEBPACK_IMPORTED_MODULE_1__["API_VERSION"]\n};\nconst conn = new Connection(config);\nconn.on("connectRPC", data => {\n  Object(_pluginCore_js__WEBPACK_IMPORTED_MODULE_0__["connectRPC"])(conn, Object.assign(data.config, config));\n});\nconn.connect();\nself.postMessage({\n  type: "worker-ready"\n});\n\n\n/***/ }),\n\n/***/ "./src/pluginCore.js":\n/*!***************************!*\\\n  !*** ./src/pluginCore.js ***!\n  \\***************************/\n/*! exports provided: connectRPC */\n/***/ (function(module, __webpack_exports__, __webpack_require__) {\n\n"use strict";\n__webpack_require__.r(__webpack_exports__);\n/* harmony export (binding) */ __webpack_require__.d(__webpack_exports__, "connectRPC", function() { return connectRPC; });\n/* harmony import */ var _rpc_js__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./rpc.js */ "./src/rpc.js");\n/**\n * Core plugin script loaded into the plugin process/thread.\n *\n * Initializes the plugin-site API global methods.\n */\n\nfunction connectRPC(connection, config) {\n  config = config || {};\n  const codecs = {};\n  const rpc = new _rpc_js__WEBPACK_IMPORTED_MODULE_0__["RPC"](connection, config, codecs);\n  rpc.on("getInterface", function () {\n    launchConnected();\n  });\n  rpc.on("remoteReady", function () {\n    const api = rpc.getRemote() || {};\n\n    api.registerCodec = function (config) {\n      if (!config["name"] || !config["encoder"] && !config["decoder"]) {\n        throw new Error("Invalid codec format, please make sure you provide a name, type, encoder and decoder.");\n      } else {\n        if (config.type) {\n          for (let k of Object.keys(codecs)) {\n            if (codecs[k].type === config.type || k === config.name) {\n              delete codecs[k];\n              console.warn("Remove duplicated codec: " + k);\n            }\n          }\n        }\n\n        codecs[config["name"]] = config;\n      }\n    };\n\n    api.init = function (config) {\n      // register a minimal plugin api\n      rpc.setInterface({\n        setup() {}\n\n      }, config);\n    };\n\n    api.disposeObject = function (obj) {\n      rpc.disposeObject(obj);\n    };\n\n    api.export = function (_interface, config) {\n      rpc.setInterface(_interface, config);\n    };\n\n    api.onLoad = function (handler) {\n      handler = checkHandler(handler);\n\n      if (connected) {\n        handler();\n      } else {\n        connectedHandlers.push(handler);\n      }\n    };\n\n    api.dispose = function (_interface) {\n      rpc.disconnect();\n    };\n\n    api._rpc = rpc;\n\n    if (typeof WorkerGlobalScope !== "undefined" && self instanceof WorkerGlobalScope) {\n      self.api = api;\n      self.postMessage({\n        type: "imjoy_remote_api_ready"\n      });\n      self.dispatchEvent(new CustomEvent("imjoy_remote_api_ready", {\n        detail: api\n      }));\n    } else if (typeof window) {\n      window.dispatchEvent(new CustomEvent("imjoy_remote_api_ready", {\n        detail: api\n      }));\n    }\n  });\n  let connected = false;\n  const connectedHandlers = [];\n\n  const launchConnected = function () {\n    if (!connected) {\n      connected = true;\n      let handler;\n\n      while (handler = connectedHandlers.pop()) {\n        handler();\n      }\n    }\n  };\n\n  const checkHandler = function (handler) {\n    const type = typeof handler;\n\n    if (type !== "function") {\n      const msg = "A function may only be subsribed to the event, " + type + " was provided instead";\n      throw new Error(msg);\n    }\n\n    return handler;\n  };\n\n  return rpc;\n}\n\n/***/ }),\n\n/***/ "./src/rpc.js":\n/*!********************!*\\\n  !*** ./src/rpc.js ***!\n  \\********************/\n/*! exports provided: API_VERSION, RPC */\n/***/ (function(module, __webpack_exports__, __webpack_require__) {\n\n"use strict";\n__webpack_require__.r(__webpack_exports__);\n/* harmony export (binding) */ __webpack_require__.d(__webpack_exports__, "API_VERSION", function() { return API_VERSION; });\n/* harmony export (binding) */ __webpack_require__.d(__webpack_exports__, "RPC", function() { return RPC; });\n/* harmony import */ var _utils_js__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./utils.js */ "./src/utils.js");\n/**\n * Contains the RPC object used both by the application\n * site, and by each plugin\n */\n\nconst API_VERSION = "0.2.3";\nconst ArrayBufferView = Object.getPrototypeOf(Object.getPrototypeOf(new Uint8Array())).constructor;\n\nfunction _appendBuffer(buffer1, buffer2) {\n  const tmp = new Uint8Array(buffer1.byteLength + buffer2.byteLength);\n  tmp.set(new Uint8Array(buffer1), 0);\n  tmp.set(new Uint8Array(buffer2), buffer1.byteLength);\n  return tmp.buffer;\n}\n\nfunction indexObject(obj, is) {\n  if (!is) throw new Error("undefined index");\n  if (typeof is === "string") return indexObject(obj, is.split("."));else if (is.length === 0) return obj;else return indexObject(obj[is[0]], is.slice(1));\n}\n/**\n * RPC object represents a single site in the\n * communication protocol between the application and the plugin\n *\n * @param {Object} connection a special object allowing to send\n * and receive messages from the opposite site (basically it\n * should only provide send() and onMessage() methods)\n */\n\n\nclass RPC extends _utils_js__WEBPACK_IMPORTED_MODULE_0__["MessageEmitter"] {\n  constructor(connection, config, codecs) {\n    super(config && config.debug);\n    this._connection = connection;\n    this.config = config || {};\n    this._codecs = codecs || {};\n    this._object_store = {};\n    this._method_weakmap = new WeakMap();\n    this._object_weakmap = new WeakMap();\n    this._local_api = null;\n    this._remote_set = false; // make sure there is an execute function\n\n    const name = this.config.name;\n\n    this._connection.execute = this._connection.execute || function () {\n      throw new Error(`connection.execute not implemented (in "${name}")`);\n    };\n\n    this._store = new ReferenceStore();\n    this._method_refs = new ReferenceStore();\n\n    this._method_refs.onReady(() => {\n      this._fire("remoteIdle");\n    });\n\n    this._method_refs.onBusy(() => {\n      this._fire("remoteBusy");\n    });\n\n    this._setupMessageHanlders();\n  }\n\n  init() {\n    this._connection.emit({\n      type: "initialized",\n      config: this.config,\n      peer_id: this._connection.peer_id\n    });\n  }\n\n  setConfig(config) {\n    if (config) for (const k of Object.keys(config)) {\n      this.config[k] = config[k];\n    }\n  }\n  /**\n   * Set a handler to be called when received a responce from the\n   * remote site reporting that the previously provided interface\n   * has been successfully set as remote for that site\n   *\n   * @param {Function} handler\n   */\n\n\n  getRemoteCallStack() {\n    return this._method_refs.getStack();\n  }\n  /**\n   * @returns {Object} set of remote interface methods\n   */\n\n\n  getRemote() {\n    return this._remote_interface;\n  }\n  /**\n   * Sets the interface of this site making it available to the\n   * remote site by sending a message with a set of methods names\n   *\n   * @param {Object} _interface to set\n   */\n\n\n  setInterface(_interface, config) {\n    config = config || {};\n    this.config.name = config.name || this.config.name;\n    this.config.description = config.description || this.config.description;\n\n    if (this.config.forwarding_functions) {\n      for (let func_name of this.config.forwarding_functions) {\n        const _remote = this._remote_interface;\n\n        if (_remote[func_name]) {\n          if (_interface.constructor === Object) {\n            if (!_interface[func_name]) {\n              _interface[func_name] = (...args) => {\n                _remote[func_name](...args);\n              };\n            }\n          } else if (_interface.constructor.constructor === Function) {\n            if (!_interface.constructor.prototype[func_name]) {\n              _interface.constructor.prototype[func_name] = (...args) => {\n                _remote[func_name](...args);\n              };\n            }\n          }\n        }\n      }\n    }\n\n    this._local_api = _interface;\n    if (!this._remote_set) this._fire("interfaceAvailable");else this.sendInterface();\n    return new Promise(resolve => {\n      this.once("interfaceSetAsRemote", resolve);\n    });\n  }\n  /**\n   * Sends the actual interface to the remote site upon it was\n   * updated or by a special request of the remote site\n   */\n\n\n  sendInterface() {\n    if (!this._local_api) {\n      throw new Error("interface is not set.");\n    }\n\n    this._encode(this._local_api, true).then(api => {\n      this._connection.emit({\n        type: "setInterface",\n        api: api\n      });\n    });\n  }\n\n  _disposeObject(objectId) {\n    if (this._object_store[objectId]) {\n      delete this._object_store[objectId];\n    } else {\n      throw new Error(`Object (id=${objectId}) not found.`);\n    }\n  }\n\n  disposeObject(obj) {\n    return new Promise((resolve, reject) => {\n      if (this._object_weakmap.has(obj)) {\n        const objectId = this._object_weakmap.get(obj);\n\n        this._connection.once("disposed", data => {\n          if (data.error) reject(new Error(data.error));else resolve();\n        });\n\n        this._connection.emit({\n          type: "disposeObject",\n          object_id: objectId\n        });\n      } else {\n        throw new Error("Invalid object");\n      }\n    });\n  }\n  /**\n   * Handles a message from the remote site\n   */\n\n\n  _setupMessageHanlders() {\n    this._connection.on("init", this.init);\n\n    this._connection.on("execute", data => {\n      Promise.resolve(this._connection.execute(data.code)).then(() => {\n        this._connection.emit({\n          type: "executed"\n        });\n      }).catch(e => {\n        console.error(e);\n\n        this._connection.emit({\n          type: "executed",\n          error: String(e)\n        });\n      });\n    });\n\n    this._connection.on("method", async data => {\n      let resolve, reject, method, method_this, args, result;\n\n      try {\n        if (data.promise) {\n          [resolve, reject] = await this._unwrap(data.promise, false);\n        }\n\n        const _interface = this._object_store[data.object_id];\n        method = indexObject(_interface, data.name);\n\n        if (data.name.includes(".")) {\n          const tmp = data.name.split(".");\n          const intf_index = tmp.slice(0, tmp.length - 1).join(".");\n          method_this = indexObject(_interface, intf_index);\n        } else {\n          method_this = _interface;\n        }\n\n        args = await this._unwrap(data.args, true);\n\n        if (data.promise) {\n          result = method.apply(method_this, args);\n\n          if (result instanceof Promise || method.constructor && method.constructor.name === "AsyncFunction") {\n            result.then(resolve).catch(reject);\n          } else {\n            resolve(result);\n          }\n        } else {\n          method.apply(method_this, args);\n        }\n      } catch (err) {\n        console.error(this.config.name, err);\n\n        if (reject) {\n          reject(err);\n        }\n      }\n    });\n\n    this._connection.on("callback", async data => {\n      let resolve, reject, method, args, result;\n\n      try {\n        if (data.promise) {\n          [resolve, reject] = await this._unwrap(data.promise, false);\n        }\n\n        if (data.promise) {\n          method = this._store.fetch(data.id);\n          args = await this._unwrap(data.args, true);\n\n          if (!method) {\n            throw new Error("Callback function can only called once, if you want to call a function for multiple times, please make it as a plugin api function. See https://imjoy.io/docs for more details.");\n          }\n\n          result = method.apply(null, args);\n\n          if (result instanceof Promise || method.constructor && method.constructor.name === "AsyncFunction") {\n            result.then(resolve).catch(reject);\n          } else {\n            resolve(result);\n          }\n        } else {\n          method = this._store.fetch(data.id);\n          args = await this._unwrap(data.args, true);\n\n          if (!method) {\n            throw new Error("Please notice that callback function can only called once, if you want to call a function for multiple times, please make it as a plugin api function. See https://imjoy.io/docs for more details.");\n          }\n\n          method.apply(null, args);\n        }\n      } catch (err) {\n        console.error(this.config.name, err);\n\n        if (reject) {\n          reject(err);\n        }\n      }\n    });\n\n    this._connection.on("disposeObject", data => {\n      try {\n        this._disposeObject(data.object_id);\n\n        this._connection.emit({\n          type: "disposed"\n        });\n      } catch (e) {\n        console.error(e);\n\n        this._connection.emit({\n          type: "disposed",\n          error: String(e)\n        });\n      }\n    });\n\n    this._connection.on("setInterface", data => {\n      this._setRemoteInterface(data.api);\n    });\n\n    this._connection.on("getInterface", () => {\n      this._fire("getInterface");\n\n      if (this._local_api) {\n        this.sendInterface();\n      } else {\n        this.once("interfaceAvailable", () => {\n          this.sendInterface();\n        });\n      }\n    });\n\n    this._connection.on("interfaceSetAsRemote", () => {\n      this._remote_set = true;\n\n      this._fire("interfaceSetAsRemote");\n    });\n\n    this._connection.on("disconnect", () => {\n      this._fire("beforeDisconnect");\n\n      this._connection.disconnect();\n\n      this._fire("disconnected");\n    });\n  }\n  /**\n   * Sends a requests to the remote site asking it to provide its\n   * current interface\n   */\n\n\n  requestRemote() {\n    this._connection.emit({\n      type: "getInterface"\n    });\n  }\n\n  _ndarray(typedArray, shape, dtype) {\n    const _dtype = Object(_utils_js__WEBPACK_IMPORTED_MODULE_0__["typedArrayToDtype"])(typedArray);\n\n    if (dtype && dtype !== _dtype) {\n      throw "dtype doesn\'t match the type of the array: " + _dtype + " != " + dtype;\n    }\n\n    shape = shape || [typedArray.length];\n    return {\n      _rtype: "ndarray",\n      _rvalue: typedArray.buffer,\n      _rshape: shape,\n      _rdtype: _dtype\n    };\n  }\n  /**\n   * Sets the new remote interface provided by the other site\n   *\n   * @param {Array} names list of function names\n   */\n\n\n  _setRemoteInterface(api) {\n    this._decode(api).then(intf => {\n      // update existing interface instead of recreating it\n      // this will preserve the object reference\n      if (this._remote_interface) {\n        // clear the interface\n        for (let k in this._remote_interface) delete this._remote_interface[k]; // then assign the new interfaces\n\n\n        Object.assign(this._remote_interface, intf);\n      } else this._remote_interface = intf;\n\n      this._fire("remoteReady");\n\n      this._reportRemoteSet();\n    });\n  }\n  /**\n   * Generates the wrapped function corresponding to a single remote\n   * method. When the generated function is called, it will send the\n   * corresponding message to the remote site asking it to execute\n   * the particular method of its interface\n   *\n   * @param {String} name of the remote method\n   *\n   * @returns {Function} wrapped remote method\n   */\n\n\n  _genRemoteMethod(targetId, name, objectId) {\n    const me = this;\n\n    const remoteMethod = function () {\n      return new Promise(async (resolve, reject) => {\n        let id = null;\n\n        try {\n          id = me._method_refs.put(objectId ? objectId + "/" + name : name);\n\n          const wrapped_resolve = function () {\n            if (id !== null) me._method_refs.fetch(id);\n            return resolve.apply(this, arguments);\n          };\n\n          const wrapped_reject = function () {\n            if (id !== null) me._method_refs.fetch(id);\n            return reject.apply(this, arguments);\n          };\n\n          const encodedPromise = await me._wrap([wrapped_resolve, wrapped_reject]); // store the key id for removing them from the reference store together\n\n          wrapped_resolve.__promise_pair = encodedPromise[1]._rvalue;\n          wrapped_reject.__promise_pair = encodedPromise[0]._rvalue;\n          let args = Array.prototype.slice.call(arguments);\n          const argLength = args.length; // if the last argument is an object, mark it as kwargs\n\n          const withKwargs = argLength > 0 && typeof args[argLength - 1] === "object" && args[argLength - 1] !== null && args[argLength - 1]._rkwargs;\n          if (withKwargs) delete args[argLength - 1]._rkwargs;\n\n          if (name === "register" || name === "registerService" || name === "register_service" || name === "export" || name === "on") {\n            args = await me._wrap(args, true);\n          } else {\n            args = await me._wrap(args);\n          }\n\n          const transferables = args.__transferables__;\n          if (transferables) delete args.__transferables__;\n\n          me._connection.emit({\n            type: "method",\n            target_id: targetId,\n            name: name,\n            object_id: objectId,\n            args: args,\n            promise: encodedPromise,\n            with_kwargs: withKwargs\n          }, transferables);\n        } catch (e) {\n          if (id) me._method_refs.fetch(id);\n          reject(`Failed to exectue remote method (interface: ${objectId || me.id}, method: ${name}), error: ${e}`);\n        }\n      });\n    };\n\n    remoteMethod.__remote_method = true;\n    return remoteMethod;\n  }\n  /**\n   * Sends a responce reporting that interface just provided by the\n   * remote site was successfully set by this site as remote\n   */\n\n\n  _reportRemoteSet() {\n    this._connection.emit({\n      type: "interfaceSetAsRemote"\n    });\n  }\n  /**\n   * Prepares the provided set of remote method arguments for\n   * sending to the remote site, replaces all the callbacks with\n   * identifiers\n   *\n   * @param {Array} args to wrap\n   *\n   * @returns {Array} wrapped arguments\n   */\n\n\n  async _encode(aObject, asInterface, objectId) {\n    const aType = typeof aObject;\n\n    if (aType === "number" || aType === "string" || aType === "boolean" || aObject === null || aObject === undefined || aObject instanceof ArrayBuffer) {\n      return aObject;\n    }\n\n    let bObject;\n\n    if (typeof aObject === "function") {\n      if (asInterface) {\n        if (!objectId) throw new Error("objectId is not specified.");\n        bObject = {\n          _rtype: "interface",\n          _rtarget_id: this._connection.peer_id,\n          _rintf: objectId,\n          _rvalue: asInterface\n        };\n\n        this._method_weakmap.set(aObject, bObject);\n      } else if (this._method_weakmap.has(aObject)) {\n        bObject = this._method_weakmap.get(aObject);\n      } else {\n        const cid = this._store.put(aObject);\n\n        bObject = {\n          _rtype: "callback",\n          _rtarget_id: this._connection.peer_id,\n          _rname: aObject.constructor && aObject.constructor.name || cid,\n          _rvalue: cid\n        };\n      }\n\n      return bObject;\n    } // skip if already encoded\n\n\n    if (aObject.constructor instanceof Object && aObject._rtype) {\n      // make sure the interface functions are encoded\n      if (aObject._rintf) {\n        const temp = aObject._rtype;\n        delete aObject._rtype;\n        bObject = await this._encode(aObject, asInterface, objectId);\n        bObject._rtype = temp;\n      } else {\n        bObject = aObject;\n      }\n\n      return bObject;\n    }\n\n    const transferables = [];\n    const _transfer = aObject._transfer;\n    const isarray = Array.isArray(aObject);\n\n    for (let tp of Object.keys(this._codecs)) {\n      const codec = this._codecs[tp];\n\n      if (codec.encoder && aObject instanceof codec.type) {\n        // TODO: what if multiple encoders found\n        let encodedObj = await Promise.resolve(codec.encoder(aObject));\n        if (encodedObj && !encodedObj._rtype) encodedObj._rtype = codec.name; // encode the functions in the interface object\n\n        if (encodedObj && encodedObj._rintf) {\n          const temp = encodedObj._rtype;\n          delete encodedObj._rtype;\n          encodedObj = await this._encode(encodedObj, asInterface, objectId);\n          encodedObj._rtype = temp;\n        }\n\n        bObject = encodedObj;\n        return bObject;\n      }\n    }\n\n    if (\n    /*global tf*/\n    typeof tf !== "undefined" && tf.Tensor && aObject instanceof tf.Tensor) {\n      const v_buffer = aObject.dataSync();\n\n      if (aObject._transfer || _transfer) {\n        transferables.push(v_buffer.buffer);\n        delete aObject._transfer;\n      }\n\n      bObject = {\n        _rtype: "ndarray",\n        _rvalue: v_buffer.buffer,\n        _rshape: aObject.shape,\n        _rdtype: aObject.dtype\n      };\n    } else if (\n    /*global nj*/\n    typeof nj !== "undefined" && nj.NdArray && aObject instanceof nj.NdArray) {\n      const dtype = Object(_utils_js__WEBPACK_IMPORTED_MODULE_0__["typedArrayToDtype"])(aObject.selection.data);\n\n      if (aObject._transfer || _transfer) {\n        transferables.push(aObject.selection.data.buffer);\n        delete aObject._transfer;\n      }\n\n      bObject = {\n        _rtype: "ndarray",\n        _rvalue: aObject.selection.data.buffer,\n        _rshape: aObject.shape,\n        _rdtype: dtype\n      };\n    } else if (aObject instanceof Error) {\n      console.error(aObject);\n      bObject = {\n        _rtype: "error",\n        _rvalue: aObject.toString()\n      };\n    } else if (typeof File !== "undefined" && aObject instanceof File) {\n      bObject = {\n        _rtype: "file",\n        _rvalue: aObject,\n        _rpath: aObject._path || aObject.webkitRelativePath\n      };\n    } // send objects supported by structure clone algorithm\n    // https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API/Structured_clone_algorithm\n    else if (aObject !== Object(aObject) || aObject instanceof Boolean || aObject instanceof String || aObject instanceof Date || aObject instanceof RegExp || aObject instanceof ImageData || typeof FileList !== "undefined" && aObject instanceof FileList || typeof FileSystemDirectoryHandle !== "undefined" && aObject instanceof FileSystemDirectoryHandle || typeof FileSystemFileHandle !== "undefined" && aObject instanceof FileSystemFileHandle || typeof FileSystemHandle !== "undefined" && aObject instanceof FileSystemHandle || typeof FileSystemWritableFileStream !== "undefined" && aObject instanceof FileSystemWritableFileStream) {\n      bObject = aObject; // TODO: avoid object such as DynamicPlugin instance.\n    } else if (typeof File !== "undefined" && aObject instanceof File) {\n      bObject = {\n        _rtype: "file",\n        _rname: aObject.name,\n        _rmime: aObject.type,\n        _rvalue: aObject,\n        _rpath: aObject._path || aObject.webkitRelativePath\n      };\n    } else if (aObject instanceof Blob) {\n      bObject = {\n        _rtype: "blob",\n        _rvalue: aObject\n      };\n    } else if (aObject instanceof ArrayBufferView) {\n      if (aObject._transfer || _transfer) {\n        transferables.push(aObject.buffer);\n        delete aObject._transfer;\n      }\n\n      const dtype = Object(_utils_js__WEBPACK_IMPORTED_MODULE_0__["typedArrayToDtype"])(aObject);\n      bObject = {\n        _rtype: "typedarray",\n        _rvalue: aObject.buffer,\n        _rdtype: dtype\n      };\n    } else if (aObject instanceof DataView) {\n      if (aObject._transfer || _transfer) {\n        transferables.push(aObject.buffer);\n        delete aObject._transfer;\n      }\n\n      bObject = {\n        _rtype: "memoryview",\n        _rvalue: aObject.buffer\n      };\n    } else if (aObject instanceof Set) {\n      bObject = {\n        _rtype: "set",\n        _rvalue: await this._encode(Array.from(aObject), asInterface)\n      };\n    } else if (aObject instanceof Map) {\n      bObject = {\n        _rtype: "orderedmap",\n        _rvalue: await this._encode(Array.from(aObject), asInterface)\n      };\n    } else if (aObject.constructor instanceof Object || Array.isArray(aObject)) {\n      bObject = isarray ? [] : {};\n      let keys; // an object/array\n\n      if (aObject.constructor === Object || Array.isArray(aObject)) {\n        keys = Object.keys(aObject);\n      } // a class\n      else if (aObject.constructor === Function) {\n        throw new Error("Please instantiate the class before exportting it.");\n      } // instance of a class\n      else if (aObject.constructor.constructor === Function) {\n        keys = Object.getOwnPropertyNames(Object.getPrototypeOf(aObject)).concat(Object.keys(aObject)); // TODO: use a proxy object to represent the actual object\n        // always encode class instance as interface\n\n        asInterface = true;\n      } else {\n        throw Error("Unsupported interface type");\n      }\n\n      let hasFunction = false; // encode interfaces\n\n      if (aObject._rintf || asInterface) {\n        if (!objectId) {\n          if (typeof aObject._rintf === "string" && aObject._rintf.length > 0) {\n            objectId = aObject._rintf; // enable custom object id\n          } else {\n            objectId = Object(_utils_js__WEBPACK_IMPORTED_MODULE_0__["randId"])();\n          } // Note: object with the same id will be overwritten\n\n\n          if (this._object_store[objectId]) console.warn(`Overwritting interface object with the same id: ${objectId}`);\n          this._object_store[objectId] = aObject;\n        }\n\n        for (let k of keys) {\n          if (k === "constructor") continue;\n\n          if (k.startsWith("_")) {\n            continue;\n          }\n\n          bObject[k] = await this._encode(aObject[k], typeof asInterface === "string" ? asInterface + "." + k : k, objectId);\n\n          if (typeof aObject[k] === "function") {\n            hasFunction = true;\n          }\n        } // object id for dispose the object remotely\n\n\n        if (hasFunction) bObject._rintf = objectId; // remove interface when closed\n\n        if (aObject.on && typeof aObject.on === "function") {\n          aObject.on("close", () => {\n            delete this._object_store[objectId];\n          });\n        }\n      } else {\n        for (let k of keys) {\n          if (["hasOwnProperty", "constructor"].includes(k)) continue;\n          bObject[k] = await this._encode(aObject[k]);\n        }\n      } // for example, browserFS object\n\n    } else if (typeof aObject === "object") {\n      const keys = Object.getOwnPropertyNames(Object.getPrototypeOf(aObject)).concat(Object.keys(aObject));\n      const objectId = Object(_utils_js__WEBPACK_IMPORTED_MODULE_0__["randId"])();\n\n      for (let k of keys) {\n        if (["hasOwnProperty", "constructor"].includes(k)) continue; // encode as interface\n\n        bObject[k] = await this._encode(aObject[k], k, bObject);\n      } // object id, used for dispose the object\n\n\n      bObject._rintf = objectId;\n    } else {\n      throw "imjoy-rpc: Unsupported data type:" + aObject;\n    }\n\n    if (transferables.length > 0) {\n      bObject.__transferables__ = transferables;\n    }\n\n    if (!bObject) {\n      throw new Error("Failed to encode object");\n    }\n\n    return bObject;\n  }\n\n  async _decode(aObject, withPromise) {\n    if (!aObject) {\n      return aObject;\n    }\n\n    let bObject;\n\n    if (aObject["_rtype"]) {\n      if (this._codecs[aObject._rtype] && this._codecs[aObject._rtype].decoder) {\n        if (aObject._rintf) {\n          const temp = aObject._rtype;\n          delete aObject._rtype;\n          aObject = await this._decode(aObject, withPromise);\n          aObject._rtype = temp;\n        }\n\n        bObject = await Promise.resolve(this._codecs[aObject._rtype].decoder(aObject));\n      } else if (aObject._rtype === "callback") {\n        bObject = this._genRemoteCallback(aObject._rtarget_id, aObject._rvalue, withPromise);\n      } else if (aObject._rtype === "interface") {\n        bObject = this._genRemoteMethod(aObject._rtarget_id, aObject._rvalue, aObject._rintf);\n      } else if (aObject._rtype === "ndarray") {\n        /*global nj tf*/\n        //create build array/tensor if used in the plugin\n        if (typeof nj !== "undefined" && nj.array) {\n          if (Array.isArray(aObject._rvalue)) {\n            aObject._rvalue = aObject._rvalue.reduce(_appendBuffer);\n          }\n\n          bObject = nj.array(new Uint8(aObject._rvalue), aObject._rdtype).reshape(aObject._rshape);\n        } else if (typeof tf !== "undefined" && tf.Tensor) {\n          if (Array.isArray(aObject._rvalue)) {\n            aObject._rvalue = aObject._rvalue.reduce(_appendBuffer);\n          }\n\n          const arraytype = _utils_js__WEBPACK_IMPORTED_MODULE_0__["dtypeToTypedArray"][aObject._rdtype];\n          bObject = tf.tensor(new arraytype(aObject._rvalue), aObject._rshape, aObject._rdtype);\n        } else {\n          //keep it as regular if transfered to the main app\n          bObject = aObject;\n        }\n      } else if (aObject._rtype === "error") {\n        bObject = new Error(aObject._rvalue);\n      } else if (aObject._rtype === "file") {\n        if (aObject._rvalue instanceof File) {\n          bObject = aObject._rvalue; //patch _path\n\n          bObject._path = aObject._rpath;\n        } else {\n          bObject = new File([aObject._rvalue], aObject._rname, {\n            type: aObject._rmime\n          });\n          bObject._path = aObject._rpath;\n        }\n      } else if (aObject._rtype === "typedarray") {\n        const arraytype = _utils_js__WEBPACK_IMPORTED_MODULE_0__["dtypeToTypedArray"][aObject._rdtype];\n        if (!arraytype) throw new Error("unsupported dtype: " + aObject._rdtype);\n        bObject = new arraytype(aObject._rvalue);\n      } else if (aObject._rtype === "memoryview") {\n        bObject = new DataView(aObject._rvalue);\n      } else if (aObject._rtype === "blob") {\n        if (aObject._rvalue instanceof Blob) {\n          bObject = aObject._rvalue;\n        } else {\n          bObject = new Blob([aObject._rvalue], {\n            type: aObject._rmime\n          });\n        }\n      } else if (aObject._rtype === "orderedmap") {\n        bObject = new Map(await this._decode(aObject._rvalue, withPromise));\n      } else if (aObject._rtype === "set") {\n        bObject = new Set(await this._decode(aObject._rvalue, withPromise));\n      } else {\n        // make sure all the interface functions are decoded\n        if (aObject._rintf) {\n          const temp = aObject._rtype;\n          delete aObject._rtype;\n          bObject = await this._decode(aObject, withPromise);\n          bObject._rtype = temp;\n        } else bObject = aObject;\n      }\n    } else if (aObject.constructor === Object || Array.isArray(aObject)) {\n      const isarray = Array.isArray(aObject);\n      bObject = isarray ? [] : {};\n\n      for (let k of Object.keys(aObject)) {\n        if (isarray || aObject.hasOwnProperty(k)) {\n          const v = aObject[k];\n          bObject[k] = await this._decode(v, withPromise);\n        }\n      }\n    } else {\n      bObject = aObject;\n    }\n\n    if (bObject === undefined) {\n      throw new Error("Failed to decode object");\n    } // store the object id for dispose\n\n\n    if (aObject._rintf) {\n      this._object_weakmap.set(bObject, aObject._rintf);\n    }\n\n    return bObject;\n  }\n\n  async _wrap(args, asInterface) {\n    return await this._encode(args, asInterface);\n  }\n  /**\n   * Unwraps the set of arguments delivered from the remote site,\n   * replaces all callback identifiers with a function which will\n   * initiate sending that callback identifier back to other site\n   *\n   * @param {Object} args to unwrap\n   *\n   * @param {Boolean} withPromise is true means this the callback should contain a promise\n   *\n   * @returns {Array} unwrapped args\n   */\n\n\n  async _unwrap(args, withPromise) {\n    return await this._decode(args, withPromise);\n  }\n  /**\n   * Generates the wrapped function corresponding to a single remote\n   * callback. When the generated function is called, it will send\n   * the corresponding message to the remote site asking it to\n   * execute the particular callback previously saved during a call\n   * by the remote site a method from the interface of this site\n   *\n   * @param {Number} id of the remote callback to execute\n   * @param {Number} argNum argument index of the callback\n   * @param {Boolean} withPromise is true means this the callback should contain a promise\n   *\n   * @returns {Function} wrapped remote callback\n   */\n\n\n  _genRemoteCallback(targetId, cid, withPromise) {\n    const me = this;\n    let remoteCallback;\n\n    if (withPromise) {\n      remoteCallback = function () {\n        return new Promise(async (resolve, reject) => {\n          const args = await me._wrap(Array.prototype.slice.call(arguments));\n          const argLength = args.length; // if the last argument is an object, mark it as kwargs\n\n          const withKwargs = argLength > 0 && typeof args[argLength - 1] === "object" && args[argLength - 1] !== null && args[argLength - 1]._rkwargs;\n          if (withKwargs) delete args[argLength - 1]._rkwargs;\n          const transferables = args.__transferables__;\n          if (transferables) delete args.__transferables__;\n          const encodedPromise = await me._wrap([resolve, reject]); // store the key id for removing them from the reference store together\n\n          resolve.__promise_pair = encodedPromise[1]._rvalue;\n          reject.__promise_pair = encodedPromise[0]._rvalue;\n\n          try {\n            me._connection.emit({\n              type: "callback",\n              target_id: targetId,\n              id: cid,\n              args: args,\n              promise: encodedPromise,\n              with_kwargs: withKwargs\n            }, transferables);\n          } catch (e) {\n            reject(`Failed to exectue remote callback ( id: ${cid}).`);\n          }\n        });\n      };\n\n      return remoteCallback;\n    } else {\n      remoteCallback = async function () {\n        const args = await me._wrap(Array.prototype.slice.call(arguments));\n        const argLength = args.length; // if the last argument is an object, mark it as kwargs\n\n        const withKwargs = argLength > 0 && typeof args[argLength - 1] === "object" && args[argLength - 1] !== null && args[argLength - 1]._rkwargs;\n        if (withKwargs) delete args[argLength - 1]._rkwargs;\n        const transferables = args.__transferables__;\n        if (transferables) delete args.__transferables__;\n        return me._connection.emit({\n          type: "callback",\n          target_id: targetId,\n          id: cid,\n          args: args,\n          with_kwargs: withKwargs\n        }, transferables);\n      };\n\n      return remoteCallback;\n    }\n  }\n\n  reset() {\n    this._event_handlers = {};\n    this._once_handlers = {};\n    this._remote_interface = null;\n    this._object_store = {};\n    this._method_weakmap = new WeakMap();\n    this._object_weakmap = new WeakMap();\n    this._local_api = null;\n    this._store = new ReferenceStore();\n    this._method_refs = new ReferenceStore();\n  }\n  /**\n   * Sends the notification message and breaks the connection\n   */\n\n\n  disconnect() {\n    this._connection.emit({\n      type: "disconnect"\n    });\n\n    this.reset();\n    setTimeout(() => {\n      this._connection.disconnect();\n    }, 2000);\n  }\n\n}\n/**\n * ReferenceStore is a special object which stores other objects\n * and provides the references (number) instead. This reference\n * may then be sent over a json-based communication channel (IPC\n * to another Node.js process or a message to the Worker). Other\n * site may then provide the reference in the responce message\n * implying the given object should be activated.\n *\n * Primary usage for the ReferenceStore is a storage for the\n * callbacks, which therefore makes it possible to initiate a\n * callback execution by the opposite site (which normally cannot\n * directly execute functions over the communication channel).\n *\n * Each stored object can only be fetched once and is not\n * available for the second time. Each stored object must be\n * fetched, since otherwise it will remain stored forever and\n * consume memory.\n *\n * Stored object indeces are simply the numbers, which are however\n * released along with the objects, and are later reused again (in\n * order to postpone the overflow, which should not likely happen,\n * but anyway).\n */\n\nclass ReferenceStore {\n  constructor() {\n    this._store = {}; // stored object\n\n    this._indices = [0]; // smallest available indices\n\n    this._readyHandler = function () {};\n\n    this._busyHandler = function () {};\n\n    this._readyHandler();\n  }\n  /**\n   * call handler when the store is empty\n   *\n   * @param {FUNCTION} id of a handler\n   */\n\n\n  onReady(readyHandler) {\n    this._readyHandler = readyHandler || function () {};\n  }\n  /**\n   * call handler when the store is not empty\n   *\n   * @param {FUNCTION} id of a handler\n   */\n\n\n  onBusy(busyHandler) {\n    this._busyHandler = busyHandler || function () {};\n  }\n  /**\n   * get the length of the store\n   *\n   */\n\n\n  getStack() {\n    return Object.keys(this._store).length;\n  }\n  /**\n   * @function _genId() generates the new reference id\n   *\n   * @returns {Number} smallest available id and reserves it\n   */\n\n\n  _genId() {\n    let id;\n\n    if (this._indices.length === 1) {\n      id = this._indices[0]++;\n    } else {\n      id = this._indices.shift();\n    }\n\n    return id;\n  }\n  /**\n   * Releases the given reference id so that it will be available by\n   * another object stored\n   *\n   * @param {Number} id to release\n   */\n\n\n  _releaseId(id) {\n    for (let i = 0; i < this._indices.length; i++) {\n      if (id < this._indices[i]) {\n        this._indices.splice(i, 0, id);\n\n        break;\n      }\n    } // cleaning-up the sequence tail\n\n\n    for (let i = this._indices.length - 1; i >= 0; i--) {\n      if (this._indices[i] - 1 === this._indices[i - 1]) {\n        this._indices.pop();\n      } else {\n        break;\n      }\n    }\n  }\n  /**\n   * Stores the given object and returns the refernce id instead\n   *\n   * @param {Object} obj to store\n   *\n   * @returns {Number} reference id of the stored object\n   */\n\n\n  put(obj) {\n    if (this._busyHandler && Object.keys(this._store).length === 0) {\n      this._busyHandler();\n    }\n\n    const id = this._genId();\n\n    this._store[id] = obj;\n    return id;\n  }\n  /**\n   * Retrieves previously stored object and releases its reference\n   *\n   * @param {Number} id of an object to retrieve\n   */\n\n\n  fetch(id) {\n    const obj = this._store[id];\n\n    if (obj && !obj.__remote_method) {\n      delete this._store[id];\n\n      this._releaseId(id);\n\n      if (this._readyHandler && Object.keys(this._store).length === 0) {\n        this._readyHandler();\n      }\n    }\n\n    if (obj && obj.__promise_pair) {\n      this.fetch(obj.__promise_pair);\n    }\n\n    return obj;\n  }\n\n}\n\n/***/ }),\n\n/***/ "./src/utils.js":\n/*!**********************!*\\\n  !*** ./src/utils.js ***!\n  \\**********************/\n/*! exports provided: randId, dtypeToTypedArray, loadRequirementsInWindow, loadRequirementsInWebworker, loadRequirements, normalizeConfig, typedArrayToDtypeMapping, typedArrayToDtype, cacheRequirements, setupServiceWorker, urlJoin, MessageEmitter */\n/***/ (function(module, __webpack_exports__, __webpack_require__) {\n\n"use strict";\n__webpack_require__.r(__webpack_exports__);\n/* harmony export (binding) */ __webpack_require__.d(__webpack_exports__, "randId", function() { return randId; });\n/* harmony export (binding) */ __webpack_require__.d(__webpack_exports__, "dtypeToTypedArray", function() { return dtypeToTypedArray; });\n/* harmony export (binding) */ __webpack_require__.d(__webpack_exports__, "loadRequirementsInWindow", function() { return loadRequirementsInWindow; });\n/* harmony export (binding) */ __webpack_require__.d(__webpack_exports__, "loadRequirementsInWebworker", function() { return loadRequirementsInWebworker; });\n/* harmony export (binding) */ __webpack_require__.d(__webpack_exports__, "loadRequirements", function() { return loadRequirements; });\n/* harmony export (binding) */ __webpack_require__.d(__webpack_exports__, "normalizeConfig", function() { return normalizeConfig; });\n/* harmony export (binding) */ __webpack_require__.d(__webpack_exports__, "typedArrayToDtypeMapping", function() { return typedArrayToDtypeMapping; });\n/* harmony export (binding) */ __webpack_require__.d(__webpack_exports__, "typedArrayToDtype", function() { return typedArrayToDtype; });\n/* harmony export (binding) */ __webpack_require__.d(__webpack_exports__, "cacheRequirements", function() { return cacheRequirements; });\n/* harmony export (binding) */ __webpack_require__.d(__webpack_exports__, "setupServiceWorker", function() { return setupServiceWorker; });\n/* harmony export (binding) */ __webpack_require__.d(__webpack_exports__, "urlJoin", function() { return urlJoin; });\n/* harmony export (binding) */ __webpack_require__.d(__webpack_exports__, "MessageEmitter", function() { return MessageEmitter; });\nfunction randId() {\n  return Math.random().toString(36).substr(2, 10) + new Date().getTime();\n}\nconst dtypeToTypedArray = {\n  int8: Int8Array,\n  int16: Int16Array,\n  int32: Int32Array,\n  uint8: Uint8Array,\n  uint16: Uint16Array,\n  uint32: Uint32Array,\n  float32: Float32Array,\n  float64: Float64Array,\n  array: Array\n};\nasync function loadRequirementsInWindow(requirements) {\n  function _importScript(url) {\n    //url is URL of external file, implementationCode is the code\n    //to be called from the file, location is the location to\n    //insert the <script> element\n    return new Promise((resolve, reject) => {\n      var scriptTag = document.createElement("script");\n      scriptTag.src = url;\n      scriptTag.type = "text/javascript";\n      scriptTag.onload = resolve;\n\n      scriptTag.onreadystatechange = function () {\n        if (this.readyState === "loaded" || this.readyState === "complete") {\n          resolve();\n        }\n      };\n\n      scriptTag.onerror = reject;\n      document.head.appendChild(scriptTag);\n    });\n  } // support importScripts outside web worker\n\n\n  async function importScripts() {\n    var args = Array.prototype.slice.call(arguments),\n        len = args.length,\n        i = 0;\n\n    for (; i < len; i++) {\n      await _importScript(args[i]);\n    }\n  }\n\n  if (requirements && (Array.isArray(requirements) || typeof requirements === "string")) {\n    try {\n      var link_node;\n      requirements = typeof requirements === "string" ? [requirements] : requirements;\n\n      if (Array.isArray(requirements)) {\n        for (var i = 0; i < requirements.length; i++) {\n          if (requirements[i].toLowerCase().endsWith(".css") || requirements[i].startsWith("css:")) {\n            if (requirements[i].startsWith("css:")) {\n              requirements[i] = requirements[i].slice(4);\n            }\n\n            link_node = document.createElement("link");\n            link_node.rel = "stylesheet";\n            link_node.href = requirements[i];\n            document.head.appendChild(link_node);\n          } else if (requirements[i].toLowerCase().endsWith(".mjs") || requirements[i].startsWith("mjs:")) {\n            // import esmodule\n            if (requirements[i].startsWith("mjs:")) {\n              requirements[i] = requirements[i].slice(4);\n            }\n\n            await import(\n            /* webpackIgnore: true */\n            requirements[i]);\n          } else if (requirements[i].toLowerCase().endsWith(".js") || requirements[i].startsWith("js:")) {\n            if (requirements[i].startsWith("js:")) {\n              requirements[i] = requirements[i].slice(3);\n            }\n\n            await importScripts(requirements[i]);\n          } else if (requirements[i].startsWith("http")) {\n            await importScripts(requirements[i]);\n          } else if (requirements[i].startsWith("cache:")) {//ignore cache\n          } else {\n            console.log("Unprocessed requirements url: " + requirements[i]);\n          }\n        }\n      } else {\n        throw "unsupported requirements definition";\n      }\n    } catch (e) {\n      throw "failed to import required scripts: " + requirements.toString();\n    }\n  }\n}\nasync function loadRequirementsInWebworker(requirements) {\n  if (requirements && (Array.isArray(requirements) || typeof requirements === "string")) {\n    try {\n      if (!Array.isArray(requirements)) {\n        requirements = [requirements];\n      }\n\n      for (var i = 0; i < requirements.length; i++) {\n        if (requirements[i].toLowerCase().endsWith(".css") || requirements[i].startsWith("css:")) {\n          throw "unable to import css in a webworker";\n        } else if (requirements[i].toLowerCase().endsWith(".js") || requirements[i].startsWith("js:")) {\n          if (requirements[i].startsWith("js:")) {\n            requirements[i] = requirements[i].slice(3);\n          }\n\n          importScripts(requirements[i]);\n        } else if (requirements[i].startsWith("http")) {\n          importScripts(requirements[i]);\n        } else if (requirements[i].startsWith("cache:")) {//ignore cache\n        } else {\n          console.log("Unprocessed requirements url: " + requirements[i]);\n        }\n      }\n    } catch (e) {\n      throw "failed to import required scripts: " + requirements.toString();\n    }\n  }\n}\nfunction loadRequirements(requirements) {\n  if (typeof WorkerGlobalScope !== "undefined" && self instanceof WorkerGlobalScope) {\n    return loadRequirementsInWebworker(requirements);\n  } else {\n    return loadRequirementsInWindow(requirements);\n  }\n}\nfunction normalizeConfig(config) {\n  config.version = config.version || "0.1.0";\n  config.description = config.description || `[TODO: add description for ${config.name} ]`;\n  config.type = config.type || "rpc-window";\n  config.id = config.id || randId();\n  config.target_origin = config.target_origin || "*";\n  config.allow_execution = config.allow_execution || false; // remove functions\n\n  config = Object.keys(config).reduce((p, c) => {\n    if (typeof config[c] !== "function") p[c] = config[c];\n    return p;\n  }, {});\n  return config;\n}\nconst typedArrayToDtypeMapping = {\n  Int8Array: "int8",\n  Int16Array: "int16",\n  Int32Array: "int32",\n  Uint8Array: "uint8",\n  Uint16Array: "uint16",\n  Uint32Array: "uint32",\n  Float32Array: "float32",\n  Float64Array: "float64",\n  Array: "array"\n};\nconst typedArrayToDtypeKeys = [];\n\nfor (const arrType of Object.keys(typedArrayToDtypeMapping)) {\n  typedArrayToDtypeKeys.push(eval(arrType));\n}\n\nfunction typedArrayToDtype(obj) {\n  let dtype = typedArrayToDtypeMapping[obj.constructor.name];\n\n  if (!dtype) {\n    const pt = Object.getPrototypeOf(obj);\n\n    for (const arrType of typedArrayToDtypeKeys) {\n      if (pt instanceof arrType) {\n        dtype = typedArrayToDtypeMapping[arrType.name];\n        break;\n      }\n    }\n  }\n\n  return dtype;\n}\n\nfunction cacheUrlInServiceWorker(url) {\n  return new Promise(function (resolve, reject) {\n    const message = {\n      command: "add",\n      url: url\n    };\n\n    if (!navigator.serviceWorker || !navigator.serviceWorker.register) {\n      reject("Service worker is not supported.");\n      return;\n    }\n\n    const messageChannel = new MessageChannel();\n\n    messageChannel.port1.onmessage = function (event) {\n      if (event.data && event.data.error) {\n        reject(event.data.error);\n      } else {\n        resolve(event.data && event.data.result);\n      }\n    };\n\n    if (navigator.serviceWorker && navigator.serviceWorker.controller) {\n      navigator.serviceWorker.controller.postMessage(message, [messageChannel.port2]);\n    } else {\n      reject("Service worker controller is not available");\n    }\n  });\n}\n\nasync function cacheRequirements(requirements) {\n  requirements = requirements || [];\n\n  if (!Array.isArray(requirements)) {\n    requirements = [requirements];\n  }\n\n  for (let req of requirements) {\n    //remove prefix\n    if (req.startsWith("js:")) req = req.slice(3);\n    if (req.startsWith("css:")) req = req.slice(4);\n    if (req.startsWith("cache:")) req = req.slice(6);\n    if (!req.startsWith("http")) continue;\n    await cacheUrlInServiceWorker(req).catch(e => {\n      console.error(e);\n    });\n  }\n}\nfunction setupServiceWorker(baseUrl, targetOrigin, cacheCallback) {\n  // register service worker for offline access\n  if ("serviceWorker" in navigator) {\n    baseUrl = baseUrl || "/";\n    navigator.serviceWorker.register(baseUrl + "plugin-service-worker.js").then(function (registration) {\n      // Registration was successful\n      console.log("ServiceWorker registration successful with scope: ", registration.scope);\n    }, function (err) {\n      // registration failed :(\n      console.log("ServiceWorker registration failed: ", err);\n    });\n    targetOrigin = targetOrigin || "*";\n    cacheCallback = cacheCallback || cacheRequirements;\n\n    if (cacheCallback && typeof cacheCallback !== "function") {\n      throw new Error("config.cache_requirements must be a function");\n    }\n\n    window.addEventListener("message", function (e) {\n      if (targetOrigin === "*" || e.origin === targetOrigin) {\n        const m = e.data;\n\n        if (m.type === "cacheRequirements") {\n          cacheCallback(m.requirements);\n        }\n      }\n    });\n  }\n} //#Source https://bit.ly/2neWfJ2\n\nfunction urlJoin(...args) {\n  return args.join("/").replace(/[\\/]+/g, "/").replace(/^(.+):\\//, "$1://").replace(/^file:/, "file:/").replace(/\\/(\\?|&|#[^!])/g, "$1").replace(/\\?/g, "&").replace("&", "?");\n}\nclass MessageEmitter {\n  constructor(debug) {\n    this._event_handlers = {};\n    this._once_handlers = {};\n    this._debug = debug;\n  }\n\n  emit() {\n    throw new Error("emit is not implemented");\n  }\n\n  on(event, handler) {\n    if (!this._event_handlers[event]) {\n      this._event_handlers[event] = [];\n    }\n\n    this._event_handlers[event].push(handler);\n  }\n\n  once(event, handler) {\n    handler.___event_run_once = true;\n    this.on(event, handler);\n  }\n\n  off(event, handler) {\n    if (!event && !handler) {\n      // remove all events handlers\n      this._event_handlers = {};\n    } else if (event && !handler) {\n      // remove all hanlders for the event\n      if (this._event_handlers[event]) this._event_handlers[event] = [];\n    } else {\n      // remove a specific handler\n      if (this._event_handlers[event]) {\n        const idx = this._event_handlers[event].indexOf(handler);\n\n        if (idx >= 0) {\n          this._event_handlers[event].splice(idx, 1);\n        }\n      }\n    }\n  }\n\n  _fire(event, data) {\n    if (this._event_handlers[event]) {\n      var i = this._event_handlers[event].length;\n\n      while (i--) {\n        const handler = this._event_handlers[event][i];\n\n        try {\n          handler(data);\n        } catch (e) {\n          console.error(e);\n        } finally {\n          if (handler.___event_run_once) {\n            this._event_handlers[event].splice(i, 1);\n          }\n        }\n      }\n    } else {\n      if (this._debug) {\n        console.warn("unhandled event", event, data);\n      }\n    }\n  }\n\n}\n\n/***/ })\n\n/******/ });\n//# sourceMappingURL=plugin.webworker.js.map',null)}},"./src/pluginCore.js":function(e,t,n){n.r(t),n.d(t,"connectRPC",(function(){return i}));var r=n("./src/rpc.js");function i(e,t){t=t||{};const n={},i=new r.RPC(e,t,n);i.on("getInterface",(function(){a()})),i.on("remoteReady",(function(){const e=i.getRemote()||{};e.registerCodec=function(e){if(!e.name||!e.encoder&&!e.decoder)throw new Error("Invalid codec format, please make sure you provide a name, type, encoder and decoder.");if(e.type)for(let t of Object.keys(n))n[t].type!==e.type&&t!==e.name||(delete n[t],console.warn("Remove duplicated codec: "+t));n[e.name]=e},e.init=function(e){i.setInterface({setup(){}},e)},e.disposeObject=function(e){i.disposeObject(e)},e.export=function(e,t){i.setInterface(e,t)},e.onLoad=function(e){e=c(e),s?e():o.push(e)},e.dispose=function(e){i.disconnect()},e._rpc=i,"undefined"!=typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope?(self.api=e,self.postMessage({type:"imjoy_remote_api_ready"}),self.dispatchEvent(new CustomEvent("imjoy_remote_api_ready",{detail:e}))):window.dispatchEvent(new CustomEvent("imjoy_remote_api_ready",{detail:e}))}));let s=!1;const o=[],a=function(){if(!s){let e;for(s=!0;e=o.pop();)e()}},c=function(e){const t=typeof e;if("function"!==t)throw new Error("A function may only be subsribed to the event, "+t+" was provided instead");return e};return i}},"./src/pluginIframe.js":function(module,__nested_webpack_exports__,__nested_webpack_require_284849__){__nested_webpack_require_284849__.r(__nested_webpack_exports__),__nested_webpack_require_284849__.d(__nested_webpack_exports__,"Connection",(function(){return Connection})),__nested_webpack_require_284849__.d(__nested_webpack_exports__,"default",(function(){return setupIframe}));var _pluginCore_js__WEBPACK_IMPORTED_MODULE_0__=__nested_webpack_require_284849__("./src/pluginCore.js"),_rpc_js__WEBPACK_IMPORTED_MODULE_1__=__nested_webpack_require_284849__("./src/rpc.js"),_utils_js__WEBPACK_IMPORTED_MODULE_2__=__nested_webpack_require_284849__("./src/utils.js");function _htmlToElement(e){var t=document.createElement("template");return e=e.trim(),t.innerHTML=e,t.content.firstChild}const _inWebWorker="undefined"!=typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope;async function executeEsModule(e){const t="data:text/javascript;charset=utf-8,"+encodeURIComponent(e);await import(t)}class Connection extends _utils_js__WEBPACK_IMPORTED_MODULE_2__.MessageEmitter{constructor(e){super(e&&e.debug),this.config=e||{},this.peer_id=Object(_utils_js__WEBPACK_IMPORTED_MODULE_2__.randId)()}connect(){this.config.target_origin=this.config.target_origin||"*",this.config.broadcastChannel?this.broadcastChannel=new BroadcastChannel(this.config.broadcastChannel):this.broadcastChannel=null,this.broadcastChannel?this.broadcastChannel.addEventListener("message",this):globalThis.addEventListener("message",this),this.emit({type:"initialized",config:this.config,origin:globalThis.location.origin,peer_id:this.peer_id}),this._fire("connected")}handleEvent(e){"message"!==e.type||!this.broadcastChannel&&"*"!==this.config.target_origin&&e.origin&&e.origin!==this.config.target_origin||(e.data.peer_id===this.peer_id?this._fire(e.data.type,e.data):this.config.debug&&console.log(`connection peer id mismatch ${e.data.peer_id} !== ${this.peer_id}`))}disconnect(){this._fire("beforeDisconnect"),globalThis.removeEventListener("message",this),this._fire("disconnected")}emit(e){let t;this.broadcastChannel?this.broadcastChannel.postMessage(e):e.__transferables__?(t=e.__transferables__,delete e.__transferables__):_inWebWorker?self.postMessage(e,t):parent.postMessage(e,this.config.target_origin,t)}async execute(code){try{if("requirements"===code.type)await Object(_utils_js__WEBPACK_IMPORTED_MODULE_2__.loadRequirementsInWindow)(code.requirements);else if("script"===code.type)if(code.src){var script_node=document.createElement("script");script_node.setAttribute("type",code.attrs.type),script_node.setAttribute("src",code.src),document.head.appendChild(script_node)}else if(code.content&&"javascript"===code.attrs.lang)"module"===code.attrs.type?await executeEsModule(code.content):eval(code.content);else{var node=document.createElement("script");for(let e in code.attrs)node.setAttribute(e,code.attrs[e]);node.appendChild(document.createTextNode(code.content)),document.body.appendChild(node)}else if("style"===code.type){const e=document.createElement("style");code.src&&(e.src=code.src),e.innerHTML=code.content,document.head.appendChild(e)}else if("link"===code.type){const e=document.createElement("link");code.rel&&(e.rel=code.rel),code.href&&(e.href=code.href),code.attrs&&code.attrs.type&&(e.type=code.attrs.type),document.head.appendChild(e)}else{if("html"!==code.type)throw"unsupported code type.";document.body.appendChild(_htmlToElement(code.content))}_inWebWorker?self.postMessage({type:"executed"}):parent.postMessage({type:"executed"},this.config.target_origin)}catch(e){console.error("failed to execute scripts: ",code,e),_inWebWorker?self.postMessage({type:"executed",error:e.stack||String(e)}):parent.postMessage({type:"executed",error:e.stack||String(e)},this.config.target_origin)}}}function setupIframe(e){(e=e||{}).dedicated_thread=!1,e.lang="javascript",e.api_version=_rpc_js__WEBPACK_IMPORTED_MODULE_1__.API_VERSION;const t=new Connection(e);Object(_pluginCore_js__WEBPACK_IMPORTED_MODULE_0__.connectRPC)(t,e),t.connect()}},"./src/rpc.js":function(e,t,n){n.r(t),n.d(t,"API_VERSION",(function(){return i})),n.d(t,"RPC",(function(){return c}));var r=n("./src/utils.js");const i="0.2.3",s=Object.getPrototypeOf(Object.getPrototypeOf(new Uint8Array)).constructor;function o(e,t){const n=new Uint8Array(e.byteLength+t.byteLength);return n.set(new Uint8Array(e),0),n.set(new Uint8Array(t),e.byteLength),n.buffer}function a(e,t){if(!t)throw new Error("undefined index");return"string"==typeof t?a(e,t.split(".")):0===t.length?e:a(e[t[0]],t.slice(1))}class c extends r.MessageEmitter{constructor(e,t,n){super(t&&t.debug),this._connection=e,this.config=t||{},this._codecs=n||{},this._object_store={},this._method_weakmap=new WeakMap,this._object_weakmap=new WeakMap,this._local_api=null,this._remote_set=!1;const r=this.config.name;this._connection.execute=this._connection.execute||function(){throw new Error(`connection.execute not implemented (in "${r}")`)},this._store=new l,this._method_refs=new l,this._method_refs.onReady((()=>{this._fire("remoteIdle")})),this._method_refs.onBusy((()=>{this._fire("remoteBusy")})),this._setupMessageHanlders()}init(){this._connection.emit({type:"initialized",config:this.config,peer_id:this._connection.peer_id})}setConfig(e){if(e)for(const t of Object.keys(e))this.config[t]=e[t]}getRemoteCallStack(){return this._method_refs.getStack()}getRemote(){return this._remote_interface}setInterface(e,t){if(t=t||{},this.config.name=t.name||this.config.name,this.config.description=t.description||this.config.description,this.config.forwarding_functions)for(let t of this.config.forwarding_functions){const n=this._remote_interface;n[t]&&(e.constructor===Object?e[t]||(e[t]=(...e)=>{n[t](...e)}):e.constructor.constructor===Function&&(e.constructor.prototype[t]||(e.constructor.prototype[t]=(...e)=>{n[t](...e)})))}return this._local_api=e,this._remote_set?this.sendInterface():this._fire("interfaceAvailable"),new Promise((e=>{this.once("interfaceSetAsRemote",e)}))}sendInterface(){if(!this._local_api)throw new Error("interface is not set.");this._encode(this._local_api,!0).then((e=>{this._connection.emit({type:"setInterface",api:e})}))}_disposeObject(e){if(!this._object_store[e])throw new Error(`Object (id=${e}) not found.`);delete this._object_store[e]}disposeObject(e){return new Promise(((t,n)=>{if(!this._object_weakmap.has(e))throw new Error("Invalid object");{const r=this._object_weakmap.get(e);this._connection.once("disposed",(e=>{e.error?n(new Error(e.error)):t()})),this._connection.emit({type:"disposeObject",object_id:r})}}))}_setupMessageHanlders(){this._connection.on("init",this.init),this._connection.on("execute",(e=>{Promise.resolve(this._connection.execute(e.code)).then((()=>{this._connection.emit({type:"executed"})})).catch((e=>{console.error(e),this._connection.emit({type:"executed",error:String(e)})}))})),this._connection.on("method",(async e=>{let t,n,r,i,s,o;try{e.promise&&([t,n]=await this._unwrap(e.promise,!1));const c=this._object_store[e.object_id];if(r=a(c,e.name),e.name.includes(".")){const t=e.name.split(".");i=a(c,t.slice(0,t.length-1).join("."))}else i=c;s=await this._unwrap(e.args,!0),e.promise?(o=r.apply(i,s),o instanceof Promise||r.constructor&&"AsyncFunction"===r.constructor.name?o.then(t).catch(n):t(o)):r.apply(i,s)}catch(e){console.error(this.config.name,e),n&&n(e)}})),this._connection.on("callback",(async e=>{let t,n,r,i,s;try{if(e.promise&&([t,n]=await this._unwrap(e.promise,!1)),e.promise){if(r=this._store.fetch(e.id),i=await this._unwrap(e.args,!0),!r)throw new Error("Callback function can only called once, if you want to call a function for multiple times, please make it as a plugin api function. See https://imjoy.io/docs for more details.");s=r.apply(null,i),s instanceof Promise||r.constructor&&"AsyncFunction"===r.constructor.name?s.then(t).catch(n):t(s)}else{if(r=this._store.fetch(e.id),i=await this._unwrap(e.args,!0),!r)throw new Error("Please notice that callback function can only called once, if you want to call a function for multiple times, please make it as a plugin api function. See https://imjoy.io/docs for more details.");r.apply(null,i)}}catch(e){console.error(this.config.name,e),n&&n(e)}})),this._connection.on("disposeObject",(e=>{try{this._disposeObject(e.object_id),this._connection.emit({type:"disposed"})}catch(e){console.error(e),this._connection.emit({type:"disposed",error:String(e)})}})),this._connection.on("setInterface",(e=>{this._setRemoteInterface(e.api)})),this._connection.on("getInterface",(()=>{this._fire("getInterface"),this._local_api?this.sendInterface():this.once("interfaceAvailable",(()=>{this.sendInterface()}))})),this._connection.on("interfaceSetAsRemote",(()=>{this._remote_set=!0,this._fire("interfaceSetAsRemote")})),this._connection.on("disconnect",(()=>{this._fire("beforeDisconnect"),this._connection.disconnect(),this._fire("disconnected")}))}requestRemote(){this._connection.emit({type:"getInterface"})}_ndarray(e,t,n){const i=Object(r.typedArrayToDtype)(e);if(n&&n!==i)throw"dtype doesn't match the type of the array: "+i+" != "+n;return t=t||[e.length],{_rtype:"ndarray",_rvalue:e.buffer,_rshape:t,_rdtype:i}}_setRemoteInterface(e){this._decode(e).then((e=>{if(this._remote_interface){for(let e in this._remote_interface)delete this._remote_interface[e];Object.assign(this._remote_interface,e)}else this._remote_interface=e;this._fire("remoteReady"),this._reportRemoteSet()}))}_genRemoteMethod(e,t,n){const r=this,i=function(){return new Promise((async(i,s)=>{let o=null;try{o=r._method_refs.put(n?n+"/"+t:t);const a=function(){return null!==o&&r._method_refs.fetch(o),i.apply(this,arguments)},c=function(){return null!==o&&r._method_refs.fetch(o),s.apply(this,arguments)},l=await r._wrap([a,c]);a.__promise_pair=l[1]._rvalue,c.__promise_pair=l[0]._rvalue;let u=Array.prototype.slice.call(arguments);const d=u.length,h=d>0&&"object"==typeof u[d-1]&&null!==u[d-1]&&u[d-1]._rkwargs;h&&delete u[d-1]._rkwargs,u="register"===t||"registerService"===t||"register_service"===t||"export"===t||"on"===t?await r._wrap(u,!0):await r._wrap(u);const p=u.__transferables__;p&&delete u.__transferables__,r._connection.emit({type:"method",target_id:e,name:t,object_id:n,args:u,promise:l,with_kwargs:h},p)}catch(e){o&&r._method_refs.fetch(o),s(`Failed to exectue remote method (interface: ${n||r.id}, method: ${t}), error: ${e}`)}}))};return i.__remote_method=!0,i}_reportRemoteSet(){this._connection.emit({type:"interfaceSetAsRemote"})}async _encode(e,t,n){const i=typeof e;if("number"===i||"string"===i||"boolean"===i||null==e||e instanceof ArrayBuffer)return e;let o;if("function"==typeof e){if(t){if(!n)throw new Error("objectId is not specified.");o={_rtype:"interface",_rtarget_id:this._connection.peer_id,_rintf:n,_rvalue:t},this._method_weakmap.set(e,o)}else if(this._method_weakmap.has(e))o=this._method_weakmap.get(e);else{const t=this._store.put(e);o={_rtype:"callback",_rtarget_id:this._connection.peer_id,_rname:e.constructor&&e.constructor.name||t,_rvalue:t}}return o}if(e.constructor instanceof Object&&e._rtype){if(e._rintf){const r=e._rtype;delete e._rtype,o=await this._encode(e,t,n),o._rtype=r}else o=e;return o}const a=[],c=e._transfer,l=Array.isArray(e);for(let r of Object.keys(this._codecs)){const i=this._codecs[r];if(i.encoder&&e instanceof i.type){let r=await Promise.resolve(i.encoder(e));if(r&&!r._rtype&&(r._rtype=i.name),r&&r._rintf){const e=r._rtype;delete r._rtype,r=await this._encode(r,t,n),r._rtype=e}return o=r,o}}if("undefined"!=typeof tf&&tf.Tensor&&e instanceof tf.Tensor){const t=e.dataSync();(e._transfer||c)&&(a.push(t.buffer),delete e._transfer),o={_rtype:"ndarray",_rvalue:t.buffer,_rshape:e.shape,_rdtype:e.dtype}}else if("undefined"!=typeof nj&&nj.NdArray&&e instanceof nj.NdArray){const t=Object(r.typedArrayToDtype)(e.selection.data);(e._transfer||c)&&(a.push(e.selection.data.buffer),delete e._transfer),o={_rtype:"ndarray",_rvalue:e.selection.data.buffer,_rshape:e.shape,_rdtype:t}}else if(e instanceof Error)console.error(e),o={_rtype:"error",_rvalue:e.toString()};else if("undefined"!=typeof File&&e instanceof File)o={_rtype:"file",_rvalue:e,_rpath:e._path||e.webkitRelativePath};else if(e!==Object(e)||e instanceof Boolean||e instanceof String||e instanceof Date||e instanceof RegExp||e instanceof ImageData||"undefined"!=typeof FileList&&e instanceof FileList||"undefined"!=typeof FileSystemDirectoryHandle&&e instanceof FileSystemDirectoryHandle||"undefined"!=typeof FileSystemFileHandle&&e instanceof FileSystemFileHandle||"undefined"!=typeof FileSystemHandle&&e instanceof FileSystemHandle||"undefined"!=typeof FileSystemWritableFileStream&&e instanceof FileSystemWritableFileStream)o=e;else if("undefined"!=typeof File&&e instanceof File)o={_rtype:"file",_rname:e.name,_rmime:e.type,_rvalue:e,_rpath:e._path||e.webkitRelativePath};else if(e instanceof Blob)o={_rtype:"blob",_rvalue:e};else if(e instanceof s){(e._transfer||c)&&(a.push(e.buffer),delete e._transfer);const t=Object(r.typedArrayToDtype)(e);o={_rtype:"typedarray",_rvalue:e.buffer,_rdtype:t}}else if(e instanceof DataView)(e._transfer||c)&&(a.push(e.buffer),delete e._transfer),o={_rtype:"memoryview",_rvalue:e.buffer};else if(e instanceof Set)o={_rtype:"set",_rvalue:await this._encode(Array.from(e),t)};else if(e instanceof Map)o={_rtype:"orderedmap",_rvalue:await this._encode(Array.from(e),t)};else if(e.constructor instanceof Object||Array.isArray(e)){let i;if(o=l?[]:{},e.constructor===Object||Array.isArray(e))i=Object.keys(e);else{if(e.constructor===Function)throw new Error("Please instantiate the class before exportting it.");if(e.constructor.constructor!==Function)throw Error("Unsupported interface type");i=Object.getOwnPropertyNames(Object.getPrototypeOf(e)).concat(Object.keys(e)),t=!0}let s=!1;if(e._rintf||t){n||(n="string"==typeof e._rintf&&e._rintf.length>0?e._rintf:Object(r.randId)(),this._object_store[n]&&console.warn(`Overwritting interface object with the same id: ${n}`),this._object_store[n]=e);for(let r of i)"constructor"!==r&&(r.startsWith("_")||(o[r]=await this._encode(e[r],"string"==typeof t?t+"."+r:r,n),"function"==typeof e[r]&&(s=!0)));s&&(o._rintf=n),e.on&&"function"==typeof e.on&&e.on("close",(()=>{delete this._object_store[n]}))}else for(let t of i)["hasOwnProperty","constructor"].includes(t)||(o[t]=await this._encode(e[t]))}else{if("object"!=typeof e)throw"imjoy-rpc: Unsupported data type:"+e;{const t=Object.getOwnPropertyNames(Object.getPrototypeOf(e)).concat(Object.keys(e)),n=Object(r.randId)();for(let n of t)["hasOwnProperty","constructor"].includes(n)||(o[n]=await this._encode(e[n],n,o));o._rintf=n}}if(a.length>0&&(o.__transferables__=a),!o)throw new Error("Failed to encode object");return o}async _decode(e,t){if(!e)return e;let n;if(e._rtype)if(this._codecs[e._rtype]&&this._codecs[e._rtype].decoder){if(e._rintf){const n=e._rtype;delete e._rtype,(e=await this._decode(e,t))._rtype=n}n=await Promise.resolve(this._codecs[e._rtype].decoder(e))}else if("callback"===e._rtype)n=this._genRemoteCallback(e._rtarget_id,e._rvalue,t);else if("interface"===e._rtype)n=this._genRemoteMethod(e._rtarget_id,e._rvalue,e._rintf);else if("ndarray"===e._rtype)if("undefined"!=typeof nj&&nj.array)Array.isArray(e._rvalue)&&(e._rvalue=e._rvalue.reduce(o)),n=nj.array(new Uint8(e._rvalue),e._rdtype).reshape(e._rshape);else if("undefined"!=typeof tf&&tf.Tensor){Array.isArray(e._rvalue)&&(e._rvalue=e._rvalue.reduce(o));const t=r.dtypeToTypedArray[e._rdtype];n=tf.tensor(new t(e._rvalue),e._rshape,e._rdtype)}else n=e;else if("error"===e._rtype)n=new Error(e._rvalue);else if("file"===e._rtype)e._rvalue instanceof File?(n=e._rvalue,n._path=e._rpath):(n=new File([e._rvalue],e._rname,{type:e._rmime}),n._path=e._rpath);else if("typedarray"===e._rtype){const t=r.dtypeToTypedArray[e._rdtype];if(!t)throw new Error("unsupported dtype: "+e._rdtype);n=new t(e._rvalue)}else if("memoryview"===e._rtype)n=new DataView(e._rvalue);else if("blob"===e._rtype)n=e._rvalue instanceof Blob?e._rvalue:new Blob([e._rvalue],{type:e._rmime});else if("orderedmap"===e._rtype)n=new Map(await this._decode(e._rvalue,t));else if("set"===e._rtype)n=new Set(await this._decode(e._rvalue,t));else if(e._rintf){const r=e._rtype;delete e._rtype,n=await this._decode(e,t),n._rtype=r}else n=e;else if(e.constructor===Object||Array.isArray(e)){const r=Array.isArray(e);n=r?[]:{};for(let i of Object.keys(e))if(r||e.hasOwnProperty(i)){const r=e[i];n[i]=await this._decode(r,t)}}else n=e;if(void 0===n)throw new Error("Failed to decode object");return e._rintf&&this._object_weakmap.set(n,e._rintf),n}async _wrap(e,t){return await this._encode(e,t)}async _unwrap(e,t){return await this._decode(e,t)}_genRemoteCallback(e,t,n){const r=this;let i;return n?(i=function(){return new Promise((async(n,i)=>{const s=await r._wrap(Array.prototype.slice.call(arguments)),o=s.length,a=o>0&&"object"==typeof s[o-1]&&null!==s[o-1]&&s[o-1]._rkwargs;a&&delete s[o-1]._rkwargs;const c=s.__transferables__;c&&delete s.__transferables__;const l=await r._wrap([n,i]);n.__promise_pair=l[1]._rvalue,i.__promise_pair=l[0]._rvalue;try{r._connection.emit({type:"callback",target_id:e,id:t,args:s,promise:l,with_kwargs:a},c)}catch(e){i(`Failed to exectue remote callback ( id: ${t}).`)}}))},i):(i=async function(){const n=await r._wrap(Array.prototype.slice.call(arguments)),i=n.length,s=i>0&&"object"==typeof n[i-1]&&null!==n[i-1]&&n[i-1]._rkwargs;s&&delete n[i-1]._rkwargs;const o=n.__transferables__;return o&&delete n.__transferables__,r._connection.emit({type:"callback",target_id:e,id:t,args:n,with_kwargs:s},o)},i)}reset(){this._event_handlers={},this._once_handlers={},this._remote_interface=null,this._object_store={},this._method_weakmap=new WeakMap,this._object_weakmap=new WeakMap,this._local_api=null,this._store=new l,this._method_refs=new l}disconnect(){this._connection.emit({type:"disconnect"}),this.reset(),setTimeout((()=>{this._connection.disconnect()}),2e3)}}class l{constructor(){this._store={},this._indices=[0],this._readyHandler=function(){},this._busyHandler=function(){},this._readyHandler()}onReady(e){this._readyHandler=e||function(){}}onBusy(e){this._busyHandler=e||function(){}}getStack(){return Object.keys(this._store).length}_genId(){let e;return e=1===this._indices.length?this._indices[0]++:this._indices.shift(),e}_releaseId(e){for(let t=0;t<this._indices.length;t++)if(e<this._indices[t]){this._indices.splice(t,0,e);break}for(let e=this._indices.length-1;e>=0&&this._indices[e]-1===this._indices[e-1];e--)this._indices.pop()}put(e){this._busyHandler&&0===Object.keys(this._store).length&&this._busyHandler();const t=this._genId();return this._store[t]=e,t}fetch(e){const t=this._store[e];return t&&!t.__remote_method&&(delete this._store[e],this._releaseId(e),this._readyHandler&&0===Object.keys(this._store).length&&this._readyHandler()),t&&t.__promise_pair&&this.fetch(t.__promise_pair),t}}},"./src/socketIOMain.js":function(e,t,n){n.r(t),n.d(t,"Connection",(function(){return l})),n.d(t,"connectToServer",(function(){return u}));var r=n("./src/pluginCore.js"),i=n("./src/rpc.js");n.d(t,"RPC",(function(){return i.RPC})),n.d(t,"API_VERSION",(function(){return i.API_VERSION}));var s=n("./src/utils.js");n.d(t,"loadRequirements",(function(){return s.loadRequirements}));var o=n("./node_modules/socket.io-client/build/esm/index.js"),a=n("./src/main.js");n.d(t,"setupRPC",(function(){return a.setupRPC})),n.d(t,"waitForInitialization",(function(){return a.waitForInitialization}));var c=n("./package.json");n.d(t,"VERSION",(function(){return c.version}));class l extends s.MessageEmitter{constructor(e){super(e&&e.debug),this.config=e||{},this.peer_id=Object(s.randId)()}init(){return new Promise(((e,t)=>{const n=this.config,i=n.server_url,s={};n.token&&(s.Authorization="Bearer "+n.token);const a=new URL(i).pathname,c=Object(o.default)(i,{withCredentials:!0,extraHeaders:s,path:(a.endsWith("/")?a.slice(0,-1):a)+"/socket.io"});let l=!1;c.on("connect",(()=>{l?console.warn("Skipping reconnect to the server"):(c.emit("register_plugin",n,(i=>{if(!i.success)return console.error(i.detail),void t(i.detail);l=!0,this.plugin_id=i.plugin_id,c.on("plugin_message",(e=>{e.peer_id===this.peer_id?this._fire(e.type,e):this.config.debug&&console.log(`connection peer id mismatch ${e.peer_id} !== ${this.peer_id}`)})),this.once("initialize",(()=>{this.rpc?this.rpc.once("remoteReady",(()=>{this.rpc.sendInterface()})):this.rpc=Object(r.connectRPC)(this,n),this.connect(),e()})),this.emit({type:"imjoyRPCReady",config:n,peer_id:this.peer_id})})),this._disconnected=!1)})),c.on("connect_error",(()=>{t("connection error"),this._fire("connectFailure")})),c.on("disconnect",(()=>{t("disconnected"),this.disconnect(),this._fire("disconnected")})),this.socket=c}))}connect(){this.emit({type:"initialized",config:this.config,origin:globalThis.location.origin,peer_id:this.peer_id}),this._fire("connected")}reset(){this._event_handlers={},this._once_handlers={}}execute(){throw new Error("Execution is not allowed for socketio connection")}disconnect(){this._fire("beforeDisconnect"),this.socket.disconnect(),this.init(),this._fire("disconnected")}emit(e){e.plugin_id=this.plugin_id,this.socket.emit("plugin_message",e,(t=>{t.success||this._fire("error",e.detail)}))}}function u(e){if(!(e=e||{}).server_url)throw new Error("Server URL is not specified.");return e.name=e.name||Object(s.randId)(),e=Object(s.normalizeConfig)(e),new Promise(((t,n)=>{const r=n=>{const i=n.detail;e.expose_api_globally&&(globalThis.api=i),t(i),globalThis.removeEventListener("imjoy_remote_api_ready",r)};globalThis.addEventListener("imjoy_remote_api_ready",r),(e=e||{}).dedicated_thread=!1,e.lang="javascript",e.api_version=i.API_VERSION,new l(e).init().catch(n)}))}},"./src/utils.js":function(module,__nested_webpack_exports__,__nested_webpack_require_333274__){function randId(){return Math.random().toString(36).substr(2,10)+(new Date).getTime()}__nested_webpack_require_333274__.r(__nested_webpack_exports__),__nested_webpack_require_333274__.d(__nested_webpack_exports__,"randId",(function(){return randId})),__nested_webpack_require_333274__.d(__nested_webpack_exports__,"dtypeToTypedArray",(function(){return dtypeToTypedArray})),__nested_webpack_require_333274__.d(__nested_webpack_exports__,"loadRequirementsInWindow",(function(){return loadRequirementsInWindow})),__nested_webpack_require_333274__.d(__nested_webpack_exports__,"loadRequirementsInWebworker",(function(){return loadRequirementsInWebworker})),__nested_webpack_require_333274__.d(__nested_webpack_exports__,"loadRequirements",(function(){return loadRequirements})),__nested_webpack_require_333274__.d(__nested_webpack_exports__,"normalizeConfig",(function(){return normalizeConfig})),__nested_webpack_require_333274__.d(__nested_webpack_exports__,"typedArrayToDtypeMapping",(function(){return typedArrayToDtypeMapping})),__nested_webpack_require_333274__.d(__nested_webpack_exports__,"typedArrayToDtype",(function(){return typedArrayToDtype})),__nested_webpack_require_333274__.d(__nested_webpack_exports__,"cacheRequirements",(function(){return cacheRequirements})),__nested_webpack_require_333274__.d(__nested_webpack_exports__,"setupServiceWorker",(function(){return setupServiceWorker})),__nested_webpack_require_333274__.d(__nested_webpack_exports__,"urlJoin",(function(){return urlJoin})),__nested_webpack_require_333274__.d(__nested_webpack_exports__,"MessageEmitter",(function(){return MessageEmitter}));const dtypeToTypedArray={int8:Int8Array,int16:Int16Array,int32:Int32Array,uint8:Uint8Array,uint16:Uint16Array,uint32:Uint32Array,float32:Float32Array,float64:Float64Array,array:Array};async function loadRequirementsInWindow(e){function t(e){return new Promise(((t,n)=>{var r=document.createElement("script");r.src=e,r.type="text/javascript",r.onload=t,r.onreadystatechange=function(){"loaded"!==this.readyState&&"complete"!==this.readyState||t()},r.onerror=n,document.head.appendChild(r)}))}async function n(){for(var e=Array.prototype.slice.call(arguments),n=e.length,r=0;r<n;r++)await t(e[r])}if(e&&(Array.isArray(e)||"string"==typeof e))try{var r;if(e="string"==typeof e?[e]:e,!Array.isArray(e))throw"unsupported requirements definition";for(var i=0;i<e.length;i++)e[i].toLowerCase().endsWith(".css")||e[i].startsWith("css:")?(e[i].startsWith("css:")&&(e[i]=e[i].slice(4)),(r=document.createElement("link")).rel="stylesheet",r.href=e[i],document.head.appendChild(r)):e[i].toLowerCase().endsWith(".mjs")||e[i].startsWith("mjs:")?(e[i].startsWith("mjs:")&&(e[i]=e[i].slice(4)),await import(e[i])):e[i].toLowerCase().endsWith(".js")||e[i].startsWith("js:")?(e[i].startsWith("js:")&&(e[i]=e[i].slice(3)),await n(e[i])):e[i].startsWith("http")?await n(e[i]):e[i].startsWith("cache:")||console.log("Unprocessed requirements url: "+e[i])}catch(t){throw"failed to import required scripts: "+e.toString()}}async function loadRequirementsInWebworker(e){if(e&&(Array.isArray(e)||"string"==typeof e))try{Array.isArray(e)||(e=[e]);for(var t=0;t<e.length;t++){if(e[t].toLowerCase().endsWith(".css")||e[t].startsWith("css:"))throw"unable to import css in a webworker";e[t].toLowerCase().endsWith(".js")||e[t].startsWith("js:")?(e[t].startsWith("js:")&&(e[t]=e[t].slice(3)),importScripts(e[t])):e[t].startsWith("http")?importScripts(e[t]):e[t].startsWith("cache:")||console.log("Unprocessed requirements url: "+e[t])}}catch(t){throw"failed to import required scripts: "+e.toString()}}function loadRequirements(e){return"undefined"!=typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope?loadRequirementsInWebworker(e):loadRequirementsInWindow(e)}function normalizeConfig(e){return e.version=e.version||"0.1.0",e.description=e.description||`[TODO: add description for ${e.name} ]`,e.type=e.type||"rpc-window",e.id=e.id||randId(),e.target_origin=e.target_origin||"*",e.allow_execution=e.allow_execution||!1,e=Object.keys(e).reduce(((t,n)=>("function"!=typeof e[n]&&(t[n]=e[n]),t)),{})}const typedArrayToDtypeMapping={Int8Array:"int8",Int16Array:"int16",Int32Array:"int32",Uint8Array:"uint8",Uint16Array:"uint16",Uint32Array:"uint32",Float32Array:"float32",Float64Array:"float64",Array:"array"},typedArrayToDtypeKeys=[];for(const arrType of Object.keys(typedArrayToDtypeMapping))typedArrayToDtypeKeys.push(eval(arrType));function typedArrayToDtype(e){let t=typedArrayToDtypeMapping[e.constructor.name];if(!t){const n=Object.getPrototypeOf(e);for(const e of typedArrayToDtypeKeys)if(n instanceof e){t=typedArrayToDtypeMapping[e.name];break}}return t}function cacheUrlInServiceWorker(e){return new Promise((function(t,n){const r={command:"add",url:e};if(!navigator.serviceWorker||!navigator.serviceWorker.register)return void n("Service worker is not supported.");const i=new MessageChannel;i.port1.onmessage=function(e){e.data&&e.data.error?n(e.data.error):t(e.data&&e.data.result)},navigator.serviceWorker&&navigator.serviceWorker.controller?navigator.serviceWorker.controller.postMessage(r,[i.port2]):n("Service worker controller is not available")}))}async function cacheRequirements(e){e=e||[],Array.isArray(e)||(e=[e]);for(let t of e)t.startsWith("js:")&&(t=t.slice(3)),t.startsWith("css:")&&(t=t.slice(4)),t.startsWith("cache:")&&(t=t.slice(6)),t.startsWith("http")&&await cacheUrlInServiceWorker(t).catch((e=>{console.error(e)}))}function setupServiceWorker(e,t,n){if("serviceWorker"in navigator){if(e=e||"/",navigator.serviceWorker.register(e+"plugin-service-worker.js").then((function(e){console.log("ServiceWorker registration successful with scope: ",e.scope)}),(function(e){console.log("ServiceWorker registration failed: ",e)})),t=t||"*",(n=n||cacheRequirements)&&"function"!=typeof n)throw new Error("config.cache_requirements must be a function");window.addEventListener("message",(function(e){if("*"===t||e.origin===t){const t=e.data;"cacheRequirements"===t.type&&n(t.requirements)}}))}}function urlJoin(...e){return e.join("/").replace(/[\/]+/g,"/").replace(/^(.+):\//,"$1://").replace(/^file:/,"file:/").replace(/\/(\?|&|#[^!])/g,"$1").replace(/\?/g,"&").replace("&","?")}class MessageEmitter{constructor(e){this._event_handlers={},this._once_handlers={},this._debug=e}emit(){throw new Error("emit is not implemented")}on(e,t){this._event_handlers[e]||(this._event_handlers[e]=[]),this._event_handlers[e].push(t)}once(e,t){t.___event_run_once=!0,this.on(e,t)}off(e,t){if(e||t){if(e&&!t)this._event_handlers[e]&&(this._event_handlers[e]=[]);else if(this._event_handlers[e]){const n=this._event_handlers[e].indexOf(t);n>=0&&this._event_handlers[e].splice(n,1)}}else this._event_handlers={}}_fire(e,t){if(this._event_handlers[e])for(var n=this._event_handlers[e].length;n--;){const r=this._event_handlers[e][n];try{r(t)}catch(e){console.error(e)}finally{r.___event_run_once&&this._event_handlers[e].splice(n,1)}}else this._debug&&console.warn("unhandled event",e,t)}}}})},module.exports=factory()},800:function(module){var factory;factory=function(){return function(e){var t={};function n(r){if(t[r])return t[r].exports;var i=t[r]={i:r,l:!1,exports:{}};return e[r].call(i.exports,i,i.exports,n),i.l=!0,i.exports}return n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)n.d(r,i,function(t){return e[t]}.bind(null,i));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s="./src/main.js")}({"./node_modules/worker-loader/dist/workers/InlineWorker.js":function(e,t,n){var r=window.URL||window.webkitURL;e.exports=function(e,t){try{try{var n;try{(n=new(window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder)).append(e),n=n.getBlob()}catch(t){n=new Blob([e])}return new Worker(r.createObjectURL(n))}catch(t){return new Worker("data:application/javascript,"+encodeURIComponent(e))}}catch(e){if(!t)throw Error("Inline worker is not supported");return new Worker(t)}}},"./package.json":function(e){e.exports=JSON.parse('{"name":"imjoy-rpc","version":"0.5.59","description":"Remote procedure calls for ImJoy.","module":"index.js","types":"index.d.ts","scripts":{"build":"rm -rf dist && npm run build-umd","build-umd":"webpack --config webpack.config.js --mode development && NODE_ENV=production webpack --config webpack.config.js --mode production --devtool source-map ","watch":"NODE_ENV=production webpack --watch --progress --config webpack.config.js --mode production --devtool source-map","publish-npm":"npm install && npm run build && npm publish","serve":"webpack-dev-server","stats":"webpack --profile --json > stats.json","stats-prod":"webpack --profile --json --mode production > stats-prod.json","analyze":"webpack-bundle-analyzer -p 9999 stats.json","analyze-prod":"webpack-bundle-analyzer -p 9999 stats-prod.json","clean":"rimraf dist/*","deploy":"npm run build && node deploy-site.js","format":"prettier --write \\"{src,tests}/**/**\\"","check-format":"prettier --check \\"{src,tests}/**/**\\"","test":"karma start --single-run --browsers ChromeHeadless,FirefoxHeadless karma.conf.js","test-watch":"karma start --auto-watch --browsers ChromeDebugging karma.conf.js --debug"},"repository":{"type":"git","url":"git+https://github.com/imjoy-team/imjoy-rpc.git"},"keywords":["imjoy","rpc"],"author":"imjoy-team <imjoy.team@gmail.com>","license":"MIT","bugs":{"url":"https://github.com/imjoy-team/imjoy-rpc/issues"},"homepage":"https://github.com/imjoy-team/imjoy-rpc","dependencies":{"@msgpack/msgpack":"^2.7.1","socket.io-client":"^4.6.2"},"devDependencies":{"@babel/core":"^7.16.12","@babel/plugin-syntax-dynamic-import":"^7.8.3","@babel/polyfill":"^7.12.1","@babel/preset-env":"^7.16.11","@types/requirejs":"^2.1.34","babel-core":"^6.26.0","babel-eslint":"^10.1.0","babel-loader":"^8.2.3","babel-runtime":"^6.26.0","chai":"^4.3.6","clean-webpack-plugin":"^0.1.19","copy-webpack-plugin":"^5.1.2","eslint":"^6.8.0","eslint-config-prettier":"^4.2.0","eslint-loader":"^4.0.2","file-loader":"^0.11.2","fs-extra":"^0.30.0","gh-pages":"^2.0.1","html-loader":"^0.5.5","html-webpack-plugin":"^3.2.0","json-loader":"^0.5.4","karma":"^6.3.12","karma-chrome-launcher":"^3.1.0","karma-firefox-launcher":"^1.3.0","karma-mocha":"^2.0.1","karma-sourcemap-loader":"^0.3.8","karma-spec-reporter":"0.0.32","karma-webpack":"^4.0.2","lerna":"^6.0.3","lodash.debounce":"^4.0.8","mocha":"^10.1.0","postcss":"^7.0.36","prettier":"^1.6.1","rimraf":"^2.6.2","schema-utils":"^0.4.3","style-loader":"^0.18.1","ts-loader":"^9.4.3","url-loader":"^0.5.9","webpack":"^4.46.0","webpack-bundle-analyzer":"^4.7.0","webpack-cli":"^3.3.12","webpack-dev-server":"^3.11.3","webpack-merge":"^4.1.1","workbox-webpack-plugin":"^4.3.1","worker-loader":"^2.0.0","write-file-webpack-plugin":"^4.5.1"},"eslintConfig":{"globals":{"document":true,"window":true}}}')},"./src/main.js":function(e,t,n){n.r(t),n.d(t,"waitForInitialization",(function(){return u})),n.d(t,"setupRPC",(function(){return d}));var r=n("./src/plugin.webworker.js"),i=n.n(r),s=n("./src/pluginIframe.js"),o=n("./src/utils.js");n.d(t,"loadRequirements",(function(){return o.loadRequirements}));var a=n("./src/rpc.js");n.d(t,"RPC",(function(){return a.RPC})),n.d(t,"API_VERSION",(function(){return a.API_VERSION}));var c=n("./package.json");function l(){return"undefined"!=typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope}function u(e){l()&&(globalThis.parent=self),(e=e||{}).enable_service_worker&&(Object(o.setupServiceWorker)(e.base_url,e.target_origin,e.cache_requirements),e.enable_service_worker=!1),e.cache_requirements&&delete e.cache_requirements;const t=e.target_origin||"*";if(e.credential_required&&"function"!=typeof e.verify_credential)throw new Error("Please also provide the `verify_credential` function with `credential_required`.");if(e.credential_required&&"*"===t)throw new Error("`target_origin` was set to `*` with `credential_required=true`, there is a security risk that you may leak the credential to website from other origin. Please specify the `target_origin` explicitly.");const n=Object(o.randId)(),r=i=>{if("message"===i.type&&(!i.origin||"*"===t||i.origin===t)){if("initialize"!==i.data.type)throw new Error(`unrecognized message: ${i.data}`);{globalThis.removeEventListener("message",r),i.data.peer_id!==n&&console.warn(`${i.data.config&&i.data.config.name}: connection peer id mismatch ${i.data.peer_id} !== ${n}`);const s=i.data.config;"*"!==t&&(s.target_origin=t),e.credential_required?e.verify_credential(s.credential).then((e=>{if(!e||!e.auth||e.error)throw new Error("Failed to verify the credentail:"+(e&&e.error));s.auth=e.auth,d(s).then((()=>{console.log("ImJoy RPC loaded successfully!")}))})):d(s).then((()=>{console.log("ImJoy RPC loaded successfully!")}))}}};globalThis.addEventListener("message",r),l()?parent.postMessage({type:"imjoyRPCReady",config:e,peer_id:n}):parent.postMessage({type:"imjoyRPCReady",config:e,peer_id:n},"*")}function d(e){return(e=e||{}).name=e.name||Object(o.randId)(),(e=Object(o.normalizeConfig)(e)).enable_service_worker&&Object(o.setupServiceWorker)(e.base_url,e.target_origin,e.cache_requirements),e.cache_requirements&&delete e.cache_requirements,new Promise(((t,n)=>{const r=n=>{const i=n.detail;e.expose_api_globally&&(globalThis.api=i),t(i),globalThis.removeEventListener("imjoy_remote_api_ready",r)};if(function(){try{return window.self!==window.top}catch(e){return!0}}()){if("web-worker"===e.type)try{!function(e){if(!e.allow_execution)throw new Error("web-worker plugin can only work with allow_execution=true");let t=null;e.broadcastChannel&&(t=new BroadcastChannel(e.broadcastChannel));const n=new i.a,r=setTimeout((function(){n.terminate(),console.warn("Plugin failed to start as a web-worker, running in an iframe instead."),Object(s.default)(e)}),2e3),a=Object(o.randId)();n.addEventListener("message",(function(i){let s;const o=i.data;if("worker-ready"===o.type)return n.postMessage({type:"connectRPC",config:e}),void clearTimeout(r);"initialized"===o.type?(o.config=Object.assign({},e,o.config),o.origin=globalThis.location.origin,o.peer_id=a):"imjoy_remote_api_ready"===o.type?globalThis.dispatchEvent(new CustomEvent("imjoy_remote_api_ready",{detail:null})):"cacheRequirements"===o.type&&"function"==typeof cache_requirements?cache_requirements(o.requirements):"disconnect"===o.type?n.terminate():o.__transferables__&&(s=o.__transferables__,delete o.__transferables__),t?t.postMessage(o):parent.postMessage(o,e.target_origin||"*",s)})),(t||window).addEventListener("message",(function(r){if("message"===r.type&&(t||"*"===e.target_origin||r.origin===e.target_origin)){let t;const i=r.data;i.__transferables__&&(t=i.__transferables__,delete i.__transferables__),i.peer_id===a?n.postMessage(i,t):e.debug&&console.log(`connection peer id mismatch ${i.peer_id} !== ${a}`)}}))}(e)}catch(t){Object(s.default)(e)}else{if(!["rpc-window","rpc-worker","iframe","window"].includes(e.type))return console.error("Unsupported plugin type: "+e.type),void n("Unsupported plugin type: "+e.type);Object(s.default)(e)}globalThis.addEventListener("imjoy_remote_api_ready",r)}else l()?Object(s.default)(e):n(new Error("imjoy-rpc should only run inside an iframe or a webworker."))}))}n.d(t,"VERSION",(function(){return c.version}))},"./src/plugin.webworker.js":function(e,t,n){e.exports=function(){return n("./node_modules/worker-loader/dist/workers/InlineWorker.js")('/******/ (function(modules) { // webpackBootstrap\n/******/ \t// The module cache\n/******/ \tvar installedModules = {};\n/******/\n/******/ \t// The require function\n/******/ \tfunction __webpack_require__(moduleId) {\n/******/\n/******/ \t\t// Check if module is in cache\n/******/ \t\tif(installedModules[moduleId]) {\n/******/ \t\t\treturn installedModules[moduleId].exports;\n/******/ \t\t}\n/******/ \t\t// Create a new module (and put it into the cache)\n/******/ \t\tvar module = installedModules[moduleId] = {\n/******/ \t\t\ti: moduleId,\n/******/ \t\t\tl: false,\n/******/ \t\t\texports: {}\n/******/ \t\t};\n/******/\n/******/ \t\t// Execute the module function\n/******/ \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n/******/\n/******/ \t\t// Flag the module as loaded\n/******/ \t\tmodule.l = true;\n/******/\n/******/ \t\t// Return the exports of the module\n/******/ \t\treturn module.exports;\n/******/ \t}\n/******/\n/******/\n/******/ \t// expose the modules object (__webpack_modules__)\n/******/ \t__webpack_require__.m = modules;\n/******/\n/******/ \t// expose the module cache\n/******/ \t__webpack_require__.c = installedModules;\n/******/\n/******/ \t// define getter function for harmony exports\n/******/ \t__webpack_require__.d = function(exports, name, getter) {\n/******/ \t\tif(!__webpack_require__.o(exports, name)) {\n/******/ \t\t\tObject.defineProperty(exports, name, { enumerable: true, get: getter });\n/******/ \t\t}\n/******/ \t};\n/******/\n/******/ \t// define __esModule on exports\n/******/ \t__webpack_require__.r = function(exports) {\n/******/ \t\tif(typeof Symbol !== \'undefined\' && Symbol.toStringTag) {\n/******/ \t\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: \'Module\' });\n/******/ \t\t}\n/******/ \t\tObject.defineProperty(exports, \'__esModule\', { value: true });\n/******/ \t};\n/******/\n/******/ \t// create a fake namespace object\n/******/ \t// mode & 1: value is a module id, require it\n/******/ \t// mode & 2: merge all properties of value into the ns\n/******/ \t// mode & 4: return value when already ns object\n/******/ \t// mode & 8|1: behave like require\n/******/ \t__webpack_require__.t = function(value, mode) {\n/******/ \t\tif(mode & 1) value = __webpack_require__(value);\n/******/ \t\tif(mode & 8) return value;\n/******/ \t\tif((mode & 4) && typeof value === \'object\' && value && value.__esModule) return value;\n/******/ \t\tvar ns = Object.create(null);\n/******/ \t\t__webpack_require__.r(ns);\n/******/ \t\tObject.defineProperty(ns, \'default\', { enumerable: true, value: value });\n/******/ \t\tif(mode & 2 && typeof value != \'string\') for(var key in value) __webpack_require__.d(ns, key, function(key) { return value[key]; }.bind(null, key));\n/******/ \t\treturn ns;\n/******/ \t};\n/******/\n/******/ \t// getDefaultExport function for compatibility with non-harmony modules\n/******/ \t__webpack_require__.n = function(module) {\n/******/ \t\tvar getter = module && module.__esModule ?\n/******/ \t\t\tfunction getDefault() { return module[\'default\']; } :\n/******/ \t\t\tfunction getModuleExports() { return module; };\n/******/ \t\t__webpack_require__.d(getter, \'a\', getter);\n/******/ \t\treturn getter;\n/******/ \t};\n/******/\n/******/ \t// Object.prototype.hasOwnProperty.call\n/******/ \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n/******/\n/******/ \t// __webpack_public_path__\n/******/ \t__webpack_require__.p = "";\n/******/\n/******/\n/******/ \t// Load entry module and return exports\n/******/ \treturn __webpack_require__(__webpack_require__.s = "./src/plugin.webworker.js");\n/******/ })\n/************************************************************************/\n/******/ ({\n\n/***/ "./src/plugin.webworker.js":\n/*!*********************************!*\\\n  !*** ./src/plugin.webworker.js ***!\n  \\*********************************/\n/*! no exports provided */\n/***/ (function(module, __webpack_exports__, __webpack_require__) {\n\n"use strict";\n__webpack_require__.r(__webpack_exports__);\n/* harmony import */ var _pluginCore_js__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./pluginCore.js */ "./src/pluginCore.js");\n/* harmony import */ var _rpc_js__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./rpc.js */ "./src/rpc.js");\n/* harmony import */ var _utils_js__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ./utils.js */ "./src/utils.js");\n/**\n * Contains the routines loaded by the plugin Worker under web-browser.\n *\n * Initializes the web environment version of the platform-dependent\n * connection object for the plugin site\n */\n\n\n\n\n// make sure this runs inside a webworker\nif (\n  typeof WorkerGlobalScope === "undefined" ||\n  !self ||\n  !(self instanceof WorkerGlobalScope)\n) {\n  throw new Error("This script can only loaded in a webworker");\n}\n\nasync function executeEsModule(content) {\n  const dataUri =\n    "data:text/javascript;charset=utf-8," + encodeURIComponent(content);\n  await import(/* webpackIgnore: true */ dataUri);\n}\n\n/**\n * Connection object provided to the RPC constructor,\n * plugin site implementation for the web-based environment.\n * Global will be then cleared to prevent exposure into the\n * Worker, so we put this local connection object into a closure\n */\nclass Connection extends _utils_js__WEBPACK_IMPORTED_MODULE_2__["MessageEmitter"] {\n  constructor(config) {\n    super(config && config.debug);\n    this.config = config || {};\n  }\n  connect() {\n    self.addEventListener("message", e => {\n      this._fire(e.data.type, e.data);\n    });\n    this.emit({\n      type: "initialized",\n      config: this.config\n    });\n  }\n  disconnect() {\n    this._fire("beforeDisconnect");\n    self.close();\n    this._fire("disconnected");\n  }\n  emit(data) {\n    let transferables = undefined;\n    if (data.__transferables__) {\n      transferables = data.__transferables__;\n      delete data.__transferables__;\n    }\n    self.postMessage(data, transferables);\n  }\n  async execute(code) {\n    if (code.type === "requirements") {\n      await Object(_utils_js__WEBPACK_IMPORTED_MODULE_2__["loadRequirementsInWebworker"])(code.requirements);\n    } else if (code.type === "script") {\n      try {\n        if (code.attrs.type === "module") {\n          await executeEsModule(code.content);\n        } else {\n          eval(code.content);\n        }\n      } catch (e) {\n        console.error(e.message, e.stack);\n        throw e;\n      }\n    } else {\n      throw "unsupported code type.";\n    }\n    if (code.type === "requirements") {\n      self.postMessage({\n        type: "cacheRequirements",\n        requirements: code.requirements\n      });\n    }\n  }\n}\nconst config = {\n  type: "web-worker",\n  dedicated_thread: true,\n  allow_execution: true,\n  lang: "javascript",\n  api_version: _rpc_js__WEBPACK_IMPORTED_MODULE_1__["API_VERSION"]\n};\nconst conn = new Connection(config);\nconn.on("connectRPC", data => {\n  Object(_pluginCore_js__WEBPACK_IMPORTED_MODULE_0__["connectRPC"])(conn, Object.assign(data.config, config));\n});\nconn.connect();\nself.postMessage({\n  type: "worker-ready"\n});\n\n\n/***/ }),\n\n/***/ "./src/pluginCore.js":\n/*!***************************!*\\\n  !*** ./src/pluginCore.js ***!\n  \\***************************/\n/*! exports provided: connectRPC */\n/***/ (function(module, __webpack_exports__, __webpack_require__) {\n\n"use strict";\n__webpack_require__.r(__webpack_exports__);\n/* harmony export (binding) */ __webpack_require__.d(__webpack_exports__, "connectRPC", function() { return connectRPC; });\n/* harmony import */ var _rpc_js__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./rpc.js */ "./src/rpc.js");\n/**\n * Core plugin script loaded into the plugin process/thread.\n *\n * Initializes the plugin-site API global methods.\n */\n\nfunction connectRPC(connection, config) {\n  config = config || {};\n  const codecs = {};\n  const rpc = new _rpc_js__WEBPACK_IMPORTED_MODULE_0__["RPC"](connection, config, codecs);\n  rpc.on("getInterface", function () {\n    launchConnected();\n  });\n  rpc.on("remoteReady", function () {\n    const api = rpc.getRemote() || {};\n\n    api.registerCodec = function (config) {\n      if (!config["name"] || !config["encoder"] && !config["decoder"]) {\n        throw new Error("Invalid codec format, please make sure you provide a name, type, encoder and decoder.");\n      } else {\n        if (config.type) {\n          for (let k of Object.keys(codecs)) {\n            if (codecs[k].type === config.type || k === config.name) {\n              delete codecs[k];\n              console.warn("Remove duplicated codec: " + k);\n            }\n          }\n        }\n\n        codecs[config["name"]] = config;\n      }\n    };\n\n    api.init = function (config) {\n      // register a minimal plugin api\n      rpc.setInterface({\n        setup() {}\n\n      }, config);\n    };\n\n    api.disposeObject = function (obj) {\n      rpc.disposeObject(obj);\n    };\n\n    api.export = function (_interface, config) {\n      rpc.setInterface(_interface, config);\n    };\n\n    api.onLoad = function (handler) {\n      handler = checkHandler(handler);\n\n      if (connected) {\n        handler();\n      } else {\n        connectedHandlers.push(handler);\n      }\n    };\n\n    api.dispose = function (_interface) {\n      rpc.disconnect();\n    };\n\n    api._rpc = rpc;\n\n    if (typeof WorkerGlobalScope !== "undefined" && self instanceof WorkerGlobalScope) {\n      self.api = api;\n      self.postMessage({\n        type: "imjoy_remote_api_ready"\n      });\n      self.dispatchEvent(new CustomEvent("imjoy_remote_api_ready", {\n        detail: api\n      }));\n    } else if (typeof window) {\n      window.dispatchEvent(new CustomEvent("imjoy_remote_api_ready", {\n        detail: api\n      }));\n    }\n  });\n  let connected = false;\n  const connectedHandlers = [];\n\n  const launchConnected = function () {\n    if (!connected) {\n      connected = true;\n      let handler;\n\n      while (handler = connectedHandlers.pop()) {\n        handler();\n      }\n    }\n  };\n\n  const checkHandler = function (handler) {\n    const type = typeof handler;\n\n    if (type !== "function") {\n      const msg = "A function may only be subsribed to the event, " + type + " was provided instead";\n      throw new Error(msg);\n    }\n\n    return handler;\n  };\n\n  return rpc;\n}\n\n/***/ }),\n\n/***/ "./src/rpc.js":\n/*!********************!*\\\n  !*** ./src/rpc.js ***!\n  \\********************/\n/*! exports provided: API_VERSION, RPC */\n/***/ (function(module, __webpack_exports__, __webpack_require__) {\n\n"use strict";\n__webpack_require__.r(__webpack_exports__);\n/* harmony export (binding) */ __webpack_require__.d(__webpack_exports__, "API_VERSION", function() { return API_VERSION; });\n/* harmony export (binding) */ __webpack_require__.d(__webpack_exports__, "RPC", function() { return RPC; });\n/* harmony import */ var _utils_js__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./utils.js */ "./src/utils.js");\n/**\n * Contains the RPC object used both by the application\n * site, and by each plugin\n */\n\nconst API_VERSION = "0.2.3";\nconst ArrayBufferView = Object.getPrototypeOf(Object.getPrototypeOf(new Uint8Array())).constructor;\n\nfunction _appendBuffer(buffer1, buffer2) {\n  const tmp = new Uint8Array(buffer1.byteLength + buffer2.byteLength);\n  tmp.set(new Uint8Array(buffer1), 0);\n  tmp.set(new Uint8Array(buffer2), buffer1.byteLength);\n  return tmp.buffer;\n}\n\nfunction indexObject(obj, is) {\n  if (!is) throw new Error("undefined index");\n  if (typeof is === "string") return indexObject(obj, is.split("."));else if (is.length === 0) return obj;else return indexObject(obj[is[0]], is.slice(1));\n}\n/**\n * RPC object represents a single site in the\n * communication protocol between the application and the plugin\n *\n * @param {Object} connection a special object allowing to send\n * and receive messages from the opposite site (basically it\n * should only provide send() and onMessage() methods)\n */\n\n\nclass RPC extends _utils_js__WEBPACK_IMPORTED_MODULE_0__["MessageEmitter"] {\n  constructor(connection, config, codecs) {\n    super(config && config.debug);\n    this._connection = connection;\n    this.config = config || {};\n    this._codecs = codecs || {};\n    this._object_store = {};\n    this._method_weakmap = new WeakMap();\n    this._object_weakmap = new WeakMap();\n    this._local_api = null;\n    this._remote_set = false; // make sure there is an execute function\n\n    const name = this.config.name;\n\n    this._connection.execute = this._connection.execute || function () {\n      throw new Error(`connection.execute not implemented (in "${name}")`);\n    };\n\n    this._store = new ReferenceStore();\n    this._method_refs = new ReferenceStore();\n\n    this._method_refs.onReady(() => {\n      this._fire("remoteIdle");\n    });\n\n    this._method_refs.onBusy(() => {\n      this._fire("remoteBusy");\n    });\n\n    this._setupMessageHanlders();\n  }\n\n  init() {\n    this._connection.emit({\n      type: "initialized",\n      config: this.config,\n      peer_id: this._connection.peer_id\n    });\n  }\n\n  setConfig(config) {\n    if (config) for (const k of Object.keys(config)) {\n      this.config[k] = config[k];\n    }\n  }\n  /**\n   * Set a handler to be called when received a responce from the\n   * remote site reporting that the previously provided interface\n   * has been successfully set as remote for that site\n   *\n   * @param {Function} handler\n   */\n\n\n  getRemoteCallStack() {\n    return this._method_refs.getStack();\n  }\n  /**\n   * @returns {Object} set of remote interface methods\n   */\n\n\n  getRemote() {\n    return this._remote_interface;\n  }\n  /**\n   * Sets the interface of this site making it available to the\n   * remote site by sending a message with a set of methods names\n   *\n   * @param {Object} _interface to set\n   */\n\n\n  setInterface(_interface, config) {\n    config = config || {};\n    this.config.name = config.name || this.config.name;\n    this.config.description = config.description || this.config.description;\n\n    if (this.config.forwarding_functions) {\n      for (let func_name of this.config.forwarding_functions) {\n        const _remote = this._remote_interface;\n\n        if (_remote[func_name]) {\n          if (_interface.constructor === Object) {\n            if (!_interface[func_name]) {\n              _interface[func_name] = (...args) => {\n                _remote[func_name](...args);\n              };\n            }\n          } else if (_interface.constructor.constructor === Function) {\n            if (!_interface.constructor.prototype[func_name]) {\n              _interface.constructor.prototype[func_name] = (...args) => {\n                _remote[func_name](...args);\n              };\n            }\n          }\n        }\n      }\n    }\n\n    this._local_api = _interface;\n    if (!this._remote_set) this._fire("interfaceAvailable");else this.sendInterface();\n    return new Promise(resolve => {\n      this.once("interfaceSetAsRemote", resolve);\n    });\n  }\n  /**\n   * Sends the actual interface to the remote site upon it was\n   * updated or by a special request of the remote site\n   */\n\n\n  sendInterface() {\n    if (!this._local_api) {\n      throw new Error("interface is not set.");\n    }\n\n    this._encode(this._local_api, true).then(api => {\n      this._connection.emit({\n        type: "setInterface",\n        api: api\n      });\n    });\n  }\n\n  _disposeObject(objectId) {\n    if (this._object_store[objectId]) {\n      delete this._object_store[objectId];\n    } else {\n      throw new Error(`Object (id=${objectId}) not found.`);\n    }\n  }\n\n  disposeObject(obj) {\n    return new Promise((resolve, reject) => {\n      if (this._object_weakmap.has(obj)) {\n        const objectId = this._object_weakmap.get(obj);\n\n        this._connection.once("disposed", data => {\n          if (data.error) reject(new Error(data.error));else resolve();\n        });\n\n        this._connection.emit({\n          type: "disposeObject",\n          object_id: objectId\n        });\n      } else {\n        throw new Error("Invalid object");\n      }\n    });\n  }\n  /**\n   * Handles a message from the remote site\n   */\n\n\n  _setupMessageHanlders() {\n    this._connection.on("init", this.init);\n\n    this._connection.on("execute", data => {\n      Promise.resolve(this._connection.execute(data.code)).then(() => {\n        this._connection.emit({\n          type: "executed"\n        });\n      }).catch(e => {\n        console.error(e);\n\n        this._connection.emit({\n          type: "executed",\n          error: String(e)\n        });\n      });\n    });\n\n    this._connection.on("method", async data => {\n      let resolve, reject, method, method_this, args, result;\n\n      try {\n        if (data.promise) {\n          [resolve, reject] = await this._unwrap(data.promise, false);\n        }\n\n        const _interface = this._object_store[data.object_id];\n        method = indexObject(_interface, data.name);\n\n        if (data.name.includes(".")) {\n          const tmp = data.name.split(".");\n          const intf_index = tmp.slice(0, tmp.length - 1).join(".");\n          method_this = indexObject(_interface, intf_index);\n        } else {\n          method_this = _interface;\n        }\n\n        args = await this._unwrap(data.args, true);\n\n        if (data.promise) {\n          result = method.apply(method_this, args);\n\n          if (result instanceof Promise || method.constructor && method.constructor.name === "AsyncFunction") {\n            result.then(resolve).catch(reject);\n          } else {\n            resolve(result);\n          }\n        } else {\n          method.apply(method_this, args);\n        }\n      } catch (err) {\n        console.error(this.config.name, err);\n\n        if (reject) {\n          reject(err);\n        }\n      }\n    });\n\n    this._connection.on("callback", async data => {\n      let resolve, reject, method, args, result;\n\n      try {\n        if (data.promise) {\n          [resolve, reject] = await this._unwrap(data.promise, false);\n        }\n\n        if (data.promise) {\n          method = this._store.fetch(data.id);\n          args = await this._unwrap(data.args, true);\n\n          if (!method) {\n            throw new Error("Callback function can only called once, if you want to call a function for multiple times, please make it as a plugin api function. See https://imjoy.io/docs for more details.");\n          }\n\n          result = method.apply(null, args);\n\n          if (result instanceof Promise || method.constructor && method.constructor.name === "AsyncFunction") {\n            result.then(resolve).catch(reject);\n          } else {\n            resolve(result);\n          }\n        } else {\n          method = this._store.fetch(data.id);\n          args = await this._unwrap(data.args, true);\n\n          if (!method) {\n            throw new Error("Please notice that callback function can only called once, if you want to call a function for multiple times, please make it as a plugin api function. See https://imjoy.io/docs for more details.");\n          }\n\n          method.apply(null, args);\n        }\n      } catch (err) {\n        console.error(this.config.name, err);\n\n        if (reject) {\n          reject(err);\n        }\n      }\n    });\n\n    this._connection.on("disposeObject", data => {\n      try {\n        this._disposeObject(data.object_id);\n\n        this._connection.emit({\n          type: "disposed"\n        });\n      } catch (e) {\n        console.error(e);\n\n        this._connection.emit({\n          type: "disposed",\n          error: String(e)\n        });\n      }\n    });\n\n    this._connection.on("setInterface", data => {\n      this._setRemoteInterface(data.api);\n    });\n\n    this._connection.on("getInterface", () => {\n      this._fire("getInterface");\n\n      if (this._local_api) {\n        this.sendInterface();\n      } else {\n        this.once("interfaceAvailable", () => {\n          this.sendInterface();\n        });\n      }\n    });\n\n    this._connection.on("interfaceSetAsRemote", () => {\n      this._remote_set = true;\n\n      this._fire("interfaceSetAsRemote");\n    });\n\n    this._connection.on("disconnect", () => {\n      this._fire("beforeDisconnect");\n\n      this._connection.disconnect();\n\n      this._fire("disconnected");\n    });\n  }\n  /**\n   * Sends a requests to the remote site asking it to provide its\n   * current interface\n   */\n\n\n  requestRemote() {\n    this._connection.emit({\n      type: "getInterface"\n    });\n  }\n\n  _ndarray(typedArray, shape, dtype) {\n    const _dtype = Object(_utils_js__WEBPACK_IMPORTED_MODULE_0__["typedArrayToDtype"])(typedArray);\n\n    if (dtype && dtype !== _dtype) {\n      throw "dtype doesn\'t match the type of the array: " + _dtype + " != " + dtype;\n    }\n\n    shape = shape || [typedArray.length];\n    return {\n      _rtype: "ndarray",\n      _rvalue: typedArray.buffer,\n      _rshape: shape,\n      _rdtype: _dtype\n    };\n  }\n  /**\n   * Sets the new remote interface provided by the other site\n   *\n   * @param {Array} names list of function names\n   */\n\n\n  _setRemoteInterface(api) {\n    this._decode(api).then(intf => {\n      // update existing interface instead of recreating it\n      // this will preserve the object reference\n      if (this._remote_interface) {\n        // clear the interface\n        for (let k in this._remote_interface) delete this._remote_interface[k]; // then assign the new interfaces\n\n\n        Object.assign(this._remote_interface, intf);\n      } else this._remote_interface = intf;\n\n      this._fire("remoteReady");\n\n      this._reportRemoteSet();\n    });\n  }\n  /**\n   * Generates the wrapped function corresponding to a single remote\n   * method. When the generated function is called, it will send the\n   * corresponding message to the remote site asking it to execute\n   * the particular method of its interface\n   *\n   * @param {String} name of the remote method\n   *\n   * @returns {Function} wrapped remote method\n   */\n\n\n  _genRemoteMethod(targetId, name, objectId) {\n    const me = this;\n\n    const remoteMethod = function () {\n      return new Promise(async (resolve, reject) => {\n        let id = null;\n\n        try {\n          id = me._method_refs.put(objectId ? objectId + "/" + name : name);\n\n          const wrapped_resolve = function () {\n            if (id !== null) me._method_refs.fetch(id);\n            return resolve.apply(this, arguments);\n          };\n\n          const wrapped_reject = function () {\n            if (id !== null) me._method_refs.fetch(id);\n            return reject.apply(this, arguments);\n          };\n\n          const encodedPromise = await me._wrap([wrapped_resolve, wrapped_reject]); // store the key id for removing them from the reference store together\n\n          wrapped_resolve.__promise_pair = encodedPromise[1]._rvalue;\n          wrapped_reject.__promise_pair = encodedPromise[0]._rvalue;\n          let args = Array.prototype.slice.call(arguments);\n          const argLength = args.length; // if the last argument is an object, mark it as kwargs\n\n          const withKwargs = argLength > 0 && typeof args[argLength - 1] === "object" && args[argLength - 1] !== null && args[argLength - 1]._rkwargs;\n          if (withKwargs) delete args[argLength - 1]._rkwargs;\n\n          if (name === "register" || name === "registerService" || name === "register_service" || name === "export" || name === "on") {\n            args = await me._wrap(args, true);\n          } else {\n            args = await me._wrap(args);\n          }\n\n          const transferables = args.__transferables__;\n          if (transferables) delete args.__transferables__;\n\n          me._connection.emit({\n            type: "method",\n            target_id: targetId,\n            name: name,\n            object_id: objectId,\n            args: args,\n            promise: encodedPromise,\n            with_kwargs: withKwargs\n          }, transferables);\n        } catch (e) {\n          if (id) me._method_refs.fetch(id);\n          reject(`Failed to exectue remote method (interface: ${objectId || me.id}, method: ${name}), error: ${e}`);\n        }\n      });\n    };\n\n    remoteMethod.__remote_method = true;\n    return remoteMethod;\n  }\n  /**\n   * Sends a responce reporting that interface just provided by the\n   * remote site was successfully set by this site as remote\n   */\n\n\n  _reportRemoteSet() {\n    this._connection.emit({\n      type: "interfaceSetAsRemote"\n    });\n  }\n  /**\n   * Prepares the provided set of remote method arguments for\n   * sending to the remote site, replaces all the callbacks with\n   * identifiers\n   *\n   * @param {Array} args to wrap\n   *\n   * @returns {Array} wrapped arguments\n   */\n\n\n  async _encode(aObject, asInterface, objectId) {\n    const aType = typeof aObject;\n\n    if (aType === "number" || aType === "string" || aType === "boolean" || aObject === null || aObject === undefined || aObject instanceof ArrayBuffer) {\n      return aObject;\n    }\n\n    let bObject;\n\n    if (typeof aObject === "function") {\n      if (asInterface) {\n        if (!objectId) throw new Error("objectId is not specified.");\n        bObject = {\n          _rtype: "interface",\n          _rtarget_id: this._connection.peer_id,\n          _rintf: objectId,\n          _rvalue: asInterface\n        };\n\n        this._method_weakmap.set(aObject, bObject);\n      } else if (this._method_weakmap.has(aObject)) {\n        bObject = this._method_weakmap.get(aObject);\n      } else {\n        const cid = this._store.put(aObject);\n\n        bObject = {\n          _rtype: "callback",\n          _rtarget_id: this._connection.peer_id,\n          _rname: aObject.constructor && aObject.constructor.name || cid,\n          _rvalue: cid\n        };\n      }\n\n      return bObject;\n    } // skip if already encoded\n\n\n    if (aObject.constructor instanceof Object && aObject._rtype) {\n      // make sure the interface functions are encoded\n      if (aObject._rintf) {\n        const temp = aObject._rtype;\n        delete aObject._rtype;\n        bObject = await this._encode(aObject, asInterface, objectId);\n        bObject._rtype = temp;\n      } else {\n        bObject = aObject;\n      }\n\n      return bObject;\n    }\n\n    const transferables = [];\n    const _transfer = aObject._transfer;\n    const isarray = Array.isArray(aObject);\n\n    for (let tp of Object.keys(this._codecs)) {\n      const codec = this._codecs[tp];\n\n      if (codec.encoder && aObject instanceof codec.type) {\n        // TODO: what if multiple encoders found\n        let encodedObj = await Promise.resolve(codec.encoder(aObject));\n        if (encodedObj && !encodedObj._rtype) encodedObj._rtype = codec.name; // encode the functions in the interface object\n\n        if (encodedObj && encodedObj._rintf) {\n          const temp = encodedObj._rtype;\n          delete encodedObj._rtype;\n          encodedObj = await this._encode(encodedObj, asInterface, objectId);\n          encodedObj._rtype = temp;\n        }\n\n        bObject = encodedObj;\n        return bObject;\n      }\n    }\n\n    if (\n    /*global tf*/\n    typeof tf !== "undefined" && tf.Tensor && aObject instanceof tf.Tensor) {\n      const v_buffer = aObject.dataSync();\n\n      if (aObject._transfer || _transfer) {\n        transferables.push(v_buffer.buffer);\n        delete aObject._transfer;\n      }\n\n      bObject = {\n        _rtype: "ndarray",\n        _rvalue: v_buffer.buffer,\n        _rshape: aObject.shape,\n        _rdtype: aObject.dtype\n      };\n    } else if (\n    /*global nj*/\n    typeof nj !== "undefined" && nj.NdArray && aObject instanceof nj.NdArray) {\n      const dtype = Object(_utils_js__WEBPACK_IMPORTED_MODULE_0__["typedArrayToDtype"])(aObject.selection.data);\n\n      if (aObject._transfer || _transfer) {\n        transferables.push(aObject.selection.data.buffer);\n        delete aObject._transfer;\n      }\n\n      bObject = {\n        _rtype: "ndarray",\n        _rvalue: aObject.selection.data.buffer,\n        _rshape: aObject.shape,\n        _rdtype: dtype\n      };\n    } else if (aObject instanceof Error) {\n      console.error(aObject);\n      bObject = {\n        _rtype: "error",\n        _rvalue: aObject.toString()\n      };\n    } else if (typeof File !== "undefined" && aObject instanceof File) {\n      bObject = {\n        _rtype: "file",\n        _rvalue: aObject,\n        _rpath: aObject._path || aObject.webkitRelativePath\n      };\n    } // send objects supported by structure clone algorithm\n    // https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API/Structured_clone_algorithm\n    else if (aObject !== Object(aObject) || aObject instanceof Boolean || aObject instanceof String || aObject instanceof Date || aObject instanceof RegExp || aObject instanceof ImageData || typeof FileList !== "undefined" && aObject instanceof FileList || typeof FileSystemDirectoryHandle !== "undefined" && aObject instanceof FileSystemDirectoryHandle || typeof FileSystemFileHandle !== "undefined" && aObject instanceof FileSystemFileHandle || typeof FileSystemHandle !== "undefined" && aObject instanceof FileSystemHandle || typeof FileSystemWritableFileStream !== "undefined" && aObject instanceof FileSystemWritableFileStream) {\n      bObject = aObject; // TODO: avoid object such as DynamicPlugin instance.\n    } else if (typeof File !== "undefined" && aObject instanceof File) {\n      bObject = {\n        _rtype: "file",\n        _rname: aObject.name,\n        _rmime: aObject.type,\n        _rvalue: aObject,\n        _rpath: aObject._path || aObject.webkitRelativePath\n      };\n    } else if (aObject instanceof Blob) {\n      bObject = {\n        _rtype: "blob",\n        _rvalue: aObject\n      };\n    } else if (aObject instanceof ArrayBufferView) {\n      if (aObject._transfer || _transfer) {\n        transferables.push(aObject.buffer);\n        delete aObject._transfer;\n      }\n\n      const dtype = Object(_utils_js__WEBPACK_IMPORTED_MODULE_0__["typedArrayToDtype"])(aObject);\n      bObject = {\n        _rtype: "typedarray",\n        _rvalue: aObject.buffer,\n        _rdtype: dtype\n      };\n    } else if (aObject instanceof DataView) {\n      if (aObject._transfer || _transfer) {\n        transferables.push(aObject.buffer);\n        delete aObject._transfer;\n      }\n\n      bObject = {\n        _rtype: "memoryview",\n        _rvalue: aObject.buffer\n      };\n    } else if (aObject instanceof Set) {\n      bObject = {\n        _rtype: "set",\n        _rvalue: await this._encode(Array.from(aObject), asInterface)\n      };\n    } else if (aObject instanceof Map) {\n      bObject = {\n        _rtype: "orderedmap",\n        _rvalue: await this._encode(Array.from(aObject), asInterface)\n      };\n    } else if (aObject.constructor instanceof Object || Array.isArray(aObject)) {\n      bObject = isarray ? [] : {};\n      let keys; // an object/array\n\n      if (aObject.constructor === Object || Array.isArray(aObject)) {\n        keys = Object.keys(aObject);\n      } // a class\n      else if (aObject.constructor === Function) {\n        throw new Error("Please instantiate the class before exportting it.");\n      } // instance of a class\n      else if (aObject.constructor.constructor === Function) {\n        keys = Object.getOwnPropertyNames(Object.getPrototypeOf(aObject)).concat(Object.keys(aObject)); // TODO: use a proxy object to represent the actual object\n        // always encode class instance as interface\n\n        asInterface = true;\n      } else {\n        throw Error("Unsupported interface type");\n      }\n\n      let hasFunction = false; // encode interfaces\n\n      if (aObject._rintf || asInterface) {\n        if (!objectId) {\n          if (typeof aObject._rintf === "string" && aObject._rintf.length > 0) {\n            objectId = aObject._rintf; // enable custom object id\n          } else {\n            objectId = Object(_utils_js__WEBPACK_IMPORTED_MODULE_0__["randId"])();\n          } // Note: object with the same id will be overwritten\n\n\n          if (this._object_store[objectId]) console.warn(`Overwritting interface object with the same id: ${objectId}`);\n          this._object_store[objectId] = aObject;\n        }\n\n        for (let k of keys) {\n          if (k === "constructor") continue;\n\n          if (k.startsWith("_")) {\n            continue;\n          }\n\n          bObject[k] = await this._encode(aObject[k], typeof asInterface === "string" ? asInterface + "." + k : k, objectId);\n\n          if (typeof aObject[k] === "function") {\n            hasFunction = true;\n          }\n        } // object id for dispose the object remotely\n\n\n        if (hasFunction) bObject._rintf = objectId; // remove interface when closed\n\n        if (aObject.on && typeof aObject.on === "function") {\n          aObject.on("close", () => {\n            delete this._object_store[objectId];\n          });\n        }\n      } else {\n        for (let k of keys) {\n          if (["hasOwnProperty", "constructor"].includes(k)) continue;\n          bObject[k] = await this._encode(aObject[k]);\n        }\n      } // for example, browserFS object\n\n    } else if (typeof aObject === "object") {\n      const keys = Object.getOwnPropertyNames(Object.getPrototypeOf(aObject)).concat(Object.keys(aObject));\n      const objectId = Object(_utils_js__WEBPACK_IMPORTED_MODULE_0__["randId"])();\n\n      for (let k of keys) {\n        if (["hasOwnProperty", "constructor"].includes(k)) continue; // encode as interface\n\n        bObject[k] = await this._encode(aObject[k], k, bObject);\n      } // object id, used for dispose the object\n\n\n      bObject._rintf = objectId;\n    } else {\n      throw "imjoy-rpc: Unsupported data type:" + aObject;\n    }\n\n    if (transferables.length > 0) {\n      bObject.__transferables__ = transferables;\n    }\n\n    if (!bObject) {\n      throw new Error("Failed to encode object");\n    }\n\n    return bObject;\n  }\n\n  async _decode(aObject, withPromise) {\n    if (!aObject) {\n      return aObject;\n    }\n\n    let bObject;\n\n    if (aObject["_rtype"]) {\n      if (this._codecs[aObject._rtype] && this._codecs[aObject._rtype].decoder) {\n        if (aObject._rintf) {\n          const temp = aObject._rtype;\n          delete aObject._rtype;\n          aObject = await this._decode(aObject, withPromise);\n          aObject._rtype = temp;\n        }\n\n        bObject = await Promise.resolve(this._codecs[aObject._rtype].decoder(aObject));\n      } else if (aObject._rtype === "callback") {\n        bObject = this._genRemoteCallback(aObject._rtarget_id, aObject._rvalue, withPromise);\n      } else if (aObject._rtype === "interface") {\n        bObject = this._genRemoteMethod(aObject._rtarget_id, aObject._rvalue, aObject._rintf);\n      } else if (aObject._rtype === "ndarray") {\n        /*global nj tf*/\n        //create build array/tensor if used in the plugin\n        if (typeof nj !== "undefined" && nj.array) {\n          if (Array.isArray(aObject._rvalue)) {\n            aObject._rvalue = aObject._rvalue.reduce(_appendBuffer);\n          }\n\n          bObject = nj.array(new Uint8(aObject._rvalue), aObject._rdtype).reshape(aObject._rshape);\n        } else if (typeof tf !== "undefined" && tf.Tensor) {\n          if (Array.isArray(aObject._rvalue)) {\n            aObject._rvalue = aObject._rvalue.reduce(_appendBuffer);\n          }\n\n          const arraytype = _utils_js__WEBPACK_IMPORTED_MODULE_0__["dtypeToTypedArray"][aObject._rdtype];\n          bObject = tf.tensor(new arraytype(aObject._rvalue), aObject._rshape, aObject._rdtype);\n        } else {\n          //keep it as regular if transfered to the main app\n          bObject = aObject;\n        }\n      } else if (aObject._rtype === "error") {\n        bObject = new Error(aObject._rvalue);\n      } else if (aObject._rtype === "file") {\n        if (aObject._rvalue instanceof File) {\n          bObject = aObject._rvalue; //patch _path\n\n          bObject._path = aObject._rpath;\n        } else {\n          bObject = new File([aObject._rvalue], aObject._rname, {\n            type: aObject._rmime\n          });\n          bObject._path = aObject._rpath;\n        }\n      } else if (aObject._rtype === "typedarray") {\n        const arraytype = _utils_js__WEBPACK_IMPORTED_MODULE_0__["dtypeToTypedArray"][aObject._rdtype];\n        if (!arraytype) throw new Error("unsupported dtype: " + aObject._rdtype);\n        bObject = new arraytype(aObject._rvalue);\n      } else if (aObject._rtype === "memoryview") {\n        bObject = new DataView(aObject._rvalue);\n      } else if (aObject._rtype === "blob") {\n        if (aObject._rvalue instanceof Blob) {\n          bObject = aObject._rvalue;\n        } else {\n          bObject = new Blob([aObject._rvalue], {\n            type: aObject._rmime\n          });\n        }\n      } else if (aObject._rtype === "orderedmap") {\n        bObject = new Map(await this._decode(aObject._rvalue, withPromise));\n      } else if (aObject._rtype === "set") {\n        bObject = new Set(await this._decode(aObject._rvalue, withPromise));\n      } else {\n        // make sure all the interface functions are decoded\n        if (aObject._rintf) {\n          const temp = aObject._rtype;\n          delete aObject._rtype;\n          bObject = await this._decode(aObject, withPromise);\n          bObject._rtype = temp;\n        } else bObject = aObject;\n      }\n    } else if (aObject.constructor === Object || Array.isArray(aObject)) {\n      const isarray = Array.isArray(aObject);\n      bObject = isarray ? [] : {};\n\n      for (let k of Object.keys(aObject)) {\n        if (isarray || aObject.hasOwnProperty(k)) {\n          const v = aObject[k];\n          bObject[k] = await this._decode(v, withPromise);\n        }\n      }\n    } else {\n      bObject = aObject;\n    }\n\n    if (bObject === undefined) {\n      throw new Error("Failed to decode object");\n    } // store the object id for dispose\n\n\n    if (aObject._rintf) {\n      this._object_weakmap.set(bObject, aObject._rintf);\n    }\n\n    return bObject;\n  }\n\n  async _wrap(args, asInterface) {\n    return await this._encode(args, asInterface);\n  }\n  /**\n   * Unwraps the set of arguments delivered from the remote site,\n   * replaces all callback identifiers with a function which will\n   * initiate sending that callback identifier back to other site\n   *\n   * @param {Object} args to unwrap\n   *\n   * @param {Boolean} withPromise is true means this the callback should contain a promise\n   *\n   * @returns {Array} unwrapped args\n   */\n\n\n  async _unwrap(args, withPromise) {\n    return await this._decode(args, withPromise);\n  }\n  /**\n   * Generates the wrapped function corresponding to a single remote\n   * callback. When the generated function is called, it will send\n   * the corresponding message to the remote site asking it to\n   * execute the particular callback previously saved during a call\n   * by the remote site a method from the interface of this site\n   *\n   * @param {Number} id of the remote callback to execute\n   * @param {Number} argNum argument index of the callback\n   * @param {Boolean} withPromise is true means this the callback should contain a promise\n   *\n   * @returns {Function} wrapped remote callback\n   */\n\n\n  _genRemoteCallback(targetId, cid, withPromise) {\n    const me = this;\n    let remoteCallback;\n\n    if (withPromise) {\n      remoteCallback = function () {\n        return new Promise(async (resolve, reject) => {\n          const args = await me._wrap(Array.prototype.slice.call(arguments));\n          const argLength = args.length; // if the last argument is an object, mark it as kwargs\n\n          const withKwargs = argLength > 0 && typeof args[argLength - 1] === "object" && args[argLength - 1] !== null && args[argLength - 1]._rkwargs;\n          if (withKwargs) delete args[argLength - 1]._rkwargs;\n          const transferables = args.__transferables__;\n          if (transferables) delete args.__transferables__;\n          const encodedPromise = await me._wrap([resolve, reject]); // store the key id for removing them from the reference store together\n\n          resolve.__promise_pair = encodedPromise[1]._rvalue;\n          reject.__promise_pair = encodedPromise[0]._rvalue;\n\n          try {\n            me._connection.emit({\n              type: "callback",\n              target_id: targetId,\n              id: cid,\n              args: args,\n              promise: encodedPromise,\n              with_kwargs: withKwargs\n            }, transferables);\n          } catch (e) {\n            reject(`Failed to exectue remote callback ( id: ${cid}).`);\n          }\n        });\n      };\n\n      return remoteCallback;\n    } else {\n      remoteCallback = async function () {\n        const args = await me._wrap(Array.prototype.slice.call(arguments));\n        const argLength = args.length; // if the last argument is an object, mark it as kwargs\n\n        const withKwargs = argLength > 0 && typeof args[argLength - 1] === "object" && args[argLength - 1] !== null && args[argLength - 1]._rkwargs;\n        if (withKwargs) delete args[argLength - 1]._rkwargs;\n        const transferables = args.__transferables__;\n        if (transferables) delete args.__transferables__;\n        return me._connection.emit({\n          type: "callback",\n          target_id: targetId,\n          id: cid,\n          args: args,\n          with_kwargs: withKwargs\n        }, transferables);\n      };\n\n      return remoteCallback;\n    }\n  }\n\n  reset() {\n    this._event_handlers = {};\n    this._once_handlers = {};\n    this._remote_interface = null;\n    this._object_store = {};\n    this._method_weakmap = new WeakMap();\n    this._object_weakmap = new WeakMap();\n    this._local_api = null;\n    this._store = new ReferenceStore();\n    this._method_refs = new ReferenceStore();\n  }\n  /**\n   * Sends the notification message and breaks the connection\n   */\n\n\n  disconnect() {\n    this._connection.emit({\n      type: "disconnect"\n    });\n\n    this.reset();\n    setTimeout(() => {\n      this._connection.disconnect();\n    }, 2000);\n  }\n\n}\n/**\n * ReferenceStore is a special object which stores other objects\n * and provides the references (number) instead. This reference\n * may then be sent over a json-based communication channel (IPC\n * to another Node.js process or a message to the Worker). Other\n * site may then provide the reference in the responce message\n * implying the given object should be activated.\n *\n * Primary usage for the ReferenceStore is a storage for the\n * callbacks, which therefore makes it possible to initiate a\n * callback execution by the opposite site (which normally cannot\n * directly execute functions over the communication channel).\n *\n * Each stored object can only be fetched once and is not\n * available for the second time. Each stored object must be\n * fetched, since otherwise it will remain stored forever and\n * consume memory.\n *\n * Stored object indeces are simply the numbers, which are however\n * released along with the objects, and are later reused again (in\n * order to postpone the overflow, which should not likely happen,\n * but anyway).\n */\n\nclass ReferenceStore {\n  constructor() {\n    this._store = {}; // stored object\n\n    this._indices = [0]; // smallest available indices\n\n    this._readyHandler = function () {};\n\n    this._busyHandler = function () {};\n\n    this._readyHandler();\n  }\n  /**\n   * call handler when the store is empty\n   *\n   * @param {FUNCTION} id of a handler\n   */\n\n\n  onReady(readyHandler) {\n    this._readyHandler = readyHandler || function () {};\n  }\n  /**\n   * call handler when the store is not empty\n   *\n   * @param {FUNCTION} id of a handler\n   */\n\n\n  onBusy(busyHandler) {\n    this._busyHandler = busyHandler || function () {};\n  }\n  /**\n   * get the length of the store\n   *\n   */\n\n\n  getStack() {\n    return Object.keys(this._store).length;\n  }\n  /**\n   * @function _genId() generates the new reference id\n   *\n   * @returns {Number} smallest available id and reserves it\n   */\n\n\n  _genId() {\n    let id;\n\n    if (this._indices.length === 1) {\n      id = this._indices[0]++;\n    } else {\n      id = this._indices.shift();\n    }\n\n    return id;\n  }\n  /**\n   * Releases the given reference id so that it will be available by\n   * another object stored\n   *\n   * @param {Number} id to release\n   */\n\n\n  _releaseId(id) {\n    for (let i = 0; i < this._indices.length; i++) {\n      if (id < this._indices[i]) {\n        this._indices.splice(i, 0, id);\n\n        break;\n      }\n    } // cleaning-up the sequence tail\n\n\n    for (let i = this._indices.length - 1; i >= 0; i--) {\n      if (this._indices[i] - 1 === this._indices[i - 1]) {\n        this._indices.pop();\n      } else {\n        break;\n      }\n    }\n  }\n  /**\n   * Stores the given object and returns the refernce id instead\n   *\n   * @param {Object} obj to store\n   *\n   * @returns {Number} reference id of the stored object\n   */\n\n\n  put(obj) {\n    if (this._busyHandler && Object.keys(this._store).length === 0) {\n      this._busyHandler();\n    }\n\n    const id = this._genId();\n\n    this._store[id] = obj;\n    return id;\n  }\n  /**\n   * Retrieves previously stored object and releases its reference\n   *\n   * @param {Number} id of an object to retrieve\n   */\n\n\n  fetch(id) {\n    const obj = this._store[id];\n\n    if (obj && !obj.__remote_method) {\n      delete this._store[id];\n\n      this._releaseId(id);\n\n      if (this._readyHandler && Object.keys(this._store).length === 0) {\n        this._readyHandler();\n      }\n    }\n\n    if (obj && obj.__promise_pair) {\n      this.fetch(obj.__promise_pair);\n    }\n\n    return obj;\n  }\n\n}\n\n/***/ }),\n\n/***/ "./src/utils.js":\n/*!**********************!*\\\n  !*** ./src/utils.js ***!\n  \\**********************/\n/*! exports provided: randId, dtypeToTypedArray, loadRequirementsInWindow, loadRequirementsInWebworker, loadRequirements, normalizeConfig, typedArrayToDtypeMapping, typedArrayToDtype, cacheRequirements, setupServiceWorker, urlJoin, MessageEmitter */\n/***/ (function(module, __webpack_exports__, __webpack_require__) {\n\n"use strict";\n__webpack_require__.r(__webpack_exports__);\n/* harmony export (binding) */ __webpack_require__.d(__webpack_exports__, "randId", function() { return randId; });\n/* harmony export (binding) */ __webpack_require__.d(__webpack_exports__, "dtypeToTypedArray", function() { return dtypeToTypedArray; });\n/* harmony export (binding) */ __webpack_require__.d(__webpack_exports__, "loadRequirementsInWindow", function() { return loadRequirementsInWindow; });\n/* harmony export (binding) */ __webpack_require__.d(__webpack_exports__, "loadRequirementsInWebworker", function() { return loadRequirementsInWebworker; });\n/* harmony export (binding) */ __webpack_require__.d(__webpack_exports__, "loadRequirements", function() { return loadRequirements; });\n/* harmony export (binding) */ __webpack_require__.d(__webpack_exports__, "normalizeConfig", function() { return normalizeConfig; });\n/* harmony export (binding) */ __webpack_require__.d(__webpack_exports__, "typedArrayToDtypeMapping", function() { return typedArrayToDtypeMapping; });\n/* harmony export (binding) */ __webpack_require__.d(__webpack_exports__, "typedArrayToDtype", function() { return typedArrayToDtype; });\n/* harmony export (binding) */ __webpack_require__.d(__webpack_exports__, "cacheRequirements", function() { return cacheRequirements; });\n/* harmony export (binding) */ __webpack_require__.d(__webpack_exports__, "setupServiceWorker", function() { return setupServiceWorker; });\n/* harmony export (binding) */ __webpack_require__.d(__webpack_exports__, "urlJoin", function() { return urlJoin; });\n/* harmony export (binding) */ __webpack_require__.d(__webpack_exports__, "MessageEmitter", function() { return MessageEmitter; });\nfunction randId() {\n  return Math.random().toString(36).substr(2, 10) + new Date().getTime();\n}\nconst dtypeToTypedArray = {\n  int8: Int8Array,\n  int16: Int16Array,\n  int32: Int32Array,\n  uint8: Uint8Array,\n  uint16: Uint16Array,\n  uint32: Uint32Array,\n  float32: Float32Array,\n  float64: Float64Array,\n  array: Array\n};\nasync function loadRequirementsInWindow(requirements) {\n  function _importScript(url) {\n    //url is URL of external file, implementationCode is the code\n    //to be called from the file, location is the location to\n    //insert the <script> element\n    return new Promise((resolve, reject) => {\n      var scriptTag = document.createElement("script");\n      scriptTag.src = url;\n      scriptTag.type = "text/javascript";\n      scriptTag.onload = resolve;\n\n      scriptTag.onreadystatechange = function () {\n        if (this.readyState === "loaded" || this.readyState === "complete") {\n          resolve();\n        }\n      };\n\n      scriptTag.onerror = reject;\n      document.head.appendChild(scriptTag);\n    });\n  } // support importScripts outside web worker\n\n\n  async function importScripts() {\n    var args = Array.prototype.slice.call(arguments),\n        len = args.length,\n        i = 0;\n\n    for (; i < len; i++) {\n      await _importScript(args[i]);\n    }\n  }\n\n  if (requirements && (Array.isArray(requirements) || typeof requirements === "string")) {\n    try {\n      var link_node;\n      requirements = typeof requirements === "string" ? [requirements] : requirements;\n\n      if (Array.isArray(requirements)) {\n        for (var i = 0; i < requirements.length; i++) {\n          if (requirements[i].toLowerCase().endsWith(".css") || requirements[i].startsWith("css:")) {\n            if (requirements[i].startsWith("css:")) {\n              requirements[i] = requirements[i].slice(4);\n            }\n\n            link_node = document.createElement("link");\n            link_node.rel = "stylesheet";\n            link_node.href = requirements[i];\n            document.head.appendChild(link_node);\n          } else if (requirements[i].toLowerCase().endsWith(".mjs") || requirements[i].startsWith("mjs:")) {\n            // import esmodule\n            if (requirements[i].startsWith("mjs:")) {\n              requirements[i] = requirements[i].slice(4);\n            }\n\n            await import(\n            /* webpackIgnore: true */\n            requirements[i]);\n          } else if (requirements[i].toLowerCase().endsWith(".js") || requirements[i].startsWith("js:")) {\n            if (requirements[i].startsWith("js:")) {\n              requirements[i] = requirements[i].slice(3);\n            }\n\n            await importScripts(requirements[i]);\n          } else if (requirements[i].startsWith("http")) {\n            await importScripts(requirements[i]);\n          } else if (requirements[i].startsWith("cache:")) {//ignore cache\n          } else {\n            console.log("Unprocessed requirements url: " + requirements[i]);\n          }\n        }\n      } else {\n        throw "unsupported requirements definition";\n      }\n    } catch (e) {\n      throw "failed to import required scripts: " + requirements.toString();\n    }\n  }\n}\nasync function loadRequirementsInWebworker(requirements) {\n  if (requirements && (Array.isArray(requirements) || typeof requirements === "string")) {\n    try {\n      if (!Array.isArray(requirements)) {\n        requirements = [requirements];\n      }\n\n      for (var i = 0; i < requirements.length; i++) {\n        if (requirements[i].toLowerCase().endsWith(".css") || requirements[i].startsWith("css:")) {\n          throw "unable to import css in a webworker";\n        } else if (requirements[i].toLowerCase().endsWith(".js") || requirements[i].startsWith("js:")) {\n          if (requirements[i].startsWith("js:")) {\n            requirements[i] = requirements[i].slice(3);\n          }\n\n          importScripts(requirements[i]);\n        } else if (requirements[i].startsWith("http")) {\n          importScripts(requirements[i]);\n        } else if (requirements[i].startsWith("cache:")) {//ignore cache\n        } else {\n          console.log("Unprocessed requirements url: " + requirements[i]);\n        }\n      }\n    } catch (e) {\n      throw "failed to import required scripts: " + requirements.toString();\n    }\n  }\n}\nfunction loadRequirements(requirements) {\n  if (typeof WorkerGlobalScope !== "undefined" && self instanceof WorkerGlobalScope) {\n    return loadRequirementsInWebworker(requirements);\n  } else {\n    return loadRequirementsInWindow(requirements);\n  }\n}\nfunction normalizeConfig(config) {\n  config.version = config.version || "0.1.0";\n  config.description = config.description || `[TODO: add description for ${config.name} ]`;\n  config.type = config.type || "rpc-window";\n  config.id = config.id || randId();\n  config.target_origin = config.target_origin || "*";\n  config.allow_execution = config.allow_execution || false; // remove functions\n\n  config = Object.keys(config).reduce((p, c) => {\n    if (typeof config[c] !== "function") p[c] = config[c];\n    return p;\n  }, {});\n  return config;\n}\nconst typedArrayToDtypeMapping = {\n  Int8Array: "int8",\n  Int16Array: "int16",\n  Int32Array: "int32",\n  Uint8Array: "uint8",\n  Uint16Array: "uint16",\n  Uint32Array: "uint32",\n  Float32Array: "float32",\n  Float64Array: "float64",\n  Array: "array"\n};\nconst typedArrayToDtypeKeys = [];\n\nfor (const arrType of Object.keys(typedArrayToDtypeMapping)) {\n  typedArrayToDtypeKeys.push(eval(arrType));\n}\n\nfunction typedArrayToDtype(obj) {\n  let dtype = typedArrayToDtypeMapping[obj.constructor.name];\n\n  if (!dtype) {\n    const pt = Object.getPrototypeOf(obj);\n\n    for (const arrType of typedArrayToDtypeKeys) {\n      if (pt instanceof arrType) {\n        dtype = typedArrayToDtypeMapping[arrType.name];\n        break;\n      }\n    }\n  }\n\n  return dtype;\n}\n\nfunction cacheUrlInServiceWorker(url) {\n  return new Promise(function (resolve, reject) {\n    const message = {\n      command: "add",\n      url: url\n    };\n\n    if (!navigator.serviceWorker || !navigator.serviceWorker.register) {\n      reject("Service worker is not supported.");\n      return;\n    }\n\n    const messageChannel = new MessageChannel();\n\n    messageChannel.port1.onmessage = function (event) {\n      if (event.data && event.data.error) {\n        reject(event.data.error);\n      } else {\n        resolve(event.data && event.data.result);\n      }\n    };\n\n    if (navigator.serviceWorker && navigator.serviceWorker.controller) {\n      navigator.serviceWorker.controller.postMessage(message, [messageChannel.port2]);\n    } else {\n      reject("Service worker controller is not available");\n    }\n  });\n}\n\nasync function cacheRequirements(requirements) {\n  requirements = requirements || [];\n\n  if (!Array.isArray(requirements)) {\n    requirements = [requirements];\n  }\n\n  for (let req of requirements) {\n    //remove prefix\n    if (req.startsWith("js:")) req = req.slice(3);\n    if (req.startsWith("css:")) req = req.slice(4);\n    if (req.startsWith("cache:")) req = req.slice(6);\n    if (!req.startsWith("http")) continue;\n    await cacheUrlInServiceWorker(req).catch(e => {\n      console.error(e);\n    });\n  }\n}\nfunction setupServiceWorker(baseUrl, targetOrigin, cacheCallback) {\n  // register service worker for offline access\n  if ("serviceWorker" in navigator) {\n    baseUrl = baseUrl || "/";\n    navigator.serviceWorker.register(baseUrl + "plugin-service-worker.js").then(function (registration) {\n      // Registration was successful\n      console.log("ServiceWorker registration successful with scope: ", registration.scope);\n    }, function (err) {\n      // registration failed :(\n      console.log("ServiceWorker registration failed: ", err);\n    });\n    targetOrigin = targetOrigin || "*";\n    cacheCallback = cacheCallback || cacheRequirements;\n\n    if (cacheCallback && typeof cacheCallback !== "function") {\n      throw new Error("config.cache_requirements must be a function");\n    }\n\n    window.addEventListener("message", function (e) {\n      if (targetOrigin === "*" || e.origin === targetOrigin) {\n        const m = e.data;\n\n        if (m.type === "cacheRequirements") {\n          cacheCallback(m.requirements);\n        }\n      }\n    });\n  }\n} //#Source https://bit.ly/2neWfJ2\n\nfunction urlJoin(...args) {\n  return args.join("/").replace(/[\\/]+/g, "/").replace(/^(.+):\\//, "$1://").replace(/^file:/, "file:/").replace(/\\/(\\?|&|#[^!])/g, "$1").replace(/\\?/g, "&").replace("&", "?");\n}\nclass MessageEmitter {\n  constructor(debug) {\n    this._event_handlers = {};\n    this._once_handlers = {};\n    this._debug = debug;\n  }\n\n  emit() {\n    throw new Error("emit is not implemented");\n  }\n\n  on(event, handler) {\n    if (!this._event_handlers[event]) {\n      this._event_handlers[event] = [];\n    }\n\n    this._event_handlers[event].push(handler);\n  }\n\n  once(event, handler) {\n    handler.___event_run_once = true;\n    this.on(event, handler);\n  }\n\n  off(event, handler) {\n    if (!event && !handler) {\n      // remove all events handlers\n      this._event_handlers = {};\n    } else if (event && !handler) {\n      // remove all hanlders for the event\n      if (this._event_handlers[event]) this._event_handlers[event] = [];\n    } else {\n      // remove a specific handler\n      if (this._event_handlers[event]) {\n        const idx = this._event_handlers[event].indexOf(handler);\n\n        if (idx >= 0) {\n          this._event_handlers[event].splice(idx, 1);\n        }\n      }\n    }\n  }\n\n  _fire(event, data) {\n    if (this._event_handlers[event]) {\n      var i = this._event_handlers[event].length;\n\n      while (i--) {\n        const handler = this._event_handlers[event][i];\n\n        try {\n          handler(data);\n        } catch (e) {\n          console.error(e);\n        } finally {\n          if (handler.___event_run_once) {\n            this._event_handlers[event].splice(i, 1);\n          }\n        }\n      }\n    } else {\n      if (this._debug) {\n        console.warn("unhandled event", event, data);\n      }\n    }\n  }\n\n}\n\n/***/ })\n\n/******/ });\n//# sourceMappingURL=plugin.webworker.js.map',null)}},"./src/pluginCore.js":function(e,t,n){n.r(t),n.d(t,"connectRPC",(function(){return i}));var r=n("./src/rpc.js");function i(e,t){t=t||{};const n={},i=new r.RPC(e,t,n);i.on("getInterface",(function(){a()})),i.on("remoteReady",(function(){const e=i.getRemote()||{};e.registerCodec=function(e){if(!e.name||!e.encoder&&!e.decoder)throw new Error("Invalid codec format, please make sure you provide a name, type, encoder and decoder.");if(e.type)for(let t of Object.keys(n))n[t].type!==e.type&&t!==e.name||(delete n[t],console.warn("Remove duplicated codec: "+t));n[e.name]=e},e.init=function(e){i.setInterface({setup(){}},e)},e.disposeObject=function(e){i.disposeObject(e)},e.export=function(e,t){i.setInterface(e,t)},e.onLoad=function(e){e=c(e),s?e():o.push(e)},e.dispose=function(e){i.disconnect()},e._rpc=i,"undefined"!=typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope?(self.api=e,self.postMessage({type:"imjoy_remote_api_ready"}),self.dispatchEvent(new CustomEvent("imjoy_remote_api_ready",{detail:e}))):window.dispatchEvent(new CustomEvent("imjoy_remote_api_ready",{detail:e}))}));let s=!1;const o=[],a=function(){if(!s){let e;for(s=!0;e=o.pop();)e()}},c=function(e){const t=typeof e;if("function"!==t)throw new Error("A function may only be subsribed to the event, "+t+" was provided instead");return e};return i}},"./src/pluginIframe.js":function(module,__nested_webpack_exports__,__nested_webpack_require_82486__){__nested_webpack_require_82486__.r(__nested_webpack_exports__),__nested_webpack_require_82486__.d(__nested_webpack_exports__,"Connection",(function(){return Connection})),__nested_webpack_require_82486__.d(__nested_webpack_exports__,"default",(function(){return setupIframe}));var _pluginCore_js__WEBPACK_IMPORTED_MODULE_0__=__nested_webpack_require_82486__("./src/pluginCore.js"),_rpc_js__WEBPACK_IMPORTED_MODULE_1__=__nested_webpack_require_82486__("./src/rpc.js"),_utils_js__WEBPACK_IMPORTED_MODULE_2__=__nested_webpack_require_82486__("./src/utils.js");function _htmlToElement(e){var t=document.createElement("template");return e=e.trim(),t.innerHTML=e,t.content.firstChild}const _inWebWorker="undefined"!=typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope;async function executeEsModule(e){const t="data:text/javascript;charset=utf-8,"+encodeURIComponent(e);await import(t)}class Connection extends _utils_js__WEBPACK_IMPORTED_MODULE_2__.MessageEmitter{constructor(e){super(e&&e.debug),this.config=e||{},this.peer_id=Object(_utils_js__WEBPACK_IMPORTED_MODULE_2__.randId)()}connect(){this.config.target_origin=this.config.target_origin||"*",this.config.broadcastChannel?this.broadcastChannel=new BroadcastChannel(this.config.broadcastChannel):this.broadcastChannel=null,this.broadcastChannel?this.broadcastChannel.addEventListener("message",this):globalThis.addEventListener("message",this),this.emit({type:"initialized",config:this.config,origin:globalThis.location.origin,peer_id:this.peer_id}),this._fire("connected")}handleEvent(e){"message"!==e.type||!this.broadcastChannel&&"*"!==this.config.target_origin&&e.origin&&e.origin!==this.config.target_origin||(e.data.peer_id===this.peer_id?this._fire(e.data.type,e.data):this.config.debug&&console.log(`connection peer id mismatch ${e.data.peer_id} !== ${this.peer_id}`))}disconnect(){this._fire("beforeDisconnect"),globalThis.removeEventListener("message",this),this._fire("disconnected")}emit(e){let t;this.broadcastChannel?this.broadcastChannel.postMessage(e):e.__transferables__?(t=e.__transferables__,delete e.__transferables__):_inWebWorker?self.postMessage(e,t):parent.postMessage(e,this.config.target_origin,t)}async execute(code){try{if("requirements"===code.type)await Object(_utils_js__WEBPACK_IMPORTED_MODULE_2__.loadRequirementsInWindow)(code.requirements);else if("script"===code.type)if(code.src){var script_node=document.createElement("script");script_node.setAttribute("type",code.attrs.type),script_node.setAttribute("src",code.src),document.head.appendChild(script_node)}else if(code.content&&"javascript"===code.attrs.lang)"module"===code.attrs.type?await executeEsModule(code.content):eval(code.content);else{var node=document.createElement("script");for(let e in code.attrs)node.setAttribute(e,code.attrs[e]);node.appendChild(document.createTextNode(code.content)),document.body.appendChild(node)}else if("style"===code.type){const e=document.createElement("style");code.src&&(e.src=code.src),e.innerHTML=code.content,document.head.appendChild(e)}else if("link"===code.type){const e=document.createElement("link");code.rel&&(e.rel=code.rel),code.href&&(e.href=code.href),code.attrs&&code.attrs.type&&(e.type=code.attrs.type),document.head.appendChild(e)}else{if("html"!==code.type)throw"unsupported code type.";document.body.appendChild(_htmlToElement(code.content))}_inWebWorker?self.postMessage({type:"executed"}):parent.postMessage({type:"executed"},this.config.target_origin)}catch(e){console.error("failed to execute scripts: ",code,e),_inWebWorker?self.postMessage({type:"executed",error:e.stack||String(e)}):parent.postMessage({type:"executed",error:e.stack||String(e)},this.config.target_origin)}}}function setupIframe(e){(e=e||{}).dedicated_thread=!1,e.lang="javascript",e.api_version=_rpc_js__WEBPACK_IMPORTED_MODULE_1__.API_VERSION;const t=new Connection(e);Object(_pluginCore_js__WEBPACK_IMPORTED_MODULE_0__.connectRPC)(t,e),t.connect()}},"./src/rpc.js":function(e,t,n){n.r(t),n.d(t,"API_VERSION",(function(){return i})),n.d(t,"RPC",(function(){return c}));var r=n("./src/utils.js");const i="0.2.3",s=Object.getPrototypeOf(Object.getPrototypeOf(new Uint8Array)).constructor;function o(e,t){const n=new Uint8Array(e.byteLength+t.byteLength);return n.set(new Uint8Array(e),0),n.set(new Uint8Array(t),e.byteLength),n.buffer}function a(e,t){if(!t)throw new Error("undefined index");return"string"==typeof t?a(e,t.split(".")):0===t.length?e:a(e[t[0]],t.slice(1))}class c extends r.MessageEmitter{constructor(e,t,n){super(t&&t.debug),this._connection=e,this.config=t||{},this._codecs=n||{},this._object_store={},this._method_weakmap=new WeakMap,this._object_weakmap=new WeakMap,this._local_api=null,this._remote_set=!1;const r=this.config.name;this._connection.execute=this._connection.execute||function(){throw new Error(`connection.execute not implemented (in "${r}")`)},this._store=new l,this._method_refs=new l,this._method_refs.onReady((()=>{this._fire("remoteIdle")})),this._method_refs.onBusy((()=>{this._fire("remoteBusy")})),this._setupMessageHanlders()}init(){this._connection.emit({type:"initialized",config:this.config,peer_id:this._connection.peer_id})}setConfig(e){if(e)for(const t of Object.keys(e))this.config[t]=e[t]}getRemoteCallStack(){return this._method_refs.getStack()}getRemote(){return this._remote_interface}setInterface(e,t){if(t=t||{},this.config.name=t.name||this.config.name,this.config.description=t.description||this.config.description,this.config.forwarding_functions)for(let t of this.config.forwarding_functions){const n=this._remote_interface;n[t]&&(e.constructor===Object?e[t]||(e[t]=(...e)=>{n[t](...e)}):e.constructor.constructor===Function&&(e.constructor.prototype[t]||(e.constructor.prototype[t]=(...e)=>{n[t](...e)})))}return this._local_api=e,this._remote_set?this.sendInterface():this._fire("interfaceAvailable"),new Promise((e=>{this.once("interfaceSetAsRemote",e)}))}sendInterface(){if(!this._local_api)throw new Error("interface is not set.");this._encode(this._local_api,!0).then((e=>{this._connection.emit({type:"setInterface",api:e})}))}_disposeObject(e){if(!this._object_store[e])throw new Error(`Object (id=${e}) not found.`);delete this._object_store[e]}disposeObject(e){return new Promise(((t,n)=>{if(!this._object_weakmap.has(e))throw new Error("Invalid object");{const r=this._object_weakmap.get(e);this._connection.once("disposed",(e=>{e.error?n(new Error(e.error)):t()})),this._connection.emit({type:"disposeObject",object_id:r})}}))}_setupMessageHanlders(){this._connection.on("init",this.init),this._connection.on("execute",(e=>{Promise.resolve(this._connection.execute(e.code)).then((()=>{this._connection.emit({type:"executed"})})).catch((e=>{console.error(e),this._connection.emit({type:"executed",error:String(e)})}))})),this._connection.on("method",(async e=>{let t,n,r,i,s,o;try{e.promise&&([t,n]=await this._unwrap(e.promise,!1));const c=this._object_store[e.object_id];if(r=a(c,e.name),e.name.includes(".")){const t=e.name.split(".");i=a(c,t.slice(0,t.length-1).join("."))}else i=c;s=await this._unwrap(e.args,!0),e.promise?(o=r.apply(i,s),o instanceof Promise||r.constructor&&"AsyncFunction"===r.constructor.name?o.then(t).catch(n):t(o)):r.apply(i,s)}catch(e){console.error(this.config.name,e),n&&n(e)}})),this._connection.on("callback",(async e=>{let t,n,r,i,s;try{if(e.promise&&([t,n]=await this._unwrap(e.promise,!1)),e.promise){if(r=this._store.fetch(e.id),i=await this._unwrap(e.args,!0),!r)throw new Error("Callback function can only called once, if you want to call a function for multiple times, please make it as a plugin api function. See https://imjoy.io/docs for more details.");s=r.apply(null,i),s instanceof Promise||r.constructor&&"AsyncFunction"===r.constructor.name?s.then(t).catch(n):t(s)}else{if(r=this._store.fetch(e.id),i=await this._unwrap(e.args,!0),!r)throw new Error("Please notice that callback function can only called once, if you want to call a function for multiple times, please make it as a plugin api function. See https://imjoy.io/docs for more details.");r.apply(null,i)}}catch(e){console.error(this.config.name,e),n&&n(e)}})),this._connection.on("disposeObject",(e=>{try{this._disposeObject(e.object_id),this._connection.emit({type:"disposed"})}catch(e){console.error(e),this._connection.emit({type:"disposed",error:String(e)})}})),this._connection.on("setInterface",(e=>{this._setRemoteInterface(e.api)})),this._connection.on("getInterface",(()=>{this._fire("getInterface"),this._local_api?this.sendInterface():this.once("interfaceAvailable",(()=>{this.sendInterface()}))})),this._connection.on("interfaceSetAsRemote",(()=>{this._remote_set=!0,this._fire("interfaceSetAsRemote")})),this._connection.on("disconnect",(()=>{this._fire("beforeDisconnect"),this._connection.disconnect(),this._fire("disconnected")}))}requestRemote(){this._connection.emit({type:"getInterface"})}_ndarray(e,t,n){const i=Object(r.typedArrayToDtype)(e);if(n&&n!==i)throw"dtype doesn't match the type of the array: "+i+" != "+n;return t=t||[e.length],{_rtype:"ndarray",_rvalue:e.buffer,_rshape:t,_rdtype:i}}_setRemoteInterface(e){this._decode(e).then((e=>{if(this._remote_interface){for(let e in this._remote_interface)delete this._remote_interface[e];Object.assign(this._remote_interface,e)}else this._remote_interface=e;this._fire("remoteReady"),this._reportRemoteSet()}))}_genRemoteMethod(e,t,n){const r=this,i=function(){return new Promise((async(i,s)=>{let o=null;try{o=r._method_refs.put(n?n+"/"+t:t);const a=function(){return null!==o&&r._method_refs.fetch(o),i.apply(this,arguments)},c=function(){return null!==o&&r._method_refs.fetch(o),s.apply(this,arguments)},l=await r._wrap([a,c]);a.__promise_pair=l[1]._rvalue,c.__promise_pair=l[0]._rvalue;let u=Array.prototype.slice.call(arguments);const d=u.length,h=d>0&&"object"==typeof u[d-1]&&null!==u[d-1]&&u[d-1]._rkwargs;h&&delete u[d-1]._rkwargs,u="register"===t||"registerService"===t||"register_service"===t||"export"===t||"on"===t?await r._wrap(u,!0):await r._wrap(u);const p=u.__transferables__;p&&delete u.__transferables__,r._connection.emit({type:"method",target_id:e,name:t,object_id:n,args:u,promise:l,with_kwargs:h},p)}catch(e){o&&r._method_refs.fetch(o),s(`Failed to exectue remote method (interface: ${n||r.id}, method: ${t}), error: ${e}`)}}))};return i.__remote_method=!0,i}_reportRemoteSet(){this._connection.emit({type:"interfaceSetAsRemote"})}async _encode(e,t,n){const i=typeof e;if("number"===i||"string"===i||"boolean"===i||null==e||e instanceof ArrayBuffer)return e;let o;if("function"==typeof e){if(t){if(!n)throw new Error("objectId is not specified.");o={_rtype:"interface",_rtarget_id:this._connection.peer_id,_rintf:n,_rvalue:t},this._method_weakmap.set(e,o)}else if(this._method_weakmap.has(e))o=this._method_weakmap.get(e);else{const t=this._store.put(e);o={_rtype:"callback",_rtarget_id:this._connection.peer_id,_rname:e.constructor&&e.constructor.name||t,_rvalue:t}}return o}if(e.constructor instanceof Object&&e._rtype){if(e._rintf){const r=e._rtype;delete e._rtype,o=await this._encode(e,t,n),o._rtype=r}else o=e;return o}const a=[],c=e._transfer,l=Array.isArray(e);for(let r of Object.keys(this._codecs)){const i=this._codecs[r];if(i.encoder&&e instanceof i.type){let r=await Promise.resolve(i.encoder(e));if(r&&!r._rtype&&(r._rtype=i.name),r&&r._rintf){const e=r._rtype;delete r._rtype,r=await this._encode(r,t,n),r._rtype=e}return o=r,o}}if("undefined"!=typeof tf&&tf.Tensor&&e instanceof tf.Tensor){const t=e.dataSync();(e._transfer||c)&&(a.push(t.buffer),delete e._transfer),o={_rtype:"ndarray",_rvalue:t.buffer,_rshape:e.shape,_rdtype:e.dtype}}else if("undefined"!=typeof nj&&nj.NdArray&&e instanceof nj.NdArray){const t=Object(r.typedArrayToDtype)(e.selection.data);(e._transfer||c)&&(a.push(e.selection.data.buffer),delete e._transfer),o={_rtype:"ndarray",_rvalue:e.selection.data.buffer,_rshape:e.shape,_rdtype:t}}else if(e instanceof Error)console.error(e),o={_rtype:"error",_rvalue:e.toString()};else if("undefined"!=typeof File&&e instanceof File)o={_rtype:"file",_rvalue:e,_rpath:e._path||e.webkitRelativePath};else if(e!==Object(e)||e instanceof Boolean||e instanceof String||e instanceof Date||e instanceof RegExp||e instanceof ImageData||"undefined"!=typeof FileList&&e instanceof FileList||"undefined"!=typeof FileSystemDirectoryHandle&&e instanceof FileSystemDirectoryHandle||"undefined"!=typeof FileSystemFileHandle&&e instanceof FileSystemFileHandle||"undefined"!=typeof FileSystemHandle&&e instanceof FileSystemHandle||"undefined"!=typeof FileSystemWritableFileStream&&e instanceof FileSystemWritableFileStream)o=e;else if("undefined"!=typeof File&&e instanceof File)o={_rtype:"file",_rname:e.name,_rmime:e.type,_rvalue:e,_rpath:e._path||e.webkitRelativePath};else if(e instanceof Blob)o={_rtype:"blob",_rvalue:e};else if(e instanceof s){(e._transfer||c)&&(a.push(e.buffer),delete e._transfer);const t=Object(r.typedArrayToDtype)(e);o={_rtype:"typedarray",_rvalue:e.buffer,_rdtype:t}}else if(e instanceof DataView)(e._transfer||c)&&(a.push(e.buffer),delete e._transfer),o={_rtype:"memoryview",_rvalue:e.buffer};else if(e instanceof Set)o={_rtype:"set",_rvalue:await this._encode(Array.from(e),t)};else if(e instanceof Map)o={_rtype:"orderedmap",_rvalue:await this._encode(Array.from(e),t)};else if(e.constructor instanceof Object||Array.isArray(e)){let i;if(o=l?[]:{},e.constructor===Object||Array.isArray(e))i=Object.keys(e);else{if(e.constructor===Function)throw new Error("Please instantiate the class before exportting it.");if(e.constructor.constructor!==Function)throw Error("Unsupported interface type");i=Object.getOwnPropertyNames(Object.getPrototypeOf(e)).concat(Object.keys(e)),t=!0}let s=!1;if(e._rintf||t){n||(n="string"==typeof e._rintf&&e._rintf.length>0?e._rintf:Object(r.randId)(),this._object_store[n]&&console.warn(`Overwritting interface object with the same id: ${n}`),this._object_store[n]=e);for(let r of i)"constructor"!==r&&(r.startsWith("_")||(o[r]=await this._encode(e[r],"string"==typeof t?t+"."+r:r,n),"function"==typeof e[r]&&(s=!0)));s&&(o._rintf=n),e.on&&"function"==typeof e.on&&e.on("close",(()=>{delete this._object_store[n]}))}else for(let t of i)["hasOwnProperty","constructor"].includes(t)||(o[t]=await this._encode(e[t]))}else{if("object"!=typeof e)throw"imjoy-rpc: Unsupported data type:"+e;{const t=Object.getOwnPropertyNames(Object.getPrototypeOf(e)).concat(Object.keys(e)),n=Object(r.randId)();for(let n of t)["hasOwnProperty","constructor"].includes(n)||(o[n]=await this._encode(e[n],n,o));o._rintf=n}}if(a.length>0&&(o.__transferables__=a),!o)throw new Error("Failed to encode object");return o}async _decode(e,t){if(!e)return e;let n;if(e._rtype)if(this._codecs[e._rtype]&&this._codecs[e._rtype].decoder){if(e._rintf){const n=e._rtype;delete e._rtype,(e=await this._decode(e,t))._rtype=n}n=await Promise.resolve(this._codecs[e._rtype].decoder(e))}else if("callback"===e._rtype)n=this._genRemoteCallback(e._rtarget_id,e._rvalue,t);else if("interface"===e._rtype)n=this._genRemoteMethod(e._rtarget_id,e._rvalue,e._rintf);else if("ndarray"===e._rtype)if("undefined"!=typeof nj&&nj.array)Array.isArray(e._rvalue)&&(e._rvalue=e._rvalue.reduce(o)),n=nj.array(new Uint8(e._rvalue),e._rdtype).reshape(e._rshape);else if("undefined"!=typeof tf&&tf.Tensor){Array.isArray(e._rvalue)&&(e._rvalue=e._rvalue.reduce(o));const t=r.dtypeToTypedArray[e._rdtype];n=tf.tensor(new t(e._rvalue),e._rshape,e._rdtype)}else n=e;else if("error"===e._rtype)n=new Error(e._rvalue);else if("file"===e._rtype)e._rvalue instanceof File?(n=e._rvalue,n._path=e._rpath):(n=new File([e._rvalue],e._rname,{type:e._rmime}),n._path=e._rpath);else if("typedarray"===e._rtype){const t=r.dtypeToTypedArray[e._rdtype];if(!t)throw new Error("unsupported dtype: "+e._rdtype);n=new t(e._rvalue)}else if("memoryview"===e._rtype)n=new DataView(e._rvalue);else if("blob"===e._rtype)n=e._rvalue instanceof Blob?e._rvalue:new Blob([e._rvalue],{type:e._rmime});else if("orderedmap"===e._rtype)n=new Map(await this._decode(e._rvalue,t));else if("set"===e._rtype)n=new Set(await this._decode(e._rvalue,t));else if(e._rintf){const r=e._rtype;delete e._rtype,n=await this._decode(e,t),n._rtype=r}else n=e;else if(e.constructor===Object||Array.isArray(e)){const r=Array.isArray(e);n=r?[]:{};for(let i of Object.keys(e))if(r||e.hasOwnProperty(i)){const r=e[i];n[i]=await this._decode(r,t)}}else n=e;if(void 0===n)throw new Error("Failed to decode object");return e._rintf&&this._object_weakmap.set(n,e._rintf),n}async _wrap(e,t){return await this._encode(e,t)}async _unwrap(e,t){return await this._decode(e,t)}_genRemoteCallback(e,t,n){const r=this;let i;return n?(i=function(){return new Promise((async(n,i)=>{const s=await r._wrap(Array.prototype.slice.call(arguments)),o=s.length,a=o>0&&"object"==typeof s[o-1]&&null!==s[o-1]&&s[o-1]._rkwargs;a&&delete s[o-1]._rkwargs;const c=s.__transferables__;c&&delete s.__transferables__;const l=await r._wrap([n,i]);n.__promise_pair=l[1]._rvalue,i.__promise_pair=l[0]._rvalue;try{r._connection.emit({type:"callback",target_id:e,id:t,args:s,promise:l,with_kwargs:a},c)}catch(e){i(`Failed to exectue remote callback ( id: ${t}).`)}}))},i):(i=async function(){const n=await r._wrap(Array.prototype.slice.call(arguments)),i=n.length,s=i>0&&"object"==typeof n[i-1]&&null!==n[i-1]&&n[i-1]._rkwargs;s&&delete n[i-1]._rkwargs;const o=n.__transferables__;return o&&delete n.__transferables__,r._connection.emit({type:"callback",target_id:e,id:t,args:n,with_kwargs:s},o)},i)}reset(){this._event_handlers={},this._once_handlers={},this._remote_interface=null,this._object_store={},this._method_weakmap=new WeakMap,this._object_weakmap=new WeakMap,this._local_api=null,this._store=new l,this._method_refs=new l}disconnect(){this._connection.emit({type:"disconnect"}),this.reset(),setTimeout((()=>{this._connection.disconnect()}),2e3)}}class l{constructor(){this._store={},this._indices=[0],this._readyHandler=function(){},this._busyHandler=function(){},this._readyHandler()}onReady(e){this._readyHandler=e||function(){}}onBusy(e){this._busyHandler=e||function(){}}getStack(){return Object.keys(this._store).length}_genId(){let e;return e=1===this._indices.length?this._indices[0]++:this._indices.shift(),e}_releaseId(e){for(let t=0;t<this._indices.length;t++)if(e<this._indices[t]){this._indices.splice(t,0,e);break}for(let e=this._indices.length-1;e>=0&&this._indices[e]-1===this._indices[e-1];e--)this._indices.pop()}put(e){this._busyHandler&&0===Object.keys(this._store).length&&this._busyHandler();const t=this._genId();return this._store[t]=e,t}fetch(e){const t=this._store[e];return t&&!t.__remote_method&&(delete this._store[e],this._releaseId(e),this._readyHandler&&0===Object.keys(this._store).length&&this._readyHandler()),t&&t.__promise_pair&&this.fetch(t.__promise_pair),t}}},"./src/utils.js":function(module,__nested_webpack_exports__,__nested_webpack_require_123819__){function randId(){return Math.random().toString(36).substr(2,10)+(new Date).getTime()}__nested_webpack_require_123819__.r(__nested_webpack_exports__),__nested_webpack_require_123819__.d(__nested_webpack_exports__,"randId",(function(){return randId})),__nested_webpack_require_123819__.d(__nested_webpack_exports__,"dtypeToTypedArray",(function(){return dtypeToTypedArray})),__nested_webpack_require_123819__.d(__nested_webpack_exports__,"loadRequirementsInWindow",(function(){return loadRequirementsInWindow})),__nested_webpack_require_123819__.d(__nested_webpack_exports__,"loadRequirementsInWebworker",(function(){return loadRequirementsInWebworker})),__nested_webpack_require_123819__.d(__nested_webpack_exports__,"loadRequirements",(function(){return loadRequirements})),__nested_webpack_require_123819__.d(__nested_webpack_exports__,"normalizeConfig",(function(){return normalizeConfig})),__nested_webpack_require_123819__.d(__nested_webpack_exports__,"typedArrayToDtypeMapping",(function(){return typedArrayToDtypeMapping})),__nested_webpack_require_123819__.d(__nested_webpack_exports__,"typedArrayToDtype",(function(){return typedArrayToDtype})),__nested_webpack_require_123819__.d(__nested_webpack_exports__,"cacheRequirements",(function(){return cacheRequirements})),__nested_webpack_require_123819__.d(__nested_webpack_exports__,"setupServiceWorker",(function(){return setupServiceWorker})),__nested_webpack_require_123819__.d(__nested_webpack_exports__,"urlJoin",(function(){return urlJoin})),__nested_webpack_require_123819__.d(__nested_webpack_exports__,"MessageEmitter",(function(){return MessageEmitter}));const dtypeToTypedArray={int8:Int8Array,int16:Int16Array,int32:Int32Array,uint8:Uint8Array,uint16:Uint16Array,uint32:Uint32Array,float32:Float32Array,float64:Float64Array,array:Array};async function loadRequirementsInWindow(e){function t(e){return new Promise(((t,n)=>{var r=document.createElement("script");r.src=e,r.type="text/javascript",r.onload=t,r.onreadystatechange=function(){"loaded"!==this.readyState&&"complete"!==this.readyState||t()},r.onerror=n,document.head.appendChild(r)}))}async function n(){for(var e=Array.prototype.slice.call(arguments),n=e.length,r=0;r<n;r++)await t(e[r])}if(e&&(Array.isArray(e)||"string"==typeof e))try{var r;if(e="string"==typeof e?[e]:e,!Array.isArray(e))throw"unsupported requirements definition";for(var i=0;i<e.length;i++)e[i].toLowerCase().endsWith(".css")||e[i].startsWith("css:")?(e[i].startsWith("css:")&&(e[i]=e[i].slice(4)),(r=document.createElement("link")).rel="stylesheet",r.href=e[i],document.head.appendChild(r)):e[i].toLowerCase().endsWith(".mjs")||e[i].startsWith("mjs:")?(e[i].startsWith("mjs:")&&(e[i]=e[i].slice(4)),await import(e[i])):e[i].toLowerCase().endsWith(".js")||e[i].startsWith("js:")?(e[i].startsWith("js:")&&(e[i]=e[i].slice(3)),await n(e[i])):e[i].startsWith("http")?await n(e[i]):e[i].startsWith("cache:")||console.log("Unprocessed requirements url: "+e[i])}catch(t){throw"failed to import required scripts: "+e.toString()}}async function loadRequirementsInWebworker(e){if(e&&(Array.isArray(e)||"string"==typeof e))try{Array.isArray(e)||(e=[e]);for(var t=0;t<e.length;t++){if(e[t].toLowerCase().endsWith(".css")||e[t].startsWith("css:"))throw"unable to import css in a webworker";e[t].toLowerCase().endsWith(".js")||e[t].startsWith("js:")?(e[t].startsWith("js:")&&(e[t]=e[t].slice(3)),importScripts(e[t])):e[t].startsWith("http")?importScripts(e[t]):e[t].startsWith("cache:")||console.log("Unprocessed requirements url: "+e[t])}}catch(t){throw"failed to import required scripts: "+e.toString()}}function loadRequirements(e){return"undefined"!=typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope?loadRequirementsInWebworker(e):loadRequirementsInWindow(e)}function normalizeConfig(e){return e.version=e.version||"0.1.0",e.description=e.description||`[TODO: add description for ${e.name} ]`,e.type=e.type||"rpc-window",e.id=e.id||randId(),e.target_origin=e.target_origin||"*",e.allow_execution=e.allow_execution||!1,e=Object.keys(e).reduce(((t,n)=>("function"!=typeof e[n]&&(t[n]=e[n]),t)),{})}const typedArrayToDtypeMapping={Int8Array:"int8",Int16Array:"int16",Int32Array:"int32",Uint8Array:"uint8",Uint16Array:"uint16",Uint32Array:"uint32",Float32Array:"float32",Float64Array:"float64",Array:"array"},typedArrayToDtypeKeys=[];for(const arrType of Object.keys(typedArrayToDtypeMapping))typedArrayToDtypeKeys.push(eval(arrType));function typedArrayToDtype(e){let t=typedArrayToDtypeMapping[e.constructor.name];if(!t){const n=Object.getPrototypeOf(e);for(const e of typedArrayToDtypeKeys)if(n instanceof e){t=typedArrayToDtypeMapping[e.name];break}}return t}function cacheUrlInServiceWorker(e){return new Promise((function(t,n){const r={command:"add",url:e};if(!navigator.serviceWorker||!navigator.serviceWorker.register)return void n("Service worker is not supported.");const i=new MessageChannel;i.port1.onmessage=function(e){e.data&&e.data.error?n(e.data.error):t(e.data&&e.data.result)},navigator.serviceWorker&&navigator.serviceWorker.controller?navigator.serviceWorker.controller.postMessage(r,[i.port2]):n("Service worker controller is not available")}))}async function cacheRequirements(e){e=e||[],Array.isArray(e)||(e=[e]);for(let t of e)t.startsWith("js:")&&(t=t.slice(3)),t.startsWith("css:")&&(t=t.slice(4)),t.startsWith("cache:")&&(t=t.slice(6)),t.startsWith("http")&&await cacheUrlInServiceWorker(t).catch((e=>{console.error(e)}))}function setupServiceWorker(e,t,n){if("serviceWorker"in navigator){if(e=e||"/",navigator.serviceWorker.register(e+"plugin-service-worker.js").then((function(e){console.log("ServiceWorker registration successful with scope: ",e.scope)}),(function(e){console.log("ServiceWorker registration failed: ",e)})),t=t||"*",(n=n||cacheRequirements)&&"function"!=typeof n)throw new Error("config.cache_requirements must be a function");window.addEventListener("message",(function(e){if("*"===t||e.origin===t){const t=e.data;"cacheRequirements"===t.type&&n(t.requirements)}}))}}function urlJoin(...e){return e.join("/").replace(/[\/]+/g,"/").replace(/^(.+):\//,"$1://").replace(/^file:/,"file:/").replace(/\/(\?|&|#[^!])/g,"$1").replace(/\?/g,"&").replace("&","?")}class MessageEmitter{constructor(e){this._event_handlers={},this._once_handlers={},this._debug=e}emit(){throw new Error("emit is not implemented")}on(e,t){this._event_handlers[e]||(this._event_handlers[e]=[]),this._event_handlers[e].push(t)}once(e,t){t.___event_run_once=!0,this.on(e,t)}off(e,t){if(e||t){if(e&&!t)this._event_handlers[e]&&(this._event_handlers[e]=[]);else if(this._event_handlers[e]){const n=this._event_handlers[e].indexOf(t);n>=0&&this._event_handlers[e].splice(n,1)}}else this._event_handlers={}}_fire(e,t){if(this._event_handlers[e])for(var n=this._event_handlers[e].length;n--;){const r=this._event_handlers[e][n];try{r(t)}catch(e){console.error(e)}finally{r.___event_run_once&&this._event_handlers[e].splice(n,1)}}else this._debug&&console.warn("unhandled event",e,t)}}}})},module.exports=factory()},237:(e,t,n)=>{e.exports={imjoyRPC:n(800),imjoyRPCSocketIO:n(64),hyphaRPC:n(822),hyphaWebsocketClient:n(140),hyphaSSEClient:n(18)}},644:function(e,t,n){!function(e){var t="undefined"!=typeof window?window:void 0!==n.g?n.g:"undefined"!=typeof self?self:{},r=function(e,t){if(t=t.split(":")[0],!(e=+e))return!1;switch(t){case"http":case"ws":return 80!==e;case"https":case"wss":return 443!==e;case"ftp":return 21!==e;case"gopher":return 70!==e;case"file":return!1}return 0!==e},i=Object.prototype.hasOwnProperty;function s(e){try{return decodeURIComponent(e.replace(/\+/g," "))}catch(e){return null}}function o(e){try{return encodeURIComponent(e)}catch(e){return null}}var a={stringify:function(e,t){t=t||"";var n,r,s=[];for(r in"string"!=typeof t&&(t="?"),e)if(i.call(e,r)){if((n=e[r])||null!=n&&!isNaN(n)||(n=""),r=o(r),n=o(n),null===r||null===n)continue;s.push(r+"="+n)}return s.length?t+s.join("&"):""},parse:function(e){for(var t,n=/([^=?#&]+)=?([^&]*)/g,r={};t=n.exec(e);){var i=s(t[1]),o=s(t[2]);null===i||null===o||i in r||(r[i]=o)}return r}},c=/[\n\r\t]/g,l=/^[A-Za-z][A-Za-z0-9+-.]*:\/\//,u=/^([a-z][a-z0-9.+-]*:)?(\/\/)?([\\/]+)?([\S\s]*)/i,d=/^[a-zA-Z]:/,h=/^[\x00-\x20\u00a0\u1680\u2000-\u200a\u2028\u2029\u202f\u205f\u3000\ufeff]+/;function p(e){return(e||"").toString().replace(h,"")}var f=[["#","hash"],["?","query"],function(e,t){return y(t.protocol)?e.replace(/\\/g,"/"):e},["/","pathname"],["@","auth",1],[NaN,"host",void 0,1,1],[/:(\d*)$/,"port",void 0,1],[NaN,"hostname",void 0,1,1]],_={hash:1,query:1};function m(e){var n,r=("undefined"!=typeof window?window:void 0!==t?t:"undefined"!=typeof self?self:{}).location||{},i={},s=typeof(e=e||r);if("blob:"===e.protocol)i=new b(unescape(e.pathname),{});else if("string"===s)for(n in i=new b(e,{}),_)delete i[n];else if("object"===s){for(n in e)n in _||(i[n]=e[n]);void 0===i.slashes&&(i.slashes=l.test(e.href))}return i}function y(e){return"file:"===e||"ftp:"===e||"http:"===e||"https:"===e||"ws:"===e||"wss:"===e}function g(e,t){e=(e=p(e)).replace(c,""),t=t||{};var n,r=u.exec(e),i=r[1]?r[1].toLowerCase():"",s=!!r[2],o=!!r[3],a=0;return s?o?(n=r[2]+r[3]+r[4],a=r[2].length+r[3].length):(n=r[2]+r[4],a=r[2].length):o?(n=r[3]+r[4],a=r[3].length):n=r[4],"file:"===i?a>=2&&(n=n.slice(2)):y(i)?n=r[4]:i?s&&(n=n.slice(2)):a>=2&&y(t.protocol)&&(n=r[4]),{protocol:i,slashes:s||y(i),slashesCount:a,rest:n}}function b(e,t,n){if(e=(e=p(e)).replace(c,""),!(this instanceof b))return new b(e,t,n);var i,s,o,l,u,h,_=f.slice(),w=typeof t,v=this,k=0;for("object"!==w&&"string"!==w&&(n=t,t=null),n&&"function"!=typeof n&&(n=a.parse),i=!(s=g(e||"",t=m(t))).protocol&&!s.slashes,v.slashes=s.slashes||i&&t.slashes,v.protocol=s.protocol||t.protocol||"",e=s.rest,("file:"===s.protocol&&(2!==s.slashesCount||d.test(e))||!s.slashes&&(s.protocol||s.slashesCount<2||!y(v.protocol)))&&(_[3]=[/(.*)/,"pathname"]);k<_.length;k++)"function"!=typeof(l=_[k])?(o=l[0],h=l[1],o!=o?v[h]=e:"string"==typeof o?~(u="@"===o?e.lastIndexOf(o):e.indexOf(o))&&("number"==typeof l[2]?(v[h]=e.slice(0,u),e=e.slice(u+l[2])):(v[h]=e.slice(u),e=e.slice(0,u))):(u=o.exec(e))&&(v[h]=u[1],e=e.slice(0,u.index)),v[h]=v[h]||i&&l[3]&&t[h]||"",l[4]&&(v[h]=v[h].toLowerCase())):e=l(e,v);n&&(v.query=n(v.query)),i&&t.slashes&&"/"!==v.pathname.charAt(0)&&(""!==v.pathname||""!==t.pathname)&&(v.pathname=function(e,t){if(""===e)return t;for(var n=(t||"/").split("/").slice(0,-1).concat(e.split("/")),r=n.length,i=n[r-1],s=!1,o=0;r--;)"."===n[r]?n.splice(r,1):".."===n[r]?(n.splice(r,1),o++):o&&(0===r&&(s=!0),n.splice(r,1),o--);return s&&n.unshift(""),"."!==i&&".."!==i||n.push(""),n.join("/")}(v.pathname,t.pathname)),"/"!==v.pathname.charAt(0)&&y(v.protocol)&&(v.pathname="/"+v.pathname),r(v.port,v.protocol)||(v.host=v.hostname,v.port=""),v.username=v.password="",v.auth&&(~(u=v.auth.indexOf(":"))?(v.username=v.auth.slice(0,u),v.username=encodeURIComponent(decodeURIComponent(v.username)),v.password=v.auth.slice(u+1),v.password=encodeURIComponent(decodeURIComponent(v.password))):v.username=encodeURIComponent(decodeURIComponent(v.auth)),v.auth=v.password?v.username+":"+v.password:v.username),v.origin="file:"!==v.protocol&&y(v.protocol)&&v.host?v.protocol+"//"+v.host:"null",v.href=v.toString()}b.prototype={set:function(e,t,n){var i=this;switch(e){case"query":"string"==typeof t&&t.length&&(t=(n||a.parse)(t)),i[e]=t;break;case"port":i[e]=t,r(t,i.protocol)?t&&(i.host=i.hostname+":"+t):(i.host=i.hostname,i[e]="");break;case"hostname":i[e]=t,i.port&&(t+=":"+i.port),i.host=t;break;case"host":i[e]=t,/:\d+$/.test(t)?(t=t.split(":"),i.port=t.pop(),i.hostname=t.join(":")):(i.hostname=t,i.port="");break;case"protocol":i.protocol=t.toLowerCase(),i.slashes=!n;break;case"pathname":case"hash":if(t){var s="pathname"===e?"/":"#";i[e]=t.charAt(0)!==s?s+t:t}else i[e]=t;break;case"username":case"password":i[e]=encodeURIComponent(t);break;case"auth":var o=t.indexOf(":");~o?(i.username=t.slice(0,o),i.username=encodeURIComponent(decodeURIComponent(i.username)),i.password=t.slice(o+1),i.password=encodeURIComponent(decodeURIComponent(i.password))):i.username=encodeURIComponent(decodeURIComponent(t))}for(var c=0;c<f.length;c++){var l=f[c];l[4]&&(i[l[1]]=i[l[1]].toLowerCase())}return i.auth=i.password?i.username+":"+i.password:i.username,i.origin="file:"!==i.protocol&&y(i.protocol)&&i.host?i.protocol+"//"+i.host:"null",i.href=i.toString(),i},toString:function(e){e&&"function"==typeof e||(e=a.stringify);var t,n=this,r=n.host,i=n.protocol;i&&":"!==i.charAt(i.length-1)&&(i+=":");var s=i+(n.protocol&&n.slashes||y(n.protocol)?"//":"");return n.username?(s+=n.username,n.password&&(s+=":"+n.password),s+="@"):n.password?(s+=":"+n.password,s+="@"):"file:"!==n.protocol&&y(n.protocol)&&!r&&"/"!==n.pathname&&(s+="@"),":"===r[r.length-1]&&(r+=":"),s+=r+n.pathname,(t="object"==typeof n.query?e(n.query):n.query)&&(s+="?"!==t.charAt(0)?"?"+t:t),n.hash&&(s+=n.hash),s}},b.extractProtocol=g,b.location=m,b.trimLeft=p,b.qs=a;var w=b;function v(e,t){setTimeout((function(t){return e.call(t)}),4,t)}function k(e,t){"undefined"!=typeof process&&console[e].call(null,t)}function j(e,t){void 0===e&&(e=[]);var n=[];return e.forEach((function(e){t(e)||n.push(e)})),n}var E=function(){this.listeners={}};function O(e){var t=e.indexOf("?");return t>=0?e.slice(0,t):e}E.prototype.addEventListener=function(e,t){"function"==typeof t&&(Array.isArray(this.listeners[e])||(this.listeners[e]=[]),0===function(e,t){void 0===e&&(e=[]);var n=[];return e.forEach((function(e){t(e)&&n.push(e)})),n}(this.listeners[e],(function(e){return e===t})).length&&this.listeners[e].push(t))},E.prototype.removeEventListener=function(e,t){var n=this.listeners[e];this.listeners[e]=j(n,(function(e){return e===t}))},E.prototype.dispatchEvent=function(e){for(var t=this,n=[],r=arguments.length-1;r-- >0;)n[r]=arguments[r+1];var i=e.type,s=this.listeners[i];return!!Array.isArray(s)&&(s.forEach((function(r){n.length>0?r.apply(t,n):r.call(t,e)})),!0)};var x=function(){this.urlMap={}};x.prototype.attachWebSocket=function(e,t){var n=O(t),r=this.urlMap[n];if(r&&r.server&&-1===r.websockets.indexOf(e))return r.websockets.push(e),r.server},x.prototype.addMembershipToRoom=function(e,t){var n=this.urlMap[O(e.url)];n&&n.server&&-1!==n.websockets.indexOf(e)&&(n.roomMemberships[t]||(n.roomMemberships[t]=[]),n.roomMemberships[t].push(e))},x.prototype.attachServer=function(e,t){var n=O(t);if(!this.urlMap[n])return this.urlMap[n]={server:e,websockets:[],roomMemberships:{}},e},x.prototype.serverLookup=function(e){var t=O(e),n=this.urlMap[t];if(n)return n.server},x.prototype.websocketsLookup=function(e,t,n){var r,i=O(e),s=this.urlMap[i];return r=s?s.websockets:[],t&&(r=s.roomMemberships[t]||[]),n?r.filter((function(e){return e!==n})):r},x.prototype.removeServer=function(e){delete this.urlMap[O(e)]},x.prototype.removeWebSocket=function(e,t){var n=O(t),r=this.urlMap[n];r&&(r.websockets=j(r.websockets,(function(t){return t===e})))},x.prototype.removeMembershipFromRoom=function(e,t){var n=this.urlMap[O(e.url)],r=n.roomMemberships[t];n&&null!==r&&(n.roomMemberships[t]=j(r,(function(t){return t===e})))};var S=new x,A={CLOSE_NORMAL:1e3,CLOSE_GOING_AWAY:1001,CLOSE_PROTOCOL_ERROR:1002,CLOSE_UNSUPPORTED:1003,CLOSE_NO_STATUS:1005,CLOSE_ABNORMAL:1006,UNSUPPORTED_DATA:1007,POLICY_VIOLATION:1008,CLOSE_TOO_LARGE:1009,MISSING_EXTENSION:1010,INTERNAL_ERROR:1011,SERVICE_RESTART:1012,TRY_AGAIN_LATER:1013,TLS_HANDSHAKE:1015},T={CONSTRUCTOR_ERROR:"Failed to construct 'WebSocket':",CLOSE_ERROR:"Failed to execute 'close' on 'WebSocket':",EVENT:{CONSTRUCT:"Failed to construct 'Event':",MESSAGE:"Failed to construct 'MessageEvent':",CLOSE:"Failed to construct 'CloseEvent':"}},I=function(){};I.prototype.stopPropagation=function(){},I.prototype.stopImmediatePropagation=function(){},I.prototype.initEvent=function(e,t,n){void 0===e&&(e="undefined"),void 0===t&&(t=!1),void 0===n&&(n=!1),this.type=""+e,this.bubbles=Boolean(t),this.cancelable=Boolean(n)};var U=function(e){function t(t,n){if(void 0===n&&(n={}),e.call(this),!t)throw new TypeError(T.EVENT_ERROR+" 1 argument required, but only 0 present.");if("object"!=typeof n)throw new TypeError(T.EVENT_ERROR+" parameter 2 ('eventInitDict') is not an object.");var r=n.bubbles,i=n.cancelable;this.type=""+t,this.timeStamp=Date.now(),this.target=null,this.srcElement=null,this.returnValue=!0,this.isTrusted=!1,this.eventPhase=0,this.defaultPrevented=!1,this.currentTarget=null,this.cancelable=!!i&&Boolean(i),this.cancelBubble=!1,this.bubbles=!!r&&Boolean(r)}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t}(I),C=function(e){function t(t,n){if(void 0===n&&(n={}),e.call(this),!t)throw new TypeError(T.EVENT.MESSAGE+" 1 argument required, but only 0 present.");if("object"!=typeof n)throw new TypeError(T.EVENT.MESSAGE+" parameter 2 ('eventInitDict') is not an object");var r=n.bubbles,i=n.cancelable,s=n.data,o=n.origin,a=n.lastEventId,c=n.ports;this.type=""+t,this.timeStamp=Date.now(),this.target=null,this.srcElement=null,this.returnValue=!0,this.isTrusted=!1,this.eventPhase=0,this.defaultPrevented=!1,this.currentTarget=null,this.cancelable=!!i&&Boolean(i),this.canncelBubble=!1,this.bubbles=!!r&&Boolean(r),this.origin=""+o,this.ports=void 0===c?null:c,this.data=void 0===s?null:s,this.lastEventId=""+(a||"")}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t}(I),R=function(e){function t(t,n){if(void 0===n&&(n={}),e.call(this),!t)throw new TypeError(T.EVENT.CLOSE+" 1 argument required, but only 0 present.");if("object"!=typeof n)throw new TypeError(T.EVENT.CLOSE+" parameter 2 ('eventInitDict') is not an object");var r=n.bubbles,i=n.cancelable,s=n.code,o=n.reason,a=n.wasClean;this.type=""+t,this.timeStamp=Date.now(),this.target=null,this.srcElement=null,this.returnValue=!0,this.isTrusted=!1,this.eventPhase=0,this.defaultPrevented=!1,this.currentTarget=null,this.cancelable=!!i&&Boolean(i),this.cancelBubble=!1,this.bubbles=!!r&&Boolean(r),this.code="number"==typeof s?parseInt(s,10):0,this.reason=""+(o||""),this.wasClean=!!a&&Boolean(a)}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t}(I);function D(e){var t=e.type,n=e.target,r=new U(t);return n&&(r.target=n,r.srcElement=n,r.currentTarget=n),r}function P(e){var t=e.type,n=e.origin,r=e.data,i=e.target,s=new C(t,{data:r,origin:n});return i&&(s.target=i,s.srcElement=i,s.currentTarget=i),s}function M(e){var t=e.code,n=e.reason,r=e.type,i=e.target,s=e.wasClean;s||(s=t===A.CLOSE_NORMAL||t===A.CLOSE_NO_STATUS);var o=new R(r,{code:t,reason:n,wasClean:s});return i&&(o.target=i,o.srcElement=i,o.currentTarget=i),o}function L(e,t,n){e.readyState=N.CLOSING;var r=S.serverLookup(e.url),i=M({type:"close",target:e.target,code:t,reason:n});v((function(){S.removeWebSocket(e,e.url),e.readyState=N.CLOSED,e.dispatchEvent(i),r&&r.dispatchEvent(i,r)}),e)}function W(e){return"[object Blob]"===Object.prototype.toString.call(e)||e instanceof ArrayBuffer||(e=String(e)),e}var B=new WeakMap;function q(e){if(B.has(e))return B.get(e);var t=new Proxy(e,{get:function(n,r){if("close"===r)return function(e){void 0===e&&(e={});var n=e.code||A.CLOSE_NORMAL,r=e.reason||"";L(t,n,r)};if("send"===r)return function(t){t=W(t),e.dispatchEvent(P({type:"message",data:t,origin:this.url,target:e}))};var i=function(e){return"message"===e?"server::"+e:e};return"on"===r?function(t,n){e.addEventListener(i(t),n)}:"off"===r?function(t,n){e.removeEventListener(i(t),n)}:"target"===r?e:n[r]}});return B.set(e,t),t}var N=function(e){function t(n,r){e.call(this),this._onopen=null,this._onmessage=null,this._onerror=null,this._onclose=null,this.url=function(e){var t=new w(e),n=t.pathname,r=t.protocol,i=t.hash;if(!e)throw new TypeError(T.CONSTRUCTOR_ERROR+" 1 argument required, but only 0 present.");if(n||(t.pathname="/"),""===r)throw new SyntaxError(T.CONSTRUCTOR_ERROR+" The URL '"+t.toString()+"' is invalid.");if("ws:"!==r&&"wss:"!==r)throw new SyntaxError(T.CONSTRUCTOR_ERROR+" The URL's scheme must be either 'ws' or 'wss'. '"+r+"' is not allowed.");if(""!==i)throw new SyntaxError(T.CONSTRUCTOR_ERROR+" The URL contains a fragment identifier ('"+i+"'). Fragment identifiers are not allowed in WebSocket URLs.");return t.toString()}(n),r=function(e){if(void 0===e&&(e=[]),!Array.isArray(e)&&"string"!=typeof e)throw new SyntaxError(T.CONSTRUCTOR_ERROR+" The subprotocol '"+e.toString()+"' is invalid.");"string"==typeof e&&(e=[e]);var t=e.map((function(e){return{count:1,protocol:e}})).reduce((function(e,t){return e[t.protocol]=(e[t.protocol]||0)+t.count,e}),{}),n=Object.keys(t).filter((function(e){return t[e]>1}));if(n.length>0)throw new SyntaxError(T.CONSTRUCTOR_ERROR+" The subprotocol '"+n[0]+"' is duplicated.");return e}(r),this.protocol=r[0]||"",this.binaryType="blob",this.readyState=t.CONNECTING;var i=q(this),s=S.attachWebSocket(i,this.url);v((function(){if(this.readyState===t.CONNECTING)if(s)if(s.options.verifyClient&&"function"==typeof s.options.verifyClient&&!s.options.verifyClient())this.readyState=t.CLOSED,k("error","WebSocket connection to '"+this.url+"' failed: HTTP Authentication failed; no valid credentials available"),S.removeWebSocket(i,this.url),this.dispatchEvent(D({type:"error",target:this})),this.dispatchEvent(M({type:"close",target:this,code:A.CLOSE_NORMAL}));else{if(s.options.selectProtocol&&"function"==typeof s.options.selectProtocol){var e=s.options.selectProtocol(r),n=""!==e,o=-1!==r.indexOf(e);if(n&&!o)return this.readyState=t.CLOSED,k("error","WebSocket connection to '"+this.url+"' failed: Invalid Sub-Protocol"),S.removeWebSocket(i,this.url),this.dispatchEvent(D({type:"error",target:this})),void this.dispatchEvent(M({type:"close",target:this,code:A.CLOSE_NORMAL}));this.protocol=e}this.readyState=t.OPEN,this.dispatchEvent(D({type:"open",target:this})),s.dispatchEvent(D({type:"connection"}),i)}else this.readyState=t.CLOSED,this.dispatchEvent(D({type:"error",target:this})),this.dispatchEvent(M({type:"close",target:this,code:A.CLOSE_NORMAL})),k("error","WebSocket connection to '"+this.url+"' failed")}),this)}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var n={onopen:{},onmessage:{},onclose:{},onerror:{}};return n.onopen.get=function(){return this._onopen},n.onmessage.get=function(){return this._onmessage},n.onclose.get=function(){return this._onclose},n.onerror.get=function(){return this._onerror},n.onopen.set=function(e){this.removeEventListener("open",this._onopen),this._onopen=e,this.addEventListener("open",e)},n.onmessage.set=function(e){this.removeEventListener("message",this._onmessage),this._onmessage=e,this.addEventListener("message",e)},n.onclose.set=function(e){this.removeEventListener("close",this._onclose),this._onclose=e,this.addEventListener("close",e)},n.onerror.set=function(e){this.removeEventListener("error",this._onerror),this._onerror=e,this.addEventListener("error",e)},t.prototype.send=function(e){var n=this;if(this.readyState===t.CONNECTING)throw new Error("Failed to execute 'send' on 'WebSocket': Still in CONNECTING state");var r=P({type:"server::message",origin:this.url,data:W(e)}),i=S.serverLookup(this.url);i&&v((function(){n.dispatchEvent(r,e)}),i)},t.prototype.close=function(e,n){if(void 0!==e&&("number"!=typeof e||1e3!==e&&(e<3e3||e>4999)))throw new TypeError(T.CLOSE_ERROR+" The code must be either 1000, or between 3000 and 4999. "+e+" is neither.");if(void 0!==n&&(r=n,i=encodeURIComponent(r).match(/%[89ABab]/g),r.length+(i?i.length:0)>123))throw new SyntaxError(T.CLOSE_ERROR+" The message must not be greater than 123 bytes.");var r,i;if(this.readyState!==t.CLOSING&&this.readyState!==t.CLOSED){var s=q(this);this.readyState===t.CONNECTING?function(e,t,n){e.readyState=N.CLOSING;var r=S.serverLookup(e.url),i=M({type:"close",target:e.target,code:t,reason:n,wasClean:!1}),s=D({type:"error",target:e.target});v((function(){S.removeWebSocket(e,e.url),e.readyState=N.CLOSED,e.dispatchEvent(s),e.dispatchEvent(i),r&&r.dispatchEvent(i,r)}),e)}(s,e||A.CLOSE_ABNORMAL,n):L(s,e||A.CLOSE_NO_STATUS,n)}},Object.defineProperties(t.prototype,n),t}(E);N.CONNECTING=0,N.prototype.CONNECTING=N.CONNECTING,N.OPEN=1,N.prototype.OPEN=N.OPEN,N.CLOSING=2,N.prototype.CLOSING=N.CLOSING,N.CLOSED=3,N.prototype.CLOSED=N.CLOSED;var F=function(e){function t(n,r){var i=this;void 0===n&&(n="socket.io"),void 0===r&&(r=""),e.call(this),this.binaryType="blob";var s=new w(n);s.pathname||(s.pathname="/"),this.url=s.toString(),this.readyState=t.CONNECTING,this.protocol="",this.target=this,"string"==typeof r||"object"==typeof r&&null!==r?this.protocol=r:Array.isArray(r)&&r.length>0&&(this.protocol=r[0]);var o=S.attachWebSocket(this,this.url);v((function(){o?(this.readyState=t.OPEN,o.dispatchEvent(D({type:"connection"}),o,this),o.dispatchEvent(D({type:"connect"}),o,this),this.dispatchEvent(D({type:"connect",target:this}))):(this.readyState=t.CLOSED,this.dispatchEvent(D({type:"error",target:this})),this.dispatchEvent(M({type:"close",target:this,code:A.CLOSE_NORMAL})),k("error","Socket.io connection to '"+this.url+"' failed"))}),this),this.addEventListener("close",(function(e){i.dispatchEvent(M({type:"disconnect",target:e.target,code:e.code}))}))}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var n={broadcast:{}};return t.prototype.close=function(){if(this.readyState===t.OPEN){var e=S.serverLookup(this.url);return S.removeWebSocket(this,this.url),this.readyState=t.CLOSED,this.dispatchEvent(M({type:"close",target:this,code:A.CLOSE_NORMAL})),e&&e.dispatchEvent(M({type:"disconnect",target:this,code:A.CLOSE_NORMAL}),e),this}},t.prototype.disconnect=function(){return this.close()},t.prototype.emit=function(e){for(var n=[],r=arguments.length-1;r-- >0;)n[r]=arguments[r+1];if(this.readyState!==t.OPEN)throw new Error("SocketIO is already in CLOSING or CLOSED state");var i=P({type:e,origin:this.url,data:n}),s=S.serverLookup(this.url);return s&&s.dispatchEvent.apply(s,[i].concat(n)),this},t.prototype.send=function(e){return this.emit("message",e),this},n.broadcast.get=function(){if(this.readyState!==t.OPEN)throw new Error("SocketIO is already in CLOSING or CLOSED state");var e=this,n=S.serverLookup(this.url);if(!n)throw new Error("SocketIO can not find a server at the specified URL ("+this.url+")");return{emit:function(t,r){return n.emit(t,r,{websockets:S.websocketsLookup(e.url,null,e)}),e},to:function(t){return n.to(t,e)},in:function(t){return n.in(t,e)}}},t.prototype.on=function(e,t){return this.addEventListener(e,t),this},t.prototype.off=function(e,t){this.removeEventListener(e,t)},t.prototype.hasListeners=function(e){var t=this.listeners[e];return!!Array.isArray(t)&&!!t.length},t.prototype.join=function(e){S.addMembershipToRoom(this,e)},t.prototype.leave=function(e){S.removeMembershipFromRoom(this,e)},t.prototype.to=function(e){return this.broadcast.to(e)},t.prototype.in=function(){return this.to.apply(null,arguments)},t.prototype.dispatchEvent=function(e){for(var t=this,n=[],r=arguments.length-1;r-- >0;)n[r]=arguments[r+1];var i=e.type,s=this.listeners[i];if(!Array.isArray(s))return!1;s.forEach((function(r){n.length>0?r.apply(t,n):r.call(t,e.data?e.data:e)}))},Object.defineProperties(t.prototype,n),t}(E);F.CONNECTING=0,F.OPEN=1,F.CLOSING=2,F.CLOSED=3;var $=function(e,t){return new F(e,t)};$.connect=function(e,t){return $(e,t)};function z(){return"undefined"!=typeof window?window:"object"==typeof process&&"object"==typeof n.g?n.g:this}var K={mock:!0,verifyClient:null,selectProtocol:null},H=function(e){function t(t,n){void 0===n&&(n=K),e.call(this);var r=new w(t);if(r.pathname||(r.pathname="/"),this.url=r.toString(),this.originalWebSocket=null,!S.attachServer(this,this.url))throw this.dispatchEvent(D({type:"error"})),new Error("A mock server is already listening on this url");this.options=Object.assign({},K,n),this.options.mock&&this.mockWebsocket()}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.prototype.mockWebsocket=function(){var e=z();this.originalWebSocket=e.WebSocket,e.WebSocket=N},t.prototype.restoreWebsocket=function(){var e=z();null!==this.originalWebSocket&&(e.WebSocket=this.originalWebSocket),this.originalWebSocket=null},t.prototype.stop=function(e){void 0===e&&(e=function(){}),this.options.mock&&this.restoreWebsocket(),S.removeServer(this.url),"function"==typeof e&&e()},t.prototype.on=function(e,t){this.addEventListener(e,t)},t.prototype.off=function(e,t){this.removeEventListener(e,t)},t.prototype.close=function(e){void 0===e&&(e={});var t=e.code,n=e.reason,r=e.wasClean,i=S.websocketsLookup(this.url);S.removeServer(this.url),i.forEach((function(e){e.readyState=N.CLOSED,e.dispatchEvent(M({type:"close",target:e.target,code:t||A.CLOSE_NORMAL,reason:n||"",wasClean:r}))})),this.dispatchEvent(M({type:"close"}),this)},t.prototype.emit=function(e,t,n){var r=this;void 0===n&&(n={});var i,s=n.websockets;s||(s=S.websocketsLookup(this.url)),"object"!=typeof n||arguments.length>3?(t=Array.prototype.slice.call(arguments,1,arguments.length),i=t.map((function(e){return W(e)}))):i=W(t),s.forEach((function(n){var s=n instanceof F?t:i;Array.isArray(s)?n.dispatchEvent.apply(n,[P({type:e,data:s,origin:r.url,target:n.target})].concat(s)):n.dispatchEvent(P({type:e,data:s,origin:r.url,target:n.target}))}))},t.prototype.clients=function(){return S.websocketsLookup(this.url)},t.prototype.to=function(e,t,n){var r=this;void 0===n&&(n=[]);var i=this,s=n.concat(S.websocketsLookup(this.url,e,t)).reduce((function(e,t){return e.indexOf(t)>-1?e:e.concat(t)}),[]);return{to:function(e,t){return r.to.call(r,e,t,s)},emit:function(e,t){i.emit(e,t,{websockets:s})}}},t.prototype.in=function(){for(var e=[],t=arguments.length;t--;)e[t]=arguments[t];return this.to.apply(null,e)},t.prototype.simulate=function(e){var t=S.websocketsLookup(this.url);"error"===e&&t.forEach((function(e){e.readyState=N.CLOSED,e.dispatchEvent(D({type:"error",target:e.target}))}))},t}(E);H.of=function(e){return new H(e)};var V=H,G=N,X=$;e.Server=V,e.WebSocket=G,e.SocketIO=X,Object.defineProperty(e,"__esModule",{value:!0})}(t)},112:function(e,t){(function(){var n=this,r={};function i(e){return null!=e}if(e.exports&&(t=e.exports=r),t.redismock=r,void 0===s||"function"!=typeof s)var s=function(e){setTimeout(e,0)};function o(){return this.scores=[],this.set={},this.invset={},this.indices={},this.lengths={},this.card=0,this}r.Array=Array,o.prototype.add=function(e,t){var n=1;return i(this.invset[t])&&(this.rem(t),n=0),i(this.set[e])||(this.scores.push(e),this.set[e]=[],this.lengths[e]=0),this.set[e].push(t),this.invset[t]=e,this.indices[t]=this.set[e].length-1,this.lengths[e]+=1,this.card+=1,n},o.prototype.rem=function(e){var t;return i(this.invset[e])?(t=this.invset[e],this.set[t].splice(this.set[t].indexOf(e),1),this.lengths[t]-=1,0===this.lengths[t]&&(this.set[t]=void 0,this.scores.splice(this.scores.indexOf(t),1)),this.invset[e]=void 0,this.indices[e]=void 0,this.card-=1,1):0},o.prototype.sortScores=function(){return this.scores.sort((function(e,t){return parseInt(e,10)-parseInt(t,10)})),this},o.prototype.sortScoresRev=function(){return this.scores.sort((function(e,t){return parseInt(t,10)-parseInt(e,10)})),this},r.SortedSet=function(){return new o};var a={},c={},l=[],u={},d="sets-"+Math.random(),h="zsets-"+Math.random(),p="hashes-"+Math.random();function f(e){var t,n,r,i,s=0,o=e.length||0;for(n="^";s<o;)if(r=e[s],s+=1,"*"===r)n+=".*";else if("?"===r)n+=".";else if("["===r){for((t=s)<o&&"!"===e[t]&&(t+=1),t<o&&"]"===e[t]&&(t+=1);t<o&&"]"!==e[t];)t+=1;t>=o?n+="\\[":(i=e.slice(s,t).replace("\\","\\\\"),s=t+1,"!"===i[0]?i="^"+i.slice(1):"^"===i[0]&&(i="\\"+i),n=n+"["+i+"]")}else n+=r.escape();return n+"$"}a[d]={},a[h]={},a[p]={},String.prototype.escape=function(){var e;return e={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",".":"\\.",'"':'\\"',"\\":"\\\\"},this.replace(/[.\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,(function(t){var n=e[t];return"string"==typeof n?n:"\\u"+("0000"+t.charCodeAt(0).toString(16)).slice(-4)}))};var _=function(e,t){return function(){var n=arguments;return e&&"function"==typeof e&&s((function(){e.apply(t,n)})),n[0]instanceof Error?n[0]:n[1]}},m=function(){return function(){var e,t,n=[];for(e=arguments.length-1;e>=0;e-=1)t||"function"!=typeof arguments[e]?i(arguments[e])&&n.unshift(arguments[e]):t=arguments[e];return{callback:t,list:n}}},y=function(e){return _(e)(new Error("WRONGTYPE Operation against a key holding the wrong kind of value"))};function g(e,t){var n=m().apply(null,arguments);i(e.listeners[t])&&e.listeners[t].forEach((function(t){s((function(){t.apply(e,n.list.slice(2))}))}))}function b(e){return this.rm=e,this}r.ifType=function(e,t,n){var r=this;return{thenex:function(e){return this._ifex=e,this},thennx:function(e){return this._ifnx=e,this},then:function(e){return this._then=e,this},end:function(){var i;if(r.exists(e)){if(r.type(e)!==t)return y(n);if("function"==typeof this._ifex&&(i=this._ifex.call(r))&&i instanceof Error)return _(n)(i)}else if("function"==typeof this._ifnx&&(i=this._ifnx.call(r))&&i instanceof Error)return _(n)(i);return"function"==typeof this._then&&(i=this._then.call(r))&&i instanceof Error?_(n)(i):_(n)(null,i)}}},r.del=function(e,t){var n=this,r=0,i=m(this.del).apply(this,arguments);t=i.callback;var s=i.list;return"object"==typeof i.list[0]&&(s=i.list[0]),s.forEach((function(e){r+=function(e){return n.exists(e)?(e in a?a[e]=void 0:e in a[d]?a[d][e]=void 0:e in a[h]?a[h][e]=void 0:e in a[p]&&(a[p][e]=void 0),1):0}(e)})),_(t)(null,r)},r.dump=function(e,t){return _(t)(new Error("UNIMPLEMENTED"))},r.exists=function(e,t){return _(t)(null,i(a[e])||i(a[d][e])||i(a[h][e])||i(a[p][e])?1:0)},r.expire=function(e,t,n){return this.pexpire(e,1e3*t,n)},r.expireat=function(e,t,n){var r=new Date;return this.pexpire(e,1e3*t-r.getTime(),n)},r.keys=function(e,t){var n,r=[],i=new RegExp(f(e));for(n in a)n!==d&&n!==h&&n!==p&&a.hasOwnProperty(n)&&null!==n.match(i)&&r.push(n);for(n in a[d])a[d].hasOwnProperty(n)&&null!==n.match(i)&&r.push(n);for(n in a[h])a[h].hasOwnProperty(n)&&null!==n.match(i)&&r.push(n);for(n in a[p])a[p].hasOwnProperty(n)&&null!==n.match(i)&&r.push(n);return _(t)(null,r)},r.migrate=function(e,t,n,r,i,s){return _(s)(new Error("UNIMPLEMENTED"))},r.move=function(e,t,n){return _(n)(new Error("UNIMPLEMENTED"))},r.object=function(e,t){return _(t)(new Error("UNIMPLEMENTED"))},r.persist=function(e,t){return this.exists(e)&&c[e]?(clearTimeout(c[e].timeout),_(t)(null,1)):_(t)(null,0)},r.pexpire=function(e,t,n){var r=this;return this.exists(e)?(c[e]&&clearTimeout(c[e].timeout),t<=0?this.del(e):(c[e]={},c[e].start=new Date,c[e].end=new Date(c[e].start.getTime()+t),c[e].timeout=setTimeout((function(){c[e]=void 0,r.del(e)}),t)),_(n)(null,1)):_(n)(null,0)},r.pexpireat=function(e,t,n){var r=new Date;return this.pexpire(e,t-r.getTime(),n)},r.pttl=function(e,t){var n=new Date;return c[e]?_(t)(null,c[e].end.getTime()-n.getTime()):_(t)(null,this.exists(e)?-1:-2)},r.randomkey=function(e){var t=null;return function e(n,r){var i;for(i in r)i!==d?i!==h?i!==p?(Math.random()<1/n&&(t=i),n+=1):n=e(n,a[p]):n=e(n,a[h]):n=e(n,a[d]);return n}(1,a),_(e)(null,t)},r.rename=function(e,t,n){var r;return this.exists(e)?(e===t||("string"===(r=this.type(e))||"list"===r?a[t]=a[e]:"set"===r?a[d][t]=a[d][e]:"zset"===r?a[h][t]=a[h][e]:"hash"===r&&(a[p][t]=a[p][e]),this.del(e)),_(n)(null,"OK")):_(n)(new Error("ERR no such key"))},r.renamenx=function(e,t,n){var r;return this.exists(t)?_(n)(null,0):(r=this.rename(e,t))instanceof Error?_(n)(r):_(n)(null,1)},r.restore=function(e,t,n,r){return _(r)(new Error("UNIMPLEMENTED"))},r.sort=function(e,t){return _(t)(new Error("UNIMPLEMENTED"))},r.ttl=function(e,t){var n=new Date;return c[e]?_(t)(null,(c[e].end.getTime()-n.getTime())/1e3):_(t)(null,this.exists(e)?-1:-2)},r.type=function(e,t){if(this.exists(e)){var n=typeof a[e];return"object"===n?a[e]instanceof Array&&(n="list"):"undefined"===n&&(e in a[d]&&a[d][e]?n="set":e in a[h]&&a[h][e]?n="zset":e in a[p]&&a[p][e]&&(n="hash")),_(t)(null,n)}return _(t)(null,"none")},r.scan=function(e,t){var n,r,s,o=m(this.scan).apply(null,arguments),c=0,l=[];for(n in o.list.forEach((function(e,t){"count"===e&&(r=o.list[t+1]),"match"===e&&(s=new RegExp(f(o.list[t+1])))})),(void 0===r||isNaN(parseInt(r,10)))&&(r=10),t=o.callback,a)if(a.hasOwnProperty(n)){if(n===d||n===h||n===p)continue;if((c+=1)>e&&(!i(s)||n.match(s))&&(l.push(n),l.length>=r))return _(t)(null,[c,l])}for(n in a[d])if(a[d].hasOwnProperty(n)&&(c+=1)>e&&(!i(s)||n.match(s))&&(l.push(n),l.length>=r))return _(t)(null,[c,l]);for(n in a[h])if(a[h].hasOwnProperty(n)&&(c+=1)>e&&(!i(s)||n.match(s))&&(l.push(n),l.length>=r))return _(t)(null,[c,l]);for(n in a[p])if(a[p].hasOwnProperty(n)&&(c+=1)>e&&(!i(s)||n.match(s))&&(l.push(n),l.length>=r))return _(t)(null,[c,l]);return l.length||(c=0),_(t)(null,[c,l])},r.append=function(e,t,n){return this.ifType(e,"string",n).thenex((function(){return a[e]+=t,null})).thennx((function(){return this.set(e,t)})).then((function(){return a[e].length})).end()},r.bitcount=function(e,t){var n,r,s=m(this.bitcount).apply(this,arguments);return t=s.callback,3===s.list.length&&(n=s.list[1],r=s.list[2]),this.ifType(e,"string",t).thenex((function(){var t,s,o;if(i(n)||(n=0),i(r)||(r=a[e].length-1),r>=a[e].length&&(r=a[e].length-1),n<0&&(n=a[e].length+n),r<0&&(r=a[e].length+r),n>r)return 0;for(o=0,t=n;t<=r;t+=1)for(s=a[e].charCodeAt(t);s;)o+=1&s,s>>=1;return o})).thennx((function(){return 0})).end()},r.bitop=function(e,t,n,r){var i,s,o,c,l=this,u=m(this.bitop).apply(this,arguments);return"and"!==(e="string"==typeof e?e.toLowerCase():"")&&"or"!==e&&"xor"!==e&&"not"!==e?_(r)(new Error("ERR syntax error")):(r=u.callback,(s=u.list.slice(2).map((function(e){return l.exists(e)&&"string"!==l.type(e)?null:l.exists(e)?a[e]:""}))).some((function(e){return null===e}))?y(r):(i=s.reduce((function(e,t){return t.length>e?t.length:e}),0),o=(s=s.map((function(e){for(;e.length<i;)e+="\0";return e}))).reduce((function(t,n,r){var s,o,a;for(a="",s=0;s<i;s+=1)"and"===e?o=t.charCodeAt(s)&n.charCodeAt(s):"or"===e?o=t.charCodeAt(s)|n.charCodeAt(s):"xor"===e?o=r>0?t.charCodeAt(s)^n.charCodeAt(s):t.charCodeAt(s):"not"===e&&(o=~t.charCodeAt(s)),a+=String.fromCharCode(o);return a}),s[0]),(c=this.set(t,o))instanceof Error?_(r)(c):_(r)(null,o.length)))},r.bitpos=function(e,t,n){var r,i,s=m(this.bitpos).apply(this,arguments);return n=s.callback,s.list.length>2&&(r=s.list[2],i=s.list[3]),void 0===r&&(r=0),0!==t&&1!==t?_(n)(new Error("ERR The bit argument must be 1 or 0.")):this.ifType(e,"string",n).thennx((function(){return 0===t?0:-1})).thenex((function(){var n,s,o,c=!1;if(r<0&&(r=a[e].length+r),void 0===i&&(c=!0,i=a[e].length-1),i<0&&(i=a[e].length+i),r>i)return-1;for(n=r;n<=i;n+=1)for(s=a[e].charCodeAt(n),o=0;o<8;){if(0===t&&128&~s)return 8*n+o;if(1===t&&!(128&~s))return 8*n+o;s<<=1,o+=1}return 1===t?-1:0===t&&c?8*n:-1})).end()},r.decr=function(e,t){return this.decrby(e,1,t)},r.decrby=function(e,t,n){return this.ifType(e,"string",n).thennx((function(){this.set(e,"0")})).then((function(){var n=parseInt(this.get(e),10);return isNaN(n)?new Error("ERR value is not an integer or out of range"):(this.set(e,n-t),n-t)})).end()},r.get=function(e,t){return"string"===this.type(e)?_(t)(null,a[e]):_(t)(null,null)},r.getbit=function(e,t,n){return this.ifType(e,"string",n).thenex((function(){return t>=8*a[e].length?0:a[e].charCodeAt(Math.floor(t/8))>>t%8&1})).thennx((function(){return 0})).end()},r.getrange=function(e,t,n,r){return this.ifType(e,"string",r).thenex((function(){var r;return n<0&&(n=a[e].length+n),r=t<0?n-(a[e].length+t)+1:n-t+1,a[e].substr(t,r)})).thennx((function(){return""})).end()},r.getset=function(e,t,n){var r=this.get(e);return this.set(e,t),_(n)(null,r)},r.incr=function(e,t){return this.incrby(e,1,t)},r.incrby=function(e,t,n){return this.ifType(e,"string",n).thennx((function(){this.set(e,"0")})).then((function(){var n=parseInt(this.get(e),10);return isNaN(n)?new Error("ERR value is not an integer or out of range"):(this.set(e,n+t),n+t)})).end()},r.incrbyfloat=function(e,t,n){return this.ifType(e,"string",n).thennx((function(){this.set(e,"0")})).then((function(){var n=parseFloat(this.get(e));return isNaN(n)?new Error("ERR value is not an integer or out of range"):(this.set(e,n+t),this.get(e))})).end()},r.mget=function(e,t){var n=m(this.mget).apply(this,arguments);t=n.callback;var r="object"==typeof n.list[0]?n.list[0]:n.list;return _(t)(null,r.map((function(e){return a[e]||null})))},r.mset=function(e,t,n){var r=[],i=this,s=m(this.mset).apply(this,arguments);return n=s.callback,s.list.forEach((function(e,t){t%2==0&&r.push([e,s.list[t+1]])})),r.forEach((function(e){i.set(e[0],e[1])})),_(n)(null,"OK")},r.msetnx=function(e,t,n){var r=[],i=this,s=m(this.msetnx).apply(this,arguments);return n=s.callback,s.list.forEach((function(e,t){t%2==0&&r.push([e,s.list[t+1]])})),r.some((function(e){return i.exists(e[0])}))?_(n)(null,0):(r.forEach((function(e){i.set(e[0],e[1])})),_(n)(null,1))},r.psetex=function(e,t,n,r){return this.set(e,n),this.pexpire(e,t),_(r)(null,"OK")},r.set=function(e,t,n){var s=!1,o=!1,c=-1,l=-1,u=m(this.set).apply(this,arguments);return n=u.callback,u.list.forEach((function(e,t){"nx"===e||"NX"===e?s=!0:"xx"===e||"XX"===e?o=!0:"ex"===e||"EX"===e?c=u.list[t+1]:"px"!==e&&"PX"!==e||(l=u.list[t+1])})),s&&this.exists(e)||o&&!this.exists(e)?_(n)(null,null):(a[e]=i(t)?t.toString():"",-1!==l&&r.pexpire(e,l),-1!==c&&r.expire(e,c),_(n)(null,"OK"))},r.setbit=function(e,t,n,r){return this.ifType(e,"string",r).thennx((function(){a[e]=""})).then((function(){var r,i,s,o,c=Math.floor(t/8),l=t%8;if(0!==n&&1!==n)return new Error("ERR bit is not an integer or out of range");for(;a[e].length<c+1;)a[e]+="\0";for(o=a[e].charCodeAt(c),r=0,s=128;r<l;)s>>=1,r+=1;return i=o&s?1:0,0===n?o&=~s:o|=s,a[e]=a[e].substr(0,c)+String.fromCharCode(o)+a[e].substr(c+1),i})).end()},r.setex=function(e,t,n,r){return this.set(e,n),this.expire(e,t),_(r)(null,"OK")},r.setnx=function(e,t,n){return this.exists(e)?_(n)(null,0):(this.set(e,t),_(n)(null,1))},r.setrange=function(e,t,n,r){return this.ifType(e,"string",r).thennx((function(){a[e]=""})).then((function(){var r,i;if(a[e].length<t+n.length-1)for(r=a[e].length;r<t+n.length;r+=1)a[e]+="\0";for(i=a[e].substr(0,t),r=t;r<t+n.length;r+=1)i+=n[r-t];return i+=a[e].substr(t+n.length),a[e]=i,a[e].length})).end()},r.strlen=function(e,t){return this.exists(e)?this.ifType(e,"string",t).thenex((function(){return a[e].length})).thennx((function(){return 0})).end():_(t)(null,0)},r.blpop=function(e,t,n){var r=this,i=m(this.blpop).apply(null,arguments),o=i.list.slice(0,i.list.length-1);t=i.list[i.list.length-1],n=i.callback;var a,c=!1;return a=function(){if(c)return _(n)(null,null);o.some((function(e){var t=r.llen(e);return t instanceof Error?(_(n)(t),!0):t>0&&(r.lpop(e,n),!0)}))||s(a)},t>0&&setTimeout((function(){c=!0}),1e3*t),s(a),this},r.brpop=function(e,t,n){var r,i=this,o=m(this.brpop).apply(null,arguments),a=o.list.slice(0,o.list.length-1),c=!1;return t=o.list[o.list.length-1],n=o.callback,r=function(){if(c)return _(n)(null,null);a.some((function(e){var t=i.llen(e);return t instanceof Error?(_(n)(t),!0):t>0&&(i.rpop(e,n),!0)}))||s(r)},t>0&&setTimeout((function(){c=!0}),1e3*t),s(r),this},r.brpoplpush=function(e,t,n,r){var i,o=this,a=!1;return i=function(){var n;return a?_(r)(null,null):(n=o.llen(e))instanceof Error?_(r)(n):void(n>0?o.rpoplpush(e,t,r):s(i))},n>0&&setTimeout((function(){a=!0}),1e3*n),s(i),this},r.lindex=function(e,t,n){var r=null;return this.ifType(e,"list",n).thenex((function(){t>=0&&t<a[e].length?r=a[e][t]:t<0&&a[e].length+1>=0&&(r=a[e][a[e].length+t])})).then((function(){return r})).end()},r.linsert=function(e,t,n,r,i){return this.ifType(e,"list",i).thenex((function(){var i=a[e].indexOf(n);return-1!==i?("before"===t?a[e].splice(i,0,r):"after"===t&&a[e].splice(i+1,0,r),a[e].length):-1})).thennx((function(){return 0})).end()},r.llen=function(e,t){return this.ifType(e,"list",t).thenex((function(){return a[e].length})).thennx((function(){return 0})).end()},r.lpop=function(e,t){return this.ifType(e,"list",t).thenex((function(){var t=a[e].shift();return a[e].length||this.del(e),t})).thennx((function(){return null})).end()},r.lpush=function(e,t,n){var i=m(this.lpush).apply(this,arguments);return n=i.callback,this.ifType(e,"list",n).thennx((function(){a[e]=new r.Array})).then((function(){return i.list.slice(1).forEach((function(t){a[e].unshift(t)})),a[e].length})).end()},r.lpushx=function(e,t,n){return this.ifType(e,"list",n).thenex((function(){return a[e].unshift(t),a[e].length})).thennx((function(){return 0})).end()},r.lrange=function(e,t,n,r){var i=[];return this.ifType(e,"list",r).thenex((function(){t>a[e].length-1?i=[]:(t<0&&(t=a[e].length+t),n<0&&(n=a[e].length+n),i=t>n?[]:a[e].slice(t,n+1))})).then((function(){return i})).end()},r.lrem=function(e,t,n,r){var i=0;return this.ifType(e,"list",r).thenex((function(){for(var r;-1!==(r=a[e].indexOf(n))&&(a[e].splice(r,1),i+=1,!(t>0&&i===t)););a[e].length||this.del(e)})).then((function(){return i})).end()},r.lset=function(e,t,n,r){return this.ifType(e,"list",r).thenex((function(){return t>=a[e].length?new Error("ERR index out of range"):(a[e][t]=n,"OK")})).thennx((function(){return new Error("ERR no such key")})).end()},r.ltrim=function(e,t,n,i){return this.ifType(e,"list",i).thenex((function(){var i,s;t>a[e].length-1||t>n?a[e]=new r.Array:(t<0&&n<0&&(s=a[e].length+n,(i=a[e].length+t)<0&&(i=0),t=i,n=s),n>a[e].length-1&&(n=a[e].length-1),a[e]=a[e].slice(t,n+1))})).then((function(){return this.exists(e)&&!a[e].length&&this.del(e),"OK"})).end()},r.rpop=function(e,t){return this.ifType(e,"list",t).thenex((function(){var t=a[e].pop();return a[e].length||this.del(e),t})).thennx((function(){return null})).end()},r.rpoplpush=function(e,t,n){var r,i;return this.exists(e)&&"list"!==this.type(e)||this.exists(t)&&"list"!==this.type(t)?y(n):(r=this.rpop(e))instanceof Error?_(n)(r):r&&(i=this.lpush(t,r))instanceof Error?_(n)(i):_(n)(null,r)},r.rpush=function(e,t,n){var i=m(this.rpush).apply(this,arguments);return n=i.callback,this.ifType(e,"list",n).thennx((function(){a[e]=new r.Array})).then((function(){return a[e]=a[e].concat(i.list.slice(1)),a[e].length})).end()},r.rpushx=function(e,t,n){return this.ifType(e,"list",n).thenex((function(){return a[e].push(t),a[e].length})).thennx((function(){return 0})).end()},r.sadd=function(e,t,n){var r=m(this.sadd).apply(this,arguments),i=0;return n=r.callback,this.ifType(e,"set",n).thennx((function(){a[d][e]={}})).then((function(){return r.list.slice(1).forEach((function(t){0!==(t=t?t.toString():"").length&&(t in a[d][e]||(a[d][e][t]="",i+=1))})),i})).end()},r.scard=function(e,t){return this.ifType(e,"set",t).thenex((function(){return Object.keys(a[d][e]).length})).thennx((function(){return 0})).end()},r.sdiff=function(e,t){var n=this,r=m(this.sdiff).apply(this,arguments);return t=r.callback,r.list.every((function(e){return"set"===n.type(e)||"none"===n.type(e)}))?this.ifType(e,"set",t).thennx((function(){return[]})).thenex((function(){return r.list.slice(1).reduce((function(e,t){return e.filter((function(e){return!(e in a[d][t])}))}),this.smembers(r.list[0]))})).end():y(t)},r.sdiffstore=function(e,t,n){var r=m(this.sdiffstore).apply(this,arguments),i=this.sdiff.apply(this,r.list.slice(1));return n=r.callback,i instanceof Error?_(n)(i):(this.exists(e)&&this.del(e),this.sadd.apply(this,[e].concat(i)),_(n)(null,i.length))},r.sinter=function(e,t){var n=this,r=m(this.sinter).apply(this,arguments);return t=r.callback,r.list.every((function(e){return"set"===n.type(e)||"none"===n.type(e)}))?this.ifType(e,"set",t).thennx((function(){return[]})).thenex((function(){return r.list.slice(1).reduce((function(e,t){return e.filter((function(e){return e in a[d][t]}))}),this.smembers(r.list[0]))})).end():y(t)},r.sinterstore=function(e,t,n){var r=this,i=m(this.sinterstore).apply(this,arguments),s=this.sinter.apply(this,i.list.slice(1));return n=i.callback,s instanceof Error?_(n)(s):(this.exists(e)&&this.del(e),s.forEach((function(t){r.sadd(e,t)})),_(n)(null,s.length))},r.sismember=function(e,t,n){return this.ifType(e,"set",n).thenex((function(){return t in a[d][e]?1:0})).thennx((function(){return 0})).end()},r.smembers=function(e,t){return this.ifType(e,"set",t).thenex((function(){return Object.keys(a[d][e])})).thennx((function(){return[]})).end()},r.smove=function(e,t,n,i){var s,o;return this.exists(e)&&"set"!==this.type(e)||this.exists(t)&&"set"!==this.type(t)?y(i):(s=r.srem(e,n))instanceof Error?_(i)(s):1===s&&(o=r.sadd(t,n))instanceof Error?_(i)(o):_(i)(null,s)},r.spop=function(e,t){var n,r=this.srandmember(e);return r instanceof Error?_(t)(r):(n=this.srem(e,r))instanceof Error?_(t)(n):_(t)(null,r)},r.srandmember=function(e,t){var n,r=this;return 2===arguments.length&&"function"!=typeof t&&(n=t,t=null),3===arguments.length&&(n=t,t=arguments[2]),this.ifType(e,"set",t).thenex((function(){var t,i,s=Object.keys(a[d][e]),o=r.scard(e);if(0===n)return null;if(n){for(t=[];t.length<Math.abs(n);)if(i=s[Math.floor(Math.random()*s.length)],n<0)t.push(i);else if(-1===t.indexOf(i)&&(t.push(i),t.length===o))break;return t}return s[Math.floor(Math.random()*s.length)]})).thennx((function(){return null})).end()},r.srem=function(e,t,n){var r=m(this.srem).apply(this,arguments),i=0;return n=r.callback,this.ifType(e,"set",n).thenex((function(){r.list.slice(1).forEach((function(t){var n=t?t.toString():"";n in a[d][e]&&(delete a[d][e][n],i+=1)})),Object.keys(a[d][e]).length||this.del(e)})).then((function(){return i})).end()},r.sunion=function(e,t){var n=this,r=m(this.sunion).apply(this,arguments);return t=r.callback,r.list.every((function(e){return"set"===n.type(e)||"none"===n.type(e)}))?this.ifType(e,"set",t).thennx((function(){return[]})).thenex((function(){return Object.keys(r.list.reduce((function(e,t){return Object.keys(a[d][t]).filter((function(t){return!(t in e)})).forEach((function(t){e[t]=""})),e}),{}))})).end():y(t)},r.sunionstore=function(e,t,n){var r=this,i=m(this.sunionstore).apply(this,arguments),s=this.sunion.apply(this,i.list.slice(1));return n=i.callback,s instanceof Error?_(n)(s):(this.exists(e)&&this.del(e),s.forEach((function(t){r.sadd(e,t)})),_(n)(null,s.length))},r.sscan=function(e,t,n){var r,i,s=m(this.sscan).apply(this,arguments);return s.list.forEach((function(e,t){"count"===e&&(r=s.list[t+1]),"match"===e&&(i=new RegExp(f(s.list[t+1])))})),(void 0===r||isNaN(parseInt(r,10)))&&(r=10),n=s.callback,this.ifType(e,"set",n).then((function(){var n=[];return this.smembers(e).slice(t).some((function(e){return(void 0===i||e.match(i))&&n.push(e),t+=1,n.length>=r})),n.length||(t=0),[t,n]})).end()},r.zadd=function(e,t,n,i){var s=m(this.zadd).apply(this,arguments);return i=s.callback,s.list=s.list.slice(1),this.ifType(e,"zset",i).thennx((function(){a[h][e]=r.SortedSet()})).then((function(){return s.list.map((function(e,t){return t%2==0?[parseFloat(s.list[t]),s.list[t+1]]:null})).filter((function(e){return null!==e})).map((function(t){return a[h][e].add(t[0],t[1].toString())})).reduce((function(e,t){return e+t}),0)})).end()},r.zcard=function(e,t){return this.ifType(e,"zset",t).thenex((function(){return a[h][e].card})).thennx((function(){return 0})).end()},r.zcount=function(e,t,n,r){return this.ifType(e,"zset",r).thenex((function(){return a[h][e].scores.filter((function(e){return t<=e&&e<=n})).reduce((function(t,n){return t+a[h][e].lengths[n]}),0)})).thennx((function(){return 0})).end()},r.zincrby=function(e,t,n,s){return this.ifType(e,"zset",s).thennx((function(){a[h][e]=r.SortedSet()})).then((function(){var r;return i(a[h][e].invset[n])?(r=a[h][e].invset[n]+t,this.zadd(e,r,n),r):(this.zadd(e,t,n),t)})).end()},r.zinterstore=function(e,t,n,r){var s,o=this,c=m(this.zinterstore).apply(this,arguments),l={},u="sum";return r=c.callback,c.list.slice(2).every((function(e){return"zset"===o.type(e)||"none"===o.type(e)}))?(c.list.forEach((function(e,t){var n,r=[];if("weights"===e){for(n=t+1;"aggregate"!==c.list[n]&&n<c.list.length;)r.push(c.list[n]),n+=1;l=r.reduce((function(e,t,n){return e[c.list[n+2]]=t,e}),{})}else"aggregate"===e&&(u=c.list[t+1])})),this.exists(e)&&this.del(e),s=0,c.list=c.list.slice(2,2+t),c.list.slice(1).reduce((function(e,t){var n,r,s,o=[],c=e.length;for(n=0;n<c;n+=1)n%2==0&&i(r=a[h][t].invset[e[n]])&&(t in l&&(r*=l[t]),s=[e[n+1],e[n]],"min"===u?s[0]=Math.min(s[0],r):"max"===u?s[0]=Math.max(s[0],r):s[0]+=r,o.push(s[1],s[0]));return o}),this.zrange(c.list[0],0,-1,"withscores").map((function(e,t){return c.list[0]in l?t%2==0?e:e*l[c.list[0]]:e}))).forEach((function(t,n,r){n%2==0&&(o.zadd(e,r[n+1],t),s+=1)})),_(r)(null,s)):y(r)},r.zlexcount=function(e,t,n,r){var i=this.zrangebylex(e,t,n);return i instanceof Error?_(r)(i):_(r)(null,i.length)},r.zrange=function(e,t,n,r){var s=!1;return"function"!=typeof r&&"withscores"===r&&(s=!0,r=arguments[4]),t<0&&(t=Math.max(this.zcard(e)+t,0)),n<0&&(n=this.zcard(e)+n),this.ifType(e,"zset",r).thenex((function(){var r=0,o=0,c=[];return a[h][e].sortScores().scores.some((function(n){return o<=t&&o+a[h][e].lengths[n]>t||(o+=a[h][e].set[n].length,r+=1,!1)})),a[h][e].scores.slice(r).some((function(r){var l=[],u=a[h][e].lengths[r],d=0,p=0;if(o>n)return!0;for(;o<t;)o+=1,d+=1;for(p=d+1;o<=n&&p<=u;)o+=1,p+=1;for(;d<p;)i(a[h][e].set[r][d])&&l.push(a[h][e].set[r][d]),d+=1;return l.sort((function(e,t){return e.localeCompare(t)})),s&&(l=l.map((function(e){return[e,r]})).reduce((function(e,t){return e.concat(t)}),[])),c=c.concat(l),!1})),c})).thennx((function(){return[]})).end()},r.zrangebylex=function(e,t,n,r){function s(e){return"string"==typeof e&&("("===e.charAt(0)||"["===e.charAt(0)||"-"===e.charAt(0)||"+"===e.charAt(0))}return s(t)&&s(n)?this.ifType(e,"zset",r).thennx((function(){return[]})).thenex((function(){var r=t.substr(1),s=n.substr(1),o="["===t.charAt(0),c="["===n.charAt(0),l="+"===n.charAt(0),u=[];return"+"===t.charAt(0)||"-"===n.charAt(0)?[]:(a[h][e].scores.forEach((function(t){a[h][e].set[t].forEach((function(e){i(e)&&(e>r&&(e<s||l)||e===r&&o||e===s&&c)&&u.push(e)}))})),u.sort((function(e,t){return e.localeCompare(t)})),u)})).end():_(r)(new Error("ERR min or max not valid string range item"))},r.zrevrangebylex=function(e,t,n,r){var i=this.zrangebylex(e,n,t);return i instanceof Error?_(r)(i):_(r)(null,i.reverse())},r.zrangebyscore=function(e,t,n,r){var s,o,c,l,u=!1,d=-1,p=-1,f=[],_=!0,m=!0;if("function"!=typeof r)for(o=arguments.length,s=3;s<o;s+=1)"withscores"===arguments[s]&&(u=!0),"function"==typeof arguments[s]&&(r=arguments[s]),"limit"===arguments[s]&&(d=arguments[s+1],p=arguments[s+2]);return"-inf"===t&&(t=Number.NEGATIVE_INFINITY),"+inf"===t&&(t=Number.POSITIVE_INFINITY),"-inf"===n&&(n=Number.NEGATIVE_INFINITY),"+inf"===n&&(n=Number.POSITIVE_INFINITY),"("===t.toString().charAt(0)&&(_=!1,t=parseFloat(t.toString().substr(1))),"("===n.toString().charAt(0)&&(m=!1,n=parseFloat(n.toString().substr(1))),c=0,l=0,this.ifType(e,"zset",r).thenex((function(){return a[h][e].sortScores().scores.some((function(r){var s=[],o=[],y=[];return a[h][e].set[r].some((function(e){if(i(e)){if((_&&t<=r||!_&&t<r)&&(m&&r<=n||!m&&r<n))if(-1!==d&&c>=d){if(-1!==p){if(!(l+s.length<p))return!0;s.push(e),u&&o.push(r)}}else-1===d&&(s.push(e),u&&o.push(r));return c+=1,!1}})),l+=s.length,s.sort((function(e,t){return e.localeCompare(t)})),u?s.forEach((function(e,t){y.push(e,o[t])})):y=s,f=f.concat(y),-1!==p&&l===p})),f})).thennx((function(){return[]})).end()},r.zrank=function(e,t,n){return this.ifType(e,"zset",n).thenex((function(){var n=0;return a[h][e].sortScores(),a[h][e].scores.some((function(r){return-1!==a[h][e].set[r].indexOf(t)||(n+=1,!1)}))?n:null})).thennx((function(){return null})).end()},r.zrem=function(e,t,n){var r=m(this.zrem).apply(this,arguments);return n=r.callback,this.ifType(e,"zset",n).thenex((function(){var t=r.list.reduce((function(t,n){return t+a[h][e].rem(n)}),0);return 0===a[h][e].scores.length&&this.del(e),t})).thennx((function(){return 0})).end()},r.zremrangebylex=function(e,t,n,r){var i=this,s=this.zrangebylex(e,t,n);return s instanceof Error?_(r)(s):(s.forEach((function(t){i.zrem(e,t)})),_(r)(null,s.length))},r.zremrangebyrank=function(e,t,n,r){return this.ifType(e,"zset",r).thenex((function(){var r,i,s,o,c,l=this,u=a[h][e].scores.length,d=[],p=this.zcard(e);for(t<0&&(t=p+t),n<0&&(n=p+n),o=0,a[h][e].sortScores(),r=0;r<u;r+=1){for(c=a[h][e].scores[r],s=a[h][e].set[c].length,i=0;i<s&&(t<=o&&o<=n&&d.push(a[h][e].set[c][i]),!(o>n));i+=1,o+=1);if(o>n)break}return d.forEach((function(t){l.zrem(e,t)})),d.length})).thennx((function(){return 0})).end()},r.zremrangebyscore=function(e,t,n,r){var i=this,s=this.zrangebyscore(e,t,n);return s instanceof Error?_(r)(s):(s.forEach((function(t){i.zrem(e,t)})),_(r)(null,s.length))},r.zrevrange=function(e,t,n,r){var i=!1;return"function"!=typeof r&&"withscores"===r&&(i=!0,r=arguments[4]),t<0&&(t=this.zcard(e)+t),n<0&&(n=this.zcard(e)+n),this.ifType(e,"zset",r).thenex((function(){var r=0,s=0,o=[];return a[h][e].sortScoresRev().scores.some((function(n){return s<=t&&s+a[h][e].set[n].length>t||(s+=a[h][e].set[n].length,r+=1,!1)})),a[h][e].scores.slice(r).some((function(r){var c=[],l=a[h][e].set[r].length,u=0,d=0;if(s>n)return!0;for(;s<t;)s+=1,u+=1;for(d=u+1;s<=n&&d<=l;)s+=1,d+=1;return(c=a[h][e].set[r].slice(u,d)).sort((function(e,t){return t.localeCompare(e)})),i&&(c=c.map((function(e){return[e,r]})).reduce((function(e,t){return e.concat(t)}),[])),o=o.concat(c),!1})),o})).thennx((function(){return[]})).end()},r.zrevrangebyscore=function(e,t,n,r){var i,s,o=m(this.zrevrangebyscore).apply(this,arguments);return r=o.callback,s=o.list[1],o.list[1]=o.list[2],o.list[2]=s,(i=this.zrangebyscore.apply(this,o.list))instanceof Error?_(r)(i):(i.reverse(),o.list.some((function(e){return"withscores"===e}))&&(i=i.map((function(e,t){return t%2==0?i[t+1]:i[t-1]}))),_(r)(null,i))},r.zrevrank=function(e,t,n){return this.ifType(e,"zset",n).thenex((function(){var n,r,i,s=a[h][e].scores.length;for(r=0,a[h][e].sortScores(),n=s-1;n>=0;n-=1,r+=1)if(i=a[h][e].scores[n],-1!==a[h][e].set[i].indexOf(t))return r;return null})).thennx((function(){return null})).end()},r.zscore=function(e,t,n){return this.ifType(e,"zset",n).thenex((function(){var n=null;return i(a[h][e].invset[t])&&(n=a[h][e].invset[t]),n})).thennx((function(){return null})).end()},r.zunionstore=function(e,t,n,r){var s,o=this,c=m(this.zunionstore).apply(this,arguments),l={},u="sum";return r=c.callback,c.list.slice(2,2+t).every((function(e){return"zset"===o.type(e)||"none"===o.type(e)}))?(c.list.forEach((function(e,t){var n,r=[];if("weights"===e){for(n=t+1;"aggregate"!==c.list[n]&&n<c.list.length;)r.push(c.list[n]),n+=1;l=r.reduce((function(e,t,n){return e[c.list[n+2]]=t,e}),{})}else"aggregate"===e&&(u=c.list[t+1])})),this.exists(e)&&this.del(e),s=0,c.list=c.list.slice(2,2+t),c.list.slice(1).reduce((function(e,t){var n,r,s,o=[],c=e.length,d=a[h][t].invset,p={};for(n=0;n<c;n+=1)n%2==0&&(s=[e[n+1],e[n]],r=a[h][t].invset[e[n]],p[s[1]]=s[0],i(r)?(t in l&&(r*=l[t]),"min"===u?s[0]=Math.min(s[0],r):"max"===u?s[0]=Math.max(s[0],r):s[0]+=r,o.push(s[1],s[0])):o.push(s[1],s[0]));return Object.keys(d).forEach((function(e){i(d[e])&&(e in p||(r=d[e],t in l&&(r*=l[t]),o.push(e,r)))})),o}),this.zrange(c.list[0],0,-1,"withscores").map((function(e,t){return c.list[0]in l?t%2==0?e:e*l[c.list[0]]:e}))).forEach((function(t,n,r){n%2==0&&(o.zadd(e,r[n+1],t),s+=1)})),_(r)(null,s)):y(r)},r.zscan=function(e,t,n){var r,i,s=m(this.zscan).apply(this,arguments);return s.list.forEach((function(e,t){"count"===e&&(r=s.list[t+1]),"match"===e&&(i=new RegExp(f(s.list[t+1])))})),(void 0===r||isNaN(parseInt(r,10)))&&(r=10),n=s.callback,this.ifType(e,"zset",n).then((function(){var n=[],s=0;return a[h][e].sortScores().scores.some((function(o){return a[h][e].set[o].some((function(e){return t<=s&&((void 0===i||e.match(i))&&n.push([e,o]),t+=1),n.length>=r||(s+=1,!1)})),n.length>=r})),(n=n.reduce((function(e,t){return e.concat(t)}),[])).length||(t=0),[t,n]})).end()},r.hdel=function(e,t,n){var r=0,i=m(this.hdel).apply(this,arguments);return n=i.callback,this.ifType(e,"hash",n).thenex((function(){i.list.forEach((function(t){t in a[p][e]&&(a[p][e][t]=void 0,r+=1)})),0===Object.keys(a[p][e]).length&&this.del(e)})).then((function(){return r})).end()},r.hexists=function(e,t,n){return this.ifType(e,"hash",n).thenex((function(){return void 0!==a[p][e][t]?1:0})).thennx((function(){return 0})).end()},r.hget=function(e,t,n){return this.ifType(e,"hash",n).thenex((function(){return a[p][e][t]})).thennx((function(){return null})).end()},r.hgetall=function(e,t){return this.ifType(e,"hash",t).thenex((function(){return Object.keys(a[p][e]).map((function(t){return[t,a[p][e][t]]})).reduce((function(e,t){return e[t[0]]=t[1],e}),{})})).thennx((function(){return null})).end()},r.hgetall_array=function(e,t){return this.ifType(e,"hash",t).thenex((function(){return Object.keys(a[p][e]).map((function(t){return[t,a[p][e][t]]})).reduce((function(e,t){return e.concat(t)}),[])})).thennx((function(){return[]})).end()},r.hincrby=function(e,t,n,r){return n=parseInt(n,10),this.ifType(e,"hash",r).thennx((function(){a[p][e]={}})).then((function(){var r;if(0===this.hexists(e,t))this.hset(e,t,n);else{if(r=parseInt(this.hget(e,t),10),isNaN(r))return new Error("ERR hash value is not an integer");this.hset(e,t,r+n)}return this.hget(e,t)})).end()},r.hincrbyfloat=function(e,t,n,r){return this.ifType(e,"hash",r).thennx((function(){a[p][e]={}})).then((function(){var r;if(0===this.hexists(e,t))this.hset(e,t,n);else{if(r=parseFloat(this.hget(e,t)),isNaN(r))return new Error("ERR hash value is not a valid float");this.hset(e,t,r+n)}return this.hget(e,t)})).end()},r.hkeys=function(e,t){return this.ifType(e,"hash",t).thenex((function(){return Object.keys(a[p][e]).filter((function(t){return void 0!==a[p][e][t]}))})).thennx((function(){return[]})).end()},r.hlen=function(e,t){var n=this.hkeys(e);return n instanceof Error?_(t)(n):_(t)(null,n.length)},r.hmget=function(e,t,n){var r=m(this.hmget).apply(this,arguments);return n=r.callback,this.ifType(e,"hash",n).thenex((function(){return r.list=r.list.slice(1),r.list.map((function(t){return a[p][e][t]}))})).thennx((function(){return[]})).end()},r.hmset=function(e,t,n){var r=m(this.hmset).apply(this,arguments);return n=r.callback,this.ifType(e,"hash",n).thennx((function(){a[p][e]={}})).then((function(){var t=this,n=r.list[1];return 2!==r.list.length||"object"!=typeof n||n instanceof Array?(r.list=r.list.slice(1),r.list.map((function(e,t){return t%2==0?[e,r.list[t+1]]:null})).filter((function(e){return null!==e})).forEach((function(n){t.hset(e,n[0],n[1])}))):Object.keys(n).forEach((function(r){t.hset(e,r,n[r])})),"OK"})).end()},r.hset=function(e,t,n,r){var i;return this.ifType(e,"hash",r).thenex((function(){i=t in a[p][e]&&void 0!==a[p][e][t]?0:1})).thennx((function(){i=1,a[p][e]={}})).then((function(){return a[p][e][t]=n,i})).end()},r.hsetnx=function(e,t,n,r){var i;return this.ifType(e,"hash",r).thenex((function(){i=t in a[p][e]&&void 0!==a[p][e][t]?0:1})).thennx((function(){i=1,a[p][e]={}})).then((function(){return 1===i&&(a[p][e][t]=n),i})).end()},r.hstrlen=function(e,t,n){return this.ifType(e,"hash",n).thennx((function(){return 0})).thenex((function(){return i(a[p][e][t])?a[p][e][t].toString().length:0})).end()},r.hvals=function(e,t){var n=[];return this.ifType(e,"hash",t).thenex((function(){n=Object.keys(a[p][e]).filter((function(t){return void 0!==a[p][e][t]})).map((function(t){return a[p][e][t]}))})).then((function(){return n})).end()},r.hscan=function(e,t,n){var r,i,s=m(this.hscan).apply(this,arguments);return s.list.forEach((function(e,t){"count"===e&&(r=s.list[t+1]),"match"===e&&(i=new RegExp(f(s.list[t+1])))})),(void 0===r||isNaN(parseInt(r,10)))&&(r=10),n=s.callback,this.ifType(e,"hash",n).then((function(){var n=[];return this.hgetall_array(e).slice(2*t).some((function(e,s,o){return s%2==0&&((void 0===i||e.match(i))&&n.push([e,o[s+1]]),t+=1,n.length>=r)})),(n=n.reduce((function(e,t){return e.concat(t)}),[])).length||(t=0),[t,n]})).end()},r.on=function(e,t){return i(this.listeners)||(this.listeners={}),i(this.listeners[e])||(this.listeners[e]=[]),this.listeners[e].push(t),this},b.prototype.subscribe=function(e){return this.channel=e,g(this.rm,"subscribe",e,l.length),this},b.prototype.psubscribe=function(e){return this.originalPattern=e,this.pattern=new RegExp(f(e)),g(this.rm,"psubscribe",e,l.length),this},b.prototype.matches=function(e){return!(!i(this.channel)||this.channel!==e)||!(!i(this.pattern)||!e.match(this.pattern))},b.prototype.message=function(e,t){if(this.matches(e)){if(i(this.channel))return g(this.rm,"message",e,t),!0;if(i(this.pattern))return g(this.rm,"pmessage",this.originalPattern,e,t),!0}return!1},b.prototype.unsubscribe=function(e){return i(this.channel)&&g(this.rm,"unsubscribe",this.channel,e),i(this.pattern)&&g(this.rm,"punsubscribe",this.originalPattern,e),this},r.psubscribe=function(e,t){var n=this,r=m(this.psubscribe).apply(this,arguments);return t=r.callback,r.list.forEach((function(e){l.push(new b(n).psubscribe(e))})),_(t)(null,"OK")},r.pubsub=function(e,t){var n,r=m(this.pubsub).apply(this,arguments),s=null;return"channels"===e?(r.list[1]&&(n=new RegExp(f(r.list[1]))),s=l.map((function(e){return!i(e.channel)||n&&!e.channel.match(n)?null:e.channel})).filter((function(e){return null!==e}))):"numsub"===e?s=r.list.slice(1).map((function(e){return l.reduce((function(t,n){return n.channel===e?t+1:t}),0)})).reduce((function(e,t){return e.concat(t)}),[]):"numpat"===e&&(s=l.reduce((function(e,t){return i(t.pattern)?e+1:e}),0)),t=r.callback,_(t)(null,s)},r.publish=function(e,t,n){var r=l.reduce((function(n,r){return r.message(e.toString(),t.toString())?n+1:n}),0);return _(n)(null,r)},r.punsubscribe=function(e){var t=this,n=m(this.punsubscribe).apply(this,arguments),r=l.length;return e=n.callback,n.list.length?n.list.forEach((function(e){l=l.filter((function(n){return n.rm!==t||n.originalPattern!==e||(r-=1,n.unsubscribe(r),!1)}))})):l=l.filter((function(e){return e.rm!==t||(i(e.pattern)&&(r-=1,e.unsubscribe(r)),!i(e.pattern))})),_(e)(null,"OK")},r.subscribe=function(e,t){var n=this,r=m(this.subscribe).apply(this,arguments);return t=r.callback,r.list.forEach((function(e){l.push(new b(n).subscribe(e))})),_(t)(null,"OK")},r.unsubscribe=function(e){var t=this,n=m(this.unsubscribe).apply(this,arguments),r=l.length;return e=n.callback,n.list.length?n.list.forEach((function(e){l=l.filter((function(n){return n.rm!==t||(n.channel===e&&(r-=1,n.unsubscribe(r)),n.channel!==e)}))})):l=l.filter((function(e){return e.rm!==t||(i(e.channel)&&(r-=1,e.unsubscribe(r)),!i(e.channel))})),_(e)(null,"OK")},r.discard=function(e){return _(e)(new Error("ERR DISCARD without MULTI"))},r.multi=function(e){var t={},n=this,r=[],s=[];return i(e)&&(r=r.concat(e.map((function(e){var t=e.slice(1);return t.push((function(e,t){e?s.push(e.message):s.push(t)})),[e[0],n[e[0]],n,t]})))),Object.keys(this).forEach((function(e){t[e]=function(){var t=Array.prototype.slice.call(arguments);return t.push((function(e,t){e?s.push(e.message):s.push(t)})),r.push([e,n[e],n,t]),this}})),t.exec=function(e){return r.some((function(e){var t=e[3][0];return!(!i(u[t])||!u[t].modified||-1===u[t].watchers.indexOf(n))}))?(n.unwatch(),_(e)(null,null)):(r.forEach((function(e){e[1].apply(e[2],e[3])})),n.unwatch(),_(e)(null,s))},t.discard=function(e){return r=[],n.unwatch(),_(e)(null,"OK")},t},r.unwatch=function(e){var t=this;return Object.keys(u).forEach((function(e){i(u[e])&&(u[e].watchers=u[e].watchers.filter((function(e){return t!==e})),0===u[e].watchers.length&&(u[e]=void 0))})),_(e)(null,"OK")},r.watch=function(e,t){return i(u[e])||(u[e]={modified:!1,watchers:[]}),u[e].watchers.push(this),_(t)(null,"OK")},r.eval=function(e,t,n,r){return _(r)(new Error("UNIMPLEMENTED"))},r.evalsha=function(e,t,n,r){return _(r)(new Error("UNIMPLEMENTED"))},r.script_exists=function(e,t){return _(t)(new Error("UNIMPLEMENTED"))},r.script_flush=function(e){return _(e)(new Error("UNIMPLEMENTED"))},r.script_kill=function(e){return _(e)(new Error("UNIMPLEMENTED"))},r.script_load=function(e){return _(e)(new Error("UNIMPLEMENTED"))},r.auth=function(e,t){return r.password?e===r.password?_(t)(null,"OK"):_(t)(new Error("ERR invalid password")):_(t)(new Error("ERR Client sent AUTH, but no password is set"))},r.echo=function(e,t){return _(t)(null,e)},r.ping=function(e){return _(e)(null,"PONG")},r.quit=function(e){return _(e)(null,"OK")},r.select=function(e,t){return _(t)(new Error("UNIMPLEMENTED"))},r.createClient=function(){return r.copy()},r.bgrewriteaof=function(e){return _(e)(new Error("UNIMPLEMENTED"))},r.bgsave=function(e){return _(e)(new Error("UNIMPLEMENTED"))},r.client_kill=function(e){return _(e)(new Error("UNIMPLEMENTED"))},r.client_list=function(e){return _(e)(new Error("UNIMPLEMENTED"))},r.client_getname=function(e){return _(e)(new Error("UNIMPLEMENTED"))},r.client_pause=function(e,t){return _(t)(new Error("UNIMPLEMENTED"))},r.client_setname=function(e,t){return _(t)(new Error("UNIMPLEMENTED"))},r.cluster_slots=function(e){return _(e)(new Error("UNIMPLEMENTED"))},r.command=function(e){return _(e)(new Error("UNIMPLEMENTED"))},r.command_count=function(e){return _(e)(new Error("UNIMPLEMENTED"))},r.command_getkeys=function(e){return _(e)(new Error("UNIMPLEMENTED"))},r.command_info=function(e){return _(e)(new Error("UNIMPLEMENTED"))},r.config_get=function(e){return _(e)(new Error("UNIMPLEMENTED"))},r.config_rewrite=function(e){return _(e)(new Error("UNIMPLEMENTED"))},r.config_set=function(e,t,n){return _(n)(new Error("UNIMPLEMENTED"))},r.config_resetstat=function(e){return _(e)(new Error("UNIMPLEMENTED"))},r.dbsize=function(e){var t,n=0;for(t in a)t!==d&&t!==h&&t!==p&&a.hasOwnProperty(t)&&(n+=1);for(t in a[d])a[d].hasOwnProperty(t)&&(n+=1);for(t in a[h])a[h].hasOwnProperty(t)&&(n+=1);for(t in a[p])a[p].hasOwnProperty(t)&&(n+=1);return _(e)(null,n)},r.debug_object=function(e,t){return _(t)(new Error("UNIMPLEMENTED"))},r.debug_segfault=function(e){return _(e)(new Error("UNIMPLEMENTED"))},r.flushall=function(e){return this.flushdb(e)},r.flushdb=function(e){return(a={})[d]={},a[h]={},a[p]={},Object.keys(c).forEach((function(e){c[e]&&clearTimeout(c[e].timeout)})),c={},_(e)(null,"OK")},r.info=function(e){return _(e)(new Error("UNIMPLEMENTED"))},r.lastsave=function(e){return _(e)(new Error("UNIMPLEMENTED"))},r.monitor=function(e){return _(e)(new Error("UNIMPLEMENTED"))},r.role=function(e){return _(e)(new Error("UNIMPLEMENTED"))},r.save=function(e){return _(e)(new Error("UNIMPLEMENTED"))},r.shutdown=function(e){return _(e)(new Error("UNIMPLEMENTED"))},r.slaveof=function(e,t,n){return _(n)(new Error("UNIMPLEMENTED"))},r.slowlog=function(e,t){return _(t)(new Error("UNIMPLEMENTED"))},r.sync=function(e){return _(e)(new Error("UNIMPLEMENTED"))},r.time=function(e){var t,r=new Date,i=r.getTime();return t=n.performance?n.performance.now?1e5*((r=n.performance.now())-Math.floor(r)):n.performance.webkitNow?1e5*((r=n.performance.webkitNow())-Math.floor(r)):0:"undefined"!=typeof process&&process.hrtime?process.hrtime()[1]/1e3:0,_(e)(null,[i,t])};var w={},v=[];for(var k in r)"function"==typeof r[k]&&(v.push(k),w[k]=r[k]);function j(e,t,n){return function(){for(var r,i,s=Array.prototype.slice.call(arguments),o=n();s.length<e.length-1;)s.push(void 0);return"function"==typeof s[s.length-1]&&(i=s[s.length-1],s.pop()),s.push((function(e,t){if(e)return i&&"function"==typeof i&&i(e),o.reject(e);i&&"function"==typeof i&&i(null,t),o.resolve(t)})),e.apply(t,s),"function"==typeof(r=o.promise)&&(r=r()),r}}if(v.forEach((function(e){r[e]=function(){return arguments.length<w[e].length-1?_(arguments[arguments.length-1])(new Error("ERR wrong number of arguments for '"+e+"' command")):w[e].apply(this,arguments)}})),["del","mset","msetnx","psetex","set","setbit","setex","setrange","incr","decr","incrby","decrby","incrbyfloat","blpop","brpop","brpoplpush","linsert","lpush","lpushx","rpush","rpushx","lpop","rpop","rpoplpush","ltrim","lset","lrem","sadd","smove","spop","sdiffstore","sinterstore","srem","sunionstore","zadd","zrem","zunionstore","zinterstore","zincrby","zremrangebylex","zremrangebyrank","zremrangebyscore","hdel","hincrby","hincrbyfloat","hset","hmset","hsetnx"].forEach((function(e){var t=r[e];r[e]=function(){var e=arguments[0];return i(u[e])&&(u[e].modified=!0),t.apply(this,arguments)}})),r.toPromiseStyle=function(e){var t=this;return Object.keys(this).filter((function(e){return"function"==typeof t[e]&&"multi"!==e})).map((function(n){return[n,j(t[n],t,e)]})).reduce((function(e,t){return e[t[0]]=t[1],e}),{multi:this.multi})},r.copy=function(){var e={};return v.forEach((function(t){e[t]=function(){return r[t].apply(e,arguments)}})),e.toPromiseStyle=r.toPromiseStyle,e.listeners={},e},r.unref=function(){},"undefined"!=typeof process&&"1"===process.env.REDIS_JS_TO_NODE_REDIS){var E=[];process.env.REDIS_JS_NODE_REDIS_PORT&&E.push(process.env.REDIS_JS_NODE_REDIS_PORT),process.env.REDIS_JS_NODE_REDIS_HOST&&E.push(process.env.REDIS_JS_NODE_REDIS_HOST),process.env.REDIS_JS_NODE_REDIS_OPTIONS&&E.push(JSON.parse(process.env.REDIS_JS_NODE_REDIS_OPTIONS))}}).call(this)}},__webpack_module_cache__={};function __webpack_require__(e){var t=__webpack_module_cache__[e];if(void 0!==t)return t.exports;var n=__webpack_module_cache__[e]={exports:{}};return __webpack_modules__[e].call(n.exports,n,n.exports,__webpack_require__),n.exports}__webpack_require__.d=(e,t)=>{for(var n in t)__webpack_require__.o(t,n)&&!__webpack_require__.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},__webpack_require__.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),__webpack_require__.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t);var __webpack_exports__={};__webpack_require__.d(__webpack_exports__,{wg:()=>HyphaServer,kb:()=>mock_socket.WebSocket,zy:()=>WebsocketRPCConnection,aR:()=>Workspace,PO:()=>connectToServer,tz:()=>hypha_rpc.hyphaWebsocketClient,Me:()=>imjoy_rpc.imjoyRPC});var mock_socket=__webpack_require__(644),hypha_rpc=__webpack_require__(515),imjoy_rpc=__webpack_require__(237);function prettyByte(e){return"".concat(e<0?"-":"","0x").concat(Math.abs(e).toString(16).padStart(2,"0"))}var ExtData=function(e,t){this.type=e,this.data=t},__extends=(extendStatics=function(e,t){return extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])},extendStatics(e,t)},function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function n(){this.constructor=e}extendStatics(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}),extendStatics,DecodeError=function(e){function t(n){var r=e.call(this,n)||this,i=Object.create(t.prototype);return Object.setPrototypeOf(r,i),Object.defineProperty(r,"name",{configurable:!0,enumerable:!1,value:t.name}),r}return __extends(t,e),t}(Error),UINT32_MAX=4294967295;function setUint64(e,t,n){var r=n/4294967296,i=n;e.setUint32(t,r),e.setUint32(t+4,i)}function setInt64(e,t,n){var r=Math.floor(n/4294967296),i=n;e.setUint32(t,r),e.setUint32(t+4,i)}function getInt64(e,t){return 4294967296*e.getInt32(t)+e.getUint32(t+4)}function getUint64(e,t){return 4294967296*e.getUint32(t)+e.getUint32(t+4)}var EXT_TIMESTAMP=-1,TIMESTAMP32_MAX_SEC=4294967295,TIMESTAMP64_MAX_SEC=17179869183;function encodeTimeSpecToTimestamp(e){var t,n=e.sec,r=e.nsec;if(n>=0&&r>=0&&n<=TIMESTAMP64_MAX_SEC){if(0===r&&n<=TIMESTAMP32_MAX_SEC){var i=new Uint8Array(4);return(t=new DataView(i.buffer)).setUint32(0,n),i}var s=n/4294967296,o=4294967295&n;return i=new Uint8Array(8),(t=new DataView(i.buffer)).setUint32(0,r<<2|3&s),t.setUint32(4,o),i}return i=new Uint8Array(12),(t=new DataView(i.buffer)).setUint32(0,r),setInt64(t,4,n),i}function encodeDateToTimeSpec(e){var t=e.getTime(),n=Math.floor(t/1e3),r=1e6*(t-1e3*n),i=Math.floor(r/1e9);return{sec:n+i,nsec:r-1e9*i}}function encodeTimestampExtension(e){return e instanceof Date?encodeTimeSpecToTimestamp(encodeDateToTimeSpec(e)):null}function decodeTimestampToTimeSpec(e){var t=new DataView(e.buffer,e.byteOffset,e.byteLength);switch(e.byteLength){case 4:return{sec:t.getUint32(0),nsec:0};case 8:var n=t.getUint32(0);return{sec:4294967296*(3&n)+t.getUint32(4),nsec:n>>>2};case 12:return{sec:getInt64(t,4),nsec:t.getUint32(0)};default:throw new DecodeError("Unrecognized data size for timestamp (expected 4, 8, or 12): ".concat(e.length))}}function decodeTimestampExtension(e){var t=decodeTimestampToTimeSpec(e);return new Date(1e3*t.sec+t.nsec/1e6)}var timestampExtension={type:EXT_TIMESTAMP,encode:encodeTimestampExtension,decode:decodeTimestampExtension},ExtensionCodec=function(){function e(){this.builtInEncoders=[],this.builtInDecoders=[],this.encoders=[],this.decoders=[],this.register(timestampExtension)}return e.prototype.register=function(e){var t=e.type,n=e.encode,r=e.decode;if(t>=0)this.encoders[t]=n,this.decoders[t]=r;else{var i=1+t;this.builtInEncoders[i]=n,this.builtInDecoders[i]=r}},e.prototype.tryToEncode=function(e,t){for(var n=0;n<this.builtInEncoders.length;n++)if(null!=(r=this.builtInEncoders[n])&&null!=(i=r(e,t)))return new ExtData(-1-n,i);for(n=0;n<this.encoders.length;n++){var r,i;if(null!=(r=this.encoders[n])&&null!=(i=r(e,t)))return new ExtData(n,i)}return e instanceof ExtData?e:null},e.prototype.decode=function(e,t,n){var r=t<0?this.builtInDecoders[-1-t]:this.decoders[t];return r?r(e,t,n):new ExtData(t,e)},e.defaultCodec=new e,e}();function utf8Count(e){for(var t=e.length,n=0,r=0;r<t;){var i=e.charCodeAt(r++);if(4294967168&i)if(4294965248&i){if(i>=55296&&i<=56319&&r<t){var s=e.charCodeAt(r);56320==(64512&s)&&(++r,i=((1023&i)<<10)+(1023&s)+65536)}n+=4294901760&i?4:3}else n+=2;else n++}return n}function utf8EncodeJs(e,t,n){for(var r=e.length,i=n,s=0;s<r;){var o=e.charCodeAt(s++);if(4294967168&o){if(4294965248&o){if(o>=55296&&o<=56319&&s<r){var a=e.charCodeAt(s);56320==(64512&a)&&(++s,o=((1023&o)<<10)+(1023&a)+65536)}4294901760&o?(t[i++]=o>>18&7|240,t[i++]=o>>12&63|128,t[i++]=o>>6&63|128):(t[i++]=o>>12&15|224,t[i++]=o>>6&63|128)}else t[i++]=o>>6&31|192;t[i++]=63&o|128}else t[i++]=o}}var sharedTextEncoder=new TextEncoder,TEXT_ENCODER_THRESHOLD=50;function utf8EncodeTE(e,t,n){sharedTextEncoder.encodeInto(e,t.subarray(n))}function utf8Encode(e,t,n){e.length>TEXT_ENCODER_THRESHOLD?utf8EncodeTE(e,t,n):utf8EncodeJs(e,t,n)}var CHUNK_SIZE=4096;function utf8DecodeJs(e,t,n){for(var r=t,i=r+n,s=[],o="";r<i;){var a=e[r++];if(128&a)if(192==(224&a)){var c=63&e[r++];s.push((31&a)<<6|c)}else if(224==(240&a)){c=63&e[r++];var l=63&e[r++];s.push((31&a)<<12|c<<6|l)}else if(240==(248&a)){var u=(7&a)<<18|(c=63&e[r++])<<12|(l=63&e[r++])<<6|63&e[r++];u>65535&&(u-=65536,s.push(u>>>10&1023|55296),u=56320|1023&u),s.push(u)}else s.push(a);else s.push(a);s.length>=CHUNK_SIZE&&(o+=String.fromCharCode.apply(String,s),s.length=0)}return s.length>0&&(o+=String.fromCharCode.apply(String,s)),o}var sharedTextDecoder=new TextDecoder,TEXT_DECODER_THRESHOLD=200;function utf8DecodeTD(e,t,n){var r=e.subarray(t,t+n);return sharedTextDecoder.decode(r)}function utf8Decode(e,t,n){return n>TEXT_DECODER_THRESHOLD?utf8DecodeTD(e,t,n):utf8DecodeJs(e,t,n)}function ensureUint8Array(e){return e instanceof Uint8Array?e:ArrayBuffer.isView(e)?new Uint8Array(e.buffer,e.byteOffset,e.byteLength):e instanceof ArrayBuffer?new Uint8Array(e):Uint8Array.from(e)}function createDataView(e){if(e instanceof ArrayBuffer)return new DataView(e);var t=ensureUint8Array(e);return new DataView(t.buffer,t.byteOffset,t.byteLength)}var DEFAULT_MAX_KEY_LENGTH=16,DEFAULT_MAX_LENGTH_PER_KEY=16,CachedKeyDecoder=function(){function e(e,t){void 0===e&&(e=DEFAULT_MAX_KEY_LENGTH),void 0===t&&(t=DEFAULT_MAX_LENGTH_PER_KEY),this.maxKeyLength=e,this.maxLengthPerKey=t,this.hit=0,this.miss=0,this.caches=[];for(var n=0;n<this.maxKeyLength;n++)this.caches.push([])}return e.prototype.canBeCached=function(e){return e>0&&e<=this.maxKeyLength},e.prototype.find=function(e,t,n){e:for(var r=0,i=this.caches[n-1];r<i.length;r++){for(var s=i[r],o=s.bytes,a=0;a<n;a++)if(o[a]!==e[t+a])continue e;return s.str}return null},e.prototype.store=function(e,t){var n=this.caches[e.length-1],r={bytes:e,str:t};n.length>=this.maxLengthPerKey?n[Math.random()*n.length|0]=r:n.push(r)},e.prototype.decode=function(e,t,n){var r=this.find(e,t,n);if(null!=r)return this.hit++,r;this.miss++;var i=utf8DecodeJs(e,t,n),s=Uint8Array.prototype.slice.call(e,t,t+n);return this.store(s,i),i},e}(),__awaiter=function(e,t,n,r){return new(n||(n=Promise))((function(i,s){function o(e){try{c(r.next(e))}catch(e){s(e)}}function a(e){try{c(r.throw(e))}catch(e){s(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}c((r=r.apply(e,t||[])).next())}))},__generator=function(e,t){var n,r,i,s,o={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return s={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function a(a){return function(c){return function(a){if(n)throw new TypeError("Generator is already executing.");for(;s&&(s=0,a[0]&&(o=0)),o;)try{if(n=1,r&&(i=2&a[0]?r.return:a[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,a[1])).done)return i;switch(r=0,i&&(a=[2&a[0],i.value]),a[0]){case 0:case 1:i=a;break;case 4:return o.label++,{value:a[1],done:!1};case 5:o.label++,r=a[1],a=[0];continue;case 7:a=o.ops.pop(),o.trys.pop();continue;default:if(!((i=(i=o.trys).length>0&&i[i.length-1])||6!==a[0]&&2!==a[0])){o=0;continue}if(3===a[0]&&(!i||a[1]>i[0]&&a[1]<i[3])){o.label=a[1];break}if(6===a[0]&&o.label<i[1]){o.label=i[1],i=a;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(a);break}i[2]&&o.ops.pop(),o.trys.pop();continue}a=t.call(e,o)}catch(e){a=[6,e],r=0}finally{n=i=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,c])}}},__asyncValues=function(e){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var t,n=e[Symbol.asyncIterator];return n?n.call(e):(e="function"==typeof __values?__values(e):e[Symbol.iterator](),t={},r("next"),r("throw"),r("return"),t[Symbol.asyncIterator]=function(){return this},t);function r(n){t[n]=e[n]&&function(t){return new Promise((function(r,i){!function(e,t,n,r){Promise.resolve(r).then((function(t){e({value:t,done:n})}),t)}(r,i,(t=e[n](t)).done,t.value)}))}}},__await=function(e){return this instanceof __await?(this.v=e,this):new __await(e)},__asyncGenerator=function(e,t,n){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var r,i=n.apply(e,t||[]),s=[];return r={},o("next"),o("throw"),o("return"),r[Symbol.asyncIterator]=function(){return this},r;function o(e){i[e]&&(r[e]=function(t){return new Promise((function(n,r){s.push([e,t,n,r])>1||a(e,t)}))})}function a(e,t){try{(n=i[e](t)).value instanceof __await?Promise.resolve(n.value.v).then(c,l):u(s[0][2],n)}catch(e){u(s[0][3],e)}var n}function c(e){a("next",e)}function l(e){a("throw",e)}function u(e,t){e(t),s.shift(),s.length&&a(s[0][0],s[0][1])}},STATE_ARRAY="array",STATE_MAP_KEY="map_key",STATE_MAP_VALUE="map_value",isValidMapKeyType=function(e){return"string"==typeof e||"number"==typeof e},HEAD_BYTE_REQUIRED=-1,EMPTY_VIEW=new DataView(new ArrayBuffer(0)),EMPTY_BYTES=new Uint8Array(EMPTY_VIEW.buffer);try{EMPTY_VIEW.getInt8(0)}catch(e){if(!(e instanceof RangeError))throw new Error("This module is not supported in the current JavaScript engine because DataView does not throw RangeError on out-of-bounds access")}var DataViewIndexOutOfBoundsError=RangeError,MORE_DATA=new DataViewIndexOutOfBoundsError("Insufficient data"),sharedCachedKeyDecoder=new CachedKeyDecoder,Decoder=function(){function e(e){var t,n,r,i,s,o,a;this.totalPos=0,this.pos=0,this.view=EMPTY_VIEW,this.bytes=EMPTY_BYTES,this.headByte=HEAD_BYTE_REQUIRED,this.stack=[],this.extensionCodec=null!==(t=null==e?void 0:e.extensionCodec)&&void 0!==t?t:ExtensionCodec.defaultCodec,this.context=null==e?void 0:e.context,this.useBigInt64=null!==(n=null==e?void 0:e.useBigInt64)&&void 0!==n&&n,this.maxStrLength=null!==(r=null==e?void 0:e.maxStrLength)&&void 0!==r?r:UINT32_MAX,this.maxBinLength=null!==(i=null==e?void 0:e.maxBinLength)&&void 0!==i?i:UINT32_MAX,this.maxArrayLength=null!==(s=null==e?void 0:e.maxArrayLength)&&void 0!==s?s:UINT32_MAX,this.maxMapLength=null!==(o=null==e?void 0:e.maxMapLength)&&void 0!==o?o:UINT32_MAX,this.maxExtLength=null!==(a=null==e?void 0:e.maxExtLength)&&void 0!==a?a:UINT32_MAX,this.keyDecoder=void 0!==(null==e?void 0:e.keyDecoder)?e.keyDecoder:sharedCachedKeyDecoder}return e.prototype.reinitializeState=function(){this.totalPos=0,this.headByte=HEAD_BYTE_REQUIRED,this.stack.length=0},e.prototype.setBuffer=function(e){this.bytes=ensureUint8Array(e),this.view=createDataView(this.bytes),this.pos=0},e.prototype.appendBuffer=function(e){if(this.headByte!==HEAD_BYTE_REQUIRED||this.hasRemaining(1)){var t=this.bytes.subarray(this.pos),n=ensureUint8Array(e),r=new Uint8Array(t.length+n.length);r.set(t),r.set(n,t.length),this.setBuffer(r)}else this.setBuffer(e)},e.prototype.hasRemaining=function(e){return this.view.byteLength-this.pos>=e},e.prototype.createExtraByteError=function(e){var t=this.view,n=this.pos;return new RangeError("Extra ".concat(t.byteLength-n," of ").concat(t.byteLength," byte(s) found at buffer[").concat(e,"]"))},e.prototype.decode=function(e){this.reinitializeState(),this.setBuffer(e);var t=this.doDecodeSync();if(this.hasRemaining(1))throw this.createExtraByteError(this.pos);return t},e.prototype.decodeMulti=function(e){return __generator(this,(function(t){switch(t.label){case 0:this.reinitializeState(),this.setBuffer(e),t.label=1;case 1:return this.hasRemaining(1)?[4,this.doDecodeSync()]:[3,3];case 2:return t.sent(),[3,1];case 3:return[2]}}))},e.prototype.decodeAsync=function(e){var t,n,r,i,s,o,a;return __awaiter(this,void 0,void 0,(function(){var c,l,u,d,h,p,f,_;return __generator(this,(function(m){switch(m.label){case 0:c=!1,m.label=1;case 1:m.trys.push([1,6,7,12]),t=!0,n=__asyncValues(e),m.label=2;case 2:return[4,n.next()];case 3:if(r=m.sent(),i=r.done)return[3,5];a=r.value,t=!1;try{if(u=a,c)throw this.createExtraByteError(this.totalPos);this.appendBuffer(u);try{l=this.doDecodeSync(),c=!0}catch(e){if(!(e instanceof DataViewIndexOutOfBoundsError))throw e}this.totalPos+=this.pos}finally{t=!0}m.label=4;case 4:return[3,2];case 5:return[3,12];case 6:return d=m.sent(),s={error:d},[3,12];case 7:return m.trys.push([7,,10,11]),t||i||!(o=n.return)?[3,9]:[4,o.call(n)];case 8:m.sent(),m.label=9;case 9:return[3,11];case 10:if(s)throw s.error;return[7];case 11:return[7];case 12:if(c){if(this.hasRemaining(1))throw this.createExtraByteError(this.totalPos);return[2,l]}throw p=(h=this).headByte,f=h.pos,_=h.totalPos,new RangeError("Insufficient data in parsing ".concat(prettyByte(p)," at ").concat(_," (").concat(f," in the current buffer)"))}}))}))},e.prototype.decodeArrayStream=function(e){return this.decodeMultiAsync(e,!0)},e.prototype.decodeStream=function(e){return this.decodeMultiAsync(e,!1)},e.prototype.decodeMultiAsync=function(e,t){return __asyncGenerator(this,arguments,(function(){var n,r,i,s,o,a,c,l,u,d,h,p;return __generator(this,(function(f){switch(f.label){case 0:n=t,r=-1,f.label=1;case 1:f.trys.push([1,15,16,21]),i=!0,s=__asyncValues(e),f.label=2;case 2:return[4,__await(s.next())];case 3:if(o=f.sent(),u=o.done)return[3,14];p=o.value,i=!1,f.label=4;case 4:if(f.trys.push([4,,12,13]),a=p,t&&0===r)throw this.createExtraByteError(this.totalPos);this.appendBuffer(a),n&&(r=this.readArraySize(),n=!1,this.complete()),f.label=5;case 5:f.trys.push([5,10,,11]),f.label=6;case 6:return[4,__await(this.doDecodeSync())];case 7:return[4,f.sent()];case 8:return f.sent(),0==--r?[3,9]:[3,6];case 9:return[3,11];case 10:if(!((c=f.sent())instanceof DataViewIndexOutOfBoundsError))throw c;return[3,11];case 11:return this.totalPos+=this.pos,[3,13];case 12:return i=!0,[7];case 13:return[3,2];case 14:return[3,21];case 15:return l=f.sent(),d={error:l},[3,21];case 16:return f.trys.push([16,,19,20]),i||u||!(h=s.return)?[3,18]:[4,__await(h.call(s))];case 17:f.sent(),f.label=18;case 18:return[3,20];case 19:if(d)throw d.error;return[7];case 20:return[7];case 21:return[2]}}))}))},e.prototype.doDecodeSync=function(){e:for(;;){var e=this.readHeadByte(),t=void 0;if(e>=224)t=e-256;else if(e<192)if(e<128)t=e;else if(e<144){if(0!=(r=e-128)){this.pushMapState(r),this.complete();continue e}t={}}else if(e<160){if(0!=(r=e-144)){this.pushArrayState(r),this.complete();continue e}t=[]}else{var n=e-160;t=this.decodeUtf8String(n,0)}else if(192===e)t=null;else if(194===e)t=!1;else if(195===e)t=!0;else if(202===e)t=this.readF32();else if(203===e)t=this.readF64();else if(204===e)t=this.readU8();else if(205===e)t=this.readU16();else if(206===e)t=this.readU32();else if(207===e)t=this.useBigInt64?this.readU64AsBigInt():this.readU64();else if(208===e)t=this.readI8();else if(209===e)t=this.readI16();else if(210===e)t=this.readI32();else if(211===e)t=this.useBigInt64?this.readI64AsBigInt():this.readI64();else if(217===e)n=this.lookU8(),t=this.decodeUtf8String(n,1);else if(218===e)n=this.lookU16(),t=this.decodeUtf8String(n,2);else if(219===e)n=this.lookU32(),t=this.decodeUtf8String(n,4);else if(220===e){if(0!==(r=this.readU16())){this.pushArrayState(r),this.complete();continue e}t=[]}else if(221===e){if(0!==(r=this.readU32())){this.pushArrayState(r),this.complete();continue e}t=[]}else if(222===e){if(0!==(r=this.readU16())){this.pushMapState(r),this.complete();continue e}t={}}else if(223===e){if(0!==(r=this.readU32())){this.pushMapState(r),this.complete();continue e}t={}}else if(196===e){var r=this.lookU8();t=this.decodeBinary(r,1)}else if(197===e)r=this.lookU16(),t=this.decodeBinary(r,2);else if(198===e)r=this.lookU32(),t=this.decodeBinary(r,4);else if(212===e)t=this.decodeExtension(1,0);else if(213===e)t=this.decodeExtension(2,0);else if(214===e)t=this.decodeExtension(4,0);else if(215===e)t=this.decodeExtension(8,0);else if(216===e)t=this.decodeExtension(16,0);else if(199===e)r=this.lookU8(),t=this.decodeExtension(r,1);else if(200===e)r=this.lookU16(),t=this.decodeExtension(r,2);else{if(201!==e)throw new DecodeError("Unrecognized type byte: ".concat(prettyByte(e)));r=this.lookU32(),t=this.decodeExtension(r,4)}this.complete();for(var i=this.stack;i.length>0;){var s=i[i.length-1];if(s.type===STATE_ARRAY){if(s.array[s.position]=t,s.position++,s.position!==s.size)continue e;i.pop(),t=s.array}else{if(s.type===STATE_MAP_KEY){if(!isValidMapKeyType(t))throw new DecodeError("The type of key must be string or number but "+typeof t);if("__proto__"===t)throw new DecodeError("The key __proto__ is not allowed");s.key=t,s.type=STATE_MAP_VALUE;continue e}if(s.map[s.key]=t,s.readCount++,s.readCount!==s.size){s.key=null,s.type=STATE_MAP_KEY;continue e}i.pop(),t=s.map}}return t}},e.prototype.readHeadByte=function(){return this.headByte===HEAD_BYTE_REQUIRED&&(this.headByte=this.readU8()),this.headByte},e.prototype.complete=function(){this.headByte=HEAD_BYTE_REQUIRED},e.prototype.readArraySize=function(){var e=this.readHeadByte();switch(e){case 220:return this.readU16();case 221:return this.readU32();default:if(e<160)return e-144;throw new DecodeError("Unrecognized array type byte: ".concat(prettyByte(e)))}},e.prototype.pushMapState=function(e){if(e>this.maxMapLength)throw new DecodeError("Max length exceeded: map length (".concat(e,") > maxMapLengthLength (").concat(this.maxMapLength,")"));this.stack.push({type:STATE_MAP_KEY,size:e,key:null,readCount:0,map:{}})},e.prototype.pushArrayState=function(e){if(e>this.maxArrayLength)throw new DecodeError("Max length exceeded: array length (".concat(e,") > maxArrayLength (").concat(this.maxArrayLength,")"));this.stack.push({type:STATE_ARRAY,size:e,array:new Array(e),position:0})},e.prototype.decodeUtf8String=function(e,t){var n;if(e>this.maxStrLength)throw new DecodeError("Max length exceeded: UTF-8 byte length (".concat(e,") > maxStrLength (").concat(this.maxStrLength,")"));if(this.bytes.byteLength<this.pos+t+e)throw MORE_DATA;var r,i=this.pos+t;return r=this.stateIsMapKey()&&(null===(n=this.keyDecoder)||void 0===n?void 0:n.canBeCached(e))?this.keyDecoder.decode(this.bytes,i,e):utf8Decode(this.bytes,i,e),this.pos+=t+e,r},e.prototype.stateIsMapKey=function(){return this.stack.length>0&&this.stack[this.stack.length-1].type===STATE_MAP_KEY},e.prototype.decodeBinary=function(e,t){if(e>this.maxBinLength)throw new DecodeError("Max length exceeded: bin length (".concat(e,") > maxBinLength (").concat(this.maxBinLength,")"));if(!this.hasRemaining(e+t))throw MORE_DATA;var n=this.pos+t,r=this.bytes.subarray(n,n+e);return this.pos+=t+e,r},e.prototype.decodeExtension=function(e,t){if(e>this.maxExtLength)throw new DecodeError("Max length exceeded: ext length (".concat(e,") > maxExtLength (").concat(this.maxExtLength,")"));var n=this.view.getInt8(this.pos+t),r=this.decodeBinary(e,t+1);return this.extensionCodec.decode(r,n,this.context)},e.prototype.lookU8=function(){return this.view.getUint8(this.pos)},e.prototype.lookU16=function(){return this.view.getUint16(this.pos)},e.prototype.lookU32=function(){return this.view.getUint32(this.pos)},e.prototype.readU8=function(){var e=this.view.getUint8(this.pos);return this.pos++,e},e.prototype.readI8=function(){var e=this.view.getInt8(this.pos);return this.pos++,e},e.prototype.readU16=function(){var e=this.view.getUint16(this.pos);return this.pos+=2,e},e.prototype.readI16=function(){var e=this.view.getInt16(this.pos);return this.pos+=2,e},e.prototype.readU32=function(){var e=this.view.getUint32(this.pos);return this.pos+=4,e},e.prototype.readI32=function(){var e=this.view.getInt32(this.pos);return this.pos+=4,e},e.prototype.readU64=function(){var e=getUint64(this.view,this.pos);return this.pos+=8,e},e.prototype.readI64=function(){var e=getInt64(this.view,this.pos);return this.pos+=8,e},e.prototype.readU64AsBigInt=function(){var e=this.view.getBigUint64(this.pos);return this.pos+=8,e},e.prototype.readI64AsBigInt=function(){var e=this.view.getBigInt64(this.pos);return this.pos+=8,e},e.prototype.readF32=function(){var e=this.view.getFloat32(this.pos);return this.pos+=4,e},e.prototype.readF64=function(){var e=this.view.getFloat64(this.pos);return this.pos+=8,e},e}(),DEFAULT_MAX_DEPTH=100,DEFAULT_INITIAL_BUFFER_SIZE=2048,Encoder=function(){function e(e){var t,n,r,i,s,o,a,c;this.extensionCodec=null!==(t=null==e?void 0:e.extensionCodec)&&void 0!==t?t:ExtensionCodec.defaultCodec,this.context=null==e?void 0:e.context,this.useBigInt64=null!==(n=null==e?void 0:e.useBigInt64)&&void 0!==n&&n,this.maxDepth=null!==(r=null==e?void 0:e.maxDepth)&&void 0!==r?r:DEFAULT_MAX_DEPTH,this.initialBufferSize=null!==(i=null==e?void 0:e.initialBufferSize)&&void 0!==i?i:DEFAULT_INITIAL_BUFFER_SIZE,this.sortKeys=null!==(s=null==e?void 0:e.sortKeys)&&void 0!==s&&s,this.forceFloat32=null!==(o=null==e?void 0:e.forceFloat32)&&void 0!==o&&o,this.ignoreUndefined=null!==(a=null==e?void 0:e.ignoreUndefined)&&void 0!==a&&a,this.forceIntegerToFloat=null!==(c=null==e?void 0:e.forceIntegerToFloat)&&void 0!==c&&c,this.pos=0,this.view=new DataView(new ArrayBuffer(this.initialBufferSize)),this.bytes=new Uint8Array(this.view.buffer)}return e.prototype.reinitializeState=function(){this.pos=0},e.prototype.encodeSharedRef=function(e){return this.reinitializeState(),this.doEncode(e,1),this.bytes.subarray(0,this.pos)},e.prototype.encode=function(e){return this.reinitializeState(),this.doEncode(e,1),this.bytes.slice(0,this.pos)},e.prototype.doEncode=function(e,t){if(t>this.maxDepth)throw new Error("Too deep objects in depth ".concat(t));null==e?this.encodeNil():"boolean"==typeof e?this.encodeBoolean(e):"number"==typeof e?this.forceIntegerToFloat?this.encodeNumberAsFloat(e):this.encodeNumber(e):"string"==typeof e?this.encodeString(e):this.useBigInt64&&"bigint"==typeof e?this.encodeBigInt64(e):this.encodeObject(e,t)},e.prototype.ensureBufferSizeToWrite=function(e){var t=this.pos+e;this.view.byteLength<t&&this.resizeBuffer(2*t)},e.prototype.resizeBuffer=function(e){var t=new ArrayBuffer(e),n=new Uint8Array(t),r=new DataView(t);n.set(this.bytes),this.view=r,this.bytes=n},e.prototype.encodeNil=function(){this.writeU8(192)},e.prototype.encodeBoolean=function(e){!1===e?this.writeU8(194):this.writeU8(195)},e.prototype.encodeNumber=function(e){!this.forceIntegerToFloat&&Number.isSafeInteger(e)?e>=0?e<128?this.writeU8(e):e<256?(this.writeU8(204),this.writeU8(e)):e<65536?(this.writeU8(205),this.writeU16(e)):e<4294967296?(this.writeU8(206),this.writeU32(e)):this.useBigInt64?this.encodeNumberAsFloat(e):(this.writeU8(207),this.writeU64(e)):e>=-32?this.writeU8(224|e+32):e>=-128?(this.writeU8(208),this.writeI8(e)):e>=-32768?(this.writeU8(209),this.writeI16(e)):e>=-2147483648?(this.writeU8(210),this.writeI32(e)):this.useBigInt64?this.encodeNumberAsFloat(e):(this.writeU8(211),this.writeI64(e)):this.encodeNumberAsFloat(e)},e.prototype.encodeNumberAsFloat=function(e){this.forceFloat32?(this.writeU8(202),this.writeF32(e)):(this.writeU8(203),this.writeF64(e))},e.prototype.encodeBigInt64=function(e){e>=BigInt(0)?(this.writeU8(207),this.writeBigUint64(e)):(this.writeU8(211),this.writeBigInt64(e))},e.prototype.writeStringHeader=function(e){if(e<32)this.writeU8(160+e);else if(e<256)this.writeU8(217),this.writeU8(e);else if(e<65536)this.writeU8(218),this.writeU16(e);else{if(!(e<4294967296))throw new Error("Too long string: ".concat(e," bytes in UTF-8"));this.writeU8(219),this.writeU32(e)}},e.prototype.encodeString=function(e){var t=utf8Count(e);this.ensureBufferSizeToWrite(5+t),this.writeStringHeader(t),utf8Encode(e,this.bytes,this.pos),this.pos+=t},e.prototype.encodeObject=function(e,t){var n=this.extensionCodec.tryToEncode(e,this.context);if(null!=n)this.encodeExtension(n);else if(Array.isArray(e))this.encodeArray(e,t);else if(ArrayBuffer.isView(e))this.encodeBinary(e);else{if("object"!=typeof e)throw new Error("Unrecognized object: ".concat(Object.prototype.toString.apply(e)));this.encodeMap(e,t)}},e.prototype.encodeBinary=function(e){var t=e.byteLength;if(t<256)this.writeU8(196),this.writeU8(t);else if(t<65536)this.writeU8(197),this.writeU16(t);else{if(!(t<4294967296))throw new Error("Too large binary: ".concat(t));this.writeU8(198),this.writeU32(t)}var n=ensureUint8Array(e);this.writeU8a(n)},e.prototype.encodeArray=function(e,t){var n=e.length;if(n<16)this.writeU8(144+n);else if(n<65536)this.writeU8(220),this.writeU16(n);else{if(!(n<4294967296))throw new Error("Too large array: ".concat(n));this.writeU8(221),this.writeU32(n)}for(var r=0,i=e;r<i.length;r++){var s=i[r];this.doEncode(s,t+1)}},e.prototype.countWithoutUndefined=function(e,t){for(var n=0,r=0,i=t;r<i.length;r++)void 0!==e[i[r]]&&n++;return n},e.prototype.encodeMap=function(e,t){var n=Object.keys(e);this.sortKeys&&n.sort();var r=this.ignoreUndefined?this.countWithoutUndefined(e,n):n.length;if(r<16)this.writeU8(128+r);else if(r<65536)this.writeU8(222),this.writeU16(r);else{if(!(r<4294967296))throw new Error("Too large map object: ".concat(r));this.writeU8(223),this.writeU32(r)}for(var i=0,s=n;i<s.length;i++){var o=s[i],a=e[o];this.ignoreUndefined&&void 0===a||(this.encodeString(o),this.doEncode(a,t+1))}},e.prototype.encodeExtension=function(e){var t=e.data.length;if(1===t)this.writeU8(212);else if(2===t)this.writeU8(213);else if(4===t)this.writeU8(214);else if(8===t)this.writeU8(215);else if(16===t)this.writeU8(216);else if(t<256)this.writeU8(199),this.writeU8(t);else if(t<65536)this.writeU8(200),this.writeU16(t);else{if(!(t<4294967296))throw new Error("Too large extension object: ".concat(t));this.writeU8(201),this.writeU32(t)}this.writeI8(e.type),this.writeU8a(e.data)},e.prototype.writeU8=function(e){this.ensureBufferSizeToWrite(1),this.view.setUint8(this.pos,e),this.pos++},e.prototype.writeU8a=function(e){var t=e.length;this.ensureBufferSizeToWrite(t),this.bytes.set(e,this.pos),this.pos+=t},e.prototype.writeI8=function(e){this.ensureBufferSizeToWrite(1),this.view.setInt8(this.pos,e),this.pos++},e.prototype.writeU16=function(e){this.ensureBufferSizeToWrite(2),this.view.setUint16(this.pos,e),this.pos+=2},e.prototype.writeI16=function(e){this.ensureBufferSizeToWrite(2),this.view.setInt16(this.pos,e),this.pos+=2},e.prototype.writeU32=function(e){this.ensureBufferSizeToWrite(4),this.view.setUint32(this.pos,e),this.pos+=4},e.prototype.writeI32=function(e){this.ensureBufferSizeToWrite(4),this.view.setInt32(this.pos,e),this.pos+=4},e.prototype.writeF32=function(e){this.ensureBufferSizeToWrite(4),this.view.setFloat32(this.pos,e),this.pos+=4},e.prototype.writeF64=function(e){this.ensureBufferSizeToWrite(8),this.view.setFloat64(this.pos,e),this.pos+=8},e.prototype.writeU64=function(e){this.ensureBufferSizeToWrite(8),setUint64(this.view,this.pos,e),this.pos+=8},e.prototype.writeI64=function(e){this.ensureBufferSizeToWrite(8),setInt64(this.view,this.pos,e),this.pos+=8},e.prototype.writeBigUint64=function(e){this.ensureBufferSizeToWrite(8),this.view.setBigUint64(this.pos,e),this.pos+=8},e.prototype.writeBigInt64=function(e){this.ensureBufferSizeToWrite(8),this.view.setBigInt64(this.pos,e),this.pos+=8},e}(),defaultEncodeOptions=null;function encode(e,t){return new Encoder(t).encodeSharedRef(e)}var splitRE=/\r?\n/g,emptyRE=/^\s*$/,needFixRE=/^(\r?\n)*[\t\s]/,deIndent=function(e){if(!needFixRE.test(e))return e;for(var t,n,r,i=e.split(splitRE),s=1/0,o=0;o<i.length;o++){var a=i[o];if(!emptyRE.test(a))if(t)(n=count(a,t))<s&&(s=n);else{if(" "!==(r=a.charAt(0))&&"\t"!==r)return e;(n=count(a,t=r))<s&&(s=n)}}return i.map((function(e){return e.slice(s)})).join("\n")};function count(e,t){for(var n=0;e.charAt(n)===t;)n++;return n}var emptyObject=Object.freeze({});function isUndef(e){return null==e}function isPrimitive(e){return"string"==typeof e||"number"==typeof e||"symbol"==typeof e||"boolean"==typeof e}function isObject(e){return null!==e&&"object"==typeof e}var _toString=Object.prototype.toString;function toRawType(e){return _toString.call(e).slice(8,-1)}function isPlainObject(e){return"[object Object]"===_toString.call(e)}function isValidArrayIndex(e){var t=parseFloat(String(e));return t>=0&&Math.floor(t)===t&&isFinite(e)}function makeMap(e,t){for(var n=Object.create(null),r=e.split(","),i=0;i<r.length;i++)n[r[i]]=!0;return t?function(e){return n[e.toLowerCase()]}:function(e){return n[e]}}var isBuiltInTag=makeMap("slot,component",!0),isReservedAttribute=makeMap("key,ref,slot,slot-scope,is");function remove(e,t){if(e.length){var n=e.indexOf(t);if(n>-1)return e.splice(n,1)}}var pluginParser_hasOwnProperty=Object.prototype.hasOwnProperty;function hasOwn(e,t){return pluginParser_hasOwnProperty.call(e,t)}function cached(e){var t=Object.create(null);return function(n){return t[n]||(t[n]=e(n))}}var camelizeRE=/-(\w)/g,camelize=cached((function(e){return e.replace(camelizeRE,(function(e,t){return t?t.toUpperCase():""}))}));function polyfillBind(e,t){function n(n){var r=arguments.length;return r?r>1?e.apply(t,arguments):e.call(t,n):e.call(t)}return n._length=e.length,n}function nativeBind(e,t){return e.bind(t)}var bind=Function.prototype.bind?nativeBind:polyfillBind;function extend(e,t){for(var n in t)e[n]=t[n];return e}function noop(e,t,n){}var no=function(e,t,n){return!1},identity=function(e){return e};function genStaticKeys(e){return e.reduce((function(e,t){return e.concat(t.staticKeys||[])}),[]).join(",")}var isUnaryTag=makeMap("area,base,br,col,embed,frame,hr,img,input,isindex,keygen,link,meta,param,source,track,wbr"),canBeLeftOpenTag=makeMap("colgroup,dd,dt,li,options,p,td,tfoot,th,thead,tr,source"),isNonPhrasingTag=makeMap("address,article,aside,base,blockquote,body,caption,col,colgroup,dd,details,dialog,div,dl,dt,fieldset,figcaption,figure,footer,form,h1,h2,h3,h4,h5,h6,head,header,hgroup,hr,html,legend,li,menuitem,meta,optgroup,option,param,rp,rt,source,style,summary,tbody,td,tfoot,th,thead,title,tr,track"),attribute=/^\s*([^\s"'<>\/=]+)(?:\s*(=)\s*(?:"([^"]*)"+|'([^']*)'+|([^\s"'=<>`]+)))?/,ncname="[a-zA-Z_][\\w\\-\\.]*",qnameCapture="((?:"+ncname+"\\:)?"+ncname+")",startTagOpen=new RegExp("^<"+qnameCapture),startTagClose=/^\s*(\/?)>/,endTag=new RegExp("^<\\/"+qnameCapture+"[^>]*>"),doctype=/^<!DOCTYPE [^>]+>/i,comment=/^<!\--/,conditionalComment=/^<!\[/,IS_REGEX_CAPTURING_BROKEN=!1;"x".replace(/x(.)?/g,(function(e,t){IS_REGEX_CAPTURING_BROKEN=""===t}));var isPlainTextElement=makeMap("script,style,textarea",!0),reCache={},decodingMap={"&lt;":"<","&gt;":">","&quot;":'"',"&amp;":"&","&#10;":"\n","&#9;":"\t"},encodedAttr=/&(?:lt|gt|quot|amp);/g,encodedAttrWithNewLines=/&(?:lt|gt|quot|amp|#10|#9);/g,isIgnoreNewlineTag=makeMap("pre,textarea",!0),shouldIgnoreFirstNewline=function(e,t){return e&&isIgnoreNewlineTag(e)&&"\n"===t[0]};function decodeAttr(e,t){var n=t?encodedAttrWithNewLines:encodedAttr;return e.replace(n,(function(e){return decodingMap[e]}))}function parseHTML(e,t){for(var n,r,i=[],s=t.expectHTML,o=t.isUnaryTag||no,a=t.canBeLeftOpenTag||no,c=0;e;){if(n=e,r&&isPlainTextElement(r)){var l=0,u=r.toLowerCase(),d=reCache[u]||(reCache[u]=new RegExp("([\\s\\S]*?)(</"+u+"[^>]*>)","i")),h=e.replace(d,(function(e,n,r){return l=r.length,isPlainTextElement(u)||"noscript"===u||(n=n.replace(/<!\--([\s\S]*?)-->/g,"$1").replace(/<!\[CDATA\[([\s\S]*?)]]>/g,"$1")),shouldIgnoreFirstNewline(u,n)&&(n=n.slice(1)),t.chars&&t.chars(n),""}));c+=e.length-h.length,e=h,x(u,c-l,c)}else{var p=e.indexOf("<");if(0===p){if(comment.test(e)){var f=e.indexOf("--\x3e");if(f>=0){t.shouldKeepComment&&t.comment(e.substring(4,f)),j(f+3);continue}}if(conditionalComment.test(e)){var _=e.indexOf("]>");if(_>=0){j(_+2);continue}}var m=e.match(doctype);if(m){j(m[0].length);continue}var y=e.match(endTag);if(y){var g=c;j(y[0].length),x(y[1],g,c);continue}var b=E();if(b){O(b),shouldIgnoreFirstNewline(r,e)&&j(1);continue}}var w=void 0,v=void 0,k=void 0;if(p>=0){for(v=e.slice(p);!(endTag.test(v)||startTagOpen.test(v)||comment.test(v)||conditionalComment.test(v)||(k=v.indexOf("<",1))<0);)p+=k,v=e.slice(p);w=e.substring(0,p),j(p)}p<0&&(w=e,e=""),t.chars&&w&&t.chars(w)}if(e===n){t.chars&&t.chars(e),!i.length&&t.warn&&t.warn('Mal-formatted tag at end of template: "'+e+'"');break}}function j(t){c+=t,e=e.substring(t)}function E(){var t=e.match(startTagOpen);if(t){var n,r,i={tagName:t[1],attrs:[],start:c};for(j(t[0].length);!(n=e.match(startTagClose))&&(r=e.match(attribute));)j(r[0].length),i.attrs.push(r);if(n)return i.unarySlash=n[1],j(n[0].length),i.end=c,i}}function O(e){var n=e.tagName,c=e.unarySlash;s&&("p"===r&&isNonPhrasingTag(n)&&x(r),a(n)&&r===n&&x(n));for(var l=o(n)||!!c,u=e.attrs.length,d=new Array(u),h=0;h<u;h++){var p=e.attrs[h];IS_REGEX_CAPTURING_BROKEN&&-1===p[0].indexOf('""')&&(""===p[3]&&delete p[3],""===p[4]&&delete p[4],""===p[5]&&delete p[5]);var f=p[3]||p[4]||p[5]||"",_="a"===n&&"href"===p[1]?t.shouldDecodeNewlinesForHref:t.shouldDecodeNewlines;d[h]={name:p[1],value:decodeAttr(f,_)}}l||(i.push({tag:n,lowerCasedTag:n.toLowerCase(),attrs:d}),r=n),t.start&&t.start(n,d,l,e.start,e.end)}function x(e,n,s){var o,a;if(null==n&&(n=c),null==s&&(s=c),e&&(a=e.toLowerCase()),e)for(o=i.length-1;o>=0&&i[o].lowerCasedTag!==a;o--);else o=0;if(o>=0){for(var l=i.length-1;l>=o;l--)(l>o||!e)&&t.warn&&t.warn("tag <"+i[l].tag+"> has no matching end tag."),t.end&&t.end(i[l].tag,n,s);i.length=o,r=o&&i[o-1].tag}else"br"===a?t.start&&t.start(e,[],!0,n,s):"p"===a&&(t.start&&t.start(e,[],!1,n,s),t.end&&t.end(e,n,s))}x()}var splitRE$1=/\r?\n/g,replaceRE=/./g,isSpecialTag=makeMap("script,style,template",!0);function parseComponent(e,t){void 0===t&&(t={});var n={script:[],style:[],config:[],window:[],docs:[],attachment:[],link:[],others:[]},r=0,i=null;return parseHTML(e,{start:function(e,t,s,o,a){0===r&&(i={type:e,content:"",start:a,attrs:t.reduce((function(e,t){var n=t.name,r=t.value;return e[n]=r||!0,e}),{})},n[e]?(function(e,t){for(var n=0;n<t.length;n++){var r=t[n];"lang"===r.name&&(e.lang=r.value),"scoped"===r.name&&(e.scoped=!0),"module"===r.name&&(e.module=r.value||!0),"src"===r.name&&(e.src=r.value)}}(i,t),n[e].push(i)):n.others.push(i)),s||r++},end:function(n,s,o){if(1===r&&i){i.end=s;var a=deIndent(e.slice(i.start,i.end));"template"!==i.type&&t.pad&&(a=function(t,n){if("space"===n)return e.slice(0,t.start).replace(replaceRE," ");var r=e.slice(0,t.start).split(splitRE$1).length,i="script"!==t.type||t.lang?"\n":"//\n";return Array(r).join(i)}(i,t.pad)+a),i.content=a,i=null}r--}}),n}function toCamelCase(e){return e.includes("_")?e.replace(/_./g,(e=>e[1].toUpperCase())):e}class MessageEmitter{constructor(e){this._event_handlers={},this._once_handlers={},this._debug=e}emit(){throw new Error("emit is not implemented")}on(e,t){this._event_handlers[e]||(this._event_handlers[e]=[]),this._event_handlers[e].push(t)}once(e,t){t.___event_run_once=!0,this.on(e,t)}off(e,t){if(e||t){if(e&&!t)this._event_handlers[e]&&(this._event_handlers[e]=[]);else if(this._event_handlers[e]){const n=this._event_handlers[e].indexOf(t);n>=0&&this._event_handlers[e].splice(n,1)}}else this._event_handlers={}}_fire(e,t){if(this._event_handlers[e])for(var n=this._event_handlers[e].length;n--;){const r=this._event_handlers[e][n];try{r(t)}catch(e){console.error(e)}finally{r.___event_run_once&&this._event_handlers[e].splice(n,1)}}else this._debug&&console.warn("unhandled event",e,t)}waitFor(e,t){return new Promise(((n,r)=>{const i=e=>{clearTimeout(s),n(e)};this.once(e,i);const s=setTimeout((()=>{this.off(e,i),r(new Error("Timeout"))}),t)}))}}function randId(){return Math.random().toString(36).substr(2,10)+(new Date).getTime()}function assert(e,t){if(!e)throw new Error(t||"Assertion failed")}class WebsocketRPCConnection{constructor(e,t,n,r,i,s=60){this._clients=t,this._clientId=n,this._handle_message=null,this._handle_connected=null,this._handle_disconnected=null,this._reconnection_token=null,this._timeout=1e3*s,this.workspace=r,this.connection_info=null,this.manager_id=i,this.eventBus=e}mount(e){assert(e.id&&e.workspace&&e.websocket&&e.user_info,"Invalid client config"),e.websocket.on("message",(e=>{const t=(new Decoder).decodeMulti(e),{value:n}=t.next();(n.to.includes("/")?n.to.split("/")[1]:n.to)===this._clientId?this._handle_message(e.buffer):this.emit_message(e)}))}on_connected(e){this._handle_connected=e}on_disconnected(e){this._handle_disconnected=e}on_message(e){assert(e,"handler is required"),this._handle_message=e}async emit_message(e){assert(this._handle_message,"No handler for message");const t=new Decoder,n=t.decodeMulti(e),{value:r}=n.next();let i=r.to;if(i.includes("/")||(i=`${this.workspace}/${i}`),!this._clients[i])return void console.error("No client found for targetId:",i);const s=this._clients[i],o=s.websocket;r.from.includes("/")||(r.from=`${this.workspace}/${r.from}`);const a=encode({...r,ws:this.workspace,to:i,from:r.from,user:s.userInfo}),c=t.pos,l=e.slice(c),u=new Uint8Array(a.length+l.length);u.set(a,0),u.set(new Uint8Array(l),a.length),o&&o.send?o.send(u.buffer):console.error("No websocket found for targetId:",i)}disconnect(e){console.info(`Websocket connection disconnected (${e})`)}}class RedisRPCConnection{constructor(e,t,n,r,i){if(!t||n.includes("/"))throw new Error("Invalid workspace or client ID");this._workspace=t,this._clientId=n,this._userInfo=r,this._stop=!1,this._eventBus=e,this._handleConnected=null,this._handleDisconnected=null,this._handleMessage=null,this.manager_id=i}on_disconnected(e){this._handleDisconnected=e}on_connected(e){this._handleConnected=e}on_message(e){this._handleMessage=e,this._eventBus.on(`${this._workspace}/${this._clientId}:msg`,e),this._eventBus.on(`${this._workspace}/*:msg`,e),this._handleConnected&&this._handleConnected(this)}async emit_message(e){if(!(e instanceof Uint8Array))throw new Error("Data must be bytes");if(this._stop)throw new Error(`Connection has already been closed (client: ${this._workspace}/${this._clientId})`);const t=new Decoder,n=t.decodeMulti(e),{value:r}=n.next(),i=t.pos;let s=r.to;if(!s.includes("/")){if(s.includes("/workspace-manager-"))throw new Error(`Invalid target ID: ${s}, it appears that the target is a workspace manager (target_id should starts with */)`);s=`${this._workspace}/${s}`}const o=`${this._workspace}/${this._clientId}`;r.ws="*"===this._workspace?s.split("/")[0]:this._workspace,r.to=s,r.from=o,r.user=this._userInfo;const a=encode(r),c=e.slice(i),l=new Uint8Array(a.length+c.length);l.set(a,0),l.set(new Uint8Array(c),a.length),this._eventBus.emit(`${s}:msg`,l.buffer)}async disconnect(e){this._stop=!0,this._handleMessage&&(this._eventBus.off(`${this._workspace}/${this._clientId}:msg`,this._handleMessage),this._eventBus.off(`${this._workspace}/*:msg`,this._handleMessage)),this._handleMessage=null,console.info(`Redis Connection Disconnected: ${e}`),this._handleDisconnected&&await this._handleDisconnected(e)}}const CONFIGURABLE_FIELDS=["env","requirements","dependencies","icon","ui","type","flags","labels","cover","base_frame","base_worker","passive"];function parsePluginCode(e,t){t=t||{};try{const n=parseComponent(e);let r;if("yaml"===n.config[0].attrs.lang)throw new Error("YAML not supported");if("json"===n.config[0].attrs.lang)r=JSON.parse(n.config[0].content);else if(r=JSON.parse(n.config[0].content),compareVersions(r.api_version,">","0.1.5"))throw`Unsupported config language ${n.config[0].attrs.lang}, please set lang="json" or lang="yaml"`;r.tag=t.tag||r.tags&&r.tags[0],r.hot_reloading=t.hot_reloading,r.scripts=[];for(let e=0;e<n.script.length;e++)n.script[e].attrs.tag===r.tag&&(r.script=n.script[e].content),n.script[e].attrs.tag&&n.script[e].attrs.tag!==r.tag||r.scripts.push(n.script[e]);!r.script&&n.script.length>0&&(r.script=n.script[0].content,r.lang=n.script[0].attrs.lang),r.links=n.link||null,r.windows=n.window||null,r.styles=n.style||null,r.docs=n.docs&&n.docs[0]||r.docs,r.attachments=n.attachment||null,r._id=t._id||r.name.replace(/ /g,"_"),r.uri=t.uri,r.origin=t.origin,r.namespace=t.namespace,r.code=e,r.id=r.name.trim().replace(/ /g,"_")+"_"+randId(),r.runnable=!1!==r.runnable,r.requirements=r.requirements||[];for(let e=0;e<CONFIGURABLE_FIELDS.length;e++){const t=r[CONFIGURABLE_FIELDS[e]];if(t&&"object"==typeof t&&!(t instanceof Array)){if(!r.tag)throw"You must use 'tags' with configurable fields.";r[CONFIGURABLE_FIELDS[e]]=t[r.tag],Object.prototype.hasOwnProperty.call(t,r.tag)||console.log("WARNING: "+CONFIGURABLE_FIELDS[e]+" do not contain a tag named: "+r.tag)}}return r.lang=r.lang||"javascript",r}catch(e){throw console.error(e),`Failed to parse the plugin file, error: ${e}`}}const _allowedCharacters=/^[a-zA-Z0-9-_/*]*$/;function validateKeyPart(e){if(!_allowedCharacters.test(e))throw new Error(`Invalid characters in query part: ${e}`)}class Workspace{static workspaces={};static tokens={};static clients={};constructor(e){this._server=e,this._redis=e.redis,this.connections=e.connections,this.eventBus=e,this.serverUrl=e.url,this.baseUrl=e.baseUrl}waitForClient(e,t){return new Promise(((n,r)=>{const i=t=>{if(t.id.split(":")[0]===e){if(this.eventBus.off("service_added",i),"imjoy"===t.type)return clearTimeout(s),void n(t);{if(!t.id.endsWith(":default"))return void logger.error("Unexpected service added:",t);const e=t;clearTimeout(s),this._rpc.get_remote_service(e.id).then((async e=>{try{await this.eventBus.emit("client_ready",e),n(e)}catch(e){r(e)}}))}}};let s=setTimeout((()=>{this.eventBus.off("service_added",i),r(new Error(`Timeout after ${t/1e3} s`))}),t);this.eventBus.on("service_added",i)}))}async setup(e){if(!e.client_id)throw new Error("client_id is required in the config");const t=new RedisRPCConnection(this.eventBus,"*",e.client_id,null,null);this.windows=[],this.services={},this.plugins={},this.eventBus.on("client_ready",(async e=>{this.plugins[e.id]=e}));const n=new hypha_rpc.hyphaWebsocketClient.RPC(t,{client_id:e.client_id,default_context:{connection_type:"websocket"},workspace:"*",silent:!1});this._rpc=n,await n.register_service(Object.assign(this.getDefaultServices(),e.default_services||{}),{notify:!1})}async registerService(e,t){const n=t.ws,r=t.from;if(e.config=e.config||{},e.config.workspace=n,e.id.includes("/")||(e.id=`${n}/${e.id}`),!e.id.includes(":"))throw new Error("Service id info must contain ':'");e.app_id=e.app_id||"*",e.config.visibility=e.config.visibility||"protected";const i=this._redis.exists(`services:*:${e.id}@${e.app_id}`),s=`services:${e.config.visibility}:${e.id}@${e.app_id}`;for(const[t,n]of Object.entries(e))this._redis.hset(s,t,n);if(i)s.includes(":built-in@")?(this.eventBus.emit("client_updated",{id:r,workspace:n}),console.info(`Updating built-in service: ${e.id}`)):(this.eventBus.emit("service_updated",e),console.info(`Updating service: ${e.id}`));else{if(s.includes(":default@"))try{const e=await this._rpc.get_remote_service(`${r}:default`);e.setup&&await e.setup()}catch(e){console.error(`Failed to run setup for default service \`${r}\`: ${e}`)}s.includes(":built-in@")?(this.eventBus.emit("client_connected",{id:r,workspace:n}),console.info(`Adding built-in service: ${e.id}, key: ${s}`)):(this.eventBus.emit("service_added",e),console.info(`Adding service ${e.id}, key: ${s}`))}}async unregisterService(e,t){const n=t.ws,r=t.from;if(e.config.workspace=n,e.id.includes("/")||(e.id=`${n}/${e.id}`),!e.id.includes(":"))throw new Error("Service id info must contain ':'");e.app_id=e.app_id||"*";const i=`services:${e.config.visibility}:${e.id}@${e.app_id}`;console.info(`Removing service: ${i}`),this._redis.exists(i)?(this._redis.delete(i),i.includes(":built-in@")?this.eventBus.emit("client_disconnected",{id:r,workspace:n}):this.eventBus.emit("service_removed",e)):console.warning(`Service ${i} does not exist and cannot be removed.`)}async getService(e,{mode:t="default",skipTimeout:n=!1,timeout:r=5},i){const s=i.ws;let o;if(i.user,"string"==typeof e?(o=e,e={id:o}):o=e.id?e.id:e.service_id||"*","string"!=typeof o)throw new Error("Service ID must be a string");if((o.match(/\//g)||[]).length>1)throw new Error("Service id must contain at most one '/'");if((o.match(/:/g)||[]).length>1)throw new Error("Service id must contain at most one ':'");if((o.match(/@/g)||[]).length>1)throw new Error("Service id must contain at most one '@'");if(o.includes("/")&&!o.includes(":")){if(o+=":default",e.workspace=o.split("/")[0],e.client_id&&e.client_id!==o.split("/")[1])throw new Error(`client_id (${e.client_id}) does not match service_id (${o})`);e.client_id=o.split("/")[1]}else if(o.includes("/")||o.includes(":"))if(!o.includes("/")&&o.includes(":")){const t=e.workspace||s;e.client_id=o.split(":")[0],o=`${t}/${o}`,e.workspace=t}else{const t=o.split("/")[0];if(e.client_id=o.split("/")[1].split(":")[0],e.workspace=t,!o.includes("*")){const e=await this._rpc.get_remote_service(o,r);return e?this.patchServiceConfig(t,e):null}}else{const t=e.workspace||"*";o=`${t}/*:${o}`,e.workspace=t,e.client_id="*"}let a="*";if(o.includes("@")&&([o,a]=o.split("@"),e.app_id&&e.app_id!==a))throw new Error(`App id mismatch: ${e.app_id} != ${a}`);e.app_id=e.app_id||a,e.service_id=o.split("/")[1].split(":")[1],console.info("Getting service:",e);const c=e.visibility||"*";let l;l="*"===e.workspace?"public":"*";const u=`services:${l}:${e.workspace}/${e.client_id}:${e.service_id}@${e.app_id}`;if(!u.startsWith("services:"))throw new Error("Query pattern does not start with 'services:'.");if(u.includes("{")||u.includes("}"))throw new Error("Query pattern contains invalid characters.");console.debug("Query services using pattern:",u);const d=this._redis.keys(u);if("*"===e.workspace){const t=`services:${c}:${s}/${e.client_id}:${e.service_id}@${e.app_id}`;d.push(...this._redis.keys(t))}console.debug("Found service keys:",d);const h=[],p=[];d.forEach((e=>{e.split("/")[1]===s?h.push(e):p.push(e)})),"random"===t?(h.sort((()=>Math.random()-.5)),p.sort((()=>Math.random()-.5))):(h.sort(),p.sort());const f=[...h,...p];for(const e of f)try{const t=e.split(":");o=t[2]+":"+t[3],[o,a]=o.split("@");const n=o.split("/")[0],i=await this._rpc.get_remote_service(o,r);if(i)return this.patchServiceConfig(n,i)}catch(e){if(n&&e instanceof TimeoutError){console.warning(`Timeout while getting service ${o}, skipping to the next one.`);continue}throw new Error(`Timeout while getting service ${o}`)}return e.app_id&&"*"!==e.app_id?await this._launch_application_for_service(e,i):null}patchServiceConfig(e,t){return t.config=t.config||{},t.config.workspace=e,t}async listServices(e,t){if(!t)throw new Error("context is required");const n=t.ws;if(t.user,e){if("string"==typeof e){let t="*",n="*",r="*",i="*";if(e.includes("/")&&e.includes(":")){const[s,o]=e.split("/"),[a,c]=o.split(":");n="*"===s?"public":s,r=a,i=c||"*",e={visibility:t,workspace:n,client_id:r,service_id:i}}else if(e.includes(":")){const[s,o]=e.split(":");r=s,i=o||"*",e={visibility:t,workspace:n,client_id:r,service_id:i}}else if(e.includes("/")){const[s,o]=e.split("/");n="*"===s?"public":s,i=o||"*",e={visibility:t,workspace:n,client_id:r,service_id:i}}else n=e,e={visibility:t,workspace:n,client_id:r,service_id:i}}else if(e.id){if(e.service_id)throw new Error("Cannot specify both 'id' and 'service_id' in the query.");e.service_id=e.id,delete e.id}}else e={visibility:"*",workspace:n,client_id:"*",service_id:"*"};const r=e.visibility||"*",i=e.workspace||"*";if("*"===i){if("protected"===r)throw new Error("Cannot list protected services in all workspaces.");e.visibility="public"}const s=e.visibility||"*",o=e.client_id||"*",a=e.service_id||"*",c=e.type||null;let l="*";if(a.includes("@")&&([a,l]=a.split("@"),e.app_id&&e.app_id!==l))throw new Error(`App id mismatch: ${e.app_id} != ${l}`);l=e.app_id||l;const u=["visibility","workspace","client_id","service_id","type","app_id"];if(Object.keys(e).some((e=>!u.includes(e))))throw console.error(`Invalid query keys: ${Object.keys(e).filter((e=>!u.includes(e)))}`),new Error(`Invalid query keys: ${Object.keys(e).filter((e=>!u.includes(e)))}`);validateKeyPart(s),validateKeyPart(i),validateKeyPart(o),validateKeyPart(a),validateKeyPart(l);const d=`services:${s}:${i}/${o}:${a}@${l}`;if(!d.startsWith("services:"))throw new Error("Query pattern does not start with 'services:'.");console.log("Listing services using pattern:",d);const h=this._redis.keys(d);if("*"===i){const e=`services:${r}:${n}/${o}:${a}@${l}`;h.push(...this._redis.keys(e)),console.log("Listing more services using pattern:",e)}const p=[];for(const e of new Set(h)){const t=this._redis.hgetall(e),n={};for(const[e,r]of Object.entries(t)){const t=e;let i=r;"string"==typeof i&&(i.startsWith("{")&&i.endsWith("}")||i.startsWith("[")&&i.endsWith("]"))&&(i=JSON.parse(i)),n[t]=i}c?n.type===c&&p.push(n):p.push(n)}return p}patchServiceConfig(e,t){return t.config=t.config||{},t.config.workspace=e,t}async createWindow(e,t,n){let r;const i=n.ws,s="client-"+Date.now();if(this.connections[i+"/"+s]={id:i+"/"+s,workspace:i,websocket:null,postMessage:e=>{r.contentWindow.postMessage(e)}},"iframe"===e.type)r=document.createElement("iframe"),r.src=e.src,r.id=e.window_id||"window-"+Date.now(),r.style.width=e.width||"100%",r.style.height=e.height||"100%",r.style.display="none",document.body.appendChild(r);else if(e.window_id){let t=0;for(;!document.getElementById(e.window_id)&&t<9;)await new Promise((e=>setTimeout(e,500))),t++;if(r=document.getElementById(e.window_id),!r)throw new Error("Window element not found: "+e.window_id)}else{if(e.window_id="window-"+Date.now(),e.workspace=i,await this.eventBus.emit("add_window",e),await new Promise((e=>setTimeout(e,0))),r=document.getElementById(e.window_id),!r)throw new Error(`iframe element not found ${e.window_id} in 4.5 s`);if("IFRAME"!==r.tagName)throw new Error("iframe element must be an iframe: "+e.window_id)}let o;if(this.connections[i+"/"+s].source=r.contentWindow,e.passive||(o=this.waitForClient(i+"/"+s,18e4)),await new Promise(((e,t)=>{r.onload=e,r.onerror=t})),e.passive)return void delete this.connections[i+"/"+s];r.contentWindow.postMessage({type:"initializeHyphaClient",server_url:this.serverUrl,client_id:s,workspace:i,config:e});const a=await o;return a.setup&&await a.setup(),a.run&&e&&await a.run({data:e.data,config:e.config}),this.windows.push({id:e.window_id,name:e.name||e.src,service:a}),a}async getWindow(e,t){return"string"==typeof e?this.windows.find((t=>t.name===e)):e.id?this.windows.find((t=>t.id===e.id)):e.name?this.windows.find((t=>t.name===e.name)):void 0}async loadPlugin(e,t,n){let r;const i=n.ws,s=e.src;if(s.startsWith("http")&&!s.split("?")[0].endsWith(".imjoy.html"))return await this.createWindow(e,t,n);if(s.startsWith("http")){const e=await fetch(s);r=await e.text()}else{if(!s.includes("\n"))throw new Error("Only local plugins are supported in the workspace manager.");r=s}switch((e=parsePluginCode(r,{})).type){case"web-worker":return await this.createWorker(e,i,this.baseUrl+"hypha-app-webworker.js");case"window":case"iframe":return e.src||(e.src=this.baseUrl+"hypha-app-iframe.html"),await this.createWindow(e,t,n);case"web-python":return await this.createWorker(e,i,this.baseUrl+"hypha-app-webpython.js");default:throw new Error("Unsupported plugin type: "+e.type)}}_waitForConnection(e,t){return new Promise(((n,r)=>{const i=t=>{t.id===e&&(this.eventBus.off("connection_ready",i),clearTimeout(s),n(t))},s=setTimeout((()=>{this.eventBus.off("connection_ready",i),r(new Error(`Timeout after ${t/1e3} s`))}),t);this.eventBus.on("connection_ready",i)}))}async createWorker(e,t,n){const r=new Worker(n),i="client-"+Date.now();return this.connections[t+"/"+i]={id:t+"/"+i,source:r,workspace:t,websocket:null,postMessage:e=>{r.postMessage(e)}},r.onmessage=this._server.messageHandler,await this._waitForConnection(t+"/"+i,6e4),r.postMessage({type:"initializeHyphaClient",server_url:this.serverUrl,workspace:t,client_id:i,config:e}),await this.waitForClient(t+"/"+i,6e4)}async getPlugin(e,t,n){if("string"==typeof e)return await this.loadPlugin({src:e},{},n);if(e.id)return this.plugins[e.id];if(!e.name)throw new Error("Please provide either id or name for the plugin");for(const[t,n]of Object.entries(this.plugins))if(n.name===e.name)return n}getDefaultServices(){return{id:"default",name:"Default workspace management service",description:"Services for managing workspace.",config:{require_context:!0,visibility:"public"},emit:async(e,t,n)=>{n.ws,await this.eventBus.emit(e,t)},on:(e,t,n)=>{n.ws,this.eventBus.on(e,t)},off:(e,t,n)=>{n.ws,this.eventBus.off(e,t)},echo:(e,t)=>e,alert:(e,t)=>{alert(e)},confirm:(e,t)=>confirm(e),prompt:(e,t,n)=>prompt(e,t),show_progress:(e,t)=>{console.log("showProgress",e)},show_message:(e,t)=>{console.log(e)},log:(e,t)=>{console.log(e)},info:(e,t)=>{console.info(e)},error:(e,t)=>{console.error(e)},warning:(e,t)=>{console.warn(e)},critical:(e,t)=>{console.error(e)},register_service:async(e,t)=>{const n=t.ws,r=await this._rpc.get_remote_service(t.from+":built-in");return e.config=e.config||{},e.config.workspace=n,assert(!(e=await r.register_service(e)).id.includes("/"),"Service id must not contain '/'"),e.id=n+"/"+e.id,e},get_service:this.getService.bind(this),list_services:this.listServices.bind(this),generate_token:async e=>{const t=e.ws,n=randId();return Workspace.tokens[n]={workspace:t},n},load_plugin:async(e,t,n)=>this.loadPlugin(e,t,n),create_window:async(e,t,n)=>this.createWindow(e,t,n),get_plugin:async(e,t,n)=>this.getPlugin(e,t,n),register_service:async(e,t)=>await this.registerService(e,t)}}}var redis_mock=__webpack_require__(112);const connectToServer=hypha_rpc.hyphaWebsocketClient.connectToServer,AUTH0_NAMESPACE="https://api.imjoy.io/";class HyphaServer extends MessageEmitter{static servers={};constructor(e){if(super(),e=e||{},this.redis=redis_mock,this.port=e.port||8080,this.baseUrl=e.base_url||new URL("./",document.location.href).href,this.baseUrl.endsWith("/")||(this.baseUrl+="/"),e.url&&e.port)throw new Error("Please provide either url or port, not both.");if(this.WebSocketClass=mock_socket.WebSocket,e.url&&(e.url.startsWith("wss://")||e.url.startsWith("ws://"))){if(!e.url.endsWith("/ws"))throw new Error("Please provide a valid wss url ending with /ws");this.url=e.url.replace("wss://","https://").replace("ws://","http://").slice(0,-3),this.wsUrl=e.url}else this.url=e.url||"https://local-hypha-server:"+this.port,this.wsUrl=this.url.replace("https://","wss://").replace("http://","ws://")+"/ws";this.server=null,this.workspaceManagerId="workspace-manager",this.connections={},this.defaultServices=e.default_services||{},this.imjoyPluginWindows=new Map,this.on("add_window",(e=>{console.log("Creating window: ",e)}))}async emit(e,t){this._fire(e,t)}_handleImJoyPlugin(e){const t=e.source,n=e.data;let r=null;for(const[e,n]of Object.entries(this.connections))if(n.source===t){r=e;break}if(!r)return void console.error("Client id not found for the plugin: ",n);const i=this.workspaceManager.getDefaultServices(),s={};for(const e in i){const t=toCamelCase(e);"function"==typeof i[e]?s[t]=async(...t)=>await i[e](...t,{ws:this.connections[r].workspace,from:`${r}`,to:`${this.connections[r].workspace}/${this.workspaceManagerId}`}):s[t]=i[e]}const o={peer_id:n.peer_id,fire(e){o._messageHandler[e.type]&&o._messageHandler[e.type](e)},disconnect:function(){},emit:e=>{e.peer_id=o.peer_id,t.postMessage(e,"*")},on:function(e,t){o._messageHandler[e]=t},_messageHandler:{},async execute(e){o.emit({type:"execute",code:e})}},a=n.config;if(n.error)return void console.error("Failed to initialize the plugin",n.error);if(!n.peer_id)throw"Please provide a peer_id for the connection.";this.imjoyPluginWindows.set(e.source,{coreConnection:o,cid:r}),console.log("plugin initialized:",a,e.source);const c=new imjoy_rpc.imjoyRPC.RPC(o,{name:"core"});c.setInterface(s),c.on("interfaceSetAsRemote",(()=>{c.on("remoteReady",(async()=>{const e=c.getRemote();e.id=`${r}:default`,e.type="imjoy",await this.workspaceManager.eventBus.emit("service_added",e)})),c.requestRemote()})),c.sendInterface()}_handleClientMessage(e){if(e.data&&"hyphaClientReady"===e.data.type)for(const t in this.connections)if(this.connections[t].source===e.currentTarget){const e=this.connections[t];this.emit("connection_ready",e);break}const t=e.data.workspace;if(!t)return void("initialized"===e.data.type?this._handleImJoyPlugin(e):this.imjoyPluginWindows.has(e.source)&&this.imjoyPluginWindows.get(e.source).coreConnection.fire(e.data));const n=e.data.from;if(!n||!this.connections[t+"/"+n])return void console.warn("Connection not found for client: ",n);const r=this.connections[t+"/"+n],i=r.websocket;if("message"===e.data.type)i.send(e.data.data);else if("close"===e.data.type)i.close();else if("connect"===e.data.type){const t=new mock_socket.WebSocket(e.data.url);t.onmessage=e=>{r.postMessage({type:"message",data:e.data,to:n})},t.onopen=()=>{r.postMessage({type:"connected",to:n})},t.onclose=()=>{r.postMessage({type:"closed",to:n})},r.websocket=t}}async start(){if(HyphaServer.servers[this.url])throw new Error(`Server already running at ${this.url}`);this.server=new mock_socket.Server(this.wsUrl,{mock:!1}),HyphaServer.servers[this.url]=this.server,this.messageHandler=this._handleClientMessage.bind(this),window.addEventListener("message",this.messageHandler),this.workspaceManager=new Workspace(this),await this.workspaceManager.setup({client_id:this.workspaceManagerId,method_timeout:60,default_services:this.defaultServices}),this.server.on("connection",(async e=>{let t,n={};try{const t=await new Promise(((t,n)=>{e.on("message",t),e.on("error",n)})),r=JSON.parse(t);Object.assign(n,r)}catch(t){return console.error(t),void e.close()}if(n.token)if(Workspace.tokens[n.token]){const e=Workspace.tokens[n.token].workspace;if(n.workspace&&n.workspace!==e.id)throw new Error("Invalid workspace token");n.workspace=e.id,t={id:e.id,is_anonymous:!0,email:""}}else{const e=parseJwt(n.token),r=e.exp;t={id:e.sub,is_anonymous:!e[AUTH0_NAMESPACE+"email"],email:e[AUTH0_NAMESPACE+"email"],roles:e[AUTH0_NAMESPACE+"roles"],scopes:e.scope,expires_at:r},n.workspace=t.id}else t={id:"anonymous",is_anonymous:!0,email:"anonymous@imjoy.io"};n.workspace||(n.workspace="workspace-"+randId()),e.send(JSON.stringify({type:"connection_info",hypha_version:"0.1.0",manager_id:this.workspaceManagerId,workspace:n.workspace,client_id:n.client_id,user:t,reconnection_token:null}));const r=new RedisRPCConnection(this,n.workspace,n.client_id,t,this.workspaceManagerId);r.on_message((t=>{e.send(t)})),e.on("message",(e=>{r.emit_message(e)}))}))}async reset(){this.close(),await this.start()}close(){for(const e of Object.values(Workspace.workspaces))e.eventBus.off("service_added");window.removeEventListener("message",this.messageHandler),this.server.stop(),delete HyphaServer.servers[this.server.url]}}function parseJwt(e){var t=e.split(".")[1].replace(/-/g,"+").replace(/_/g,"/"),n=decodeURIComponent(window.atob(t).split("").map((function(e){return"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2)})).join(""));return JSON.parse(n)}var __webpack_exports__HyphaServer=__webpack_exports__.wg,__webpack_exports__WebSocket=__webpack_exports__.kb,__webpack_exports__WebsocketRPCConnection=__webpack_exports__.zy,__webpack_exports__Workspace=__webpack_exports__.aR,__webpack_exports__connectToServer=__webpack_exports__.PO,__webpack_exports__hyphaWebsocketClient=__webpack_exports__.tz,__webpack_exports__imjoyRPC=__webpack_exports__.Me;export{__webpack_exports__HyphaServer as HyphaServer,__webpack_exports__WebSocket as WebSocket,__webpack_exports__WebsocketRPCConnection as WebsocketRPCConnection,__webpack_exports__Workspace as Workspace,__webpack_exports__connectToServer as connectToServer,__webpack_exports__hyphaWebsocketClient as hyphaWebsocketClient,__webpack_exports__imjoyRPC as imjoyRPC};